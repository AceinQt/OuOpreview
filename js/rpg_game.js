/* --- RPG Gameæ¸¸æˆ Integration Logic (Fixed V4) --- */
            // --- æ¸¸æˆRPG Global Variables (Must be at top) ---
window.rpgGameInstance = null; // å…¨å±€å®žä¾‹
const RPG_CONFIG = { TILE: 64 };
const rpgInput = { x: 0, y: 0 };
// å­˜æ¡£ä¸Šä¸‹æ–‡
let rpgSaveContext = 'title';
let selectedPartnerCharId = null; // å…¨å±€å˜é‡å­˜å‚¨é€‰ä¸­çš„ä¼™ä¼´ID
let tempRpgConfig = null;
// RPG DOM Cache
            // === æ–°å¢žï¼šRPGæ¸¸æˆ æŒ‰é’®ç¼“å­˜ ===
const rpgNewGameBtn = document.getElementById('rpg-new-game-btn');
const rpgLoadGameBtn = document.getElementById('rpg-load-game-btn');
const rpgExitGameBtn = document.getElementById('rpg-exit-game-btn');
const rpgStartAdventureBtn = document.getElementById('rpg-start-adventure-btn');
const rpgBackToTitleBtn = document.getElementById('rpg-back-to-title-btn');
const rpgOpenSaveBtn = document.getElementById('rpg-open-save-btn');
const rpgSaveBackBtn = document.getElementById('rpg-save-back-btn'); // ä¿®æ­£å­˜æ¡£é¡µè¿”å›žæŒ‰é’®
// === RPG ç‰©å“æ•°æ®åº“ ===
const RPG_ITEMS = {
    // åœ°å›¾é“å…·
    'return_scroll': { name: 'å›žå®¶å·è½´', icon: 'ðŸ“œ', desc: 'ç«‹å³ä¼ é€å›žæ¸©é¦¨å®¶å›­ (ä¸€æ¬¡æ€§)', type: 'consumable', use: 'map' },
    'tent': { name: 'é‡Žè¥å¸ç¯·', icon: 'â›º', desc: 'éœ²è¥ä¼‘æ¯ï¼Œæ¢å¤å…¨å‘˜çŠ¶æ€ (ä¸€æ¬¡æ€§)', type: 'consumable', use: 'map' },
    
    // æˆ˜æ–—é“å…·
    'potion_red': { name: 'ç”Ÿå‘½è¯æ°´', icon: 'ðŸ·', desc: 'æ¢å¤å•ä½“ 100 HP', type: 'consumable', use: 'battle', effect: { type: 'heal_hp', val: 100 } },
    'potion_blue': { name: 'é­”åŠ›è¯æ°´', icon: 'ðŸ’§', desc: 'æ¢å¤å•ä½“ 50 MP', type: 'consumable', use: 'battle', effect: { type: 'heal_mp', val: 50 } },
    'potion_revive': { name: 'å¤æ´»è¯æ°´', icon: 'âœï¸', desc: 'å¤æ´»æ— æ³•æˆ˜æ–—çš„é˜Ÿå‹å¹¶æ¢å¤50%HP', type: 'consumable', use: 'battle', effect: { type: 'revive', val: 0.5 } },
    'smoke_bomb': { name: 'çƒŸé›¾å¼¹', icon: 'ðŸ’¨', desc: 'ç«‹å³ä»Žæˆ˜æ–—ä¸­é€ƒè·‘', type: 'consumable', use: 'battle', effect: { type: 'flee' } },
    'potion_purify': { name: 'å‡€åŒ–è¯æ°´', icon: 'âœ¨', desc: 'è§£é™¤æ‰€æœ‰å¼‚å¸¸çŠ¶æ€', type: 'consumable', use: 'battle', effect: { type: 'cure_all' } },
       
             
    // ä»»åŠ¡/å®¶å›­é“å…·
    'dye': { name: 'ç¥žå¥‡æŸ“æ–™', icon: 'ðŸŽ¨', desc: 'ä¼¼ä¹Žå¯ä»¥æ”¹å˜è¡£æœçš„é¢œè‰²', type: 'material', use: 'home' },
    'blueprint': { name: 'å®¶å…·å›¾çº¸', icon: 'ðŸ“', desc: 'ç¨€æœ‰çš„è®¾è®¡å›¾', type: 'material', use: 'home' },
    'currency': { name: 'é‡‘å¸', icon: 'ðŸ’°', desc: 'é€šç”¨çš„è´§å¸ï¼Œå¯ä»¥ç”¨æ¥è´­ä¹°å®¶å…·', type: 'currency' }
};

 // === æŽ‰è½é…ç½®è¡¨ (åœ¨è¿™é‡Œä¿®æ”¹æ¦‚çŽ‡) ===
// rate: 0.0 ~ 1.0 (ä¾‹å¦‚ 0.35 ä»£è¡¨ 35%)
// min/max: æŽ‰è½æ•°é‡èŒƒå›´
const RPG_DROP_CONFIG = {
    // æ™®é€šæ€ªç‰©æŽ‰è½åˆ—è¡¨ (ç‹¬ç«‹è®¡ç®—ï¼Œäº’ä¸å†²çª)
    normal: [
        { id: 'currency',    rate: 1.0,  min: 1, max: 3, name: '' },        // 100% æŽ‰ 1-3 é‡‘å¸
        { id: 'potion_red',  rate: 0.10, min: 1, max: 1,  name: 'ç”Ÿå‘½è¯æ°´' }, // 10% æŽ‰çº¢è¯
        { id: 'potion_blue', rate: 0.05, min: 1, max: 1,  name: 'é­”åŠ›è¯æ°´' }, // 5% æŽ‰è“è¯
        // æƒ³åŠ æ–°ç‰©å“ç›´æŽ¥åœ¨ä¸‹é¢åŠ ä¸€è¡Œï¼š
        { id: 'return_scroll', rate: 0.05, min: 1, max: 1, name: 'å›žå®¶å·è½´' },
        { id: 'potion_revive', rate: 0.05, min: 1, max: 1,  name: 'å¤æ´»è¯æ°´' }, // 5% æŽ‰è“è¯
        { id: 'potion_purify', rate: 0.05, min: 1, max: 1,  name: 'å‡€åŒ–è¯æ°´' } // 5% æŽ‰è“è¯
    ],
    
    // BOSS æŽ‰è½åˆ—è¡¨
    boss: [
        { id: 'currency',    rate: 1.0,  min: 50, max: 100, name: '' },      // 100% æŽ‰ 100-150 é‡‘å¸
        { id: 'dye',         rate: 0.8,  min: 1,   max: 1,   name: 'æŸ“æ–™' },  // 80% æŽ‰æŸ“æ–™
        { id: 'blueprint',   rate: 0.3,  min: 1,   max: 1,   name: 'å›¾çº¸' },  // 30% æŽ‰å›¾çº¸
        { id: 'potion_revive', rate: 0.5, min: 1, max: 2, name: 'å¤æ´»è¯æ°´' }  // 50% æŽ‰å¤æ´»è¯
    ]
};   


// === å®¶å…·æ•°æ®åº“ ===
const RPG_FURNITURE = {
    'bed': { name: 'èˆ’é€‚çš„åºŠ', cost: 100, icon: 'ðŸ›ï¸', mapChar: 'b', color: '#8e44ad', x: 15, y: 4, map: 'indoor' },
    'plant': { name: 'ç»¿æ¤ç›†æ ½', cost: 50, icon: 'ðŸª´', mapChar: 'p', color: '#27ae60', x: 2, y: 2, map: 'indoor' },
    'table': { name: 'æ©¡æœ¨æ¡Œå­', cost: 100, icon: 'ðŸª‘', mapChar: 't', color: '#d35400', x: 10, y: 5, map: 'indoor' },
    'tree': { name: 'åº­é™¢å¤§æ ‘', cost: 50, icon: 'ðŸŒ³', mapChar: 'T', color: '#2ecc71', x: 18, y: 3, map: 'home' } // å®¤å¤–
};

// çŠ¶æ€æ•ˆæžœå®šä¹‰
const RPG_STATUS = {
    POISON: 'poison', // ä¸­æ¯’
    STUN: 'stun'      // çœ©æ™•
};

// === å¼‚å¸¸çŠ¶æ€é…ç½®è¡¨ (åœ¨è¿™é‡Œè‡ªå®šä¹‰BUFF/DEBUFF) ===
// === å¼‚å¸¸çŠ¶æ€é…ç½®è¡¨ (å®Œå…¨æ•°æ®é©±åŠ¨ç‰ˆ) ===
const RPG_STATUS_CONFIG = {
    'poison': { 
        name: 'ä¸­æ¯’', 
        icon: 'â˜ ï¸', 
        overlay: 'rgba(46, 204, 113, 0.4)', 
        // ã€æ–°å¢žã€‘æ–½åŠ è§„åˆ™ï¼š10%æ¦‚çŽ‡è§¦å‘ï¼ŒæŒç»­3å›žåˆ
        apply: { rate: 0.10, duration: 3, msg: "ä¸­æ¯’äº†ï¼" },
        effect: { 
            damage_pct: 0.10, 
            shake: true, 
            can_move: true 
        }
    },
    'stun': { 
        name: 'çœ©æ™•', 
        icon: 'ðŸ’«', 
        overlay: null, 
        // ã€æ–°å¢žã€‘æ–½åŠ è§„åˆ™ï¼š5%æ¦‚çŽ‡è§¦å‘ï¼ŒæŒç»­1å›žåˆ
        apply: { rate: 0.05, duration: 1, msg: "æ™•å€’äº†ï¼" },
        effect: { 
            can_move: false 
        }
    }

};

    // å®Œæ•´ç´ æåº“
    const ASSETS = {
        // === æ­£é¢ Front ===
        BANGS_46_FRONT: { y: 7, data: [
            "...............................D................................",
            "..............................D.................................",
            "................................................................",
            "................................................................",
            "................................................................",
            "...................................D............................",
            ".......................D............D...........................",
            "......................D......HH......D........H.................",
            "...............LHHHHHDHHHHDHHDHHHHHHHDHHHHHHHHHD................",
            "..............LHHHHHHDHHHHHDDHHHHHHHHHDHHHHHDHHHD...............",
            "..............LHHHHHDHHHHHHHHHLHHHHHHHDHHHHHHDHHHL..............",
            "..............LHHHHHDHHHHHLHHLDLHHHHHHDHHHHHHDHHHL..............",
            "..............LHHHHHDHHHHLDLHLDDLHHHHHHHHHHHHHHHHL..............",
            "..............LHHHHHHHHHHLDDLDDDLHHHHHLHHHHHHDHHHL..............",
            "..............LHHHHHDHHHHL......LHHHHHLHHHHHHDHHHL..............",
            "...............LHHHHDDHHHL......LHHHHL.LHHHHHDHHHL..............",
            "...............LHHHHDLHHHL......LHHHL..LHHHHHDHHL...............",
            "................LHHHDLLHHL......LHHL....LHHHLDHHL...............",
            "................LHHHDL.LHL......LHL.....LHHLDDHL................",
            ".................LHHDL..L........L......LHL.LDHL................",
            "..................LHHL..................LL..LDL.................",
            "...................LHL..................L...LL..................",
            "....................LL......................L...................",
            ".....................L.........................................."
        ]},
        BANGS_M_FRONT: { y: 8, data: [
            ".............................D..................................",
            "............................D...................................",
            "...........................D....................................",
            "...........................D....................................",
            "..........................D.....................................",
            "..........................D.....................................",
            ".........................D......................................",
            ".........................D......................................",
            "........................DD......................................",
            "..............LDHHHHHHHHDLHHHHHHHHHHHHHHHHHHHHHHDL..............",
            "..............LDHHHHHHHDL.LHHHHHHHLHHHHHHHHHHHHHDL..............",
            "..............LDHHHHHHHDL.LHHHHHHL.LDHHHHHHHDHHHDL..............",
            "..............LDHHHHHHDL..LHHHHHHL..LDHHHHHHHDHHHL..............",
            "..............LDHHHHHHDL..LDHHHHHL...LDHHHHHHDHHHL..............",
            "..............LDHHHHHHDL...LHHHHHL....LDHHHHHHDHHL..............",
            "..............LDHHHHHDL....LDHHHHL.....LDHHHHHDHHL..............",
            "..............LDHDHHHDL.....LDHDHHL....LDHHHHHDHHL..............",
            "..............LDHLDHHDL......LDLDHL.....LDHHHHLHHHL.............",
            ".............LDDL.LHDL........L.LDL.....LDHHHDLLHHHL............",
            "..............LL..LDDL...........LL......LDHDL..LLL.............",
            "...................LDL...................LDHL...................",
            "....................L....................LDL....................",
            "..........................................L....................."
        ]},
        BANGS_QI_FRONT: { y: 12, data: [
            ".........................D............D.........................",
            "........................D..............D........................",
            ".......................D................D.......................",
            ".......................D................D.......................",
            "...............LDHHHHHDHHHHHHHHHHHHHHHHHHDHHHHHHDL..............",
            "..............LDHHHHHHDHHHHHHHHHHHHHHHHHHDHHHHHHDL..............",
            "..............LDHHHHHDHHHHHHHHHHHHHHHHHHHHDHHHHHDL..............",
            "..............LDHHHHHDHHHHHHHHHHHHHHHHHHHHDHHHHHDL..............",
            "..............LDHHHHHDHHHHHHHHHHHHHHHHHHHHDHHHHHDL..............",
            "..............LDHHHHDLHHHHHHHHHHHHHHHHHHHHLDHHHHDL..............",
            "..............LDHHHHDLDHHHHHHHHHHHHHHHHHHHLDHHHHDL..............",
            "..............LDHHHHDLDHHHHHHHHHHHHHHHHHHDLDHHHHDL..............",
            "..............LDHHHHL.LLLLLLLLLLLLLLLLLLLL.LHHHHDL..............",
            "..............LDHHHHL......................LHHHHDL..............",
            "..............LDHHHHL......................LHHHHDL..............",
            "..............LDHHHHL......................LHHHHDL..............",
            "...............LDHHHL......................LHHHDL..............",
            "................LDDHL......................LHDDL................",
            ".................LLDDL....................LDDLL.................",
            "...................LL......................LL..................."
        ]},
        BODY_FRONT: { y: 5, data: [
            "..........................LLLLL.LLLLLL..........................",
            ".......................LLLDDDDDLDDDDDDLLL.......................",
            ".....................LLDDDHHHHHHHHHHHHDDDLL.....................",
            "....................LDDHHHHHHHHHHHHHHHHHHDDL....................",
            "...................LDHHHHHHHHHHHHHHHHHHHHHHDL...................",
            "..................LDHHHHHHHHHHHHHHHHHHHHHHHHDL..................",
            ".................LDHHHHHHHHHHHHHHHHHHHHHHHHHHDL.................",
            "................LDHHHHHHHHHHHHHHHHHHHHHHHHHHHHDL................",
            "................LDHHHHHHHHHHHHHHHHHHHHHHHHHHHHDL................",
            "...............LDHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHDL...............",
            "...............LDHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHDL...............",
            "...............LDHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHDL..............",
            "...............DSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSS................",
            "................SSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSS................",
            "................SSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSS................",
            "................SSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSS................",
            "................SSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSS................",
            "................SSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSS................",
            "................SSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSS................",
            "................SSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSS................",
            "................SSSSSSSOOOOOOSSSSSSOOOOOOSSSSSSS................",
            ".................MMMSSOSGEEWGSSSSSSGEEWGSOSSMMM.................",
            "................MSSSSSSSGEEEGSSSSSSGEEEGSSSSSSSM................",
            "................MSYSYSSSWAEAWSSSSSSWAEAWSSSYSYSM................",
            "................MSSYSSSSWAAAWSSSSSSWAAAWSSSSYSSM................",
            ".................MSSYSSFFFSSSSSSSSSSSSFFFSSYSSM.................",
            "..................MYYYSSSSSSSSSSSSSSSSSSSSYYYM..................",
            "...................MMMMYSSSSSSSSSSSSSSSSYMMMM...................",
            ".......................MMMSSSSSSSSSSSSMMM.......................",
            "..........................MMMYYYYYYMMM..........................",
            "...........................NZMMYYMMZN...........................",
            "..........................NCCCNYYNCCCN..........................",
            "..........................ZNCCCNNCCCNZ..........................",
            "..........................CZNNNCCNNNZC..........................",
            "..........................NCCCNCNZCCZN..........................",
            "..........................NCCCNCCCCCCN..........................",
            ".........................ZNCCCNCNCCCCNZ.........................",
            ".........................NCCCCNCCCCCCZN.........................",
            "........................ZNCCCCNCNCCCCZNZ........................",
            "........................ZNCCCCNCCCCCCZNZ........................",
            ".........................NZCCZNNZZCCCZN.........................",
            "..........................NZZN..NNZZZN..........................",
            "...........................NN.....NNN..........................."
        ]},
        ARM_NORMAL: { y: 37, data: [
            ".........................NC..........CN.........................",
            "........................NCC..........CCN........................",
            "........................NC............CN........................",
            ".......................NCC............CCN.......................",
            ".......................NCC............CCN.......................",
            ".......................NC..............CN.......................",
            "......................NCC..............CCN......................",
            "......................NCC..............CCN......................",
            "......................NCC..............CCN......................",
            "......................YNN..............NNY......................",
            "......................YSS..............SSY......................",
            ".......................YY..............YY......................."
        ]},
        ARM_WAVE: { y: 37, data: [
            ".........................N...........CN.........................",
            "........................NC...........CCN........................",
            ".......................NCC............CCN.......................",
            "......................NCCC............CCCN......................",
            "......................NCCC............CCCN......................",
            ".....................NCCC..............CCCN.....................",
            ".....................NCCC..............CCCN.....................",
            ".....................YNCC..............CCNY.....................",
            "....................YSSNN..............NNSSY....................",
            "....................YSSSSY............YSSSSY....................",
            ".....................YSSY..............YSSY.....................",
            "......................YY................YY......................"
        ]},
        LEGS_SKIRT_FRONT: { y: 46, data: [
            ".........................ITKKKKKKKKKKKI.........................",
            "........................IKTTTTTTTTTTTKKI........................",
            ".......................IKTTTTTTTTTTTTTKKI.......................",
            ".......................IKTTTTTTTTTTTTTKKI.......................",
            "......................IKTTTTTTTTTTTTTTTKKI......................",
            "......................IKTTTTTTTTTTTTTTTKKI......................",
            ".......................IIKKKKKKKKKKKKKKII.......................",
            ".........................IIIIIIIIIIIIII.........................",
            "..........................YYYY....YYYY..........................",
            "..........................SSSS....SSSS..........................",
            "..........................SSSS....SSSS..........................",
            ".........................JSSSSJ..JSSSSJ.........................",
            ".........................JBBBBJ..JBBBBJ.........................",
            ".........................JBBBBJ..JBBBBJ.........................",
            "..........................JJJJ....JJJJ.........................."
        ]},
        LEGS_PANTS_FRONT: { y: 46, data: [
            ".........................ITTTTKKTTTTTTI.........................",
            ".........................ITTTTTTTTTTTKI.........................",
            ".........................ITTTTTTTTTTTKI.........................",
            ".........................ITTTKIIIITTTKI.........................",
            ".........................ITTTKI..ITTTKI.........................",
            ".........................ITTTKI..ITTTKI.........................",
            ".........................ITTTKI..ITTTKI.........................",
            ".........................ITTTKI..ITTTKI.........................",
            ".........................ITTTKI..ITTTKI.........................",
            ".........................ITTTKI..ITTTKI.........................",
            ".........................JIIIIJ..JIIIIJ.........................",
            ".........................JBBBBJ..JBBBBJ.........................",
            ".........................JBBBBJ..JBBBBJ.........................",
            "..........................JJJJ....JJJJ.........................."
        ]},
        BACKHAIR_MID_FRONT: { y: 33, data: [
            "....................LDD................DDDDL....................",
            "....................LDDDDD............DDDDDL....................",
            "...................LDDYLDDL..........LDDLDDDL...................",
            "....................LLL.LL............LL.LLL...................."
        ]},
        BACKHAIR_LONG_FRONT: { y: 18, data: [
            "...............DDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDD..............",
            "..............DDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDD..............",
            "..............DDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDD..............",
            "..............DDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDD..............",
            "..............LDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDL..............",
            "..............LDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDL..............",
            "..............LHDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDHL..............",
            "..............LHDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDHL..............",
            "..............LHDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDHL..............",
            "..............LHDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDHL..............",
            "..............LHDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDHL..............",
            "..............LHDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDHHL..............",
            "..............LHHDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDHHL..............",
            "..............LHHDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDHHL..............",
            "..............LHHDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDHHL..............",
            "..............LHHDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDHHL..............",
            ".............LHHHDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDHHHL.............",
            ".............LHHHDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDHHHL.............",
            ".............LHHHDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDHHHL.............",
            ".............LHHHDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDHHHL.............",
            ".............LHHHDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDHHHL.............",
            ".............LHHHDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDHHHL.............",
            "............LHHHHHDDDDDDDDDDDDDDDDDDDDDDDDDDDDHHHHHL............",
            "............LHHHHHDDDDDDDDDDDDDDDDDDDDDDDDDDDDHHHHHL............",
            ".............LHHHHHDDDDDDDDDDDDDDDDDDDDDDDDDDHHHHHL.............",
            "..............LHHHHDDDDDDDDDDDDDDDDDDDDDDDDDDHHHHL..............",
            "...............LHHHHDDDDDDDDDDDDDDDDDDDDDDDDHHHHL...............",
            "................LLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLL................"
        ]},

        // === èƒŒé¢ Back ===
        BODY_BACK: { y: 5, data: [
            "..........................LLLLLHLLLLLL..........................",
            ".......................LLLDDDDDLDDDDDDLLL.......................",
            ".....................LLDDDHHHHHHHHHHHHDDDLL.....................",
            "....................LDDHHHHHHHHHHHHHHHHHHDDL....................",
            "...................LDHHHHHHHHHHHHHHHHHHHHHHDL...................",
            "..................LDHHHHHHHHHHHHHHHHHHHHHHHHDL..................",
            ".................LDHHHHHHHHHHHHHHHHHHHHHHHHHHDL.................",
            "................LDHHHHHHHHHHHHHHHHHHHHHHHHHHHHDL................",
            "................LDHHHHHHHHHHHHHHHHHHHHHHHHHHHHDL................",
            "...............LDHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHDL...............",
            "...............LDHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHDL...............",
            "...............LDHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHDDL..............",
            "..............LDDDHHHHHHHHHHHHHHHHHHHHHHHHHHHHDDDL..............",
            "..............LDDDDHHHHHHHHHHHHHHHHHHHHHHHHHHDDDDL..............",
            "..............LDDDDDHHHHHHHHHHHHHHHHHHHHHHHHDDDDDL..............",
            "..............LDDDDDDDHHHHHHHHHHHHHHHHHHHHDDDDDDDL..............",
            "..............LDDDDDDDDDDHHHHHHHHHHHHHHDDDDDDDDDDL..............",
            "..............LDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDL..............",
            "...............LDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDL...............",
            "...............LDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDL...............",
            "...............LDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDL...............",
            "................LDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDL................",
            "................MLDDDDDDDDDDDDDDDDDDDDDDDDDDDDLM................",
            "................MSLDDDDDDDDDDDDDDDDDDDDDDDDDDLSM................",
            "................MSSLDDDDDDDDDDDDDDDDDDDDDDDDLSSM................",
            ".................MSSLDDDDDDDDDDDDDDDDDDDDDDLSSM.................",
            "..................MYYLDDDDDDDDDDDDDDDDDDDDLYYM..................",
            "...................MMMLDDDDDDDDDDDDDDDDDDLMMM...................",
            ".......................LLLDDDDDDDDDDDDLLL.......................",
            "..........................LLLDDDDDDLLL..........................",
            "...........................NZLLLLLLZN...........................",
            "..........................NCCZZZZZZCCN..........................",
            "..........................NCCCCCCCCCCN..........................",
            "..........................NCCCCCCCCCCN..........................",
            "..........................NCCCCCCCCCCN..........................",
            "..........................NCCCCCCCCCCN..........................",
            "..........................NCCCCCCCCCCN..........................",
            ".........................NCCCCCCCCCCCCN.........................",
            ".........................NCCCCCCCCCCCCN.........................",
            ".........................NCCCCCCCCCCCCN.........................",
            ".........................NCCCCCCCCCCCCN.........................",
            "..........................NCCCCCCCCCCN..........................",
            "...........................NNNNNNNNNN..........................."
        ]},
        BANGS_46_BACK: { y: 16, data: [
            "..............LD................................................",
            "..............L.................................................",
            "..............L.................................................",
            "..............L.................................................",
            "..............L.................................................",
            "..............L.................................................",
            "................................................................",
            "...............L.......................L........................"
        ]},
        BANGS_M_BACK: { y: 17, data: [
            "...............D.................................L..............",
            "...............D.................................L..............",
            "..............L..................................L..............",
            "..............L..................................L..............",
            "..............L..................................L..............",
            "..............L..................................L..............",
            "..............LD................................DL..............",
            "..............LD................................DL..............",
            "..............LD................................DDL.............",
            ".............LDDL..............................LDDDL............",
            "..............LL................................LLL.............",
            ".....................L.........................................."
        ]},
        BANGS_QI_BACK: { y: 16, data: [
            "...............L.................................L..............",
            "..............L..................................L..............",
            "..............L..................................L..............",
            "..............L..................................L..............",
            "..............L..................................L..............",
            "..............L..................................L..............",
            "..............L.................................DL..............",
            "..............LDD...............................DL..............",
            "..............LDD...............................DL..............",
            "..............LDD..............................DDL..............",
            "..............LDD.............................DDDL..............",
            "..............LDDD...........................DDDDL..............",
            "...............LDDD.........................DDDDL...............",
            "................LDDD.......................DDDDL................",
            ".................LLDD......................DDLL.................",
            "...................LL......................LL..................."
        ]},
        BACKHAIR_MID_BACK: { y: 32, data: [
            ".....................LDD................DDL.....................",
            "....................LDDDDD............DDDDDL....................",
            "....................LDDDDDDDDDDDDDDDDDDDDDDL....................",
            "...................LDDDLDDDDDDDDDDDDDDDDLDDDL...................",
            "....................LLL.LDDLLLLLLLLLLDDL.LLL....................",
            ".........................LL..........LL........................."
        ]},
        BACKHAIR_LONG_BACK: { y: 22, data: [
            "..............L..................................L..............",
            "..............LDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDL..............",
            "..............LDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDL..............",
            "..............LDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDL..............",
            "..............LDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDL..............",
            "..............LDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDL..............",
            "..............LDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDL..............",
            "..............LDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDL..............",
            "..............LDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDL..............",
            "..............LDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDL..............",
            "..............LDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDL..............",
            "..............LDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDL..............",
            ".............LDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDL.............",
            ".............LDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDL.............",
            ".............LDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDL.............",
            ".............LDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDL.............",
            ".............LDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDL.............",
            ".............LDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDL.............",
            "............LDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDL.............",
            "............LDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDL.............",
            ".............LDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDL.............",
            "..............LDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDL..............",
            "...............LDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDL...............",
            "................LLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLL................"
        ]},

        // === ä¾§é¢ Side ===
        BODY_SIDE: { y: 6, data: [
            "...........................LLLLLLLLLL...........................",
            ".........................LLDDHHHHHHHYLL.........................",
            ".......................LLYHHHHHHHHHHHHDLL.......................",
            "......................LDHHHHHHHHHHHHHHHHDL......................",
            ".....................LDHHHHHHHHHHHHHHHHHHDL.....................",
            "....................LDHHHHHHHHHHHHHHHHHHHHDL....................",
            "...................LDHHHHHHHHHHHHHHHHHHHHHHDL...................",
            "..................LDHHHHHHHHHHHHHHHHHHHHHHHHDL..................",
            "..................LHHHHHHHHHHHHHHHHHHHHHHHHHDL..................",
            ".................LDHHHHHHHHHHHHHHHHHHHHHHHHHHDL.................",
            ".................LHHHHHHHHHHHHHHHHHHHHHHHHHHHDL.................",
            ".................LHHHHHHHHHHHHHHHHHHHHHHHHHHHDL.................",
            ".................LHHHHHHHHHHHHHHHHHHHHHHHHHHHDL.................",
            "....................SSSSSSSSSSSSSSSSSSHHHHHHHDDL................",
            "....................SSSSSSSSSSSSSSSSSSHHHHHHDDDL................",
            "....................SSSSSSSSSSSSSSSSSSHHHHHDDDDL................",
            "....................SSSSSSSSSSSSSSSSSSHHHHDDDDDL................",
            "....................SSSSSSSSSSSSSSSSSSHHDDDDDDDL................",
            "....................MSSSSSSSSSSSSSSSSSDDDDDDDDDL................",
            "....................MSOOOOSSSSSSSSSSSSDDDDDDDDDL................",
            ".....................MSWEGOSSSSSSSSMMMDDDDDDDDL.................",
            ".....................MSEEGSSSSSSSSMSSSMDDDDDDDL.................",
            ".....................MSEAWSSSSSSSSMYYSMDDDDDDYL.................",
            "....................MSSAAWSSSSSSSSYYYSMDDDDDDL..................",
            "....................MSSSFFFSSSSSSSYYSSMDDDDDL...................",
            "....................MSSSSSSSSSSSSSSSSMDDDDDL....................",
            ".....................MSSSSSSSSSSYMMMMDDDDLL.....................",
            "......................MSSSSSSSYYMDDDDDLLL.......................",
            ".......................MMMMMMMYYCDLLLL..........................",
            "...........................NNYCCCNN.............................",
            "..........................NCCCCNNCN.............................",
            "..........................NNCNNCCCCN............................",
            "..........................NCNCCCCCCN............................",
            "..........................NCCCCCCCCN............................",
            "..........................NCCCCCCCCN............................",
            "..........................NCCCCCCCCN............................",
            "..........................NCCCCCCCCN............................",
            "..........................NCCCCCCCCN............................",
            ".........................NCCCCCCCCCCN...........................",
            ".........................NZCCCCCCCCCN...........................",
            "..........................NNNN....NN............................"
        ]},
        BANGS_46_SIDE: { y: 10, data: [
            ".........................Y......................................",
            "........................Y.......................................",
            "................................................................",
            "...................Y....YYY.......Y.............................",
            "...................YYD.Y...Y.......Y............................",
            "...................Y..Y............Y............................",
            "..................D.................Y...........................",
            "................LYDHH.Y.LH...Y......L...........................",
            "................LDHHHLYLYLHHHHY..H.HHL..........................",
            "................LDHHHLYLYLHHHHDHHHHHHL..........................",
            "................LDHHLYLYYLHHHHHYHHHHHHLH........................",
            "................LYHHL....LHHHHHYHHHHHHLH........................",
            "................LYHHL....DLHHHHYHHHHHHLH........................",
            ".................LHHL.....LHHHHYHHYHHHHL........................",
            "..................LHHL.....LHHHYHHYHHHHL...L....................",
            "...................LHL.....LHHHLYHHYHHHHL.......................",
            "....................LL......LHHLLYHYHHHHHL......................",
            ".............................LHLHLHHLHHHHHL.....................",
            "..............................L...LL.LHHHL......................",
            "......................................LLL......................."
        ]},
        BANGS_M_SIDE: { y: 16, data: [
            "..................................D.............................",
            "................LD................D.............................",
            "................LD.................D............................",
            "...............LDHHHHDHHHHHHDHHHHHHDHH..........................",
            "...............LDHHHHDDHHHHHHHHHHHHHDH......H...................",
            "...............LDHHHHDLHHHHHDHHHHHHHDH.....HH...................",
            "...............LDHHHHL.LHHHHDHHHHHHHDDH..DHHHH..................",
            "................LHHHHL..LHHHDHHHHHHHDDD.H.DHHH.L................",
            "................LHHHHL...LHHDHHHHHHLDD..H.DDHHHL................",
            ".................LHHHL....LHLHHHHHHLDD.....LHHH.L...............",
            "..................LHHL.....LHHHHHHHL........LHHHHL..............",
            "...................LHL......LHHHHHL..........LLLL...............",
            "....................L.......LHHHLL..............................",
            "............................LHLL................................",
            ".............................L.................................."
        ]},
        BANGS_QI_SIDE: { y: 17, data: [
            "................LD..............................................",
            "................LH..............................................",
            "................LHHHHHHHHHHHHHHDHHHHHHHD........................",
            "................LHHHHHHHHHHHHHHDHHHHHHHDD.......................",
            "................LHHHHHHHHHHHHHHLHHHHHHHLD.......................",
            "................LDHHHHHHHHHHHHDLDHHHHHHLD.......................",
            "................LDDDDDDDDDDDDDDLDHHHHHHLD.......................",
            ".................LLLLLLLLLLLLLL.LHHHHHDLD.......................",
            "................................LHHHHHDLD.......................",
            "................................LHHHHDLDD.......................",
            "................................LHHHDDLDD.......................",
            "................................LHHDDL.D........................",
            "................................LHDDL..D........................",
            "...............................LDDLL...D........................",
            "................................LL.....D........................"
        ]},
        BACKHAIR_LONG_SIDE: { y: 19, data: [
            "........................................H..HHH..................",
            "........................................H..HHH..................",
            "........................................H..HHH..................",
            "........................................H.HHHH.L................",
            "........................................HHHHHH.L................",
            ".......................................HHHHHHH.L................",
            ".......................................HHHHHHH.L................",
            ".......................................HHHHHHHDL................",
            ".......................................HHHHHHHDL................",
            ".......................................HHHHHHHDL................",
            ".......................................HHHHHHHDL................",
            ".......................................HHHHHHHHL................",
            ".......................................HHHHHHHHL................",
            ".......................................HHHHHHHHL................",
            ".................................D...DDHHHHHHHHL................",
            "..................................DDDDDHHHHHHHHDL...............",
            "..................................DDDDDHHHHHHHHDL...............",
            "...................................DDDDDHHHHHHHDL...............",
            "....................................DDDDHHHHHHHHL...............",
            "....................................DDDDHHHHHHHHL...............",
            "....................................DDDDHHHHHHHHL...............",
            "....................................DDDDHHHHHHHHDL..............",
            "....................................DDDDHHHHHHHHDL...............",
            "....................................DDDDHHHHHHHHL...............",
            "....................................DDDHHHHHHHHL................",
            ".....................................DHHHHHHHHL.................",
            ".....................................LLLLLLLLL.................."
        ]},
        BACKHAIR_MID_SIDE: { y: 30, data: [
            "............................................L...................",
            "...........................................L....................",
            ".........................................DDL....................",
            "......................................DDDDDL....................",
            "..................................DDDDDDDDDL....................",
            "..................................DDDDDDDLDDL...................",
            "...................................DDLLDDDLL....................",
            "....................................LL.LLL......................"
        ]},
        ARM_SIDE: { y: 37, data: [
            "..................................N.............................",
            "..............................N...N.............................",
            "..............................NCCCN.............................",
            "..............................NCCCN.............................",
            "..............................NCCCN.............................",
            "..............................NCCCN.............................",
            "..............................NCCCN.............................",
            "..............................NCCCN.............................",
            "..............................NCCCN.............................",
            "..............................MNNNM.............................",
            "..............................MSSSM.............................",
            "...............................MMM.............................."
        ]},
        LEGS_SKIRT_SIDE: { y: 46, data: [
            "...........................KKKKKKKKI............................",
            ".........................ITTTTTTTTKKI...........................",
            "........................ITTTTTTTTTTKKI..........................",
            "........................ITTTTTTTTTTKKI..........................",
            ".......................ITTTTTTTTTTTTKKI.........................",
            ".......................ITTTTTTTTTTTTKKI.........................",
            "........................IIKKKKKKKKKKII..........................",
            "..........................IIIIIIIIII............................",
            "...........................MYYYYYM..............................",
            "...........................MSSSSSM..............................",
            "...........................MSSSSSM..............................",
            "..........................JBMMMMMJ..............................",
            "..........................JBBBBBBJ..............................",
            "..........................JBBBBBBJ..............................",
            "...........................JJJJJJ..............................."
        ]},
        LEGS_PANTS_SIDE: { y: 46, data: [
            "...........................ITTTTTT..............................",
            "...........................ITTTTTKKI............................",
            "...........................ITTTTTKI.............................",
            "...........................ITTTTTKI.............................",
            "...........................ITTTTKI..............................",
            "...........................ITTTTKI..............................",
            "...........................ITTTTKI..............................",
            "...........................ITTTTKI..............................",
            "...........................ITTTTKI..............................",
            "...........................ITTTTKI..............................",
            "..........................JBIIIIIJ..............................",
            "..........................JBBBBBBJ..............................",
            "..........................JBBBBBBJ..............................",
            "...........................JJJJJJ..............................."
        ]}
    };


// === é€šç”¨çš„ç»˜åˆ¶é€»è¾‘ï¼Œç”¨äºŽ P1 å’Œ P2 ===
    const drawCroppedPreview = (canvas, settings) => {
        if (!canvas) return;
        const ctx = canvas.getContext('2d');
        ctx.imageSmoothingEnabled = false;

        // 1. ç”ŸæˆåŽŸå§‹ 256x256 SpriteSheet
        const sheet = generateCharaSprite(settings);

        // 2. è®¾ç½® Canvas å†…éƒ¨åˆ†è¾¨çŽ‡ï¼ˆé•¿æ–¹å½¢ï¼Œé«˜åˆ†è¾¨çŽ‡ä»¥ä¿æŒæ¸…æ™°ï¼‰
        // è®¾ä¸º 64å®½ x 128é«˜ï¼Œè¿™æ ·æ˜¯ 1:2 çš„é•¿æ–¹å½¢
        canvas.width = 64;  
        canvas.height = 64; 

        // 3. è£å‰ªå¹¶ç»˜åˆ¶
        // æºå›¾(sheet): æˆªå–å·¦ä¸Šè§’äººç‰© (x=0, y=0)ï¼ŒåŽŸå§‹å¤§å°æ˜¯ 64x64
        // æˆ‘ä»¬æƒ³åªçœ‹ä¸­é—´éƒ¨åˆ†ï¼ˆåŽ»æŽ‰å·¦å³ç©ºç™½ï¼ŒåŽ»æŽ‰å¤´é¡¶è¿‡å¤šç•™ç™½ï¼‰
        // å‡è®¾äººç‰©ä¸»ä½“åœ¨ 64x64 çš„ä¸­å¿ƒåŒºåŸŸï¼šx:16, y:8, w:32, h:48
        
        // drawImage(img, sx, sy, sw, sh, dx, dy, dw, dh)
        // ç›®æ ‡ï¼šæ”¾å¤§æ˜¾ç¤ºåˆ° canvas.width, canvas.height
        
        // æ–¹æ¡ˆï¼šæˆªå–äººç‰©ä¸»ä½“ (x=12, y=4, w=40, h=56) å¹¶æ”¾å¤§é“ºæ»¡
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(
            sheet, 
            0, 0, 64, 64,      // æºæˆªå–ï¼šç¨å¾®ä¿®å‰ªå››å‘¨ç©ºç™½
            0, 0, 64, 64       // ç›®æ ‡ï¼šæ‹‰ä¼¸åˆ°æ•´ä¸ªé•¿æ–¹å½¢ç”»å¸ƒ (åƒç´ é£Žæ‹‰ä¼¸ä¸å½±å“è§‚æ„Ÿï¼Œæˆ–è€…ä½ å¯ä»¥æŒ‰æ¯”ä¾‹)
        );
        // æˆ–è€…ä¿æŒæ¯”ä¾‹å±…ä¸­æ”¾å¤§ï¼š
        // ctx.drawImage(sheet, 0, 0, 64, 64, -32, 20, 128, 128); // æ”¾å¤§2å€å¹¶å±…ä¸­
    };

// --- è¾…åŠ©å·¥å…·ï¼šé¢œè‰²å˜äº®/å˜æš— ---
// col: hexé¢œè‰², amt: æ•°å€¼ (æ­£æ•°å˜äº®ï¼Œè´Ÿæ•°å˜æš—)
function adjustColor(col, amt) {
    let usePound = false;
    if (col[0] == "#") {
        col = col.slice(1);
        usePound = true;
    }
    let num = parseInt(col, 16);
    let r = (num >> 16) + amt;
    if (r > 255) r = 255; else if (r < 0) r = 0;
    let b = ((num >> 8) & 0x00FF) + amt;
    if (b > 255) b = 255; else if (b < 0) b = 0;
    let g = (num & 0x0000FF) + amt;
    if (g > 255) g = 255; else if (g < 0) g = 0;
    return (usePound ? "#" : "") + (g | (b << 8) | (r << 16)).toString(16).padStart(6, '0');
}


// è§’è‰²åˆ›å»ºé¡µé€»è¾‘æ›´æ–°
function setupRpgCreateScreenLogic() {
    // 1. èŽ·å–æ‰€æœ‰è¾“å…¥æ¡† (ä¿æŒåŽŸæœ‰é€»è¾‘ä¸å˜)
    const getInputs = (prefix) => ({
        hair: document.getElementById(`${prefix}-color-hair`).value,
        eye: document.getElementById(`${prefix}-color-eye`).value,
        skin: document.getElementById(`${prefix}-color-skin`).value,
        top: document.getElementById(`${prefix}-color-top`).value,
        bottom: document.getElementById(`${prefix}-color-bottom`).value,
        shoe: document.getElementById(`${prefix}-color-shoe`).value,
        bangs: document.getElementById(`${prefix}-style-bangs`).value,
        back: document.getElementById(`${prefix}-style-back`).value,
        botStyle: document.getElementById(`${prefix}-style-bottom`).value
    });

    // ã€æ–°å¢žã€‘P1 å®žæ—¶é¢„è§ˆç›‘å¬
    document.querySelectorAll('.preview-trigger-p1').forEach(el => {
        el.addEventListener('input', () => updatePreview('p1'));
        el.addEventListener('change', () => updatePreview('p1'));
    });

    // ã€æ–°å¢žã€‘P2 å®žæ—¶é¢„è§ˆç›‘å¬
    document.querySelectorAll('.preview-trigger-p2').forEach(el => {
        el.addEventListener('input', () => updatePreview('p2'));
        el.addEventListener('change', () => updatePreview('p2'));
    });

    // 2. é¢„è§ˆæ›´æ–°å‡½æ•° (ä¿æŒä¸å˜)
   const updatePreview = (target) => {
        const canvasId = `${target}-preview-canvas`;
        const canvas = document.getElementById(canvasId);
        const settings = getInputs(target);
        drawCroppedPreview(canvas, settings);
    };

    // ============================================================
    // 1. è¯»å–ç”¨æˆ·äººè®¾ (ä»Ž db.myPersonaPresets è¯»å–)
    // ============================================================
    const loadUserBtn = document.getElementById('rpg-load-user-btn');
    const userPersonaModal = document.getElementById('rpg-user-persona-modal');
    const userPersonaList = document.getElementById('rpg-user-persona-list');
    const confirmUserBtn = document.getElementById('rpg-confirm-user-persona');

    if (loadUserBtn) {
        loadUserBtn.addEventListener('click', () => {
            const presets = db.myPersonaPresets || [];
            if (presets.length === 0) return showToast('æš‚æ— äººè®¾é¢„è®¾ï¼Œè¯·å…ˆåœ¨è®¾ç½®ä¸­æ·»åŠ ã€‚');
            
            userPersonaList.innerHTML = '';
            presets.forEach((preset, index) => {
                const item = document.createElement('div');
                item.style.cssText = "display:flex; align-items:center; padding:10px; border-bottom:1px solid #444;";
                const isChecked = index === 0 ? 'checked' : '';
                
                item.innerHTML = `
                    <input type="radio" name="rpg_user_select" value="${index}" id="rpg_u_${index}" style="margin-right:10px;" ${isChecked}>
                    <label for="rpg_u_${index}" style="display:flex; flex-direction:column; flex:1; cursor:pointer;">
                        <span style="font-weight:bold; color:#f1c40f;">${preset.name}</span>
                        <span style="font-size:12px; color:#aaa; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width:200px;">${preset.persona || 'æ— æè¿°'}</span>
                    </label>`;
                userPersonaList.appendChild(item);
            });
            userPersonaModal.classList.add('visible');
        });
    }

    if (confirmUserBtn) {
        confirmUserBtn.addEventListener('click', () => {
            const checked = userPersonaList.querySelector('input[name="rpg_user_select"]:checked');
            if (checked) {
                const preset = db.myPersonaPresets[parseInt(checked.value)];
                // å¡«å…¥åå­—
                document.getElementById('p1-name-input').value = preset.name;
                // å­˜å…¥éšè—åŸŸä¾›AIä½¿ç”¨
                document.getElementById('p1-persona-hidden').value = preset.persona; 
                showToast(`å·²è¯»å–è®¾å®šï¼š${preset.name}`);
            }
            userPersonaModal.classList.remove('visible');
        });
    }


    // ============================================================
    // 2. é€‰æ‹©å†’é™©ä¼™ä¼´ (ä»Ž db.characters è¯»å–)
    // ============================================================
    const choosePartnerBtn = document.getElementById('rpg-choose-partner-btn');
    const partnerModal = document.getElementById('rpg-partner-select-modal');
    const confirmPartnerBtn = document.getElementById('rpg-confirm-partner-select');
    const partnerListContainer = document.getElementById('rpg-partner-list');
    const startBtn = document.getElementById('rpg-start-adventure-btn');

    if (choosePartnerBtn) {
        choosePartnerBtn.addEventListener('click', () => {
            partnerListContainer.innerHTML = '';
            if (!db.characters || db.characters.length === 0) {
                partnerListContainer.innerHTML = '<p style="color:#aaa; text-align:center; padding:20px;">æ²¡æœ‰å¯ç”¨çš„è§’è‰²ã€‚</p>';
            } else {
                db.characters.forEach(char => {
                    const item = document.createElement('div');
                    item.className = 'list-item-row'; // ä½¿ç”¨æå–çš„CSSç±»
                    item.innerHTML = `
                    <input type="radio" name="rpg_partner_select" value="${char.id}" id="rpg_p_${char.id}" style="margin-right:15px; transform:scale(1.2);">
                    <label for="rpg_p_${char.id}" style="display:flex; align-items:center; flex:1; cursor:pointer;">
                        <img src="${char.avatar}" class="list-item-avatar">
                        <span style="font-weight:500;">${char.realName}</span>
                    </label>`;
                    partnerListContainer.appendChild(item);
                });
            }
            partnerModal.classList.add('visible');
        });
    }

    if (confirmPartnerBtn) {
        // å…ˆç§»é™¤æ—§çš„ç›‘å¬å™¨ï¼ˆé˜²æ­¢å¤šæ¬¡ç»‘å®šï¼‰ï¼Œè™½ç„¶åœ¨ setupRpgGame é‡Œé€šå¸¸åªè°ƒä¸€æ¬¡ï¼Œä½†ä¿é™©èµ·è§
        const newBtn = confirmPartnerBtn.cloneNode(true);
        confirmPartnerBtn.parentNode.replaceChild(newBtn, confirmPartnerBtn);
        
        newBtn.addEventListener('click', () => {
            const checked = partnerListContainer.querySelector('input[name="rpg_partner_select"]:checked');
            if (checked) {
                selectedPartnerCharId = checked.value;
                const char = db.characters.find(c => c.id === selectedPartnerCharId);
                
                // æ˜¾ç¤º P2 è®¾ç½®åŒºåŸŸ
                const p2Card = document.getElementById('rpg-partner-card');
                if (p2Card) p2Card.style.display = 'block';
                const nameToUse = char.remarkName || char.realName;
                
                // æ˜¾ç¤º AI åˆå§‹åŒ–æŒ‰é’®
                const aiBtn = document.getElementById('rpg-ai-init-btn');
                if (aiBtn) aiBtn.style.display = 'inline-block';
                
                choosePartnerBtn.innerText = `å½“å‰ä¼™ä¼´: ${char.realName}`;
                document.getElementById('p2-name-input').value = nameToUse;
                
                // ã€å…³é”®ä¿®å¤ã€‘ç¦ç”¨å¼€å§‹æŒ‰é’®ï¼Œå¹¶ç½®ç°
                if (startBtn) {
                    startBtn.disabled = true; // è®¾ç½® disabled å±žæ€§
                    startBtn.innerText = "è¯·å…ˆè¿›è¡Œå†’é™©åˆå§‹åŒ–";
                }
                
                // é‡ç½®å¡«å……çŽ‡æ˜¾ç¤º
                const rateEl = document.getElementById('fill-rate-val');
                if(rateEl) {
                    rateEl.innerText = "0% (ç­‰å¾…åˆå§‹åŒ–)";
                    rateEl.style.color = "#aaa";
                }

                // ç«‹å³æ¸²æŸ“ä¸€æ¬¡é»˜è®¤çš„ P2 é¢„è§ˆ
                setTimeout(() => updatePreview('p2'), 50);
            } else {
                showToast("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè§’è‰²");
                return; // æ²¡é€‰ä¸å…³é—­
            }
            partnerModal.classList.remove('visible');
        });
    }


    // ============================================================
    // 3. AI å†’é™©åˆå§‹åŒ– (ç”Ÿæˆå°è¯å’Œé¢œè‰²)
    // ============================================================
     const aiInitBtn = document.getElementById('rpg-ai-init-btn');
    
    if (aiInitBtn) {
    aiInitBtn.addEventListener('click', async () => {
        if (!selectedPartnerCharId) return showToast("è¯·å…ˆé€‰æ‹©ä¼™ä¼´");
        const { url, key, model } = db.apiSettings;
        if (!url || !key || !model) return showToast('è¯·å…ˆé…ç½®API');

        const char = db.characters.find(c => c.id === selectedPartnerCharId);
        const userPersona = document.getElementById('p1-persona-hidden').value || "æ™®é€šå†’é™©è€…";
        const userName = document.getElementById('p1-name-input').value;

        aiInitBtn.disabled = true;
        aiInitBtn.innerText = "åˆå§‹åŒ–ä¸­...";

        const prompt = `ä½ æ˜¯ä¸€ä¸ªRPGæ¸¸æˆæ–‡æ¡ˆç­–åˆ’ã€‚è¯·æ ¹æ®ä»¥ä¸‹ä¸¤äººçš„äººè®¾ï¼Œä¸ºè§’è‰²ã€${char.realName}ã€‘ç”Ÿæˆåœ¨åƒç´ RPGä¸­çš„å…¨å¥—å°è¯å’Œå½¢è±¡é…è‰²ã€‚
ã€è§’è‰²A(ä¼™ä¼´)ã€‘ï¼š${char.realName}ï¼Œäººè®¾ï¼š${char.persona}
ã€è§’è‰²B(çŽ©å®¶)ã€‘ï¼š${userName}ï¼Œäººè®¾ï¼š${userPersona}
å…³ç³»ï¼šä¸¤äººæ˜¯å…±åŒå†’é™©çš„æ­æ¡£ï¼Œè§’è‰²Açš„å°è¯éœ€è¦ä½“çŽ°å¯¹è§’è‰²Bçš„ç‰¹å®šæ€åº¦ã€‚

ã€è¾“å‡ºè¦æ±‚ã€‘ï¼š
1. ä¸¥ç¦è¿”å›žJSONã€‚è¯·ä¸¥æ ¼ä½¿ç”¨ä¸‹æ–¹ã€æ ¼å¼æ¨¡æ¿ã€‘ï¼Œæ¯ä¸ªæ ‡ç­¾å ä¸€è¡Œã€‚
2. æˆ˜æ–—ç±»å’Œå‰§æƒ…ç±»å°è¯ï¼Œæ¯ç§è¯·ç”Ÿæˆã€3å¥ã€‘ä¸åŒçš„å˜ä½“ï¼Œç”¨ç«–çº¿ "|" åˆ†éš”ã€‚
3. å°è¯è¦ç®€çŸ­ï¼ˆ15å­—ä»¥å†…ï¼‰ï¼Œç¬¦åˆRPGé£Žæ ¼ã€‚

ã€å½¢è±¡é…è‰²å‚æ•°è¾“å‡ºè¦æ±‚ã€‘ï¼š
è¯·æä¾›ä»¥ä¸‹9ä¸ªæ ‡ç­¾ï¼Œé¢œè‰²è¯·ä½¿ç”¨Hexä»£ç ï¼Œæ ·å¼è¯·è¾“å‡ºæ•°å­—ä»£ç ã€‚
#C_HAIR# å¤´å‘é¢œè‰² (Hex)
#C_EYE# çœ¼ç›é¢œè‰² (Hex)
#C_SKIN# çš®è‚¤é¢œè‰² (Hexï¼ŒæŽ¨è #FFE4CF æˆ– #FAD7BB)
#C_TOP# ä¸Šè¡£é¢œè‰² (Hex)
#C_BOT# ä¸‹è£…é¢œè‰² (Hex)
#C_SHOE# éž‹å­é¢œè‰² (Hex)
#S_BANG# åˆ˜æµ·æ ·å¼ä»£ç  (0=åˆ†å‘, 1=Må­—, 2=é½åˆ˜æµ·) - è¯·æ ¹æ®äººè®¾é€‰æ‹©æœ€åˆé€‚çš„
#S_BACK# åŽå‘æ ·å¼ä»£ç  (0=çŸ­å‘, 1=ä¸­å‘, 2=é•¿å‘)
#S_BTYP# ä¸‹è£…ç±»åž‹ä»£ç  (0=è£¤å­, 1=è£™å­) - è¯·æ ¹æ®ä½ æŽ¨æ–­çš„äººç‰©æ€§åˆ«é€‰æ‹©æœ€åˆé€‚çš„

ã€å°è¯è¾“å‡ºè¦æ±‚ã€‘ï¼š
#INTRO# å¼€åœºç™½ (1å¥)
#MAP1# è¿·é›¾æ£®æž—çš„é—²èŠ (3-5å¥ï¼Œç”¨|åˆ†éš”)
#MAP2# é—å¿˜åºŸå¢Ÿçš„é—²èŠ (3-5å¥ï¼Œç”¨|åˆ†éš”)
#MAP3# é­”çŽ‹åŸŽçš„é—²èŠ (3-5å¥ï¼Œç”¨|åˆ†éš”)
#MAP_RETURN# å›žåˆ°å·²æŽ¢ç´¢åœ°å›¾æ—¶çš„åæ§½ (3å¥ï¼Œç”¨|åˆ†éš”)
#ATK# å‘èµ·æ”»å‡»æ—¶çš„å–Šè¯ (3å¥ï¼Œç”¨|åˆ†éš”ï¼Œä¾‹å¦‚ï¼šçœ‹æ‹›ï¼|æŽ¥å¥½äº†ï¼|å“ˆï¼)
#HURT# è¢«æ”»å‡»å—ä¼¤æ—¶çš„ååº” (3å¥ï¼Œç”¨|åˆ†éš”ï¼Œä¾‹å¦‚ï¼šå¥½ç—›ï¼|å¤§æ„äº†...|ä½ ç­‰ç€ï¼)
#HEAL# æ²»ç–—æ—¶çš„å°è¯ (3å¥ï¼Œç”¨|åˆ†éš”ï¼Œä¾‹å¦‚ï¼šåˆ«ä¹±åŠ¨ã€‚|æ²»ç–—æœ¯ï¼|æ„Ÿè§‰å¥½ç‚¹æ²¡ï¼Ÿ)
#HEALED# è¢«çŽ©å®¶æ²»ç–—æ—¶çš„æ„Ÿè°¢ (3å¥ï¼Œç”¨|åˆ†éš”ï¼Œä¾‹å¦‚ï¼šè°¢äº†ã€‚|å¤æ´»äº†ï¼|ä½ è¿˜æŒºåœ¨è¡Œçš„ã€‚)
#LVUP# å‡çº§æ—¶çš„å–œæ‚¦ (3å¥ï¼Œç”¨|åˆ†éš”)
#DEAD# æˆ˜æ–—å¤±è´¥/æ­»äº¡æ—¶çš„é—è¨€ (3å¥ï¼Œç”¨|åˆ†éš”)
#ENDING# é€šå…³åŽçš„æ„Ÿè¨€ (5å¥ä»¥ä¸Šï¼Œç”¨|åˆ†éš”ï¼Œä¾‹å¦‚ï¼šç»ˆäºŽç»“æŸäº†...|æˆ‘ä»¬æ˜¯å† å†›ï¼|è¯¥å›žå®¶äº†ã€‚|è°¢è°¢ä½ ä¸€ç›´é™ªç€æˆ‘ã€‚|å†è§ï¼Œæœ‹å‹ã€‚)`;

        try {
            const response = await fetch(`${url}/v1/chat/completions`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${key}` },
                body: JSON.stringify({
                    model: model,
                    messages: [{ role: "user", content: prompt }],
                    temperature: 0.8
                })
            });
            
            const data = await response.json();
            const content = data.choices[0].message.content;

            const parseTag = (tag) => {
                const regex = new RegExp(`${tag}\\s*(.*)`);
                const match = content.match(regex);
                return match ? match[1].trim() : null;
            };
            const splitLines = (text) => text ? text.split('|').map(t => t.trim()).filter(t => t) : [];

            tempRpgConfig = {
                p2Name: char.realName,
                styleData: {
                    hair: parseTag('#C_HAIR#') || '#e74c3c',
                    eye: parseTag('#C_EYE#') || '#2c3e50',
                    skin: parseTag('#C_SKIN#') || '#FFE4CF',
                    top: parseTag('#C_TOP#') || '#2ecc71',
                    bottom: parseTag('#C_BOT#') || '#2c3e50',
                    shoe: parseTag('#C_SHOE#') || '#101018',
                    bangs: parseTag('#S_BANG#') || '0',
                    back: parseTag('#S_BACK#') || '0',
                    botStyle: parseTag('#S_BTYP#') || '0'
                },
                headColor: parseTag('#C_HAIR#') || '#e74c3c',
                bodyColor: parseTag('#C_TOP#') || '#2ecc71',
                intro: parseTag('#INTRO#') || "æˆ‘ä»¬å‡ºå‘å§ï¼",
                dialogues: {
                    map1: splitLines(parseTag('#MAP1#')),
                    map2: splitLines(parseTag('#MAP2#')),
                    map3: splitLines(parseTag('#MAP3#')),
                    return: splitLines(parseTag('#MAP_RETURN#')),
                    atk: splitLines(parseTag('#ATK#')),
                    hurt: splitLines(parseTag('#HURT#')),
                    heal: splitLines(parseTag('#HEAL#')),
                    healed: splitLines(parseTag('#HEALED#')),
                    lvup: splitLines(parseTag('#LVUP#')),
                    dead: splitLines(parseTag('#DEAD#')),
                    ending: splitLines(parseTag('#ENDING#'))
                }
            };

            const setVal = (id, val) => { const el = document.getElementById(id); if(el) el.value = val; };
            
            setVal('p2-color-hair', tempRpgConfig.styleData.hair);
            setVal('p2-color-eye', tempRpgConfig.styleData.eye);
            setVal('p2-color-skin', tempRpgConfig.styleData.skin);
            setVal('p2-color-top', tempRpgConfig.styleData.top);
            setVal('p2-color-bottom', tempRpgConfig.styleData.bottom);
            setVal('p2-color-shoe', tempRpgConfig.styleData.shoe);
            setVal('p2-style-bangs', tempRpgConfig.styleData.bangs);
            setVal('p2-style-back', tempRpgConfig.styleData.back);
            setVal('p2-style-bottom', tempRpgConfig.styleData.botStyle);

            // ã€å…³é”®ä¿®å¤ã€‘æ˜¾ç¤ºä¼™ä¼´è®¾ç½®åŒºåŸŸå’Œé¢„è§ˆ
            const settingsContainer = document.getElementById('rpg-partner-settings-container');
            const waitMsg = document.getElementById('rpg-partner-wait-msg');
            if (settingsContainer) settingsContainer.style.display = 'block';
            if (waitMsg) waitMsg.style.display = 'none';

            // è§¦å‘é¢„è§ˆæ›´æ–°
            updatePreview('p2');

            const keys = ['map1','map2','map3','return','atk','hurt','heal','healed','lvup','dead','ending'];
            let filledCount = 0;
            keys.forEach(k => { 
                if(tempRpgConfig.dialogues[k] && tempRpgConfig.dialogues[k].length > 0) filledCount++; 
            });
            const rate = Math.floor((filledCount / keys.length) * 100);
            
            const rateEl = document.getElementById('fill-rate-val');
            if(rateEl) {
                rateEl.innerText = `${rate}%`;
                rateEl.style.color = rate >= 80 ? '#2ecc71' : '#e74c3c';
            }

            const startBtn = document.getElementById('rpg-start-adventure-btn');
            if (rate > 50) {
                startBtn.disabled = false;
                startBtn.innerText = "å¼€å§‹å†’é™©";
                showToast("åˆå§‹åŒ–æˆåŠŸï¼");
            } else {
                startBtn.innerText = "åˆå§‹åŒ–å¡«å……çŽ‡è¿‡ä½Ž";
                showToast("ç”Ÿæˆç¼ºå¤±è¾ƒå¤šï¼Œè¯·é‡è¯•");
            }

        } catch (e) {
            console.error(e);
            showToast("ç”Ÿæˆå¤±è´¥ï¼Œè¯·æ£€æŸ¥APIè®¾ç½®");
        } finally {
            aiInitBtn.disabled = false;
            aiInitBtn.innerText = "âœ¨ å†’é™©åˆå§‹åŒ–";
        }
    });
}
}


// --- çŸ©é˜µç»˜å›¾å·¥å…· ---
// ctx: ç”»å¸ƒä¸Šä¸‹æ–‡
// matrix: å­—ç¬¦æ•°ç»„ï¼Œä¾‹å¦‚ ["001100", "011110"]
// palette: é¢œè‰²æ˜ å°„å¯¹è±¡ï¼Œä¾‹å¦‚ { '0': null, '1': hairColor, '2': skinColor }
// startX, startY: èµ·å§‹åæ ‡
function drawFromMatrix(ctx, matrix, palette, startX, startY) {
    for (let y = 0; y < matrix.length; y++) {
        const row = matrix[y];
        for (let x = 0; x < row.length; x++) {
            const char = row[x];
            const color = palette[char];
            if (color) { // å¦‚æžœé¢œè‰²ä¸ä¸º null/false æ‰ç»˜åˆ¶
                ctx.fillStyle = color;
                ctx.fillRect(startX + x, startY + y, 1, 1);
            }
        }
    }
}


/* ã€âœªå¼€å§‹ã€‘JS: æ€ªç‰©ç”Ÿæˆä¸Žè§’è‰²ç”Ÿæˆå™¨æ›´æ–° */

// 1. æ€ªç‰©ç”Ÿæˆå™¨ (48x48) - 3ç§å›ºå®šæ ·å¼
function generateMonsterSprite(type) {
    const size = 48;
    const canvas = document.createElement('canvas');
    canvas.width = size; canvas.height = size;
    const ctx = canvas.getContext('2d');
    ctx.imageSmoothingEnabled = false;

    // ç®€å•ç»˜åˆ¶é€»è¾‘ï¼Œå®žé™…å¯ä»¥æ˜¯æ›´å¤æ‚çš„çŸ©é˜µ
    const drawPixel = (x, y, color) => { ctx.fillStyle = color; ctx.fillRect(x, y, 4, 4); }; // æ”¾å¤§åƒç´ ç‚¹

    if (type === 0) { // å²èŽ±å§† (Slime)
        ctx.fillStyle = "#e74c3c"; // çº¢è‰²
        ctx.beginPath();
        ctx.arc(24, 30, 16, Math.PI, 0); // åŠåœ†é¡¶
        ctx.lineTo(40, 44); ctx.lineTo(8, 44);
        ctx.fill();
        // çœ¼ç›
        ctx.fillStyle = "#fff"; ctx.fillRect(16, 26, 4, 8); ctx.fillRect(28, 26, 4, 8);
        ctx.fillStyle = "#000"; ctx.fillRect(18, 28, 2, 4); ctx.fillRect(30, 28, 2, 4);
    } else if (type === 1) { // è™è  (Bat)
        ctx.fillStyle = "#8e44ad"; // ç´«è‰²
        ctx.beginPath();
        ctx.arc(24, 24, 10, 0, Math.PI*2); ctx.fill(); // èº«ä½“
        // ç¿…è†€
        ctx.beginPath(); ctx.moveTo(14, 24); ctx.lineTo(2, 10); ctx.lineTo(14, 18); ctx.fill();
        ctx.beginPath(); ctx.moveTo(34, 24); ctx.lineTo(46, 10); ctx.lineTo(34, 18); ctx.fill();
        // çœ¼ç›
        ctx.fillStyle = "#f1c40f"; ctx.fillRect(20, 22, 2, 2); ctx.fillRect(26, 22, 2, 2);
    } else if (type === 2) { // å¹½çµ/BOSS (Ghost)
        ctx.fillStyle = "#bdc3c7"; // ç™½è‰²
        ctx.beginPath();
        ctx.arc(24, 20, 14, Math.PI, 0); // å¤´éƒ¨
        ctx.lineTo(38, 44); ctx.lineTo(32, 38); ctx.lineTo(24, 44); ctx.lineTo(16, 38); ctx.lineTo(10, 44);
        ctx.lineTo(10, 20); 
        ctx.fill();
        // çœ¼ç›
        ctx.fillStyle = "#2c3e50"; ctx.fillRect(18, 18, 4, 4); ctx.fillRect(26, 18, 4, 4);
    }
    return canvas;
}

// 2. è§’è‰²ç”Ÿæˆå™¨æ›´æ–° (æ”¯æŒæ‰€æœ‰9ä¸ªå‚æ•°)
function generateCharaSprite(settings) {
    // å…¼å®¹æ—§è°ƒç”¨ï¼šå¦‚æžœåªä¼ äº†é¢œè‰²ï¼Œæˆ–è€…ç»“æž„ä¸å¯¹ï¼Œè¿›è¡Œè½¬æ¢
    // é»˜è®¤å€¼å¤„ç†
    const S = {
        hair: settings.hair || '#917C66',
        eye: settings.eye || '#D7CAFF',
        skin: settings.skin || '#FFE4CF',
        top: settings.top || '#3498db',     // ä¸Šè¡£é¢œè‰² (åŽŸ bodyColor)
        bottom: settings.bottom || '#2c3e50', // ä¸‹è£…é¢œè‰²
        shoe: settings.shoe || '#101018',   // éž‹å­é¢œè‰²
        bangs: settings.bangs !== undefined ? parseInt(settings.bangs) : 0, // 0:æ–œåˆ˜æµ·, 1:ä¸­åˆ†, 2:é½åˆ˜æµ·
        back: settings.back !== undefined ? parseInt(settings.back) : 0,    // 0:æ— , 1:ä¸­å‘, 2:é•¿å‘
        botStyle: settings.botStyle !== undefined ? parseInt(settings.botStyle) : 0 // 0:è£¤å­, 1:è£™å­
    };

    const SIZE = 64; 
    const canvas = document.createElement('canvas');
    canvas.width = SIZE * 4;  
    canvas.height = SIZE * 4; 
    const ctx = canvas.getContext('2d');
    ctx.imageSmoothingEnabled = false;

    // è¾…åŠ©å‡½æ•°ï¼šè°ƒæ•´é¢œè‰²äº®åº¦
    const adjust = (c, a) => typeof adjustColor === 'function' ? adjustColor(c, a) : c; 

    // æž„å»ºè‰²è¡¨ Mapping
    // è¿™é‡Œçš„é”®åå¯¹åº” ASSETS çŸ©é˜µä¸­çš„å­—ç¬¦
    const P = {
        '.': null, 
        // å¤´éƒ¨
        'H': S.hair, 
        'D': adjust(S.hair, -30), 
        'L': adjust(S.hair, -100),
        'S': S.skin, 
        'M': adjust(S.skin, -80), 
        'Y': adjust(S.skin, -40),
        'E': adjust(S.eye, -60), // çž³å­”
        'A': S.eye, // é¢œè‰²ä¸»è‰²ï¼Œè™¹è†œ (å¤ç”¨çœ¼ç›è‰²ç³»)
        'W': "#ffffff", // çœ¼ç™½å’Œé«˜å…‰
        'O': "#4a3c31", // ç«æ¯›        
        'G': "#cccccc", // çœ¼çƒé˜´å½±
        'F': "#ffb0a0", // çº¢æ™•
        
        // èº«ä½“ (ä¸Šè¡£)
        'C': S.top, 
        'Z': adjust(S.top, -30), 
        'N': adjust(S.top, -110),
        
        // ä¸‹è£…
        'T': S.bottom, 
        'K': adjust(S.bottom, -30), 
        'I': adjust(S.bottom, -80),
        
        // éž‹å­ (åŽŸçŸ©é˜µç”¨ J å’Œ Bï¼Œæ˜ å°„åˆ° shoe)
        'B': S.shoe, 
        'J': adjust(S.shoe, -40)
        
        
    };



    // ç»˜åˆ¶çŸ©é˜µå‡½æ•° (ox, oy ä¸ºç›¸å¯¹ç”»å¸ƒçš„åç§»é‡)
    const drawMatrix = (matrixObj, ox, oy, flipX) => {
        if (!matrixObj || !matrixObj.data) return;
        const matrix = matrixObj.data;
        const startY = matrixObj.y + oy; // åº”ç”¨èµ„æºæœ¬èº«çš„ y åç§»
        
        for (let y = 0; y < matrix.length; y++) {
            const rowStr = matrix[y];
            for (let x = 0; x < rowStr.length; x++) {
                const char = rowStr[x];
                // å¦‚æžœæ˜¯é€æ˜Žå­—ç¬¦åˆ™è·³è¿‡
                if (P[char]) {
                    // ç¿»è½¬å¤„ç†ï¼šxåæ ‡ä»Žå³è¾¹å¼€å§‹ç®—
                    const drawX = flipX ? (SIZE - 1 - x) : x;
                    ctx.fillStyle = P[char];
                    ctx.fillRect(ox + drawX, startY + y, 1, 1);
                }
            }
        }
    };

    // ç»˜å›¾å¾ªçŽ¯ (4æ–¹å‘ x 4å¸§)
    for (let dir = 0; dir < 4; dir++) {
        for (let frame = 0; frame < 4; frame++) {
            const isWalk = (frame === 1 || frame === 3);
            const bob = isWalk ? 2 : 0; 
            const ox = frame * SIZE;
            const oy = dir * SIZE;
            const isSkirt = (S.botStyle === 1);

            // æ­£é¢
            if (dir === 0) { 
                // 1. åŽå‘
                if (S.back === 1) drawMatrix(ASSETS.BACKHAIR_MID_FRONT, ox, oy + bob, false);
                if (S.back === 2) drawMatrix(ASSETS.BACKHAIR_LONG_FRONT, ox, oy + bob, false);
                
                // 2. ä¸‹è£…
                if (isSkirt) drawMatrix(ASSETS.LEGS_SKIRT_FRONT, ox, oy + bob, false);
                else drawMatrix(ASSETS.LEGS_PANTS_FRONT, ox, oy + bob, false);

                // 3. èº«ä½“
                drawMatrix(ASSETS.BODY_FRONT, ox, oy + bob, false);

                // 4. åˆ˜æµ·
                if (S.bangs === 0) drawMatrix(ASSETS.BANGS_46_FRONT, ox, oy + bob, false);
                else if (S.bangs === 1) drawMatrix(ASSETS.BANGS_M_FRONT, ox, oy + bob, false);
                else if (S.bangs === 2) drawMatrix(ASSETS.BANGS_QI_FRONT, ox, oy + bob, false);

                // 5. æ‰‹è‡‚
                if (isWalk) drawMatrix(ASSETS.ARM_WAVE, ox, oy + bob, false);
                else drawMatrix(ASSETS.ARM_NORMAL, ox, oy + bob, false);
            }
            // ä¾§é¢
            else if (dir === 1 || dir === 2) {
                const flip = (dir === 2); // å³ä¾§éœ€è¦é•œåƒ
                
                // 1. ä¸‹è£…
                if (isSkirt) drawMatrix(ASSETS.LEGS_SKIRT_SIDE, ox, oy + bob, flip);
                else drawMatrix(ASSETS.LEGS_PANTS_SIDE, ox, oy + bob, flip);

                // 2. èº«ä½“
                drawMatrix(ASSETS.BODY_SIDE, ox, oy + bob, flip);

                // 3. åˆ˜æµ·
                if (S.bangs === 0) drawMatrix(ASSETS.BANGS_46_SIDE, ox, oy + bob, flip);
                else if (S.bangs === 1) drawMatrix(ASSETS.BANGS_M_SIDE, ox, oy + bob, flip);
                else if (S.bangs === 2) drawMatrix(ASSETS.BANGS_QI_SIDE, ox, oy + bob, flip);
                
                // 4. åŽå‘
                if (S.back === 1) drawMatrix(ASSETS.BACKHAIR_MID_SIDE, ox, oy + bob, flip);
                if (S.back === 2) drawMatrix(ASSETS.BACKHAIR_LONG_SIDE, ox, oy + bob, flip);
                
                // 5. æ‰‹è‡‚ (å¸¦å‰åŽæ‘†åŠ¨åç§»)
                let armOffsetX = isWalk ? (frame === 1 ? 3 : -3) : 0;
                drawMatrix(ASSETS.ARM_SIDE, ox + armOffsetX, oy + bob, flip);
            }
            // èƒŒé¢
            else if (dir === 3) {
                // 1. èº«ä½“
                drawMatrix(ASSETS.BODY_BACK, ox, oy + bob, false);
                
                // 2. ä¸‹è£…
                if (isSkirt) drawMatrix(ASSETS.LEGS_SKIRT_FRONT, ox, oy + bob, false);
                else drawMatrix(ASSETS.LEGS_PANTS_FRONT, ox, oy + bob, false);
                
                // 3. åˆ˜æµ·
                if (S.bangs === 0) drawMatrix(ASSETS.BANGS_46_BACK, ox, oy + bob, false);
                else if (S.bangs === 1) drawMatrix(ASSETS.BANGS_M_BACK, ox, oy + bob, false);
                else if (S.bangs === 2) drawMatrix(ASSETS.BANGS_QI_BACK, ox, oy + bob, false);
                
                // 4. æ‰‹è‡‚
                if (isWalk) drawMatrix(ASSETS.ARM_WAVE, ox, oy + bob, false);
                else drawMatrix(ASSETS.ARM_NORMAL, ox, oy + bob, false);
                
                // 5. åŽå‘
                if (S.back === 1) drawMatrix(ASSETS.BACKHAIR_MID_BACK, ox, oy + bob, false);
                if (S.back === 2) drawMatrix(ASSETS.BACKHAIR_LONG_BACK, ox, oy + bob, false);
            }
        }
    }
    return canvas;
}


// --- å®žä½“ç±»å®šä¹‰ ---
// 1. ä¿®æ­£ RpgEntity æž„é€ å‡½æ•°
class RpgEntity {
    constructor(name, styleData, type) {
        this.name = name;
        this.type = type;
        this.status = {}; // { poison: 2, stun: 1 } key: turn_count
        this.pendingRecovery = [];
        
        // ã€å…³é”®ã€‘ç¡®ä¿ styleData è¢«ä¿å­˜ä¸ºå®žä¾‹å±žæ€§
        this.styleData = (typeof styleData === 'object' && styleData !== null) ? styleData : {};

        this.x = 0; this.y = 0;
        this.lv = 1; this.maxHp = 100; this.hp = 100;
        this.maxMp = 50; this.mp = 50; this.atk = 20;
        this.xp = 0; this.nextXp = 100; this.shake = 0;
        this.direction = 0; this.step = 0;

        // ç”Ÿæˆ Sprite
        if (type === 'player' || type === 'partner') {
            this.sprite = generateCharaSprite(this.styleData);
            // å…¼å®¹æ—§é€»è¾‘çš„é¢œè‰²å±žæ€§
            this.headColor = this.styleData.hair || '#f1c40f';
            this.bodyColor = this.styleData.top || '#3498db';
        } else if (type === 'enemy' || type === 'boss') {
            const mType = this.styleData.monsterType !== undefined ? this.styleData.monsterType : 0;
            this.sprite = generateMonsterSprite(mType);
            this.bodyColor = '#e74c3c'; 
        }
    }

    levelUp() {
        this.lv++; this.maxHp += 20; this.hp = this.maxHp; 
        this.maxMp += 10; this.mp = this.maxMp; 
        this.atk += 5; this.nextXp = Math.floor(this.nextXp * 1.5);
    }
}

// --- ç•Œé¢äº¤äº’å‡½æ•° ---

async function rpgStartNewGame() {
    // 1. èŽ·å– P1 (ä¸»è§’) å®Œæ•´æ•°æ®
    // ä½¿ç”¨æ–°çš„ HTML ID èŽ·å–é¢œè‰²å’Œæ ·å¼
    const p1Name = document.getElementById('p1-name-input').value || "å‹‡è€…";
    const p1Persona = document.getElementById('p1-persona-hidden').value || "å‹‡æ•¢çš„å†’é™©è€…";
    
    const p1StyleData = {
        hair: document.getElementById('p1-color-hair').value,
        eye: document.getElementById('p1-color-eye').value,
        skin: document.getElementById('p1-color-skin').value,
        top: document.getElementById('p1-color-top').value,
        bottom: document.getElementById('p1-color-bottom').value,
        shoe: document.getElementById('p1-color-shoe').value,
        bangs: document.getElementById('p1-style-bangs').value,
        back: document.getElementById('p1-style-back').value,
        botStyle: document.getElementById('p1-style-bottom').value
    };

    // 2. èŽ·å– P2 (ä¼™ä¼´) æ•°æ®
    const p2CardVisible = document.getElementById('rpg-partner-card').style.display !== 'none';
    let p2Config = null;
    let p2RealName = "";
    let p2Persona = "";
    
    if (p2CardVisible) {
        // å°è¯•ä»Žé€‰ä¸­çš„ ID èŽ·å–åŽŸå§‹äººè®¾
        if (typeof selectedPartnerCharId !== 'undefined' && selectedPartnerCharId) {
            const char = db.characters.find(c => c.id === selectedPartnerCharId);
            if (char) {
                p2RealName = char.realName;
                p2Persona = char.persona;
            }
        }

        // å¦‚æžœæœ‰ AI ç”Ÿæˆçš„é…ç½®ï¼Œä¼˜å…ˆä½¿ç”¨
        if (typeof tempRpgConfig !== 'undefined' && tempRpgConfig) {
            p2Config = tempRpgConfig;
        } else {
            p2Config = {
                p2Name: document.getElementById('p2-name-input').value,
                intro: "å‡†å¤‡å¥½äº†å—ï¼Ÿ",
                dialogues: {}
            };
        }
        
        // å¼ºåˆ¶ä½¿ç”¨ UI å½“å‰çš„è®¾ç½®è¦†ç›– (ä»¥é˜²ç”¨æˆ·æ‰‹åŠ¨ä¿®æ”¹äº† AI ç”Ÿæˆçš„ç»“æžœ)
        p2Config.styleData = {
            hair: document.getElementById('p2-color-hair').value,
            eye: document.getElementById('p2-color-eye').value,
            skin: document.getElementById('p2-color-skin').value,
            top: document.getElementById('p2-color-top').value,
            bottom: document.getElementById('p2-color-bottom').value,
            shoe: document.getElementById('p2-color-shoe').value,
            bangs: document.getElementById('p2-style-bangs').value,
            back: document.getElementById('p2-style-back').value,
            botStyle: document.getElementById('p2-style-bottom').value
        };
        // å…¼å®¹æ—§é€»è¾‘çš„é¢œè‰²å­—æ®µ
        p2Config.headColor = p2Config.styleData.hair; 
        p2Config.bodyColor = p2Config.styleData.top;

    } else {
        // è·¯äººé…ç½®
        p2Config = {
            p2Name: "è·¯äºº",
            styleData: { hair: '#555', top: '#333' } // ç®€ç•¥é…ç½®
        };
    }

p2Config.realName = p2RealName || p2Config.p2Name; // å¦‚æžœæ²¡çœŸåå°±ç”¨æ˜µç§°
    p2Config.persona = p2Persona || "å¿ è¯šçš„ä¼™ä¼´";     // å…œåº•äººè®¾

    const newProfileId = Date.now().toString(); // ç”Ÿæˆå”¯ä¸€ID
    const newProfile = {
        id: newProfileId,
        name: `${p1Name} ä¸Ž ${p2Config.p2Name} çš„å†’é™©`,
        p1Name: p1Name,
        p2Name: p2Config.p2Name,
        timestamp: Date.now(),
        saves: [null, null, null] // è¿™ä¸€å±‚é‡Œæ‰æ˜¯åŽŸæ¥çš„3ä¸ªå­˜æ¡£æ§½
    };
    
    // å­˜å…¥æ•°æ®åº“
    if (!db.rpgProfiles) db.rpgProfiles = [];
    db.rpgProfiles.push(newProfile);
    currentProfileId = newProfileId; // é”å®šå½“å‰æ¡£æ¡ˆ
    await saveData(); // ç«‹å³ä¿å­˜ï¼Œé˜²æ­¢åˆ·æ–°ä¸¢å¤±
    // ===================================


    switchScreen('rpg-game-screen');
    
    requestAnimationFrame(() => {
        requestAnimationFrame(() => {
            if (window.rpgGameInstance) {
                // ä¼ é€’æ‰“åŒ…å¥½çš„ styleData å¯¹è±¡
                window.rpgGameInstance.initNewGame(p1Name, p1StyleData, p2Config, p1Persona);
            }
        });
    });
}



function rpgBackToTitle() {
    window.rpgGameInstance.stop();
    setTimeout(() => {
        if(confirm("è¿”å›žæ ‡é¢˜ç”»é¢ï¼Ÿæœªä¿å­˜çš„è¿›åº¦å°†ä¸¢å¤±ã€‚")) {
            switchScreen('rpg-title-screen');
        } else {
            window.rpgGameInstance.resume(); // æ¢å¤æ¸¸æˆ
        }
    }, 50);
}

 

function rpgShowSaveScreen() {    
    window.rpgGameInstance.stop();
    switchScreen('rpg-load-screen');
    const titleEl = document.querySelector('#rpg-load-screen .title');
    if(titleEl) titleEl.innerText = "ä¿å­˜è¿›åº¦";
    setTimeout(renderSaveSlots, 50);
}

function rpgShowLoadScreen() {
    switchScreen('rpg-load-screen');
    const titleEl = document.querySelector('#rpg-load-screen .title');
    if(titleEl) titleEl.innerText = "è¯»å–è¿›åº¦";
    setTimeout(renderSaveSlots, 50);
}

// ã€ä¿®æ”¹ã€‘ç»Ÿä¸€è¿”å›žé€»è¾‘
function rpgHandleSaveBack() {
    if (rpgSaveContext === 'title') {
        // ä»Žæ ‡é¢˜/æ¡£æ¡ˆé¡µè¿›å…¥ -> è¿”å›žæ¡£æ¡ˆåˆ—è¡¨
        switchScreen('rpg-profile-screen');
        renderProfileList();
    } 
    else if (rpgSaveContext === 'pause_save' || rpgSaveContext === 'pause_load') {
        // ä»Žæš‚åœèœå•è¿›å…¥ -> è¿”å›žæ–°çš„æš‚åœé¡µé¢
        switchScreen('rpg-pause-screen'); 
        // ä¸éœ€è¦æ‰‹åŠ¨ flex æ˜¾ç¤ºäº†ï¼Œå› ä¸º switchScreen ä¼šå¤„ç† .active ç±»
    } 
    else {
        // æ¸¸æˆå†…ç›´æŽ¥è°ƒç”¨ç­‰ -> è¿”å›žæ¸¸æˆå¹¶ç»§ç»­
        switchScreen('rpg-game-screen');
        if (window.rpgGameInstance) window.rpgGameInstance.resume();
    }
}

// ã€æ–°å¢žã€‘æ¸²æŸ“æ¡£æ¡ˆåˆ—è¡¨
function renderProfileList() {
    const container = document.getElementById('rpg-profile-list-container');
    if (!container) return;
    container.innerHTML = '';

    if (!db.rpgProfiles || db.rpgProfiles.length === 0) {
        container.innerHTML = '<div class="text-center" style="color:#999; margin-top:50px;">æš‚æ— å†’é™©æ¡£æ¡ˆ</div>';
        return;
    }

    db.rpgProfiles.forEach((profile, index) => {
        const div = document.createElement('div');
        div.className = 'rpg-profile-card';
        
        // è®¡ç®—æ¸¸çŽ©æ—¶é—´æˆ–æœ€åŽå­˜æ¡£æ—¶é—´ï¼ˆè¿™é‡Œç®€å•ç”¨åˆ›å»ºæ—¶é—´å±•ç¤ºï¼‰
        const dateStr = new Date(profile.timestamp).toLocaleString();

        div.innerHTML = `
            <div onclick="selectProfile('${profile.id}')" style="cursor:pointer; padding-right:50px;">
                <div class="profile-title">${profile.name}</div>
                <div class="profile-info">
                    <div>ä¸»è§’: ${profile.p1Name} & ${profile.p2Name}</div>
                    <div>åˆ›å»ºäºŽ: ${dateStr}</div>
                </div>
            </div>
            <button class="profile-delete-btn" onclick="deleteProfile('${profile.id}', event)">åˆ é™¤</button>
        `;
        container.appendChild(div);
    });
}

// ã€æ–°å¢žã€‘é€‰æ‹©æ¡£æ¡ˆ
window.selectProfile = function(id) {
    currentProfileId = id; // é”å®šå½“å‰æ¡£æ¡ˆID
    rpgSaveContext = 'title';
    rpgShowLoadScreen();   // è¿›å…¥åŽŸæ¥çš„3ä¸ªæ§½ä½ç•Œé¢
};

// ã€æ–°å¢žã€‘åˆ é™¤æ¡£æ¡ˆï¼ˆåŒé‡ç¡®è®¤ï¼‰
window.deleteProfile = async function(id, e) {
    if (e) e.stopPropagation(); // é˜²æ­¢è§¦å‘è¿›å…¥
    
    // ç¬¬ä¸€æ¬¡ç¡®è®¤
    if (!confirm("ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå†’é™©æ¡£æ¡ˆå—ï¼Ÿ\nè¯¥æ¡£æ¡ˆä¸‹çš„æ‰€æœ‰å­˜æ¡£éƒ½å°†ä¸¢å¤±ï¼")) return;
    
    // ç¬¬äºŒæ¬¡ç¡®è®¤
    const profile = db.rpgProfiles.find(p => p.id === id);
    const input = prompt(`ã€é«˜å±æ“ä½œã€‘\nè¯·è¾“å…¥ "${profile.p1Name}" ä»¥ç¡®è®¤åˆ é™¤ï¼š`);
    
    if (input === profile.p1Name) {
        db.rpgProfiles = db.rpgProfiles.filter(p => p.id !== id);
        await saveData(); // ä¿å­˜æ›´æ”¹
        renderProfileList(); // åˆ·æ–°åˆ—è¡¨
        showToast("æ¡£æ¡ˆå·²å½»åº•åˆ é™¤");
    } else {
        showToast("è¾“å…¥é”™è¯¯ï¼Œåˆ é™¤å–æ¶ˆ");
    }
};



function renderSaveSlots() {
    const container = document.getElementById('rpg-save-list-container');
    if (!container) return;
    container.innerHTML = '';
    
    // 1. æ‰¾åˆ°å½“å‰æ¡£æ¡ˆ
    const profile = db.rpgProfiles.find(p => p.id === currentProfileId);
    if (!profile) {
        showToast("æ¡£æ¡ˆè¯»å–é”™è¯¯");
        switchScreen('rpg-profile-screen');
        return;
    }
    
    // 2. èŽ·å–è¯¥æ¡£æ¡ˆä¸‹çš„ saves
    const saves = profile.saves || [null, null, null];
    
    saves.forEach((save, index) => {
        const div = document.createElement('div');
        div.className = 'rpg-save-slot ' + (save ? '' : 'empty');
        
        if (save) {
            div.innerHTML = `
    <div class="save-index">${index + 1}</div>
    <div class="save-info-col">
        <div class="save-name-row">
            <span>${save.p1.name}</span>
            <span style="color:#aaa; font-weight:normal;">&</span>
            <span>${save.p2.name}</span>
        </div>
        <div class="save-stats-text">
            LV.${save.p1.lv} / LV.${save.p2.lv}
        </div>
        <div class="save-meta-row">
            <span>âž¤ ${save.mapName}</span>
            <span>æ—¥æœŸï¼š${new Date(save.timestamp).toLocaleDateString()}</span>
        </div>
    </div>
    <div class="save-avatars-row">
        <canvas id="save-cvs-${index}-p1" class="save-avatar-canvas avatar-p1" width="40" height="40"></canvas>
        <canvas id="save-cvs-${index}-p2" class="save-avatar-canvas avatar-p2" width="40" height="40"></canvas>
    </div>
            `;
            
            div.onclick = () => handleSlotClick(index);
            container.appendChild(div);

           setTimeout(() => {
    const drawHead = (char, cvsId) => {
        const cvs = document.getElementById(cvsId);
        if (!cvs) return;
        const ctx = cvs.getContext('2d');
        ctx.imageSmoothingEnabled = false;
        
        const styleData = char.styleData || {
            hair: char.headColor || '#f1c40f',
            eye: '#2c3e50',
            skin: '#FFE4CF',
            top: char.bodyColor || '#3498db',
            bottom: '#2c3e50',
            shoe: '#101018',
            bangs: 0,
            back: 0,
            botStyle: 0
        };
        
        const sheet = generateCharaSprite(styleData);
        
        ctx.clearRect(0, 0, 40, 40);
        // 1:1ç»˜åˆ¶ï¼Œåƒç´ å®Œç¾Ž
        ctx.drawImage(sheet, 12, 0, 40, 40, 0, 0, 40, 40);
    };
    
    drawHead(save.p1, `save-cvs-${index}-p1`);
    drawHead(save.p2, `save-cvs-${index}-p2`);
}, 0);

        } else {
            div.innerHTML = `
                <div class="save-index">${index + 1}</div>
                <div class="empty-slot-text">-- ç©ºå­˜æ¡£ --</div>
            `;
            div.onclick = () => handleSlotClick(index);
            container.appendChild(div);
        }
    });
}





// å­˜æ¡£å¤„ç†ï¼šä¿å­˜åŽç«‹å³åˆ·æ–°
// ã€ä¿®æ”¹ã€‘handleSlotClick
async function handleSlotClick(index) {
    // 1. æ‰¾åˆ°å½“å‰æ¡£æ¡ˆ
    const profile = db.rpgProfiles.find(p => p.id === currentProfileId);
    if (!profile) return;

    if (rpgSaveContext === 'game' || rpgSaveContext === 'pause_save') {
        // === å­˜æ¡£ ===
        if (confirm(`è¦†ç›–å­˜æ¡£ ${index + 1}?`)) {
            const data = window.rpgGameInstance.exportSaveData();
            
            // ã€å…³é”®ã€‘å†™å…¥åˆ°å½“å‰æ¡£æ¡ˆçš„ saves æ•°ç»„é‡Œ
            profile.saves[index] = JSON.parse(JSON.stringify(data)); 
            
            // æ›´æ–°æ¡£æ¡ˆçš„æœ€åŽæ¸¸çŽ©æ—¶é—´
            profile.timestamp = Date.now();
            
            await saveData(); // å…¨å±€ä¿å­˜
            showToast("æ¸¸æˆå·²ä¿å­˜");
            requestAnimationFrame(() => renderSaveSlots());
        }
    } else {
        // === è¯»æ¡£ ===
        // ã€å…³é”®ã€‘ä»Žå½“å‰æ¡£æ¡ˆçš„ saves é‡Œè¯»
        const save = profile.saves[index]; 
        
        if (!save) return;
        if (confirm(`è¯»å–å­˜æ¡£ ${index + 1}?`)) {
            switchScreen('rpg-game-screen');
           
            if (window.rpgGameInstance) {
                window.rpgGameInstance.isPaused = false;
            }
            requestAnimationFrame(() => {
                requestAnimationFrame(() => {
                    if (window.rpgGameInstance) window.rpgGameInstance.importSaveData(save);
                });
            });
        }
    }
}

// --- æ¸¸æˆæ ¸å¿ƒç±» ---

class RpgGame {

// ã€ä¿®æ”¹ç‰ˆã€‘getStaticLevelsï¼šåŒ…å«å®Œæ•´çš„æ–°æ‰‹å…³+ä¿®æ”¹åŽçš„å®¶å›­+æ–°å¢žå®¤å†…
getStaticLevels() {
    return [
        // 0. åºç«  (ä¿ç•™)
        {
            id: 'prologue', name: "åºç« ", type: 'prologue',
            story: [
                "å¾ˆä¹…å¾ˆä¹…ä»¥å‰ï¼Œè¿™ç‰‡å¤§é™†è¢«é»‘æš—ç¬¼ç½©...",
                "ä¼ è¯´ä¸­çš„å‹‡è€…ç»ˆäºŽè§‰é†’äº†ã€‚",
                "ä½†æ˜¯ï¼Œä¸€ä¸ªäººçš„åŠ›é‡å¤ªè¿‡æ¸ºå°ã€‚",
                "äºŽæ˜¯ï¼Œå‘½è¿è®©ä¸¤ä¸ªäººç›¸é‡äº†ã€‚"
            ]
        },
        // 1. è¿·é›¾æ£®æž— (ä¿ç•™)
        {
            id: 'lv1', name: "è¿·é›¾æ£®æž—", type: 'tutorial',
            intro: "å†’é™©çš„èµ·ç‚¹ã€‚", partnerText: "å‡†å¤‡å¥½äº†å—ï¼Ÿ", returnText: "æˆ‘ä»¬å¥½åƒæ¥è¿‡è¿™é‡Œã€‚",
            colors: { floor: "#27ae60", wall: "#1e824c" },
            enemyPool: { name: "å²èŽ±å§†", hp: 40, atk: 8, color: "#e74c3c", mp: 0, lv: 1 }, 
            map: ["#######################","#S....................#","#.....................#","#.#######.......#####.#","#.#..M..#.......#...#.#","#.#.....#...M...#...#.#","#...................#.#","#.......#.......#.....#","#.#######.......#####.#","#...M..............M..#","#.....................E","#######################"]
        },
        // 2. é—å¿˜åºŸå¢Ÿ (ä¿ç•™)
        {
            id: 'lv2', name: "é—å¿˜åºŸå¢Ÿ", type: 'tutorial',
            intro: "å¤è€çš„é—è¿¹ã€‚", partnerText: "è¿™é‡Œé˜´æ£®æ£®çš„ã€‚", returnText: "è¿™å †çŸ³å¤´æˆ‘çœ‹è…»äº†ã€‚",
            colors: { floor: "#95a5a6", wall: "#7f8c8d" },
            enemyPool: { name: "çŸ³åƒé¬¼", hp: 60, atk: 12, color: "#8e44ad", mp: 0, lv: 3 },
            map: ["#######################","#P........#...........#","#.........#...........#","#...M.....#.....M.....#","#####.#########.#######","#.........#...........#","#....M....#.....M.....#","#.........#...........#","#.###################.#","#.....................E","#######################"]
        },
        // 3. é­”çŽ‹åŸŽ (ä¿ç•™)
        {
            id: 'lv3', name: "é­”çŽ‹åŸŽ", type: 'tutorial',
            intro: "æœ€ç»ˆå†³æˆ˜ä¹‹åœ°ã€‚", partnerText: "å°±æ˜¯çŽ°åœ¨ï¼", returnText: "è¿˜æ²¡æ‰“è´¥é­”çŽ‹ï¼Œä¸èƒ½èµ°ã€‚",
            colors: { floor: "#34495e", wall: "#2c3e50" },
            enemyPool: { name: "é»‘éª‘å£«", hp: 100, atk: 20, color: "#555", mp: 0, lv: 5 },
            boss: { name: "é­”çŽ‹", hp: 800, atk: 50, color: "#c0392b", lv: 10 },
            map: ["###################",
            "#.................#",
            "#P................#",
            "#.M.............M.#",
            "#.................#",
            "#.......B.........#",
            "#.................#",
            "#.M.............M.#",
            "#.................#","###################"]
        },
        
       // 5. å®¤å†… (â˜…è¿™æ˜¯æ–°å¢žçš„)
        {
            id: 'indoor', name: "æˆ‘çš„å°å±‹", type: 'indoor',
            intro: "æ¸©æš–çš„å°å±‹ã€‚", partnerText: "è¿˜æ˜¯å®¶é‡Œèˆ’æœã€‚",
            colors: { floor: "#dcdde1", wall: "#7f8c8d" },
            // â˜… æ–°å¢žå±žæ€§ï¼šå‡ºé—¨çš„ä½ç½® (å‡è®¾åœ°å›¾ä¸ŠEæ˜¯å‡ºå£)
            map: [
                "############",
                "#..........#",
                "#..........#",
                "#..........#",
                "#..........#",
                "#..........#", // è¿™é‡Œå¯ä»¥æ”¾å®¶å…·
                "#....S.....#",
                "#....E.....#", // E æ˜¯å‡ºé—¨ç‚¹
                "############"
            ]
        }, 
        
        
        // 4. æ¸©é¦¨å®¶å›­ (â˜…ä¿®æ”¹äº†è¿™é‡Œ)
        {
            id: 'home', name: "æ¸©é¦¨å®¶å›­", type: 'home',
            intro: "è¿™é‡Œæ˜¯ä½ ä»¬çš„å®¶ã€‚", partnerText: "ç»ˆäºŽå¯ä»¥ä¼‘æ¯äº†ã€‚", returnText: "å›žå®¶çš„æ„Ÿè§‰çœŸå¥½ã€‚",
            colors: { floor: "#f39c12", wall: "#e67e22" },
            // â˜… æ–°å¢žå±žæ€§ï¼šç”¨äºŽåˆ†å±‚æ¸²æŸ“å’Œè¿›é—¨åˆ¤æ–­
            hasHouse: true,
            // æ ¹æ®ä½ çš„åœ°å›¾ 'H' æ‰€åœ¨çš„ä½ç½® (x:10-12, y:3-5)ï¼Œé—¨åº”è¯¥åœ¨ä¸­é—´åº•éƒ¨
            doorPos: { x: 11, y: 5 }, 
            // æˆ¿å­çš„é€»è¾‘èŒƒå›´ï¼Œç”¨äºŽç»˜åˆ¶å±‹é¡¶
            houseRect: { x: 10, y: 3, w: 3, h: 3 },
            map: [
                "#######################",
                "#.....................#",
                "#.....................#",
                "#.........HHH.........#",
                "#.........HHH.........#",
                "#.........HHH.........#",
                "#.....................#",
                "#..........S..........#",
                "#.....................#",
                "#..........G..........#",
                "#######################"
            ]
        }
        
    ];
}
    
    
    constructor() {
        this.canvas = document.getElementById('rpgGameCanvas');
        this.ctx = this.canvas.getContext('2d');
        this.bufferCanvas = document.createElement('canvas');
        this.bufferCanvas.width = 64;
        this.bufferCanvas.height = 64;
        this.bufferCtx = this.bufferCanvas.getContext('2d');
        this.bufferCtx.imageSmoothingEnabled = false;
        this.container = document.querySelector('.rpg-canvas-container'); 
        if (window.ResizeObserver && this.container) {
        this.resizeObserver = new ResizeObserver(() => {
            this.resize();
            this.draw(); // å¼ºåˆ¶é‡ç»˜ä¸€å¸§
        });
        this.resizeObserver.observe(this.container);
    }
        if (!this.container) this.container = document.querySelector('.rpg-canvas-container');
        this.isAutoBattle = false;
        this.STATE = { LOADING: 0, STORY: 1, MAP: 2, BATTLE_CMD: 3, BATTLE_TARGET: 4, BATTLE_ANIM: 5, GAME_OVER: 6 };
        
        this.LEVELS = this.getStaticLevels();

        this.p1 = new RpgEntity("å‹‡è€…", "#f1c40f", "#3498db", "player");
        this.p2 = new RpgEntity("ä¼™ä¼´", "#e67e22", "#2ecc71", "partner");
        
        this.visitedLevels = new Set();
        this.mapEnemies = []; 
        this.cam = { x: 0, y: 0 };
        this.state = this.STATE.LOADING;
        this.battleTeam = [this.p1, this.p2]; 
        this.battleEnemies = [];            
        this.isRunning = false;
        this.animationFrameId = null;
        this.bindEvents();
        this.isGameClear = false;
    this.isGoingHome = false; // ã€æ–°å¢žã€‘æ ‡è®°æ˜¯å¦æ­£åœ¨å›žå®¶å›­
    this.isPaused = false;
        
        // åˆå§‹èƒŒåŒ… (é€ä¸€ç‚¹æ–°æ‰‹è£…å¤‡)
        this.inventory = {
            'potion_red': 3,
            'potion_blue': 1,
            'return_scroll': 1
        };
        this.currency = 0; // å…‘æ¢ç‚¹æ•°
        
        // å®¶å›­çŠ¶æ€
        this.homeState = {
            furniture: [] // å­˜æ”¾å·²è´­ä¹°çš„å®¶å…·ID ['bed', 'table']
        };

       
    }

resetUI() {
    // 1. éšè—æˆ˜æ–—ç›¸å…³ UI
    const battleMenu = document.getElementById('rpg-battle-menu');
    if (battleMenu) battleMenu.style.display = 'none';
    
    const targetPanel = document.getElementById('rpg-battle-target-panel');
    if (targetPanel) targetPanel.style.display = 'none';

    // 2. éšè—å¯¹è¯æ¡†
    document.getElementById('rpg-bottom-dialog').style.display = 'none';
    document.getElementById('rpg-top-dialog').style.display = 'none';
    document.getElementById('rpg-game-over-screen').style.display = 'none';
    


    // 3. éšè—å…¶ä»–è¦†ç›–å±‚
    document.getElementById('rpg-controls').style.display = 'none'; 
    
    const autoBtn = document.getElementById('rpg-auto-battle-btn');
    if (autoBtn) autoBtn.style.display = 'none';
    
    // 4. é‡ç½®æš‚åœçŠ¶æ€
    // (æ³¨æ„ï¼šä¹‹å‰çš„ä¿®æ”¹ä¸­è¦æ±‚åˆ é™¤å¯¹ rpg-pause-menu çš„å¼•ç”¨)
    document.getElementById('rpg-common-modal').classList.remove('visible');
    this.isPaused = false; 

    // 5. æ¢å¤äº¤äº’æŒ‰é’®ä¸ºéšè—
    const interactBtn = document.getElementById('rpg-interact-btn');
    if(interactBtn) interactBtn.style.display = 'none';
    this.pendingInteraction = null;

    // 6. æ¢å¤é¡¶éƒ¨æŒ‰é’®
    const menuBtn = document.getElementById('rpg-menu-toggle-btn');
    if(menuBtn) menuBtn.style.display = 'flex'; 


    // 7. ã€æ–°å¢žã€‘é‡ç½®æ ‡é¢˜ä¸ºå½“å‰åœ°å›¾å
    const titleEl = document.getElementById('rpg-header-title');
    if (titleEl) {
        titleEl.innerText = this.curLv ? this.curLv.name : "åŠ è½½ä¸­...";
        titleEl.style.color = 'var(--text-color)';
    }
}

// ã€ä¿®å¤ç‰ˆã€‘initNewGame
initNewGame(p1Name, p1StyleData, p2Config, p1Persona) {
    this.stop();
    this.resetUI();
    this.inventory = { 'potion_red': 3, 'potion_blue': 1, 'return_scroll': 1 };
        this.currency = 0;
        this.homeState = { furniture: [] };
    // 1. é‡ç½®ä¸ºçº¯å‡€çš„åŸºç¡€åœ°å›¾åˆ—è¡¨
    // è¿™ç¡®ä¿äº†æ–°æ¸¸æˆä¸ä¼šå¸¦æœ‰ä¸Šä¸€å±€çš„éšæœºåœ°å›¾
    this.LEVELS = this.getStaticLevels();
    
    // 2. é‡ç½®è§’è‰²æ•°æ®
    this.p1 = new RpgEntity(p1Name, p1StyleData, "player");
    this.p1.persona = p1Persona || "å‹‡æ•¢çš„å†’é™©è€…";
    this.p2 = new RpgEntity(p2Config.p2Name, p2Config.styleData, "partner");
    
    this.p2.customData = {
        intro: p2Config.intro,
        dialogues: p2Config.dialogues || {},
        realName: p2Config.realName || p2Config.p2Name, // å­˜å…¥çœŸå
        persona: p2Config.persona || "å¿ è¯šçš„ä¼™ä¼´"       // å­˜å…¥äººè®¾
    };

    this.battleTeam = [this.p1, this.p2];
    this.visitedLevels.clear();
    
    // 3. åˆå§‹åŒ–éšæœºåœ°å›¾ç³»ç»Ÿ
    this.randomMapData = {
        worldTheme: null,
        currentMapIndex: 0,
        mapStories: [],
        storyPoints: [],
         triggeredPoints: new Set(),
    // ã€æ–°å¢žã€‘æ¯ä¸ªåœ°å›¾çš„å‰§æƒ…ç‚¹çŠ¶æ€ç®¡ç†
    mapStates: {} // æ ¼å¼: { 'random0': { points: [{x,y}], triggered: Set(['0,1', '2,3']) } }
    };
    
    // 4. ä»Žåºç« å¼€å§‹
    this.loadLevel(0, 'start');
    this.start();
}

    // ã€ä¿®å¤1-Aã€‘å­˜æ¡£ï¼šä¿å­˜åŠ¨æ€ç”Ÿæˆçš„åœ°å›¾æ•°æ®
// ã€ä¿®å¤ç‰ˆã€‘exportSaveData
exportSaveData() {
    // 1. æå–æ‰€æœ‰ç±»åž‹ä¸º 'random' çš„åœ°å›¾
    // è¿™æ ·æ— è®ºç”Ÿæˆäº†å¤šå°‘å¼ ï¼Œéƒ½èƒ½è¢«å®Œæ•´ä¿å­˜ï¼Œè§£å†³è¯»æ¡£åŽå›žé€€å˜å®¶å›­çš„é—®é¢˜
    const randomLevels = this.LEVELS.filter(lv => lv.type === 'random');

    return {
        timestamp: Date.now(),
        mapName: this.curLv ? this.curLv.name : "æœªçŸ¥",
        lvIdx: this.lvIdx,
        
        inventory: { ...this.inventory }, 
        
        // homeState é‡Œé¢æœ‰æ•°ç»„ furnitureï¼Œå»ºè®®ç”¨ JSON è½¬æ¢æ³•è¿›è¡Œæ·±æ‹·è´
        homeState: JSON.parse(JSON.stringify(this.homeState)),
        
        currency: this.currency,
        
        
        // è½¬æ¢ Set -> Array
        visited: Array.from(this.visitedLevels),
        
randomMapData: this.randomMapData ? {
    ...this.randomMapData,
    triggeredPoints: Array.from(this.randomMapData.triggeredPoints || []),
    // ã€æ–°å¢žã€‘ä¿å­˜æ¯ä¸ªåœ°å›¾çš„çŠ¶æ€
    mapStates: Object.fromEntries(
        Object.entries(this.randomMapData.mapStates || {}).map(([id, state]) => [
            id, 
            { 
                points: state.points, 
                triggered: Array.from(state.triggered) // Set è½¬ Array
            }
        ])
    )
} : null,
        
        // ã€å…³é”®ä¿®æ”¹ç‚¹ã€‘ä¿å­˜ç”Ÿæˆçš„â€œæ‰€æœ‰â€éšæœºåœ°å›¾åˆ—è¡¨
        allRandomLevels: randomLevels,

        // å…¼å®¹æ—§å­˜æ¡£çš„å­—æ®µ
        customLevelData: (this.curLv.type === 'random') ? this.curLv : null,

        p1: { 
            name: this.p1.name,
            persona: this.p1.persona,
            lv: this.p1.lv,
            hp: this.p1.hp,
            maxHp: this.p1.maxHp,
            mp: this.p1.mp,
            maxMp: this.p1.maxMp,
            atk: this.p1.atk,
            xp: this.p1.xp,
            nextXp: this.p1.nextXp,
            x: this.p1.x,
            y: this.p1.y,
            direction: this.p1.direction,
            step: this.p1.step,
            type: this.p1.type,
            styleData: this.p1.styleData,
            headColor: this.p1.headColor,
            bodyColor: this.p1.bodyColor
        },
        p2: { 
            name: this.p2.name,
            lv: this.p2.lv,
            hp: this.p2.hp,
            maxHp: this.p2.maxHp,
            mp: this.p2.mp,
            maxMp: this.p2.maxMp,
            atk: this.p2.atk,
            xp: this.p2.xp,
            nextXp: this.p2.nextXp,
            x: this.p2.x,
            y: this.p2.y,
            direction: this.p2.direction,
            step: this.p2.step,
            type: this.p2.type,
            styleData: this.p2.styleData,
            headColor: this.p2.headColor,
            bodyColor: this.p2.bodyColor,
            customData: this.p2.customData
        }
        
    };
}

// ã€ä¿®å¤ã€‘è¯»æ¡£é€»è¾‘ï¼šæ¢å¤å®Œæ•´çš„åœ°å›¾é“¾
// ã€ä¿®å¤ç‰ˆã€‘importSaveData
importSaveData(data) {
    this.stop();
    this.resetUI();

    // 1. ã€æ ¸å¿ƒã€‘å…ˆé‡ç½®ä¸ºçº¯å‡€çš„åŸºç¡€åœ°å›¾åˆ—è¡¨
    this.LEVELS = this.getStaticLevels();

// 2. æ¢å¤éšæœºä¸–ç•ŒçŠ¶æ€
    if (data.randomMapData) {
    this.randomMapData = data.randomMapData;
    
    // æ¢å¤ triggeredPoints (æ—§ç‰ˆå…¼å®¹)
    if (Array.isArray(this.randomMapData.triggeredPoints)) {
         this.randomMapData.triggeredPoints = new Set(this.randomMapData.triggeredPoints);
    } else {
         this.randomMapData.triggeredPoints = new Set();
    }
    
    // ã€æ–°å¢žã€‘æ¢å¤æ¯ä¸ªåœ°å›¾çš„çŠ¶æ€
    if (this.randomMapData.mapStates) {
        Object.keys(this.randomMapData.mapStates).forEach(mapId => {
            const state = this.randomMapData.mapStates[mapId];
            // Array è½¬å›ž Set
            if (Array.isArray(state.triggered)) {
                state.triggered = new Set(state.triggered);
            } else {
                state.triggered = new Set();
            }
        });
    } else {
        this.randomMapData.mapStates = {};
    }
}

    // 3. ã€æ ¸å¿ƒã€‘å°†å­˜æ¡£é‡Œçš„éšæœºåœ°å›¾æ’å›žåŽ»
    // æ‰¾åˆ°å®¶å›­åœ°å›¾çš„ä½ç½®ï¼Œéšæœºåœ°å›¾é€šå¸¸æ’åœ¨å®¶å›­åŽé¢
    const homeIdx = this.LEVELS.findIndex(lv => lv.type === 'home');
    const insertBaseIndex = (homeIdx !== -1) ? (homeIdx + 1) : this.LEVELS.length;

    if (data.allRandomLevels && data.allRandomLevels.length > 0) {
        // éåŽ†å­˜æ¡£ä¸­çš„éšæœºåœ°å›¾ï¼Œé€ä¸ªæ’å…¥åˆ°å†…å­˜ä¸­çš„åœ°å›¾åˆ—è¡¨
        data.allRandomLevels.forEach((lv, i) => {
            this.LEVELS.splice(insertBaseIndex + i, 0, lv);
        });
    } else if (data.customLevelData) {
        // å…¼å®¹æ—§å­˜æ¡£
        const existing = this.LEVELS.find(l => l.id === data.customLevelData.id);
        if (!existing) {
            this.LEVELS.splice(insertBaseIndex, 0, data.customLevelData);
        }
    }

    // 4. æ¢å¤è§’è‰²æ•°æ®
    const createFallbackStyle = (legacyHead, legacyBody) => ({
        hair: legacyHead || '#f1c40f', eye: '#2c3e50', skin: '#FFE4CF',
        top: legacyBody || '#3498db', bottom: '#2c3e50', shoe: '#101018',
        bangs: 0, back: 0, botStyle: 0
    });

    if (!data.p1.styleData) data.p1.styleData = createFallbackStyle(data.p1.headColor, data.p1.bodyColor);
    if (!data.p2.styleData) data.p2.styleData = createFallbackStyle(data.p2.headColor, data.p2.bodyColor);

    this.p1 = new RpgEntity(data.p1.name, data.p1.styleData, "player");
    Object.assign(this.p1, data.p1);
    if (!this.p1.persona) {
        // å°è¯•å°è¯•è¯»å–å…¨å±€é¢„è®¾ï¼Œæˆ–è€…ç»™ä¸ªé»˜è®¤å€¼
        this.p1.persona = "å‹‡æ•¢çš„å†’é™©è€…ï¼Œå……æ»¡å¥½å¥‡å¿ƒã€‚";
    }
    
    this.p2 = new RpgEntity(data.p2.name, data.p2.styleData, "partner");
    Object.assign(this.p2, data.p2); 
    if (!this.p2.customData) this.p2.customData = { dialogues: {} };

    this.battleTeam = [this.p1, this.p2];
    this.visitedLevels = new Set(data.visited || []);
    
    // 5. åŠ è½½åœ°å›¾
    this.loadLevel(data.lvIdx, 'load');
    
    this.p1.x = data.p1.x; this.p1.y = data.p1.y;
    this.p2.x = data.p1.x; this.p2.y = data.p1.y;

   this.inventory = data.inventory ? { ...data.inventory } : {};
        this.currency = data.currency || 0;
        this.homeState = data.homeState ? JSON.parse(JSON.stringify(data.homeState)) : { furniture: [] };
    
      this.state = this.STATE.MAP; 
    
    document.getElementById('rpg-controls').style.display = 'block';
    const menuBtn = document.getElementById('rpg-menu-toggle-btn');
    if(menuBtn) menuBtn.style.display = 'flex';


    
    this.start();
}

resize() {
    if (this.canvas && this.container) {
        // å¼ºåˆ¶èŽ·å–å®žé™…æ˜¾ç¤ºå°ºå¯¸
        const rect = this.container.getBoundingClientRect();
        const w = Math.floor(rect.width);
        const h = Math.floor(rect.height);
        
        // åªæœ‰å½“å°ºå¯¸æœ‰æ•ˆä¸”å‘ç”Ÿå˜åŒ–æ—¶æ‰è°ƒæ•´
        if (w > 0 && h > 0 && (this.canvas.width !== w || this.canvas.height !== h)) {
            this.canvas.width = w;
            this.canvas.height = h;
            this.ctx = this.canvas.getContext('2d');
            this.ctx.imageSmoothingEnabled = false;
            
            this.updateCamera(true);
            this.draw();
        }
    }
}

    // æ¢å¤æ¸¸æˆï¼ˆç”¨äºŽä»Žèœå•è¿”å›žï¼‰
    resume() {
        // å…ˆè®¡ç®—å°ºå¯¸
        this.resize(); 
        
        // æ— è®ºæ˜¯å¦å·²ç»åœ¨è¿è¡Œï¼Œéƒ½å¼ºåˆ¶é‡ç»˜ä¸€å¸§é™æ€ç”»é¢
        // è¿™æ ·å³ä½¿ loop æœ‰å»¶è¿Ÿï¼ŒçŽ©å®¶ä¹Ÿèƒ½ç«‹å³çœ‹åˆ°å½“å‰çŠ¶æ€
        this.draw(); 

        if (!this.isRunning) {
            this.isRunning = true;
            this.lastTime = Date.now();
            this.loop();
        }
    }

    start() {
        this.isRunning = true;
        this.resize();
        this.lastTime = Date.now();
        this.loop();
        
    }

    stop() {
        this.isRunning = false;
        if (this.animationFrameId) {
            cancelAnimationFrame(this.animationFrameId);
            this.animationFrameId = null;
        }
    }
    


    bindEvents() {
        const setInput = (axis, val) => { rpgInput[axis] = val; };
        const bindKey = (cls, axis, val) => {
            const el = document.querySelector(cls);
            if(el) {
                el.addEventListener('touchstart', (e) => { e.preventDefault(); setInput(axis, val); }, {passive: false});
                el.addEventListener('touchend', (e) => { e.preventDefault(); setInput(axis, 0); });
                el.addEventListener('mousedown', (e) => { e.preventDefault(); setInput(axis, val); });
                el.addEventListener('mouseup', (e) => { e.preventDefault(); setInput(axis, 0); });
                el.addEventListener('mouseleave', (e) => { e.preventDefault(); setInput(axis, 0); });
            }
        };
        bindKey('.rpg-up', 'y', -1);
        bindKey('.rpg-down', 'y', 1);
        bindKey('.rpg-left', 'x', -1);
        bindKey('.rpg-right', 'x', 1);
        
        const goScreen = document.getElementById('rpg-game-over-screen');
        if(goScreen) {
            goScreen.addEventListener('pointerup', () => {
                if (this.state === this.STATE.GAME_OVER) {
                    switchScreen('rpg-title-screen');
                }
            });
        }
        
       
        
     // ============================================
        // ã€æ–°å¢ž/ä¿®æ”¹ã€‘å³ä¸Šè§’èœå•æŒ‰é’®ç»‘å®š
        // ============================================
        const menuBtn = document.getElementById('rpg-menu-toggle-btn');
        if (menuBtn) {
            // ä½¿ç”¨ cloneNode(true) ç§»é™¤ä¹‹å‰æ‰€æœ‰å¯èƒ½ç»‘å®šçš„äº‹ä»¶ï¼Œé˜²æ­¢å†²çª
            const newMenuBtn = menuBtn.cloneNode(true);
            menuBtn.parentNode.replaceChild(newMenuBtn, menuBtn);
            
            // ç»‘å®šæ–°çš„ç‚¹å‡»äº‹ä»¶ï¼šæ‰“å¼€æš‚åœèœå•
            newMenuBtn.addEventListener('click', (e) => {
                e.stopPropagation(); // é˜²æ­¢å†’æ³¡
                this.toggleMenu(true); // è°ƒç”¨ç±»å†…éƒ¨çš„ toggleMenu æ–¹æ³•
            });
        }

        // ============================================
        // ã€æ–°å¢žã€‘æˆ˜æ–—ç•Œé¢èƒŒåŒ…æŒ‰é’®ç»‘å®š (å¯¹åº”é—®é¢˜2)
        // ============================================
        const battleBagBtn = document.getElementById('rpg-battle-bag-btn');
        if (battleBagBtn) {
            const newBagBtn = battleBagBtn.cloneNode(true);
            battleBagBtn.parentNode.replaceChild(newBagBtn, battleBagBtn);

            newBagBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                // æ‰“å¼€æˆ˜æ–—èƒŒåŒ…
                this.openInventory('battle'); 
            });
        }
        const interactBtn = document.getElementById('rpg-interact-btn');
    if (interactBtn) {
        // é˜²æ­¢é‡å¤ç»‘å®š
        const newBtn = interactBtn.cloneNode(true);
        interactBtn.parentNode.replaceChild(newBtn, interactBtn);
        
 newBtn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            this.triggerInteraction(); // æ‰§è¡Œäº¤äº’
        });          
    }
    }
    
    triggerInteraction() {
    if (!this.pendingInteraction) return;

    const target = this.pendingInteraction;
    
    if (target.type === 'shop') {
        this.openShop();
    } else if (target.type === 'furniture') {
        this.interactWithFurniture(target.data);
    }
    // äº¤äº’åŽéšè—æŒ‰é’®ï¼Œé˜²æ­¢é‡å¤ç‚¹å‡»ï¼ˆå¯é€‰ï¼Œæˆ–è€…ä¿ç•™æ–¹ä¾¿è¿žç»­æ“ä½œï¼‰
    document.getElementById('rpg-interact-btn').style.display = 'none';
}

// ã€ä¿®å¤ç‰ˆã€‘loadLevel å‡½æ•°
// ã€ä¿®å¤ç‰ˆã€‘loadLevel å‡½æ•°
loadLevel(idx, mode = 'start') {
    // === ä¿®å¤ç‚¹ 1ï¼šæ¸…ç†æ—§çŠ¶æ€ï¼Œé˜²æ­¢éšæœºåœ°å›¾æ•°æ®æ®‹ç•™å¹²æ‰° ===
    this.currentStoryPoints = [];
    
    // 1. ç´¢å¼•è¾¹ç•Œæ£€æŸ¥
    if (idx < 0) idx = 0;
    if (idx >= this.LEVELS.length) idx = this.LEVELS.length - 1;

    this.lvIdx = idx;
    this.curLv = this.LEVELS[idx];

    // === ä¿®å¤ç‚¹ 2ï¼šç«‹å³æ›´æ–°æ ‡é¢˜ (ç§»åˆ°è¿™é‡Œï¼Œé˜²æ­¢åŽé¢ return å¯¼è‡´æ ‡é¢˜ä¸æ›´æ–°) ===
    const titleEl = document.getElementById('rpg-header-title');
    if (titleEl && this.curLv) {
        titleEl.innerText = this.curLv.name; 
        titleEl.style.color = 'var(--text-color)';
    }

    // éšæœºåœ°å›¾æ•°æ®åˆå§‹åŒ–é€»è¾‘
    if (this.curLv.type === 'random') {
        const mapId = this.curLv.id;
        // ç¡®ä¿ mapStates å·²åˆå§‹åŒ–
        if (!this.randomMapData.mapStates) {
            this.randomMapData.mapStates = {};
        }
        // å¦‚æžœè¿™ä¸ªåœ°å›¾è¿˜æ²¡æœ‰çŠ¶æ€è®°å½•ï¼Œåˆ›å»ºä¸€ä¸ª
        if (!this.randomMapData.mapStates[mapId]) {
            this.randomMapData.mapStates[mapId] = {
                points: [],
                triggered: new Set()
            };
        }
        // æ¸…ç©ºä¸´æ—¶åæ ‡åˆ—è¡¨
        this.randomMapData.mapStates[mapId].points = [];
    }

    // 2. å¤„ç†åºç«  (çº¯å‰§æƒ…ï¼Œæ— åœ°å›¾)
    if (this.curLv.type === 'prologue') {
        this.state = this.STATE.STORY;
        this.storyQueue = [];
        this.curLv.story.forEach(text => {
            this.storyQueue.push({ name: "", text: text });
        });
        
        // éšè—æ‰€æœ‰æ“ä½œUI
        document.getElementById('rpg-controls').style.display = 'none';
        
        const menuBtn = document.getElementById('rpg-menu-toggle-btn');
        if (menuBtn) menuBtn.style.display = 'none';
        
        // ç«‹å³å¼€å§‹æ’­æ”¾ç¬¬ä¸€å¥
        this.nextStory();
        return; // ã€æ³¨æ„ã€‘è¿™é‡Œ return äº†ï¼Œæ‰€ä»¥æ ‡é¢˜æ›´æ–°ä»£ç å¿…é¡»æ”¾åœ¨ä¸Šé¢
    }

    // 3. å¤„ç†å®¶å›­åœ°å›¾ (ç‰¹æ®Šé€»è¾‘)
    if (this.curLv.type === 'home') {
        this.mapData = [];
        this.mapEnemies = [];
        let rows = this.curLv.map;
        this.h = rows.length;
        this.w = rows[0].length;
        let startPos = { x: 1, y: 7 };
        this.gatePos = null;

        for (let y = 0; y < this.h; y++) {
            let rowStr = "";
            for (let x = 0; x < this.w; x++) {
                let char = rows[y][x];
                if (char === 'S') startPos = { x, y };
                else if (char === 'G') {
                    this.gatePos = { x, y };
                    char = '.';
                } else if (char === 'H') char = '.';
                rowStr += char;
            }
            this.mapData.push(rowStr);
        }

        if (mode !== 'load') {
            this.p1.x = startPos.x; this.p1.y = startPos.y;
            this.p2.x = startPos.x; this.p2.y = startPos.y;
            this.state = this.STATE.STORY;
            this.storyQueue = [
                { name: "", text: this.curLv.intro },
                { name: this.p2.name, text: this.curLv.partnerText }
            ];
            document.getElementById('rpg-controls').style.display = 'none';
            const menuBtn = document.getElementById('rpg-menu-toggle-btn');
            if (menuBtn) menuBtn.style.display = 'none';
            this.nextStory();
        } else {
            this.state = this.STATE.MAP;
            document.getElementById('rpg-controls').style.display = 'block';
            const menuBtn = document.getElementById('rpg-menu-toggle-btn');
            if (menuBtn) menuBtn.style.display = 'flex';
        }

        this.updateCamera(true);
        return; // ã€æ³¨æ„ã€‘è¿™é‡Œä¹Ÿ return äº†
    }

    // 4. å¤„ç†æ™®é€š/éšæœº/å®¤å†…åœ°å›¾
    this.mapData = [];
    this.mapEnemies = [];

    let rows = this.curLv.map;
    this.h = rows.length;
    this.w = rows[0].length;

    let startPos = { x: 1, y: 1 };
    let prevPos = { x: 1, y: 1 };
    let exitPos = { x: 1, y: 1 };

    // å¦‚æžœæ˜¯éšæœºåœ°å›¾ä¸”æ˜¯åˆæ¬¡è¿›å…¥ï¼Œé‡ç½®å‰§æƒ…ç‚¹
    if (this.curLv.type === 'random' && mode !== 'prev' && !this.visitedLevels.has(this.curLv.id)) {
        if (this.randomMapData) {
            this.randomMapData.storyPoints = [];
            this.randomMapData.triggeredPoints = new Set();
        }
    }

    // è§£æžåœ°å›¾æ•°æ®
    for (let y = 0; y < this.h; y++) {
        let rowStr = "";
        for (let x = 0; x < this.w; x++) {
            let char = rows[y][x];
            if (char === 'S') startPos = { x, y };
            else if (char === 'P') prevPos = { x, y };
            else if (char === 'E') exitPos = { x, y };
            else if (char === 'M') {
                let mType = Math.min(idx - 1, 1);
                let e = new RpgEntity("æ€ªç‰©", { monsterType: mType }, "enemy");
                if (this.curLv.enemyPool) {
                    e.hp = this.curLv.enemyPool.hp;
                    e.maxHp = this.curLv.enemyPool.hp;
                    e.atk = this.curLv.enemyPool.atk;
                    e.lv = this.curLv.enemyPool.lv;
                    e.xp = e.lv * 20;
                }
                e.x = x; e.y = y;
                this.mapEnemies.push(e);
                char = '.';
            } else if (char === 'B') {
                let e = new RpgEntity("BOSS", { monsterType: 2 }, "boss");
                if (this.curLv.boss) {
                    e.hp = this.curLv.boss.hp;
                    e.maxHp = this.curLv.boss.hp;
                    e.atk = this.curLv.boss.atk;
                    e.lv = this.curLv.boss.lv;
                    e.xp = e.lv * 50;
                }
                e.x = x; e.y = y;
                this.mapEnemies.push(e);
                char = '.';
            }  else if (char === 'T') {
                // è®°å½•å‰§æƒ…ç‚¹åæ ‡
                if (this.curLv.type === 'random') {
                    const mapId = this.curLv.id;
                    this.randomMapData.mapStates[mapId].points.push({ x, y });
                }
                if (!this.currentStoryPoints) this.currentStoryPoints = [];
                this.currentStoryPoints.push({ x, y });
            }
            rowStr += char;
        }
        this.mapData.push(rowStr);
    }

    // === æ ¸å¿ƒé€»è¾‘åˆ†æ”¯ ===
    if (mode !== 'load') {
        // è®¾ç½®åæ ‡
        if (mode === 'start') {
            this.p1.x = startPos.x; this.p1.y = startPos.y;
        } else if (mode === 'prev') {
            if (prevPos.x !== 1 || prevPos.y !== 1) {
                this.p1.x = prevPos.x; this.p1.y = prevPos.y;
            } else {
                this.p1.x = Math.max(1, exitPos.x - 1); this.p1.y = exitPos.y;
            }
        }
        this.p2.x = this.p1.x; this.p2.y = this.p1.y;

        this.state = this.STATE.STORY;
        this.isOpeningStory = (mode === 'start' && !this.visitedLevels.has(this.curLv.id));
        this.storyQueue = [];

        // åˆ¤æ–­æ˜¯å¦æ˜¯æ—§åœ°é‡æ¸¸
        const isRevisit = this.visitedLevels.has(this.curLv.id);

        if (isRevisit) {
            // --- æƒ…å†µAï¼šæ—§åœ°é‡æ¸¸ ---
            let envText = mode === 'prev' ? 
                (this.curLv.returnText || "å›žåˆ°äº†ä¹‹å‰çš„åŒºåŸŸã€‚") : 
                "åˆå›žåˆ°äº†è¿™é‡Œã€‚";
            
            this.storyQueue.push({ name: "", text: envText });

            const returnLines = this.p2.customData?.dialogues?.return || [];
            if (returnLines.length > 0 && Math.random() > 0.5) {
                this.storyQueue.push({ name: this.p2.name, text: this.getRandomLine(returnLines) });
            }
        } else {
            // --- æƒ…å†µBï¼šåˆæ¬¡æŽ¢ç´¢ ---
            this.visitedLevels.add(this.curLv.id); 

            let hasRandomStory = false;
            if (this.curLv.type === 'random' && this.randomMapData) {
                 const mapIdx = this.randomMapData.currentMapIndex;
                 if (this.curLv.id === `random${mapIdx}`) {
                     const storyData = this.randomMapData.mapStories[mapIdx];
                     if (storyData && storyData.opening && storyData.opening.length > 0) {
                         storyData.opening.forEach(text => {
                             let parts = text.split(/[ï¼š:]/);
                             let speaker = parts.length>=2 ? parts[0] : "";
                             let content = parts.length>=2 ? parts.slice(1).join(":") : text;
                             this.storyQueue.push({ name: speaker, text: content });
                         });
                         hasRandomStory = true;
                     }
                 }
            }
            
            if (!hasRandomStory) {
                let envText = this.curLv.intro || "æ¥åˆ°äº†ä¸€ä¸ªæ–°çš„åŒºåŸŸã€‚";
                this.storyQueue.push({ name: "", text: envText });

                if (this.curLv.type !== 'random') {
                    // å›ºå®šåœ°å›¾çš„ç‰¹æ®Šå¯¹è¯
                    let lines = [];
                    if (idx === 1 && mode === 'start') {
                        const introLine = this.p2.customData?.intro;
                        if(introLine) lines.push(introLine);
                    }
                    
                    const mapKey = `map${idx}`;
                    const pool = this.p2.customData?.dialogues?.[mapKey] || [];
                    if (pool.length > 0) {
                        const shuffled = [...pool].sort(() => 0.5 - Math.random());
                        lines = lines.concat(shuffled.slice(0, 2));
                    }

                    lines.forEach(line => {
                        this.storyQueue.push({ name: this.p2.name, text: line });
                    });
                }
            }
        }

        document.getElementById('rpg-controls').style.display = 'none';
        this.nextStory();
    } else {
        // mode === 'load'
        this.state = this.STATE.MAP;
        document.getElementById('rpg-controls').style.display = 'block';
    }
    
    this.updateCamera(true);
}

// ã€ä¿®å¤ç‰ˆã€‘nextStoryï¼šå¤„ç†åºç« è·³è½¬
nextStory() {
    if (this.state === this.STATE.STORY) {
        if (this.storyQueue && this.storyQueue.length > 0) {
            // æœ‰å‰§æƒ…ï¼šæ˜¾ç¤ºä¸‹ä¸€å¥
            const talk = this.storyQueue.shift();
            this.showBottomDialog(talk.name, talk.text);
        } else {
        this.isOpeningStory = false;
            // --- å‰§æƒ…æ’­æ”¾å®Œæ¯• ---
            this.closeDialogs();
            
            // 1. æ£€æŸ¥æ˜¯å¦é€šå…³ (ä¿æŒåŽŸæœ‰é€»è¾‘)
            if (this.isGameClear) {
                this.isGameClear = false;
                this.stop();
                switchScreen('rpg-title-screen');
                return;
            }

            // 2. æ£€æŸ¥æ˜¯å¦å›žå®¶ (ä¿æŒåŽŸæœ‰é€»è¾‘)
            if (this.isGoingHome) {
                this.isGoingHome = false;
                const homeIdx = this.LEVELS.findIndex(lv => lv.type === 'home');
                if (homeIdx !== -1) this.loadLevel(homeIdx, 'start');
                else this.loadLevel(0, 'start');
                return;
            }
            
            // 3. ã€æ ¸å¿ƒä¿®å¤ã€‘æ£€æŸ¥æ˜¯å¦æ˜¯åºç« 
            // å¦‚æžœåˆšçœ‹å®Œåºç« ï¼Œå¿…é¡»æ‰‹åŠ¨åŠ è½½ç¬¬1å…³ï¼Œå¦åˆ™ä¼šåœç•™åœ¨åºç« çš„é»‘å±çŠ¶æ€ï¼
            if (this.curLv.type === 'prologue') {
                // åŠ è½½ä¸‹ä¸€å…³ (ç´¢å¼• 0+1 = 1ï¼Œå³è¿·é›¾æ£®æž—)
                this.loadLevel(this.lvIdx + 1, 'start');
                return; // ç›´æŽ¥è¿”å›žï¼Œè®© loadLevel æŽ¥ç®¡åŽç»­é€»è¾‘
            }
            
            // 4. æ™®é€šåœ°å›¾å‰§æƒ…ç»“æŸï¼ˆæ¯”å¦‚åˆšè¿›å…¥è¿·é›¾æ£®æž—çœ‹å®Œä»‹ç»ï¼‰
            // æ¢å¤åœ°å›¾æŽ§åˆ¶æƒ
            this.state = this.STATE.MAP;
            
            // å¼ºåˆ¶æ¢å¤æ‰€æœ‰ UI å…ƒç´ 
            const controls = document.getElementById('rpg-controls');
            const menuBtn = document.getElementById('rpg-menu-toggle-btn');

            
            if (controls) controls.style.display = 'block';
            if (menuBtn) menuBtn.style.display = 'flex';

            
            // é‡ç½®è¾“å…¥çŠ¶æ€
            if (typeof rpgInput !== 'undefined') {
                rpgInput.x = 0;
                rpgInput.y = 0;
            }
            
            // ç¡®ä¿æ¸¸æˆå¾ªçŽ¯è¿è¡Œ
            if (!this.isRunning) {
                this.start();
            }
        }
    }
}


// ã€ä¿®æ”¹ã€‘åˆ‡æ¢æš‚åœçŠ¶æ€ï¼šä¸å†æ˜¯å¼¹çª—ï¼Œè€Œæ˜¯åˆ‡æ¢é¡µé¢
    toggleMenu(show) {
        this.isPaused = show;
        
        if (show) {
            this.stop(); // åœæ­¢æ¸¸æˆå¾ªçŽ¯
            switchScreen('rpg-pause-screen'); // åˆ‡æ¢åˆ°æ ‡å‡†çš„æš‚åœé¡µé¢
        } else {
            switchScreen('rpg-game-screen'); // åˆ‡å›žæ¸¸æˆé¡µé¢
            this.resume(); // æ¢å¤æ¸¸æˆå¾ªçŽ¯
        }
    }




    loop() {
        if (!this.isRunning) return;
        if (!this.isPaused) {
            this.update();
            this.draw();
        }
        this.animationFrameId = requestAnimationFrame(() => this.loop());
    }

    update() {
        if(this.state === this.STATE.MAP) this.updateMap();
        else if(this.state === this.STATE.BATTLE_TARGET) { /* managed by UI */ }
        this.updateCamera();
    }

    updateCamera(instant = false) {
        let targetX = this.p1.x * RPG_CONFIG.TILE - this.canvas.width/2 + RPG_CONFIG.TILE/2;
        let targetY = this.p1.y * RPG_CONFIG.TILE - this.canvas.height/2 + RPG_CONFIG.TILE/2;
        let minX = 0;
        let maxX = Math.max(0, this.w * RPG_CONFIG.TILE - this.canvas.width);
        let minY = 0;
        let maxY = Math.max(0, this.h * RPG_CONFIG.TILE - this.canvas.height);
        targetX = Math.max(minX, Math.min(targetX, maxX));
        targetY = Math.max(minY, Math.min(targetY, maxY));
        if(instant) { this.cam.x = targetX; this.cam.y = targetY; }
        else { this.cam.x += (targetX - this.cam.x) * 0.1; this.cam.y += (targetY - this.cam.y) * 0.1; }
    }

    // ã€ä¿®å¤3ã€‘åœ°å›¾ç§»åŠ¨é€»è¾‘æ›´æ–°ï¼šæ£€æŸ¥ä¸‹ä¸€å…³æ˜¯å¦å­˜åœ¨
// ã€æ›¿æ¢åŽŸæœ‰çš„ updateMapã€‘
updateMap() {
    this.frameCounter = (this.frameCounter || 0) + 1;

    // ç§»åŠ¨å†·å´
    if(this.moveWait > 0) { 
        this.moveWait--; 
        if (this.frameCounter % 5 === 0) {
            this.p1.step = (this.p1.step + 1) % 4;
            this.p2.step = (this.p2.step + 1) % 4;
        }
        return; 
    }

    // æ— è¾“å…¥åˆ™é™æ­¢
    if (rpgInput.x === 0 && rpgInput.y === 0) {
        this.p1.step = 0;
        this.p2.step = 0;
        return;
    }

    // è®¾ç½®æ–¹å‘
    if (rpgInput.y > 0) this.p1.direction = 0;
    else if (rpgInput.x < 0) this.p1.direction = 1;
    else if (rpgInput.x > 0) this.p1.direction = 2;
    else if (rpgInput.y < 0) this.p1.direction = 3;

    // è®¡ç®—ç›®æ ‡åæ ‡
    let nx = this.p1.x + rpgInput.x;
    let ny = this.p1.y + rpgInput.y;
    
    // è¾¹ç•Œä¸Žå¢™å£ç¢°æ’žæ£€æŸ¥
    if(nx < 0 || nx >= this.w || ny < 0 || ny >= this.h) return;
    if(this.mapData[ny][nx] === '#') return;
    
    // --- ã€æ–°é€»è¾‘ã€‘äº¤äº’æ£€æµ‹ ---
    
    let interactTarget = null;
    
    // 1. æ£€æŸ¥å®¶å…·äº¤äº’
    if (this.curLv.type === 'indoor' || this.curLv.type === 'home') {
        const furniture = this.getFurnitureAt(nx, ny);
        if (furniture) {
            interactTarget = { type: 'furniture', data: furniture };
        }
        
        // 2. æ£€æŸ¥å•†åº—å‘Šç¤ºç‰Œ (å®¶å›­ç‰¹å®šåæ ‡ 10, 6)
        if (this.curLv.id === 'home' && nx === 10 && ny === 6) {
            interactTarget = { type: 'shop' };
        }
    }

    // 3. å¤„ç†äº¤äº’é€»è¾‘
    const interactBtn = document.getElementById('rpg-interact-btn');
    
    if (interactTarget) {
        // å¦‚æžœå‰æ–¹æœ‰ä¸œè¥¿ï¼š
        // 1. é˜»æ­¢ç§»åŠ¨ (return)
        // 2. æ˜¾ç¤ºæŒ‰é’®
        // 3. è®°å½•å¾…äº¤äº’å¯¹è±¡
        this.pendingInteraction = interactTarget;
        if (interactBtn) {
            interactBtn.style.display = 'flex';
            // å¯ä»¥æ ¹æ®ç±»åž‹æ”¹å˜å›¾æ ‡ï¼Œæ¯”å¦‚å•†åº—æ˜¾ç¤ºðŸ’°
            interactBtn.innerText = interactTarget.type === 'shop' ? 'ðŸ’°' : 'ðŸ–ï¸';
        }
        return; // ã€å…³é”®ã€‘ä¸å†æ‰§è¡Œä¸‹é¢çš„ç§»åŠ¨ä»£ç 
    } else {
        // å‰æ–¹æ²¡æœ‰ä¸œè¥¿ï¼Œéšè—æŒ‰é’®ï¼Œæ¸…ç©ºå¾…äº¤äº’
        this.pendingInteraction = null;
        if (interactBtn) interactBtn.style.display = 'none';
    }
    
    // --- ç§»åŠ¨é€»è¾‘ç»§ç»­ ---

    // è¿›é—¨é€»è¾‘ (Home -> Indoor)
    if (this.curLv.id === 'home' && nx === 15 && ny === 5) {
        // å‡è®¾é—¨åœ¨ (15,5)
        this.loadLevel(this.LEVELS.findIndex(l => l.id === 'indoor'), 'start');
        // æ¸…é™¤æŒ‰é’®çŠ¶æ€
        if (interactBtn) interactBtn.style.display = 'none';
        return;
    }
    
    // å‡ºé—¨é€»è¾‘ (Indoor -> Home)
    if (this.curLv.id === 'indoor' && this.mapData[ny][nx] === 'E') {
        const homeIdx = this.LEVELS.findIndex(l => l.id === 'home');
        this.loadLevel(homeIdx, 'start');
        this.p1.x = 15; this.p1.y = 6; // ä¼ é€åˆ°é—¨å£
        if (interactBtn) interactBtn.style.display = 'none';
        return;
    }
    
    // æ—¶ç©ºä¹‹é—¨é€»è¾‘
    if (this.curLv.type === 'home' && this.gatePos && nx === this.gatePos.x && ny === this.gatePos.y) {
        this.triggerGateDialog();
        return;
    }
    
    // å‰§æƒ…ç‚¹é€»è¾‘
if (this.currentStoryPoints && this.currentStoryPoints.length > 0) {
    const point = this.currentStoryPoints.find(p => p.x === nx && p.y === ny);
    
    if (point) {
        // ã€ä¿®å¤ã€‘åªæœ‰éšæœºåœ°å›¾æ‰è§¦å‘å‰§æƒ…ç‚¹é€»è¾‘
        if (this.curLv.type === 'random') {
            const mapId = this.curLv.id;
            const mapState = this.randomMapData?.mapStates?.[mapId];
            const pointKey = `${nx},${ny}`;
            
            if (mapState && !mapState.triggered.has(pointKey)) {
                this.triggerStoryPoint(point); 
                return;
            }
        }
        // æ•™ç¨‹åœ°å›¾çš„ T ç‚¹ï¼ˆå¦‚æžœæœ‰ï¼‰ä¸åšç‰¹æ®Šå¤„ç†ï¼Œç›´æŽ¥å¿½ç•¥
    }
}
    
    // é‡æ•Œé€»è¾‘
    let hitEnemy = this.mapEnemies.find(e => e.x === nx && e.y === ny);
    if(hitEnemy && !hitEnemy.isDefeated) { 
        this.startBattle(hitEnemy); 
        return; 
    }
    
    // æ‰§è¡Œç§»åŠ¨
    let ox = this.p1.x, oy = this.p1.y;
    let oldDir = this.p1.direction;

    this.p1.x = nx; this.p1.y = ny;
    this.moveWait = 10; // ç§»åŠ¨é€Ÿåº¦
    
    // é˜Ÿå‹è·Ÿéš
    if(Math.abs(this.p1.x - this.p2.x) + Math.abs(this.p1.y - this.p2.y) > 1) { 
        this.p2.x = ox; 
        this.p2.y = oy;
        this.p2.direction = oldDir; 
    }
    
// ... åœ¨ updateMap æ–¹æ³•å†…éƒ¨ ...

    // åœ°å›¾åˆ‡æ¢ (ä¸Šä¸€å±‚/ä¸‹ä¸€å±‚)
    let tile = this.mapData[ny][nx];
    
    if(tile === 'E') {
    if (this.curLv.type === 'random') {
        // ã€ä¿®å¤ã€‘ä½¿ç”¨å½“å‰åœ°å›¾çš„è§¦å‘æ•°ï¼Œè€Œä¸æ˜¯å…¨å±€ç»Ÿè®¡
        const mapId = this.curLv.id;
        const mapState = this.randomMapData.mapStates[mapId];
        const currentMapCount = mapState ? mapState.triggered.size : 0;
        
        // æŽ’é™¤ random0ï¼ˆåºç« åœ°å›¾ï¼Œä¸éœ€è¦æ”¶é›†ï¼‰
        if (this.curLv.id !== 'random0' && currentMapCount < 3) {
            this.triggerSimpleDialog("", "å‡ºå£è¢«ä¸€ç§ç¥žç§˜çš„åŠ›é‡å°å°ç€...\n(éœ€è¦æ”¶é›† 3 ä¸ªçº¿ç´¢æ‰èƒ½è§£é”)");
            return;
        }
    }
        
        if (this.isGenerating) return; 
        
        // è®¡ç®—ä¸‹ä¸€å…³åœ¨æ•°ç»„ä¸­çš„ç´¢å¼•
        const nextIdx = this.lvIdx + 1;

        // ã€æ ¸å¿ƒä¿®å¤ã€‘æ£€æŸ¥ä¸‹ä¸€å…³æ˜¯å¦å·²ç»å­˜åœ¨äºŽå†…å­˜ä¸­
        if (nextIdx < this.LEVELS.length) {
            // --- æƒ…å†µAï¼šä¸‹ä¸€å…³å·²ç»å­˜åœ¨ï¼ˆæ—§åœ°é‡æ¸¸ï¼‰---
            // ç›´æŽ¥è¯»å–ï¼Œä¸å†è°ƒç”¨ AI ç”Ÿæˆ
            
            // ä¸ºäº†ä½“éªŒä¸€è‡´ï¼Œå¦‚æžœæ˜¯åŽ»å¾€éšæœºåœ°å›¾ï¼Œè¿˜æ˜¯æ˜¾ç¤ºä¸€ä¸‹ä¼ é€æ•ˆæžœ
            if (this.LEVELS[nextIdx].type === 'random') {
                this.showTeleportScreen("æ­£åœ¨å‰å¾€ä¸‹ä¸€åŒºåŸŸ", 'light');
                // ç¨å¾®å»¶è¿Ÿä¸€ä¸‹ï¼Œæ¨¡æ‹Ÿä¼ é€æ„Ÿ
                setTimeout(() => {
                    this.hideTeleportScreen();
                    this.loadLevel(nextIdx, 'start');
                }, 800);
            } else {
                // å¦‚æžœæ˜¯åŽ»å¾€å›ºå®šåœ°å›¾ï¼ˆå¦‚åºç« è¿›ç¬¬ä¸€å…³ï¼‰ï¼Œç›´æŽ¥åˆ‡
                this.loadLevel(nextIdx, 'start');
            }
        } 
        else if (this.curLv.type === 'random') {
            // --- æƒ…å†µBï¼šä¸‹ä¸€å…³ä¸å­˜åœ¨ï¼ˆå¼€è’ï¼‰---
            // åªæœ‰å½“å‰æ˜¯éšæœºåœ°å›¾ï¼Œä¸”åŽé¢æ²¡è·¯äº†ï¼Œæ‰ç”Ÿæˆæ–°çš„
            this.proceedToNextRandomMap(); 
        }
    } 
    else if (tile === 'P') {
        // è¿”å›žä¸Šä¸€å±‚ (ä¿æŒä¸å˜)
        this.loadLevel(this.lvIdx - 1, 'prev');
    }
}


// ã€å®Œæ•´ä¿®å¤ã€‘è§¦å‘æ—¶ç©ºä¹‹é—¨å¯¹è¯
triggerGateDialog() {
    this.stop(); // æš‚åœæ¸¸æˆå¾ªçŽ¯
    
    const overlay = document.createElement('div');
    overlay.className = 'modal-overlay';
    overlay.style.cssText = 'position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:1000; display:flex; align-items:center; justify-content:center;';
    
    const modal = document.createElement('div');
    modal.style.cssText = 'background:#fff; border-radius:12px; padding:20px; max-width:80%; box-shadow: 0 4px 20px rgba(0,0,0,0.3);';
    
    modal.innerHTML = `
        <h3 style="margin:0 0 15px 0; color:#3498db; text-align:center;">æ—¶ç©ºä¹‹é—¨</h3>
        <p style="margin:0 0 20px 0; color:#666; text-align:center; line-height:1.6;">${this.p2.name}ï¼šè¦åŽ»æ–°çš„ä¸–ç•Œå†’é™©å—ï¼Ÿ</p>
        <div style="display:flex; gap:10px; justify-content:center;">
            <button id="gate-yes-btn" class="btn btn-primary" style="min-width:80px;">æ˜¯</button>
            <button id="gate-no-btn" class="btn btn-neutral" style="min-width:80px;">å¦</button>
        </div>
    `;
    
    overlay.appendChild(modal);
    document.body.appendChild(overlay);
    
    // ã€å…³é”®ä¿®å¤ã€‘å¿…é¡»åœ¨DOMæ’å…¥åŽå†ç»‘å®šäº‹ä»¶
    setTimeout(() => {
        const yesBtn = document.getElementById('gate-yes-btn');
        const noBtn = document.getElementById('gate-no-btn');
        
        if (yesBtn) {
            yesBtn.onclick = (e) => {
                e.preventDefault();
                e.stopPropagation();
                console.log('ç‚¹å‡»äº†"æ˜¯"æŒ‰é’®'); // è°ƒè¯•æ—¥å¿—
                document.body.removeChild(overlay);
                this.showWorldInputModal();
            };
        } else {
            console.error('æ‰¾ä¸åˆ°"æ˜¯"æŒ‰é’®');
        }
        
        if (noBtn) {
            noBtn.onclick = (e) => {
                e.preventDefault();
                e.stopPropagation();
                console.log('ç‚¹å‡»äº†"å¦"æŒ‰é’®'); // è°ƒè¯•æ—¥å¿—
                document.body.removeChild(overlay);
                this.resume();
            };
        } else {
            console.error('æ‰¾ä¸åˆ°"å¦"æŒ‰é’®');
        }
    }, 0);
}

// ã€ä¿®å¤2ã€‘4å­—è¾“å…¥æ¡†ï¼ˆå®Œç¾Žæ”¯æŒå¤šå­—ç²˜è´´/è¾“å…¥ï¼‰
showWorldInputModal() {
    const overlay = document.createElement('div');
    overlay.className = 'modal-overlay visible';
    overlay.style.zIndex = '2000';
    
    const modal = document.createElement('div');
    modal.className = 'modal-window';
    modal.style.textAlign = 'center';
    
    modal.innerHTML = `
        <h3 style="margin-bottom:20px; color:var(--primary-color);">è¾“å…¥æ–°ä¸–ç•Œåç§°</h3>
        <p style="font-size:12px; color:#666; margin-bottom:15px;">è¯·è¾“å…¥4ä¸ªå­—çš„ä¸–ç•Œåç§°</p>
        
        <div class="code-input-container">
            <input type="text" class="code-input-box" maxlength="4" data-index="0">
            <input type="text" class="code-input-box" maxlength="4" data-index="1">
            <input type="text" class="code-input-box" maxlength="4" data-index="2">
            <input type="text" class="code-input-box" maxlength="4" data-index="3">
        </div>
        
        <div style="display:flex; gap:10px; margin-top:20px;">
            <button id="world-cancel-btn" class="btn btn-neutral" style="flex:1;">å–æ¶ˆ</button>
            <button id="world-confirm-btn" class="btn btn-primary" style="flex:1;">å‡ºå‘</button>
        </div>
    `;
    
    overlay.appendChild(modal);
    document.body.appendChild(overlay);
    
    const inputs = overlay.querySelectorAll('.code-input-box');
    
    inputs.forEach((input, idx) => {
        input.addEventListener('input', (e) => {
            const val = e.target.value;
            
            // å¦‚æžœè¾“å…¥äº†å†…å®¹ï¼ˆåŒ…æ‹¬å•å­—æˆ–å¤šå­—ç²˜è´´ï¼‰
            if (val.length >= 1) {
                const chars = val.split('');
                
                // 1. å¡«å……å½“å‰åŠåŽç»­æ ¼å­
                for (let i = 0; i < chars.length; i++) {
                    const targetIdx = idx + i;
                    if (targetIdx < inputs.length) {
                        inputs[targetIdx].value = chars[i];
                    }
                }
                
                // 2. ä¿®æ­£å½“å‰æ ¼å­ï¼šåªä¿ç•™ç¬¬ä¸€ä¸ªå­—ç¬¦ï¼ˆå› ä¸ºå®ƒæ˜¯ maxlength=4 ä¸ºäº†æŽ¥æ”¶ç²˜è´´ï¼‰
                input.value = chars[0];

                // 3. è‡ªåŠ¨èšç„¦åˆ°ä¸‹ä¸€ä¸ªç©ºæ ¼å­æˆ–æœ€åŽä¸€ä¸ªæ ¼å­
                const nextIdx = Math.min(idx + chars.length, inputs.length - 1);
                // æ£€æŸ¥ nextIdx æ˜¯å¦æœ‰å€¼ï¼Œæœ‰åˆ™èšç„¦å†ä¸‹ä¸€ä¸ªï¼ˆé˜²æ­¢è¦†ç›–ç”¨æˆ·åˆšå¡«çš„ï¼‰
                if (inputs[nextIdx].value && nextIdx < inputs.length - 1) {
                     inputs[nextIdx + 1].focus();
                } else {
                     inputs[nextIdx].focus();
                }
            }
        });
        
        // å›žåˆ é€»è¾‘
        input.addEventListener('keydown', (e) => {
            if (e.key === 'Backspace' && e.target.value === '') {
                if (idx > 0) inputs[idx - 1].focus();
            }
            if (e.key === 'Enter' && idx === 3) {
                 document.getElementById('world-confirm-btn').click();
            }
        });
        
        input.addEventListener('focus', (e) => e.target.select());
    });
    
    setTimeout(() => inputs[0].focus(), 100);

    document.getElementById('world-cancel-btn').onclick = () => {
        document.body.removeChild(overlay);
        this.resume();
    };

    document.getElementById('world-confirm-btn').onclick = async () => {
        let theme = "";
        inputs.forEach(input => theme += input.value);
        if (theme.length === 0) return showToast("è¯·è¾“å…¥ä¸–ç•Œåç§°");
        document.body.removeChild(overlay);
        await this.generateRandomWorld(theme);
    };
}

// ã€æ–°å¢žã€‘ç”Ÿæˆéšæœºä¸–ç•Œ
// ã€ä¿®å¤ç‰ˆã€‘generateRandomWorld
async generateRandomWorld(theme) {
    this.showTeleportScreen(`æ­£åœ¨å‰å¾€${theme}`, 'dark');
    
    try {
        const { url, key, model } = db.apiSettings;
        if (!url || !key || !model) {
            this.hideTeleportScreen();
            showToast('è¯·å…ˆé…ç½®API');
            this.resume();
            return;
        }
        
        // 1. ã€æ ¸å¿ƒä¿®å¤ã€‘æ¸…é™¤æ—§çš„éšæœºåœ°å›¾è®¿é—®è®°å½•
        // è¿™æ ·æ–°ç”Ÿæˆçš„ random0 æ‰ä¼šè¢«è§†ä¸ºâ€œåˆæ¬¡æŽ¢ç´¢â€
        // æˆ‘ä»¬ä¿ç•™ 'lv1', 'home' ç­‰å›ºå®šåœ°å›¾çš„è®°å½•ï¼Œåªåˆ  'random' å¼€å¤´çš„
        const keptVisits = Array.from(this.visitedLevels).filter(id => !id.startsWith('random'));
        this.visitedLevels = new Set(keptVisits);

        // 2. æ¸…ç†å†…å­˜ä¸­çš„åœ°å›¾åˆ—è¡¨ (ä¿ç•™å›ºå®šåœ°å›¾ï¼Œç§»é™¤æ—§éšæœºåœ°å›¾)
        // é˜²æ­¢ä¸Šä¸€å±€çš„ random1 ç•™åœ¨æ•°ç»„é‡Œå¹²æ‰°
        this.LEVELS = this.LEVELS.filter(lv => lv.type !== 'random');

        // 3. é‡ç½®éšæœºåœ°å›¾æ•°æ®
        this.randomMapData = {
            worldTheme: theme,
            currentMapIndex: 0,
            mapStories: [],
            storyPoints: [],
            triggeredPoints: new Set(),
            mapStates: {} // ã€ç¡®ä¿è¿™è¡Œå­˜åœ¨ã€‘
        };
        
        // 4. ç”Ÿæˆç¬¬ä¸€å¼ åœ°å›¾
        await this.generateNextRandomMap();
        
        setTimeout(() => {
            this.hideTeleportScreen();
        }, 800);
        
    } catch (e) {
        console.error('ç”Ÿæˆä¸–ç•Œå¤±è´¥:', e);
        this.hideTeleportScreen();
        showToast('ç”Ÿæˆå¤±è´¥: ' + e.message);
        this.resume();
    }
}




// ã€ä¿®å¤ç‰ˆã€‘ç¡®ä¿åœ°å›¾è¿žé€šæ€§ (Dijkstra æƒé‡ç‰ˆ)
ensureMapConnectivity(mapLines) {
    // 1. è½¬ä¸ºäºŒç»´æ•°ç»„
    let grid = mapLines.map(line => line.split(''));
    const h = grid.length;
    const w = grid[0].length;

    // 2. æ‰¾åˆ°èµ·ç‚¹å’Œæ‰€æœ‰ç›®æ ‡
    let start = null;
    let targets = []; 

    for (let y = 0; y < h; y++) {
        for (let x = 0; x < w; x++) {
            const char = grid[y][x];
            if (char === 'S' || char === 'P') start = { x, y };
            // è®°å½•ç›®æ ‡ï¼ŒåŒæ—¶è®°å½•å®ƒæ˜¯å¹²å˜›çš„ï¼Œæ–¹ä¾¿åŽç»­å¤„ç†
            if (char === 'E' || char === 'T') targets.push({ x, y, id: `${x},${y}` });
        }
    }

    if (!start) return mapLines; 

    // 3. å®šä¹‰å¸¦æƒé‡çš„å¯»è·¯å‡¿å¢™å‡½æ•°
    // åŽŸç†ï¼šä¼˜å…ˆèµ°å¹³åœ°ï¼Œå®žåœ¨æ²¡è·¯äº†æ‰å‡¿å¢™
    const carvePathToTarget = (target) => {
        // ä¼˜å…ˆé˜Ÿåˆ— (æŒ‰æ¶ˆè€—æŽ’åº)
        // ç»“æž„: { x, y, cost, parent }
        let queue = [{ x: start.x, y: start.y, cost: 0, parent: null }];
        let visited = new Map(); // key: "x,y", value: minCost

        while (queue.length > 0) {
            // å–å‡ºæ¶ˆè€—æœ€å°çš„èŠ‚ç‚¹ (æ¨¡æ‹Ÿä¼˜å…ˆé˜Ÿåˆ—)
            queue.sort((a, b) => a.cost - b.cost);
            const curr = queue.shift();
            const key = `${curr.x},${curr.y}`;

            // å¦‚æžœå·²ç»è®¿é—®è¿‡ä¸”ä¹‹å‰çš„è·¯å¾„ä»£ä»·æ›´å°ï¼Œè·³è¿‡
            if (visited.has(key) && visited.get(key) <= curr.cost) continue;
            visited.set(key, curr.cost);

            // åˆ°è¾¾ç›®æ ‡ï¼Ÿå¼€å§‹å›žæº¯å‡¿å¢™
            if (curr.x === target.x && curr.y === target.y) {
                let node = curr;
                while (node) {
                    const tile = grid[node.y][node.x];
                    // åªå‡¿å¢™ï¼Œä¸è¦†ç›–å…¶ä»–ç‰¹æ®Šç‰©ä½“(å¦‚ M, B, T)
                    if (tile === '#') {
                        grid[node.y][node.x] = '.';
                    }
                    node = node.parent;
                }
                return; // æžå®šä¸€ä¸ªç›®æ ‡ï¼Œé€€å‡º
            }

            // æŽ¢ç´¢å››å‘¨
            const dirs = [[0, 1], [0, -1], [1, 0], [-1, 0]];
            for (let d of dirs) {
                const nx = curr.x + d[0];
                const ny = curr.y + d[1];

                // ã€ä¿®å¤æ ¸å¿ƒã€‘èŒƒå›´æ£€æŸ¥æ”¾å®½ï¼šå…è®¸è®¿é—®è¾¹ç¼˜ (0 å’Œ w-1)
                // è¿™æ ·å¦‚æžœå‡ºå£åœ¨è¾¹ç¼˜ï¼Œä¹Ÿèƒ½æ‰¾å¾—åˆ°
                if (nx >= 0 && nx < w && ny >= 0 && ny < h) {
                    const nextTile = grid[ny][nx];
                    
                    // è®¡ç®—ä»£ä»·
                    // å¦‚æžœæ˜¯æ™®é€šè·¯æˆ–è€…ç›®æ ‡ç‚¹ï¼Œä»£ä»·å° (èµ°æ­£é“)
                    // å¦‚æžœæ˜¯å¢™ï¼Œä»£ä»·æžå¤§ (é™¤éžé€¼ä¸å¾—å·²ï¼Œå¦åˆ™ä¸èµ°å¢™)
                    let moveCost = 1; 
                    if (nextTile === '#') moveCost = 50; // å‡¿å¢™ä»£ä»·é«˜
                    
                    // å°†æ–°èŠ‚ç‚¹åŠ å…¥é˜Ÿåˆ—
                    const newCost = curr.cost + moveCost;
                    const nextKey = `${nx},${ny}`;
                    
                    if (!visited.has(nextKey) || visited.get(nextKey) > newCost) {
                        queue.push({ 
                            x: nx, y: ny, 
                            cost: newCost, 
                            parent: curr 
                        });
                    }
                }
            }
        }
    };

    // 4. å¯¹æ¯ä¸ªç›®æ ‡åˆ†åˆ«æ‰§è¡Œå¯»è·¯
    targets.forEach(t => {
        carvePathToTarget(t);
    });
    
    // 5. é¢å¤–æ¸…ç†ï¼šé˜²æ­¢ T æˆ– E è¢«æ­»è§’å¡ä½
    // å¦‚æžœç›®æ ‡ç‚¹å››å‘¨å…¨æ˜¯éšœç¢ç‰©ï¼Œå¼ºåˆ¶æ‰“é€šä¸Šæ–¹æˆ–å·¦æ–¹
    targets.forEach(t => {
        const dirs = [[0, 1], [0, -1], [1, 0], [-1, 0]];
        const isBlocked = dirs.every(d => {
            const nx = t.x + d[0];
            const ny = t.y + d[1];
            // è¶…å‡ºè¾¹ç•Œç®—é€šï¼Œæˆ–è€…ä¸æ˜¯å¢™ç®—é€š
            if (nx < 0 || nx >= w || ny < 0 || ny >= h) return true; 
            return grid[ny][nx] === '#'; 
        });

        if (isBlocked) {
            // ä¼˜å…ˆæ‰“é€šä¸Šæ–¹ï¼Œå¦‚æžœä¸Šæ–¹æ˜¯è¾¹ç•Œåˆ™æ‰“é€šå·¦æ–¹
            if (t.y > 0) grid[t.y - 1][t.x] = '.';
            else if (t.x > 0) grid[t.y][t.x - 1] = '.';
        }
    });

    return grid.map(row => row.join(''));
}



// ã€é‡æž„ç‰ˆ V5ã€‘ç”Ÿæˆä¸‹ä¸€å¼ éšæœºåœ°å›¾ (æŒ‰æ ‡ç‚¹è‡ªåŠ¨æ–­å¥ + æ™ºèƒ½è¡¥å…¨å‘è¨€äºº)
async generateNextRandomMap() {
    const idx = this.randomMapData.currentMapIndex;

    if (idx >= 5) {
        showToast('å†’é™©ç»“æŸï¼');
        const homeIdx = this.LEVELS.findIndex(lv => lv.type === 'home');
        this.loadLevel(homeIdx, 'start');
        return;
    }

    try {
        const { url, key, model } = db.apiSettings;
        if (!url || !key) throw new Error("è¯·å…ˆé…ç½®API");

        // ... (äººè®¾å‡†å¤‡ä»£ç ä¿æŒä¸å˜) ...
        const p1RealName = db.forumUserIdentity?.nickname || this.p1.name;
        const p1GameName = this.p1.name;
        let p1PersonaText = this.p1.persona;
        
        if (!p1PersonaText) {
            // å…œåº•é€»è¾‘ï¼šè¯»å–é¡µé¢æˆ–æ•°æ®åº“
            p1PersonaText = document.getElementById('p1-persona-hidden')?.value || "";
            if (!p1PersonaText && db.myPersonaPresets && db.myPersonaPresets.length > 0) {
                p1PersonaText = db.myPersonaPresets[0].persona;
            }
        }
        if (!p1PersonaText) p1PersonaText = "å‹‡æ•¢çš„å†’é™©è€…ã€‚";

        // --- P2 (ä¼™ä¼´) ã€æ ¸å¿ƒä¿®æ”¹åŒºã€‘ ---
        // ç›´æŽ¥ä»Žå½“å‰æ¸¸æˆå®žä¾‹çš„ p2.customData ä¸­è¯»å–
        // è¿™æ ·æ— è®ºè¯»å“ªä¸ªå­˜æ¡£ï¼Œéƒ½æ˜¯è·Ÿç€å­˜æ¡£èµ°çš„
        let p2RealName = this.p2.customData?.realName || this.p2.name;
        let p2PersonaText = this.p2.customData?.persona;

        // ã€å…¼å®¹æ—§å­˜æ¡£çš„å…œåº•é€»è¾‘ã€‘
        // å¦‚æžœæ˜¯è€å­˜æ¡£ï¼ŒcustomData é‡Œå¯èƒ½æ²¡æœ‰ personaï¼Œè¿™æ—¶å€™æ‰åŽ»è¯•ç€è¯»å…¨å±€å˜é‡æˆ–é»˜è®¤å€¼
        if (!p2PersonaText) {
            console.warn("å½“å‰å­˜æ¡£æ— P2äººè®¾æ•°æ®ï¼Œå°è¯•ä½¿ç”¨å…¨å±€å›žé€€...");
            if (typeof selectedPartnerCharId !== 'undefined' && selectedPartnerCharId) {
                const partnerChar = db.characters.find(c => c.id === selectedPartnerCharId);
                if (partnerChar) {
                    p2RealName = partnerChar.realName;
                    p2PersonaText = partnerChar.persona;
                }
            }
        }
        // æœ€ç»ˆå…œåº•
        if (!p2PersonaText) p2PersonaText = "å¿ è¯šçš„ä¼™ä¼´ï¼Œæ€§æ ¼å¼€æœ—ã€‚";

        const characterContext = `
ã€è§’è‰²èµ„æ–™ã€‘
å‹‡è€…ï¼ˆä¸å‘è¨€ï¼‰: æ¸¸æˆå[${p1GameName}]ã€‚
å‹‡è€…è®¾å®š: ${p1PersonaText}

å†’é™©ä¼™ä¼´: çœŸå[${p2RealName}] ï¼Œæ¸¸æˆå[${this.p2.name}]ã€‚
å†’é™©ä¼™ä¼´äººè®¾: ${p2PersonaText}

ã€å¯¹è¯è§„åˆ™ - ç»å¯¹æ‰§è¡Œã€‘
1. **å‹‡è€…åœ¨å¼€åœºå‰§æƒ…ä¸­å§‹ç»ˆä¿æŒæ²‰é»˜**ï¼Œä¸è¦ç”Ÿæˆå‹‡è€…çš„å°è¯ã€‚
2. å¼€åœºå‰§æƒ…åªèƒ½ç”± **å†’é™©ä¼™ä¼´** å‘è¨€ï¼Œæˆ–è€…ä½¿ç”¨ **æ—ç™½** æå†™ã€‚
3. **å†’é™©ä¼™ä¼´** çš„è¯­æ°”å¿…é¡»ç¬¦åˆäººè®¾ã€‚
`;

        // ==========================================
        // 2. æž„å»º Prompt
        // ==========================================
        let prompt = "";
        const theme = this.randomMapData.worldTheme;
        
        const commonHeader = `ä½ æ˜¯ä¸€ä¸ªæ¸¸æˆå‰§æœ¬ä½œå®¶ï¼Œä½ æ­£åœ¨æ’°å†™ä¸€ä¸ªå¤©é©¬è¡Œç©ºçš„å†’é™©æ•…äº‹ã€‚è¯·æ ¹æ®ä»¥ä¸‹è¦æ±‚ç”Ÿæˆçº¯æ–‡æœ¬å†…å®¹ã€‚
ã€å†’é™©ä¸–ç•Œåç§°ã€‘: ${theme}
${characterContext}

`;

        // --- åœºæ™¯ A: ç¬¬1å…³ ---
        if (idx === 0) {
            prompt = `${commonHeader}
ã€ä»»åŠ¡ã€‘
1.é¦–å…ˆï¼Œè¯·ä½ è®¾è®¡ä¸–ç•Œå…¥å£å¤„çš„**åœ°å›¾é…è‰²** (Hexé¢œè‰²ä»£ç )ï¼Œå®šä¸‹æ•…äº‹åœºæ™¯åŸºè°ƒã€‚
2. ç„¶åŽè¯·ä½ å…ˆæ’°å†™æ•´ä¸ªæ•…äº‹çš„5ç« èŠ‚å¤§çº²ï¼Œæƒ…èŠ‚å¤©é©¬è¡Œç©ºã€è·Œå®•èµ·ä¼ï¼Œè¦æœ‰åè½¬ã€‚
3. æŽ¥ç€ï¼Œè¯·ç”Ÿæˆç¬¬1ç« å¼€åœºå¯¹è¯ï¼ˆ**ä»…ä¼™ä¼´å‘è¨€æˆ–æ—ç™½**ï¼‰ã€‚


ã€æ ¼å¼æŒ‡ä»¤ - å¿…é¡»ä½¿ç”¨æ ‡ç­¾ã€‘
#META_DATA#
å¢™å£é¢œè‰²: [Hexä»£ç , å¦‚ #1e824c]
åœ°é¢é¢œè‰²: [Hexä»£ç , å¦‚ #27ae60]

#GRAND_PLOT#
ç¬¬1ç« : [å†…å®¹]
...
ç¬¬5ç« : [ç»“å±€]

#STORY_OPENING#
æ—ç™½
${this.p2.name}ï¼šä¼™ä¼´çš„å°è¯
...


`;
        }
        
        // --- åœºæ™¯ B: ç¬¬5å…³ (å†³æˆ˜) ---
        else if (idx === 4) {
            const grandPlot = this.randomMapData.grandPlot || [];
            const summary = grandPlot[4] || "æœ€ç»ˆå†³æˆ˜ã€‚";
            
            prompt = `${commonHeader}
ã€è¿›åº¦ã€‘ç¬¬5ç« (æœ€ç»ˆç« )
ã€å¤§çº²ã€‘${summary}

ã€ä»»åŠ¡ã€‘
1. è¯·ä½ è®¾è®¡æœ€ç»ˆæˆ˜æ–—åœºæ™¯çš„é…è‰²å’Œæœ€ç»ˆbossçš„åç§°ã€‚
2. è¯·ä½ æ’°å†™å†³æˆ˜å‰å¼€åœºç™½ï¼ˆ**ä»…ä¼™ä¼´å‘è¨€æˆ–æ—ç™½**ï¼‰ã€‚
3. è¯·æ’°å†™æˆ˜èƒœBOSSåŽçš„ç»“å±€å‰§æƒ…ï¼ˆç”±ä¼™ä¼´ä¸»å¯¼ï¼‰ã€‚

ã€æ ¼å¼æŒ‡ä»¤ã€‘
#META_DATA#
BOSSåç§°: [éœ¸æ°”çš„åå­—]
å¢™å£é¢œè‰²: [Hex]
åœ°é¢é¢œè‰²: [Hex]

#STORY_OPENING#
æ—ç™½
${this.p2.name}ï¼šæˆ˜å‰å‘è¨€
â€¦â€¦

#STORY_ENDING#
æ—ç™½ä¾‹å¦‚BOSSå€’ä¸‹
${this.p2.name}ï¼šç»“å±€å°è¯
â€¦â€¦
`;
        }
        
        // --- åœºæ™¯ C: ä¸­é—´å…³å¡ ---
        else {
            const grandPlot = this.randomMapData.grandPlot || [];
            const summary = grandPlot[idx] || "æŽ¢ç´¢ä¸­ã€‚";
            
            prompt = `${commonHeader}

ã€å¤§çº²ã€‘${summary}
ã€è¿›åº¦ã€‘çŽ°åœ¨ä½ æ­£åœ¨æ’°å†™ç¬¬${idx+1}ç« 

ã€ä»»åŠ¡ã€‘
1. è¯·ä½ è®¾è®¡æœ¬å…³çš„ **æ€ªç‰©åç§°** å’Œ **åœ°å›¾é…è‰²** (Hexé¢œè‰²ä»£ç )ï¼Œéœ€ç¬¦åˆä¸»é¢˜æ°›å›´ã€‚
2. æ’°å†™æœ¬ç« èŠ‚çš„å¼€åœºå‰§æƒ…ï¼ˆ**ä»…ä¼™ä¼´å‘è¨€æˆ–æ—ç™½**ï¼‰ã€‚
3. æ’°å†™3ä¸ªå†’é™©ä¸­çš„çªå‘å‰§æƒ…ï¼Œå¯æœ‰Npcå‚ä¸Žï¼Œä¹Ÿå¯ä»¥æ²¡æœ‰ï¼ˆ**å‰§æƒ…ä»…ä¼™ä¼´ã€Npcå‘è¨€æˆ–æ—ç™½**ï¼‰ï¼Œè¿™äº›å‰§æƒ…å‘ç”ŸåŽï¼Œè¿™ä¸ªåœ°å›¾çš„å‡ºå£æ‰ä¼šè§£é”ã€‚
4. 11x11åœ°å›¾çŸ©é˜µã€‚åŒ…å«ï¼šP(å…¥å£), E(å‡ºå£), 3ä¸ªT(çªå‘å‰§æƒ…è§¦å‘ç‚¹), 2-4ä¸ªM(æ€ªç‰©)ã€‚På’ŒEè¦ç¦»å¾—è¿œä¸€ç‚¹ã€‚

ã€æ ¼å¼æŒ‡ä»¤ã€‘
#META_DATA#
å°æ€ªåç§°: [ä¾‹å¦‚: æ£®æž—å²èŽ±å§†]
å¢™å£é¢œè‰²: [Hexä»£ç , å¦‚ #1e824c]
åœ°é¢é¢œè‰²: [Hexä»£ç , å¦‚ #27ae60]

#STORY_OPENING#
æ—ç™½
${this.p2.name}ï¼šå°è¯...
â€¦â€¦

#STORY_POINTS#
æ—ç™½
${this.p2.name}ï¼šå°è¯...
æŸæ€ªç‰©ï¼šå°è¯
â€¦â€¦
===SEP===
æ—ç™½
å°å¥³å­©ï¼šå°è¯
${this.p2.name}ï¼šå°è¯...
â€¦â€¦
===SEP===
æ—ç™½
${this.p2.name}ï¼šå°è¯...
â€¦â€¦

#MAP_BLOCK#
###########
#P.#...M..#
#.###.###.#
#T....#..E#
#.#####.###
#...M.....#
###.###.###
#...T.#...#
#.#######.#
#M......T.#
###########
`;
        }

        // --- API è¯·æ±‚ ---
        const response = await fetch(`${url}/v1/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${key}` },
            body: JSON.stringify({
                model: model,
                messages: [{ role: "user", content: prompt }],
                temperature: 0.85, 
                max_tokens: 2500
            })
        });

        if (!response.ok) throw new Error(`APIè¯·æ±‚å¤±è´¥`);
        const data = await response.json();
        let rawContent = data.choices[0].message.content;

// ==========================================
// â˜…â˜…â˜… ä¿®å¤ç‰ˆï¼šæ™ºèƒ½åˆ‡å‰² + æœç»ç©ºå¯¹è¯æ¡† â˜…â˜…â˜…
// ==========================================
const splitDialogueByPunctuation = (lines) => {
    let result = [];
    lines.forEach(line => {
        line = line.trim();
        if (!line) return; // è¿‡æ»¤ç©ºè¡Œ

        let speakerPrefix = "";
        let content = line;

        // 1. å°è¯•æå–å‘è¨€äºº
        if (line.match(/[:ï¼š]/)) {
            const parts = line.split(/[:ï¼š]/);
            // åªæœ‰å½“å‰ç¼€è¾ƒçŸ­æ—¶æ‰è®¤ä¸ºæ˜¯åå­—
            if (parts[0].length < 10) {
                const potentialName = parts[0].trim();
                const potentialContent = parts.slice(1).join("ï¼š").trim();
                
                // ã€æ ¸å¿ƒä¿®å¤ã€‘åªæœ‰å½“å†’å·åŽé¢çœŸçš„æœ‰å†…å®¹æ—¶ï¼Œæ‰æå–åå­—
                // å¦‚æžœæ˜¯ "ä¼™ä¼´ï¼š" è¿™ç§ç©ºå†…å®¹ï¼Œç›´æŽ¥è§†ä¸ºæ— æ•ˆè¡Œæˆ–çº¯æ—ç™½
                if (potentialContent.length > 0) {
                    speakerPrefix = potentialName + "ï¼š";
                    content = potentialContent;
                } else {
                    // åªæœ‰åå­—æ²¡æœ‰å†…å®¹ï¼Œè·³è¿‡æ­¤è¡Œï¼Œé˜²æ­¢å‡ºçŽ°â€œåªæœ‰åå­—çš„ç©ºæ¡†â€
                    return;
                }
            }
        }

        // 2. æŒ‰æ ‡ç‚¹ç¬¦å·åˆ‡åˆ†
        // è§£é‡Šï¼šå°† å¥å·/æ„Ÿå¹å·/é—®å·/çœç•¥å· åŠå…¶ç´§è·Ÿçš„é—­åˆç¬¦å· è§†ä¸ºä¸€ä¸ªæ•´ä½“
        const segments = content
            .replace(/([ã€‚ï¼ï¼Ÿâ€¦]+)([â€â€™"'\)\]ã€‘ï¼‰]*)/g, "$1$2<SPLIT>") 
            .split('<SPLIT>')
            .map(s => s.trim())
            .filter(s => s.length > 0); // ã€æ ¸å¿ƒä¿®å¤ã€‘è¿‡æ»¤åˆ‡åˆ†åŽäº§ç”Ÿçš„ç©ºå­—ç¬¦ä¸²

        // 3. é‡ç»„
        if (segments.length === 0) {
            // å¦‚æžœæ²¡æœ‰æ ‡ç‚¹ï¼ˆæ¯”å¦‚ä¸€å¥è¯æ²¡è¯´å®Œï¼‰ï¼Œä¿ç•™åŽŸæ ·
            if (content) result.push(speakerPrefix + content);
        } else {
            segments.forEach(seg => {
                // ç¡®ä¿æ¯ä¸€å°æ®µéƒ½å¸¦ä¸Šåå­—
                result.push(speakerPrefix + seg);
            });
        }
    });
    return result;
};

        // è¿‡æ»¤çŽ©å®¶å‘è¨€å·¥å…·
        const filterPlayerLines = (lines) => {
            return lines.filter(line => {
                if (line.includes(':') || line.includes('ï¼š')) {
                    const parts = line.split(/[:ï¼š]/);
                    const speaker = parts[0].trim();
                    if (speaker === p1RealName || speaker === p1GameName || speaker === 'æˆ‘' || speaker === 'çŽ©å®¶') {
                        return false; 
                    }
                }
                return true;
            });
        };

        // ==========================================
        // 4. æ¸…æ´—ä¸Žè§£æž
        // ==========================================
        let content = rawContent
            .replace(/\*\*/g, '')
            .replace(/```\w*/g, '')
            .replace(/[\[\]ã€ã€‘]/g, '') 
            .trim();

        console.log(`ç¬¬${idx+1}å…³ç”ŸæˆåŽŸæ–‡:`, content);

        const getSection = (tag) => {
            if (!content.includes(tag)) return null;
            let parts = content.split(tag);
            if (parts.length < 2) return null;
            let section = parts[1];
            const knownTags = ['#META_DATA#',
  '#GRAND_PLOT#', '#STORY_OPENING#', '#STORY_POINTS#', '#STORY_ENDING#', '#MAP_BLOCK#'];
            let minIndex = section.length;
            knownTags.forEach(t => {
                if (t === tag) return;
                let idx = section.indexOf(t);
                if (idx !== -1 && idx < minIndex) minIndex = idx;
            });
            return section.substring(0, minIndex).trim();
        };
        
                // --- è§£æžå…ƒæ•°æ® (æ–°åŠŸèƒ½) ---
        let aiMonsterName = null;
        let aiBossName = null;
        let aiColors = null;

        const metaText = getSection('#META_DATA#');
        if (metaText) {
            const lines = metaText.split('\n');
            lines.forEach(line => {
                if (line.includes('å°æ€ªåç§°')) aiMonsterName = line.split(/[:ï¼š]/)[1]?.trim();
                if (line.includes('BOSSåç§°')) aiBossName = line.split(/[:ï¼š]/)[1]?.trim();
                
                // é¢œè‰²è§£æž
                if (!aiColors) aiColors = {};
                if (line.includes('å¢™å£é¢œè‰²')) aiColors.wall = line.match(/#[0-9a-fA-F]{3,6}/)?.[0];
                if (line.includes('åœ°é¢é¢œè‰²')) aiColors.floor = line.match(/#[0-9a-fA-F]{3,6}/)?.[0];
            });
        }
        
        // æ ¡éªŒé¢œè‰²ï¼Œå¦‚æžœ AI æ²¡ç”Ÿæˆæœ‰æ•ˆçš„ï¼Œåˆ™è®¾ä¸º null ä»¥è§¦å‘å…œåº•
        if (aiColors && (!aiColors.wall || !aiColors.floor)) aiColors = null;

        // --- è§£æžå¤§çº² ---
        const plotText = getSection('#GRAND_PLOT#');
        if (plotText) {
            this.randomMapData.grandPlot = plotText.split('\n').filter(l => l.trim().length > 2);
        }

        // --- è§£æžå¼€åœº (åº”ç”¨æ–­å¥ + è¿‡æ»¤) ---
        let openingText = getSection('#STORY_OPENING#');
        if (!openingText && !content.includes('#')) openingText = content; 
        
        let openingStories = openingText 
            ? openingText.split(/\n|\|/).map(s => s.trim()).filter(s => s.length > 1) 
            : ["(å‘¨å›´å¾ˆå®‰é™...)"];

        // 1. å…ˆæŒ‰æ ‡ç‚¹ç»†åˆ†
        openingStories = splitDialogueByPunctuation(openingStories);
        // 2. å†è¿‡æ»¤çŽ©å®¶å‘è¨€ (è¿™æ ·å¦‚æžœçŽ©å®¶è¯´äº†ä¸‰å¥è¯ï¼Œä¸‰å¥éƒ½ä¼šè¢«åˆ æŽ‰)
        openingStories = filterPlayerLines(openingStories);
        
        if (openingStories.length === 0) openingStories.push("(ä½ ä»¬é™é™åœ°çœ‹ç€å‰æ–¹...)");

        // --- è§£æžå‰§æƒ…ç‚¹ (ä¸åº”ç”¨æ–­å¥ï¼Œå› ä¸ºå‰§æƒ…ç‚¹é€šå¸¸åªéœ€ä¸€å¥è¯) ---
        const pointsText = getSection('#STORY_POINTS#');
        let pointStories = [];
        if (pointsText) {
        const rawPoints = pointsText.split('===SEP===')
                .map(s => s.trim())
                .filter(s => s.length > 2);
        pointStories = rawPoints.map(rawText => {
                // å…ˆæŒ‰æ¢è¡Œç¬¦æ‹†ä¸€ä¸‹ï¼Œé˜²æ­¢AIæ²¡ç”¨æ ‡ç‚¹ä½†ç”¨äº†æ¢è¡Œ
                let lines = rawText.split(/\n|\|/);
                // åº”ç”¨æ™ºèƒ½åˆ‡åˆ†
                let processed = splitDialogueByPunctuation(lines);
                // åº”ç”¨çŽ©å®¶ç¦è¨€è¿‡æ»¤ (ä¿æŒä¸€è‡´æ€§)
              return filterPlayerLines(processed);
            });          
        }

        // --- è§£æžç»“å±€ (åº”ç”¨æ–­å¥) ---
        const endingText = getSection('#STORY_ENDING#');
        let endingStories = [];
        if (endingText) {
            let rawEnding = endingText.split(/\n|\|/).map(s => s.trim()).filter(s => s.length > 1);
            // ç»“å±€åº”ç”¨æ–­å¥
            endingStories = splitDialogueByPunctuation(rawEnding);
        }

        // --- è§£æžåœ°å›¾ (ä¸å˜) ---
        let mapLines = [];
        const mapText = getSection('#MAP_BLOCK#');
        
        if (idx === 0) {
            mapLines = ["#######","#S....#","#.....#","#.....#","#.....#","#.....#","#.....#","#....E#","#######"];
        } else if (idx === 4) {
            mapLines = ["#################","#...............#","#P..............#","#...............#","#...............#","#......B........#","#...............#","#...............#","#...............#","#################"];
        } else {
            // è§£æž AI åœ°å›¾
            if (mapText) mapLines = mapText.split('\n').map(l => l.trim()).filter(l => l.length >= 5);
            
            // â˜…è´¨é‡æ£€æµ‹â˜…
            let isValid = true;
            if (mapLines.length < 5) isValid = false;
            else {
                // æ£€æŸ¥å…³é”®å…ƒç´ æ˜¯å¦å­˜åœ¨
                const fullStr = mapLines.join('');
                if (!fullStr.includes('T') || !fullStr.includes('E')) {
                    console.warn("AIç”Ÿæˆçš„åœ°å›¾ç¼ºå°‘å…³é”®å…ƒç´ (Tæˆ–E)ï¼Œä¸¢å¼ƒ");
                    isValid = false;
                }
                const wallCount = fullStr.split('#').length - 1;
                if (wallCount < 45) { // 11x11åœ°å›¾è¾¹æ¡†å¤§çº¦40ä¸ª#ï¼Œå¦‚æžœæ€»æ•°å¾ˆå°‘ï¼Œè¯´æ˜Žå†…éƒ¨æ˜¯ç©ºçš„
                    console.warn("AIç”Ÿæˆçš„åœ°å›¾å¤ªç®€å•(ç©ºæˆ¿é—´)ï¼Œä¸¢å¼ƒ");
                    isValid = false;
                }
            }
            // å¦‚æžœæ— æ•ˆï¼Œå¼ºåˆ¶ä½¿ç”¨é»˜è®¤åœ°å›¾
            if (!isValid) {
                console.warn("ä½¿ç”¨é»˜è®¤å¤‡ç”¨åœ°å›¾");
                mapLines = this.getDefaultRandomMap(idx);
            }
            // ç¡®ä¿è¿žé€šæ€§ (é˜²æ­¢AIç”»äº†å¢™æŠŠè·¯å µæ­»)
            try { mapLines = this.ensureMapConnectivity(mapLines); } catch (e) {}
        }

        // ==========================================
        // 5. åº”ç”¨æ•°æ®å¹¶åŠ è½½ (ä¸å˜)
        // ==========================================
        this.randomMapData.mapStories[idx] = {
            opening: openingStories,
            points: pointStories,
            ending: endingStories
        };
        this.randomMapData.usedPointIndices = [];

        // å†³å®šæ€ªç‰©åå­— (ä¼˜å…ˆ AIï¼Œå¤±è´¥åˆ™å›žé€€)
        const fallbackNames = this.getThemeMonsterName(theme, idx);
        const finalMonsterName = aiMonsterName || fallbackNames.normal;
        const finalBossName = aiBossName || fallbackNames.boss;

        // å†³å®šé¢œè‰² (ä¼˜å…ˆ AIï¼Œå¤±è´¥åˆ™å›žé€€)
        const finalColors = aiColors || this.getRandomColors();
                const newLevel = {
            id: `random${idx}`,
            name: (idx === 4) ? `${theme}Â·ç»ˆ` : (idx === 0 ? `${theme}Â·åº` : `${theme}Â·${idx+1}`),
            type: 'random',
            intro: openingStories[0], 
            colors: finalColors, // åº”ç”¨é¢œè‰²
            enemyPool: (idx === 0) ? null : { 
                name: finalMonsterName, // åº”ç”¨å°æ€ªå
                hp: 50 + idx * 20, atk: 10 + idx * 5, lv: 2 + idx * 2, xp: 50 
            },
            map: mapLines
        };

        if (idx === 4) {
            newLevel.boss = { 
                name: finalBossName, // åº”ç”¨BOSSå
                hp: 800, atk: 45, lv: 15 
            };
        }

        const homeIdx = this.LEVELS.findIndex(lv => lv.type === 'home');
        let insertIdx = (homeIdx !== -1) ? homeIdx + 1 : this.LEVELS.length;
        for (let i = this.LEVELS.length - 1; i > homeIdx; i--) {
            if (this.LEVELS[i].type === 'random') { insertIdx = i + 1; break; }
        }
        
        const existingIdx = this.LEVELS.findIndex(lv => lv.id === `random${idx}`);
        if (existingIdx !== -1) this.LEVELS[existingIdx] = newLevel;
        else this.LEVELS.splice(insertIdx, 0, newLevel);

        this.loadLevel(this.LEVELS.findIndex(lv => lv.id === `random${idx}`), 'start');
        this.resize(); this.updateCamera(true); this.draw(); 
        if (!this.isRunning) this.start();

    } catch (e) {
        console.error('åœ°å›¾ç”Ÿæˆé”™è¯¯:', e);
        this.hideTeleportScreen();
        showToast('ç”Ÿæˆå¤±è´¥: ' + e.message);
        throw e;
    }
}

// ã€ä¿®å¤3ã€‘æ–°å¢žï¼šéšæœºèŽ·å–åœ°å›¾é…è‰²æ–¹æ¡ˆ
getRandomColors() {
    const palettes = [
        { floor: "#27ae60", wall: "#1e824c" }, // æ£®æž—ç»¿
        { floor: "#95a5a6", wall: "#7f8c8d" }, // åºŸå¢Ÿç°
        { floor: "#e67e22", wall: "#d35400" }, // ç«ç„°çº¢
        { floor: "#3498db", wall: "#2980b9" }, // å†°éœœè“
        { floor: "#9b59b6", wall: "#8e44ad" }, // æ¯’æ²¼ç´«
        { floor: "#f1c40f", wall: "#f39c12" }, // æ²™æ¼ é»„
        { floor: "#1abc9c", wall: "#16a085" }, // ç¿¡ç¿ é’
        { floor: "#34495e", wall: "#2c3e50" }  // æ·±æ¸Šé»‘
    ];
    return palettes[Math.floor(Math.random() * palettes.length)];
}




// ã€ä¿®å¤5ã€‘æ–°å¢žï¼šæ ¹æ®ä¸»é¢˜èŽ·å–æ€ªç‰©åç§°
getThemeMonsterName(theme, idx) {
    // ç®€å•çš„å…³é”®è¯æ˜ å°„
    const suffix = ["å›¢", "çƒ", "ç¾½æ¯›", "èŠ±", "ç‰ç’ƒ"];
    const bossSuffix = ["é¢†ä¸»", "é­”é¾™", "å·¨ç¥ž", "å¥³çŽ‹", "éœ¸ä¸»"];
    
    // å¦‚æžœæ²¡æœ‰ä¸»é¢˜ï¼Œç»™ä¸ªé»˜è®¤
    if (!theme) theme = "è¿·ä¹‹";
    
    // æˆªå–å‰ä¸¤ä¸ªå­—ä½œä¸ºå‰ç¼€ï¼Œé˜²æ­¢åå­—å¤ªé•¿
    const prefix = theme.substring(0, 2);
    
    // ä¼ªéšæœºé€‰æ‹©åŽç¼€
    const nIdx = (theme.length + idx) % suffix.length;
    const bIdx = (theme.length + idx + 1) % bossSuffix.length;
    
    return {
        normal: `${prefix}${suffix[nIdx]}`,
        boss: `${prefix}${bossSuffix[bIdx]}`
    };
}



// ã€ä¿®å¤2ã€‘æ”¯æŒè‡ªå®šä¹‰æ–‡æœ¬å’Œä¸»é¢˜ï¼ˆlight=ç™½åº•, dark=é»‘åº•ï¼‰
showTeleportScreen(customText, theme = 'dark') {
    const screen = document.getElementById('rpg-teleport-screen');
    if (!screen) return;
    
    screen.classList.add('active');
    
    // è®¾ç½®ä¸»é¢˜ç±»
    if (theme === 'light') {
        screen.classList.add('light-theme');
    } else {
        screen.classList.remove('light-theme');
    }
    
    // è®¾ç½®æç¤ºæ–‡æœ¬
    const textEl = screen.querySelector('.rpg-teleport-text');
    if (textEl) {
        const msg = customText || "æ­£åœ¨ä¼ é€è¿›å…¥æ–°ä¸–ç•Œ";
        textEl.innerHTML = `${msg}<span class="rpg-teleport-dots" id="rpg-teleport-dots">...</span>`;
    }

    // ç²’å­æ•ˆæžœï¼ˆä»…åœ¨ dark æ¨¡å¼ä¸‹æ˜¾ç¤ºï¼ŒCSSæŽ§åˆ¶ï¼‰
    const particlesContainer = document.getElementById('rpg-teleport-particles');
    if (particlesContainer && theme === 'dark') {
        particlesContainer.innerHTML = ''; 
        for (let i = 0; i < 30; i++) {
            const particle = document.createElement('div');
            particle.className = 'rpg-particle';
            particle.style.left = Math.random() * 100 + '%';
            particle.style.animationDelay = Math.random() * 3 + 's';
            particle.style.animationDuration = (2 + Math.random() * 2) + 's';
            particlesContainer.appendChild(particle);
        }
    } else if (particlesContainer) {
        particlesContainer.innerHTML = ''; // light æ¨¡å¼æ¸…ç©ºç²’å­
    }
    
    // åŠ¨ç”»ç‚¹
    let dotCount = 0;
    const dotsEl = document.getElementById('rpg-teleport-dots');
    if (dotsEl) {
        if (this.teleportInterval) clearInterval(this.teleportInterval);
        this.teleportInterval = setInterval(() => {
            dotCount = (dotCount + 1) % 4;
            dotsEl.textContent = '.'.repeat(dotCount || 1);
        }, 500);
    }
}

// ã€æ–°å¢žã€‘éšè—ä¼ é€é»‘å±
hideTeleportScreen() {
    const screen = document.getElementById('rpg-teleport-screen');
    if (screen) {
        screen.classList.remove('active');
    }
    
    // æ¸…é™¤åŠ¨ç”»å®šæ—¶å™¨
    if (this.teleportInterval) {
        clearInterval(this.teleportInterval);
        this.teleportInterval = null;
    }
}

// ã€æ–°å¢žã€‘èŽ·å–é»˜è®¤éšæœºåœ°å›¾ï¼ˆå¤‡ç”¨æ–¹æ¡ˆï¼‰
getDefaultRandomMap(idx) {
    const maps = [
        [
            "###########",
            "#S.......E#",
            "#...M.....#",
            "#.#####...#",
            "#.T...M...#",
            "#.....T...#",
            "#.........#",
            "#.........#",
            "#.........#",
            "#.........#",
            "###########"
        ],
        [
            "###########",
            "#P.......E#",
            "#...M.T...#",
            "#.........#",
            "#..T.M....#",
            "#.........#",
            "#.........#",
            "#.........#",
            "#.........#",
            "#.........#",
            "###########"
        ],
        [
            "###########",
            "#P.......E#",
            "#.M.T.M...#",
            "#.........#",
            "#..T......#",
            "#.........#",
            "#.........#",
            "#.........#",
            "#.........#",
            "#.........#",
            "###########"
        ],
        [
            "###########",
            "#P.......E#",
            "#.M...M...#",
            "#...T.T...#",
            "#.........#",
            "#.........#",
            "#.........#",
            "#.........#",
            "#.........#",
            "#.........#",
            "###########"
        ],
        [
            "###########",
            "#P.......E#",
            "#...M.....#",
            "#....B....#",
            "#...M.....#",
            "#.........#",
            "#.........#",
            "#.........#",
            "#.........#",
            "#.........#",
            "###########"
        ]
    ];
    return maps[Math.min(idx, maps.length - 1)];
}

// ã€ä¿®å¤ã€‘è¿›å…¥ä¸‹ä¸€å¼ éšæœºåœ°å›¾
// ã€ä¿®å¤ç‰ˆã€‘è¿›å…¥ä¸‹ä¸€å¼ éšæœºåœ°å›¾ (å¸¦é”ã€å›žæ»šã€æŽ¨äººé€»è¾‘)
async proceedToNextRandomMap() {
    // 1. ã€é”ã€‘å¦‚æžœæ­£åœ¨ç”Ÿæˆä¸­ï¼Œç›´æŽ¥æ— è§†åŽç»­è§¦å‘
    if (this.isGenerating) return;
    this.isGenerating = true;

    // 2. ä¹è§‚æ›´æ–°ç´¢å¼•
    this.randomMapData.currentMapIndex++;
    
    
    // æ£€æŸ¥æ˜¯å¦å…¨éƒ¨é€šå…³
    if (this.randomMapData.currentMapIndex >= 5) {
        showToast('å†’é™©åœ†æ»¡ç»“æŸï¼');
        const homeIdx = this.LEVELS.findIndex(lv => lv.type === 'home');
        this.loadLevel(homeIdx, 'start');
        this.isGenerating = false;
        return;
    }

    try {
        // 3. æ˜¾ç¤ºä¼ é€ç‰¹æ•ˆ
        this.showTeleportScreen("æ­£åœ¨è¿›å…¥ä¸‹ä¸€ä¸ªåŒºåŸŸ", 'light');
        
        // 4. æ‰§è¡Œç”Ÿæˆ (ç­‰å¾…ç»“æžœ)
        await this.generateNextRandomMap();
        
        // 5. æˆåŠŸåŽå»¶è¿Ÿå…³é—­ç‰¹æ•ˆ
        setTimeout(() => {
            this.hideTeleportScreen();
            this.isGenerating = false;
        }, 800);

    } catch (e) {
        // ==========================================
        // ã€æ ¸å¿ƒä¿®å¤ã€‘å¤±è´¥å›žæ»šæœºåˆ¶
        // ==========================================
        console.warn("ç”Ÿæˆå¤±è´¥ï¼Œæ‰§è¡Œå›žæ»šæ“ä½œ");
        
        // 1. ç´¢å¼•å›žé€€ (æ¢å¤åˆ°ä¸Šä¸€å…³)
        this.randomMapData.currentMapIndex--;
        
        // 2. å…³é—­ç‰¹æ•ˆ
        this.hideTeleportScreen();
        
        // 3. çŽ©å®¶åŽé€€ä¸€æ­¥ (é˜²æ­¢ç«™åœ¨å‡ºå£ä¸Šæ— é™è§¦å‘)
        // å‡è®¾å‡ºå£æ˜¯ Eï¼ŒçŽ©å®¶åœ¨ E ä¸Šã€‚ç®€å•çš„å¤„ç†æ˜¯æ ¹æ®æœå‘åå‘ç§»åŠ¨ï¼Œæˆ–è€…å›ºå®š x-1
        // è¿™é‡Œç®€å•ç²—æš´åœ°è®©çŽ©å®¶ x-1 (é€šå¸¸è¿·å®«å‡ºå£åœ¨å³è¾¹ï¼Œå¾€å·¦æŽ¨ä¸€æ­¥é€šå¸¸æ˜¯å®‰å…¨çš„)
        if (this.p1.x > 1) this.p1.x -= 1;
        this.p2.x = this.p1.x;
        this.p2.y = this.p1.y;
        
        // 4. æ›´æ–°ç”»é¢
        this.updateCamera(true);
        this.draw();
        
        // 5. æ¢å¤æ¸¸æˆå¾ªçŽ¯
        this.isGenerating = false;
        this.resume();
        
        showToast('ç”Ÿæˆå¤±è´¥ï¼Œè¯·ç¨åŽé‡è¯•');
    }
}

// ã€æ–°å¢žã€‘è§¦å‘å‰§æƒ…ç‚¹
triggerStoryPoint(point) {
    if (this.curLv.type !== 'random') return;
    
    const mapId = this.curLv.id;
    const mapState = this.randomMapData.mapStates[mapId];
    const pointKey = `${point.x},${point.y}`;
    
    // ã€å…³é”®ã€‘é˜²æ­¢é‡å¤è§¦å‘
    if (!mapState || mapState.triggered.has(pointKey)) return;

    // 1. è®°å½•è§¦å‘çŠ¶æ€ï¼ˆåªè®°å½•åœ¨å½“å‰åœ°å›¾çš„ Set é‡Œï¼‰
    mapState.triggered.add(pointKey);

    // 2. è®¡ç®—å½“å‰åœ°å›¾çš„è§¦å‘è¿›åº¦
    const currentMapCount = mapState.triggered.size;

    // 3. åœæ­¢ç§»åŠ¨å’Œéšè—UI
    rpgInput.x = 0; rpgInput.y = 0;
    this.p1.step = 0; this.p2.step = 0;
    const controls = document.getElementById('rpg-controls');
    const menuBtn = document.getElementById('rpg-menu-toggle-btn');
    if (controls) controls.style.display = 'none';
    if (menuBtn) menuBtn.style.display = 'none';

    // 4. å‡†å¤‡å‰§æƒ…æ’­æ”¾
    this.state = this.STATE.STORY;
    this.storyQueue = []; 
    
    const idx = this.randomMapData.currentMapIndex;
    const storyData = this.randomMapData.mapStories[idx];
    const pointStories = storyData?.points || [];
    
    let linesToPlay = [];

    if (pointStories.length === 0) {
        linesToPlay = ["å‘çŽ°äº†å¥‡æ€ªçš„ç—•è¿¹..."];
    } else {
        if (!this.randomMapData.usedPointIndices) this.randomMapData.usedPointIndices = [];
        let storyIndex = this.randomMapData.usedPointIndices.length;
        if (storyIndex >= pointStories.length) storyIndex = Math.floor(Math.random() * pointStories.length);
        else this.randomMapData.usedPointIndices.push(storyIndex);
        
        const content = pointStories[storyIndex];
        linesToPlay = Array.isArray(content) ? content : [content];
    }
    
    linesToPlay.forEach(line => {
        let speaker = "";
        let content = line;
        if (line.includes('ï¼š') || line.includes(':')) {
            const parts = line.split(/[ï¼š:]/);
            if (parts.length >= 2 && parts[0].length < 10) {
                speaker = parts[0].trim();
                content = parts.slice(1).join('ï¼š').trim();
            }
        }
        this.storyQueue.push({ name: speaker, text: content });
    });

    // 5. ã€æ ¸å¿ƒã€‘å¦‚æžœé›†é½3ä¸ªï¼Œè¿½åŠ è§£é”æç¤º
    if (currentMapCount === 3) {
        this.storyQueue.push({ name: "", text: "ï¼ˆéšç€å…‰èŠ’æ±‡èšï¼Œé€šå¾€ä¸‹ä¸€åŒºåŸŸçš„å…¥å£å‡ºçŽ°äº†ï¼ï¼‰" });
        this.storyQueue.push({ name: "", text: "å‡ºå£å¥½åƒæ‰“å¼€äº†ï¼" });
    } else {
        this.storyQueue.push({ name: "", text: `ï¼ˆå·²æ”¶é›†çº¿ç´¢ ${currentMapCount}/3ï¼‰` });
    }
    
    // 6. å¼€å§‹æ’­æ”¾
    this.nextStory(); 
}


// ã€ä¿®å¤1ã€‘æ–°å¢žï¼šæ£€æŸ¥å‰§æƒ…ç‚¹ç‰¹æ®Šäº‹ä»¶ï¼ˆé˜²æ­¢æœªå®šä¹‰æŠ¥é”™å¯¼è‡´å¡æ­»ï¼‰
checkStoryPointEvent(point) {
    // æš‚æ—¶ç•™ç©ºï¼Œé˜²æ­¢æŠ¥é”™
    // è¿™é‡Œæœªæ¥å¯ä»¥æ‰©å±•ï¼šæ¯”å¦‚è¸©åˆ°ç‰¹å®šç‚¹èŽ·å¾—é“å…·ã€å›žè¡€ç­‰
    console.log(`è§¦å‘å‰§æƒ…ç‚¹åæ ‡: ${point.x}, ${point.y}`);
}



    startBattle(mapEntity) {
    if (mapEntity.isDefeated) return;
    
    // 1. å¼ºåˆ¶å…³é—­è‡ªåŠ¨æˆ˜æ–—çŠ¶æ€
    this.isAutoBattle = false;
    
    // 2. éšè—â€œåœæ­¢è‡ªåŠ¨â€æŒ‰é’®
    const stopBtn = document.getElementById('rpg-auto-battle-btn');
    if (stopBtn) stopBtn.style.display = 'none';
        this.state = this.STATE.BATTLE_CMD;
        this.battleEnemies = [];
        this.battleMapEntity = mapEntity; // è®°å½•è§¦å‘æˆ˜æ–—çš„åœ°å›¾å®žä½“ï¼Œç”¨äºŽèƒœåˆ©åŽåˆ é™¤
        
        let count = mapEntity.type === 'boss' ? 1 : Math.floor(Math.random() * 3) + 1;
        let template = mapEntity.type === 'boss' ? this.curLv.boss : this.curLv.enemyPool;
        
        // ç¡®å®šæ€ªç‰©è´´å›¾ç±»åž‹
        let mType = 0;
        if (template.name === 'çŸ³åƒé¬¼') mType = 1;
        if (template.name === 'é­”çŽ‹' || template.name === 'é»‘éª‘å£«') mType = 2;

        for(let i=0; i<count; i++) {
            let e = new RpgEntity(template.name, { monsterType: mType }, "enemy");
            // å¦‚æžœæ˜¯BOSSï¼Œå¼ºåˆ¶ç±»åž‹è®¾ä¸º bossï¼Œæ–¹ä¾¿æŽ‰è½è¡¨è¯†åˆ«
            if (mapEntity.type === 'boss') e.type = 'boss'; 
            
            e.hp = template.hp; e.maxHp = template.hp;
            e.atk = template.atk; e.xp = 20; e.lv = template.lv || 1;
            this.battleEnemies.push(e);
        }

        // ã€å…³é”®ä¿®å¤ã€‘åˆ›å»ºä¸€ä»½æ•Œäººåˆ—è¡¨çš„å¤‡ä»½ï¼Œç”¨äºŽç»“ç®—æŽ‰è½
        // å› ä¸ºæˆ˜æ–—ä¸­ battleEnemies é‡Œçš„æ€ªæ­»ä¸€ä¸ªå°‘ä¸€ä¸ªï¼Œç»“ç®—æ—¶å°±æ²¡äº†
        this.allBattleEnemiesCache = [...this.battleEnemies];
        
         // éšè—åœ°å›¾UI
    document.getElementById('rpg-controls').style.display = 'none';
    const menuBtn = document.getElementById('rpg-menu-toggle-btn');
    if(menuBtn) menuBtn.style.display = 'none';

    
    const titleEl = document.getElementById('rpg-header-title');
    if (titleEl) {
        // å¦‚æžœæ˜¯å¤šä¸ªæ€ªç‰©ï¼Œæ˜¾ç¤º "æ€ªç‰©å xæ•°é‡"ï¼Œå¦‚æžœæ˜¯å•ä¸ªåˆ™æ˜¾ç¤º "æ€ªç‰©å LV.xx"
        if (count > 1) {
            titleEl.innerText = `${template.name} x${count} (LV.${template.lv})`;
        } else {
            titleEl.innerText = `${template.name} LV.${template.lv}`;
        }
        // å¯é€‰ï¼šæˆ˜æ–—æ—¶æ ‡é¢˜å˜çº¢ï¼Œå¢žåŠ ç´§å¼ æ„Ÿ
        
    }

    this.showBottomDialog("", `é­é‡äº† ${this.battleEnemies.length} ä¸ªæ•Œäººï¼`);
    
    // 1ç§’åŽå¼€å§‹çŽ©å®¶å›žåˆ
    setTimeout(() => this.playerTurn(), 1000);
}
    
// ã€ä¿®æ”¹ç‰ˆã€‘ç»˜åˆ¶æˆ˜æ–—æ¨¡å¼ï¼šç¨³é‡çš„å¢™å£èƒŒæ™¯ + åŠ¨æ„Ÿå€¾æ–œåœ°é¢
drawBattleMode() {
    const w = this.canvas.width;
    const h = this.canvas.height;
    const TILE_SIZE = 64;

    // èŽ·å–é¢œè‰²
    const wallColor = this.curLv?.colors?.wall || "#222";
    const floorColor = this.curLv?.colors?.floor || "#333";

    // å®šä¹‰åˆ†ç•Œçº¿ (å·¦ä½Žå³é«˜)
    const leftY = h * 0.45;
    const rightY = h * 0.10;

    // è®¡ç®—å€¾æ–œè§’åº¦
    const angle = Math.atan2(rightY - leftY, w);

    // ==========================================
    // 1. ç»˜åˆ¶å¢™å£ (é™æ€èƒŒæ™¯ï¼Œä¸æ—‹è½¬)
    // ==========================================
    // ç›´æŽ¥å¡«å……å…¨å±ä½œä¸ºåº•è‰²ï¼Œè¿™å°±ç›¸å½“äºŽå¢™å£
    this.ctx.fillStyle = wallColor;
    this.ctx.fillRect(0, 0, w, h);

    // å¯é€‰ï¼šç»™å¢™å£åŠ ä¸€ä¸ªç®€å•çš„æ¸å˜é˜´å½±ï¼Œè®©å®ƒåƒä¸€é¢å¢™è€Œä¸æ˜¯çº¯è‰²å—
    // ä»Žä¸Šåˆ°ä¸‹å˜æš—ä¸€ç‚¹ï¼Œæ¨¡æ‹Ÿå®¤å†…å…‰ç…§
    const gradient = this.ctx.createLinearGradient(0, 0, 0, h);
    gradient.addColorStop(0, "rgba(0,0,0,0)");
    gradient.addColorStop(0.6, "rgba(0,0,0,0.3)"); // æŽ¥è¿‘åœ°é¢å¤„å˜æš—
    this.ctx.fillStyle = gradient;
    this.ctx.fillRect(0, 0, w, h);

    // ==========================================
    // 2. ç»˜åˆ¶åœ°é¢ (æ—‹è½¬åæ ‡ç³»)
    // ==========================================
    this.ctx.save();

    // A. è®¾ç½®æ—‹è½¬æ”¯ç‚¹ (åˆ†ç•Œçº¿å·¦ä¾§)
    this.ctx.translate(0, leftY);
    this.ctx.rotate(angle);

    // B. è®¡ç®—è¦†ç›–èŒƒå›´
    const extra = 4; 
    const rotatedCols = Math.ceil(w / TILE_SIZE) + extra;
    const rotatedRowsBot = Math.ceil(h / TILE_SIZE) + extra;

    const totalW = (rotatedCols + extra) * TILE_SIZE;
    const startX = -extra * TILE_SIZE;

    // C. åœ°é¢â€œåº•æ¼†â€ (å¡«è¡¥æ—‹è½¬äº§ç”Ÿçš„ç¼éš™)
    this.ctx.fillStyle = floorColor;
    // åªç”» y >= 0 çš„éƒ¨åˆ† (å³åˆ†ç•Œçº¿ä»¥ä¸‹)
    this.ctx.fillRect(startX, 0, totalW, rotatedRowsBot * TILE_SIZE);

    // D. åœ°é¢çº¹ç† (åªç”»åœ°é¢ï¼)
    for (let r = 0; r < rotatedRowsBot; r++) {
        for (let c = -extra; c < rotatedCols; c++) {
            // ç»˜åˆ¶åœ°é¢çº¹ç†
            this.drawTexturedTile(this.ctx, c * TILE_SIZE, r * TILE_SIZE, c + 10, r + 10, TILE_SIZE, 'floor', floorColor);
        }
    }

    // E. ç»˜åˆ¶åˆ†ç•Œçº¿ (åŠ å¼ºåœ°é¢å’Œå¢™å£çš„åˆ†å‰²æ„Ÿ)
    this.ctx.lineWidth = 4;
    this.ctx.strokeStyle = "rgba(0, 0, 0, 0.5)";
    this.ctx.beginPath();
    this.ctx.moveTo(-TILE_SIZE * extra, 0); // åœ¨æ—‹è½¬åæ ‡ç³»é‡Œï¼Œè¿™æ˜¯æ°´å¹³çº¿
    this.ctx.lineTo(w + TILE_SIZE * extra, 0);
    this.ctx.stroke();

    this.ctx.restore(); // æ¢å¤åæ ‡ç³»

    // ==========================================
    // 3. ç»˜åˆ¶è§’è‰² (å¸¦é€è§†ä½ç½®)
    // ==========================================
    
    const enemyStartX = w * 0.65;
    const enemyStartY = h * 0.30; 
    
    const p1X = w * 0.25;      
    const p1Y = h * 0.60; 
    
    const p2X = w * 0.10;      
    const p2Y = h * 0.55; 

    let renderList = [];

    this.battleEnemies.forEach((e, i) => {
        let ex = enemyStartX + (i % 2) * 50; 
        let ey = enemyStartY + Math.floor(i / 2) * 60 + (i * 10);
        renderList.push({ type: 'unit', entity: e, x: ex, y: ey });
    });

    renderList.push({ type: 'unit', entity: this.p1, x: p1X, y: p1Y });
    renderList.push({ type: 'unit', entity: this.p2, x: p2X, y: p2Y });

    renderList.sort((a, b) => a.y - b.y);

    renderList.forEach(item => {
        this.drawBattleUnit(item.entity, item.x, item.y);
    });
    
    // ==========================================
    // 4. ç»˜åˆ¶å…‰æ ‡
    // ==========================================
    if (this.state === this.STATE.BATTLE_TARGET) {
        let t = this.targets[this.targetIndex];
        let tx = 0, ty = 0;
        
        if (this.battleEnemies.includes(t)) {
            let i = this.battleEnemies.indexOf(t);
            tx = enemyStartX + (i % 2) * 50 + 32; 
            ty = enemyStartY + Math.floor(i / 2) * 60 + (i * 10);
        } else {
            if (t === this.p1) { tx = p1X + 32; ty = p1Y; } 
            else { tx = p2X + 32; ty = p2Y; }
        }
        this.drawMarker(tx, ty - 20);
    }
}

// ã€ä¿®å¤1ã€‘åˆ‡æ¢è‡ªåŠ¨æˆ˜æ–—é€»è¾‘æ›´æ–°
toggleAutoBattle(enable) {
    this.isAutoBattle = enable;
    
    const stopBtn = document.getElementById('rpg-auto-battle-btn');
    const battleMenu = document.getElementById('rpg-battle-menu');
    const targetPanel = document.getElementById('rpg-battle-target-panel');
    
    if (this.isAutoBattle) {
        // å¼€å¯è‡ªåŠ¨
        if (stopBtn) stopBtn.style.display = 'block';
        if (battleMenu) battleMenu.style.display = 'none';
        if (targetPanel) targetPanel.style.display = 'none';
        
        
        
        // å¦‚æžœæ˜¯ç­‰å¾…æŒ‡ä»¤çŠ¶æ€ï¼Œç«‹å³è§¦å‘
        if (this.state === this.STATE.BATTLE_CMD) {
            this.playerTurn();
        }
    } else {
        // å…³é—­è‡ªåŠ¨
        if (stopBtn) stopBtn.style.display = 'none';
        
        
        // ã€å…³é”®ã€‘å¦‚æžœå½“å‰å¤„äºŽ AI æ€è€ƒæˆ–ç­‰å¾…çŠ¶æ€ï¼Œå¼ºåˆ¶åˆ‡å›žæ‰‹åŠ¨å‘½ä»¤çŠ¶æ€
        if (this.state === this.STATE.BATTLE_ANIM && this.activeUnit === this.p1) {
            // è¿™é‡Œé…åˆ playerTurn é‡Œçš„æ£€æŸ¥ç”Ÿæ•ˆ
        } else if (this.state === this.STATE.BATTLE_CMD) {
            // æ¢å¤èœå•æ˜¾ç¤º
             if (battleMenu) battleMenu.style.display = 'flex';
        }
    }
}

    playerTurn() {
        // 1. å¿…é¡»å…ˆæ ‡è®°å½“å‰è¡ŒåŠ¨è€…
        this.activeUnit = this.p1;

        // 2. æ‰§è¡ŒçŠ¶æ€æ£€æŸ¥ï¼ŒèŽ·å–æŠ¥å‘Š
        const statusReport = this.checkStatusEffect(this.p1);
        
        // --- å®šä¹‰ä¸€ä¸ªè¾…åŠ©å‡½æ•°ï¼šæŒ‰é¡ºåºæ’­æ”¾æ¶ˆæ¯ ---
        const playStatusMessages = (messages, onComplete) => {
            if (messages.length === 0) {
                onComplete();
                return;
            }
            
            // å–å‡ºç¬¬ä¸€æ¡æ¶ˆæ¯
            const msg = messages.shift();
            this.showBottomDialog("", msg); // ä½¿ç”¨åº•éƒ¨å¯¹è¯æ¡†
            
            // 1.5ç§’åŽæ’­æ”¾ä¸‹ä¸€æ¡ï¼Œæˆ–è€…ç»“æŸ
            setTimeout(() => {
                playStatusMessages(messages, onComplete);
            }, 800);
        };

        // --- å¼€å§‹æ‰§è¡Œå›žåˆé€»è¾‘ ---
        
        // å…ˆæ’­æ”¾çŠ¶æ€æ¶ˆæ¯ï¼ˆå¦‚æžœæœ‰ï¼‰
        playStatusMessages(statusReport.msgs, () => {
            
            // æ¶ˆæ¯æ’­æ”¾å®Œæ¯•åŽçš„å›žè°ƒ...
            
            // æƒ…å†µA: è¢«çŠ¶æ€å¼„æ­»äº†
            if (statusReport.isDead) {
                this.nextTurn();
                return;
            }

            // æƒ…å†µB: è¢«çœ©æ™•ï¼ˆæ— æ³•è¡ŒåŠ¨ï¼‰
            if (statusReport.skip) {
                // è¿™é‡Œä¸éœ€è¦å†å¼¹çª—äº†ï¼Œå› ä¸ºåˆšæ‰çš„æ¶ˆæ¯é‡Œå·²ç»åŒ…å«äº† "æ— æ³•è¡ŒåŠ¨"
                // ç›´æŽ¥å»¶è¿Ÿä¸€ä¸‹è¿›å…¥ä¸‹ä¸€å›žåˆï¼Œç»™çŽ©å®¶ä¸€ç‚¹ååº”æ—¶é—´
                setTimeout(() => {
                    
                    this.nextTurn();
                }, 500);
                return;
            }
            


            // === ä¸‹é¢æ˜¯åŽŸæœ¬çš„æ‰‹åŠ¨/è‡ªåŠ¨æˆ˜æ–—é€»è¾‘ ===
            
            if (this.isAutoBattle) {
                this.state = this.STATE.BATTLE_ANIM;
                document.getElementById('rpg-battle-menu').style.display = 'none';
                document.getElementById('rpg-battle-target-panel').style.display = 'none';
                
                setTimeout(() => {
                    if (!this.isAutoBattle) {
                         this.state = this.STATE.BATTLE_CMD;
                         document.getElementById('rpg-battle-menu').style.display = 'flex';
                         this.showBottomDialog(this.p1.name, "è‡ªåŠ¨å·²åœæ­¢ï¼Œè¯·æŒ‡ç¤ºã€‚");
                         return;
                    }
                    
                    let target = null;
                    let action = 'attack';
                    const lowHpAlly = this.battleTeam.find(a => a.hp > 0 && a.hp < a.maxHp * 0.4);
                    const canHeal = this.p1.mp >= 5;
                    
                    if (lowHpAlly && canHeal && Math.random() < 0.3) {
                        action = 'heal'; target = lowHpAlly;
                    } else {
                        action = 'attack';
                        const enemies = this.battleEnemies.sort((a,b) => a.hp - b.hp);
                        if (enemies.length > 0) target = enemies[0];
                    }
                    
                    if (target) this.executeAction(this.p1, target, action);
                    else this.nextTurn();
                }, 800);
                return;
            }
            
            // æ‰‹åŠ¨æ“ä½œç•Œé¢
            this.showBottomDialog(this.p1.name, "è¯¥æˆ‘è¡ŒåŠ¨äº†ã€‚");
            this.state = this.STATE.BATTLE_CMD;
            document.getElementById('rpg-battle-menu').style.display = 'flex';
            document.getElementById('rpg-battle-target-panel').style.display = 'none';
        });
    }

// ã€é‡å†™ã€‘æ£€æŸ¥çŠ¶æ€ï¼ˆè¿”å›žæ˜¯å¦è·³è¿‡å›žåˆï¼Œå¹¶å¤„ç†è§†è§‰æ•ˆæžœï¼‰
    checkStatusEffect(actor) {
        let skipTurn = false;
        let messages = []; // å­˜å‚¨è¿™ä¸€è½®çŠ¶æ€ç»“ç®—çš„æ‰€æœ‰æ–‡æœ¬

        // å¤åˆ¶ä¸€ä»½ keys é˜²æ­¢éåŽ†æ—¶ä¿®æ”¹å‡ºé”™
        const statusIds = Object.keys(actor.status || {});
        
        statusIds.forEach(statusId => {
            const turns = actor.status[statusId];
            const config = RPG_STATUS_CONFIG[statusId];
            
            if (!config) {
                delete actor.status[statusId];
                return;
            }

            const effect = config.effect;
            let subMsgs = [];

            // 1. å¤„ç†ä¼¤å®³/æ²»ç–—
            let damage = 0;
            if (effect.damage_pct) damage += Math.floor(actor.maxHp * effect.damage_pct);
            if (effect.damage_val) damage += effect.damage_val;

            if (damage > 0) {
                actor.hp -= damage;
                if (effect.shake) actor.shake = 20;
                subMsgs.push(`å—åˆ°${damage}ä¼¤å®³`);
            }

            // 2. å¤„ç†è¡ŒåŠ¨é™åˆ¶
            if (effect.can_move === false) {
                skipTurn = true;
                subMsgs.push("æ— æ³•è¡ŒåŠ¨ï¼");
            }

            // ç”Ÿæˆç¬¬ä¸€æ¡æ¶ˆæ¯ï¼šä¾‹å¦‚ "å‹‡è€… ä¸­æ¯’ å—åˆ°10ä¼¤å®³"
            if (subMsgs.length > 0) {
                messages.push(`${actor.name} ${config.name} ${subMsgs.join('ï¼Œ')}`);
            }

            // 3. æ‰£å‡å›žåˆæ•°
            actor.status[statusId]--;
            
            // 4. å¤„ç†çŠ¶æ€è§£é™¤
            if (actor.status[statusId] <= 0) {
                delete actor.status[statusId];
                 if (effect.can_move === false) {
                    actor.pendingRecovery.push(config.name);
                } else {
                messages.push(`${actor.name} çš„ ${config.name} çŠ¶æ€è§£é™¤äº†ã€‚`);
                }
            }
        });
        


        // å¦‚æžœçŠ¶æ€å¯¼è‡´æ­»äº¡ï¼Œå¼ºåˆ¶è·³è¿‡
        if (actor.hp <= 0) return { skip: true, msgs: messages, isDead: true };

        return { skip: skipTurn, msgs: messages, isDead: false };
    }



    inputBattleCommand(cmd) {
        this.currentAction = cmd;
        this.state = this.STATE.BATTLE_TARGET;
        document.getElementById('rpg-battle-menu').style.display = 'none';
        document.getElementById('rpg-battle-target-panel').style.display = 'flex';
        this.targets = (cmd === 'attack') ? this.battleEnemies : this.battleTeam;
        this.targetIndex = 0;
        this.showBottomDialog(this.p1.name, cmd === 'attack' ? "æ”»å‡»è°ï¼Ÿ" : "æ²»ç–—è°ï¼Ÿ");
    }

    moveTargetCursor(dir) {
        if (this.state !== this.STATE.BATTLE_TARGET) return;
        this.targetIndex += dir;
        if (this.targetIndex < 0) this.targetIndex = this.targets.length - 1;
        if (this.targetIndex >= this.targets.length) this.targetIndex = 0;
    }
    
    confirmTarget() {
        if (this.state !== this.STATE.BATTLE_TARGET) return;
        let target = this.targets[this.targetIndex];

        if (this.currentAction === 'heal' && target.hp <= 0) {
            this.showBottomDialog(this.p1.name, "æ²¡æ•‘äº†...");
            return;
        }

        this.executeAction(this.p1, target, this.currentAction);
        document.getElementById('rpg-battle-target-panel').style.display = 'none';
    }
    
    cancelTarget() {
        if (this.state !== this.STATE.BATTLE_TARGET) return;
        
        // ã€æ–°å¢žã€‘å¦‚æžœå–æ¶ˆäº†ç‰©å“ä½¿ç”¨ï¼Œæ¸…ç©º pendingItemId
        if (this.currentAction === 'item') {
            this.pendingItemId = null;
        }

        this.state = this.STATE.BATTLE_CMD;
        document.getElementById('rpg-battle-target-panel').style.display = 'none';
        document.getElementById('rpg-battle-menu').style.display = 'flex';
        this.showBottomDialog(this.p1.name, "è¯·ä¸‹è¾¾æŒ‡ä»¤ã€‚");
    }

    // è¾…åŠ©å‡½æ•°ï¼šéšæœºèŽ·å–ä¸€å¥æˆ˜æ–—å°è¯
    getBattleBark(type) {
        if (!this.p2.customData || !this.p2.customData.dialogues) return null;
        const lines = this.p2.customData.dialogues[type];
        if (lines && lines.length > 0) {
            return lines[Math.floor(Math.random() * lines.length)];
        }
        return null;
    }

    executeAction(actor, target, action) {
        this.state = this.STATE.BATTLE_ANIM;
        
        // MP æ£€æŸ¥ (ä¿æŒä¸å˜)
        if (action === 'heal' && actor.mp < 5) {
            this.showBottomDialog(actor.name, "MPä¸è¶³ï¼");
            setTimeout(() => this.nextTurn(), 1000);
            return;
        }

        // --- 1. å†³å®šå°è¯ä¸Žæ—¶æœº (ä¿æŒä¸å˜) ---
        let bark = null;
        let timing = 'after'; 

        if (this.p2.customData && this.p2.customData.dialogues) {
            const dialogs = this.p2.customData.dialogues;
            if (actor === this.p2) {
                timing = 'before';
                if (action === 'attack') bark = this.getRandomLine(dialogs.atk);
                if (action === 'heal') bark = this.getRandomLine(dialogs.heal);
                // ç‰©å“å°è¯æš‚æ—¶å¤ç”¨æ²»ç–—çš„
                if (action === 'item') bark = this.getRandomLine(dialogs.heal); 
            } else if (target === this.p2) {
                timing = 'after';
                if (action === 'heal' || action === 'item') bark = this.getRandomLine(dialogs.healed);
            }
        }

        // --- 2. å°è£…åŠ¨ä½œé€»è¾‘ (ä¿®æ”¹è¿™é‡Œ) ---
        const performAction = () => {
            let msg = "";
            
            if (action === 'attack') {
                // ... (æ”»å‡»é€»è¾‘ä¿æŒä¸å˜)
                let dmg = Math.floor(actor.atk * (1 + Math.random()*0.2));
                target.hp -= dmg; target.shake = 20; 
                msg = `é€ æˆ ${dmg} ç‚¹ä¼¤å®³ï¼`;
                if(actor.type === 'enemy') this.showTopDialog(actor.name, "æ”»å‡»ï¼");
                else this.showBottomDialog(actor.name, msg);

            } else if (action === 'heal') {
                // ... (æ²»ç–—é€»è¾‘ä¿æŒä¸å˜)
                actor.mp -= 5;
                let heal = 30 + actor.lv * 10;
                target.hp = Math.min(target.maxHp, target.hp + heal);
                msg = `æ¢å¤ ${heal} ç‚¹HPï¼`;
                this.showBottomDialog(actor.name, msg);

            // ... (å‰ç•¥ï¼Œåœ¨ performAction å‡½æ•°å†…éƒ¨)

            } else if (action === 'item') {
                const itemId = this.pendingItemId;
                const item = RPG_ITEMS[itemId];
                
                if (this.inventory[itemId] > 0) {
                    this.inventory[itemId]--; 
                    
                    msg = `ä½¿ç”¨äº† ${item.name}`;
                    
                    if (item.effect) {
                        switch (item.effect.type) {
                            case 'heal_hp':
                                // ç¡®ä¿æ•°å€¼è¢«æ­£ç¡®æ›´æ–°
                                target.hp = Math.min(target.maxHp, target.hp + item.effect.val);
                                msg += `ï¼Œæ¢å¤äº†${item.effect.val}HP`;
                                break;
                            case 'heal_mp':
                                target.mp = Math.min(target.maxMp, target.mp + item.effect.val);
                                msg += `ï¼Œæ¢å¤äº†${item.effect.val}MP`;
                                break;
                            case 'revive':
                                if (target.hp <= 0) {
                                    target.hp = Math.floor(target.maxHp * item.effect.val);
                                    msg = `å¤æ´»äº† ${target.name}!`;
                                } else {
                                    msg += " (æ²¡æœ‰æ•ˆæžœ)";
                                }
                                break;
                            case 'flee':
                                this.showBottomDialog(actor.name, "æºœäº†æºœäº†ï¼");
                                this.pendingItemId = null;
                                setTimeout(() => this.battleWin(), 1000); 
                                return; 
                            case 'cure_all':
                                target.status = {};
                                msg += "ï¼ŒçŠ¶æ€å·²å‡€åŒ–ï¼";
                                break;
                        }
                    }
                    this.showBottomDialog(actor.name, msg);
                    this.pendingItemId = null; 
                    
                    // ã€å…³é”®ä¿®å¤ã€‘ç‰©å“ä½¿ç”¨å®Œå¿…é¡»è°ƒç”¨ finishTurnï¼Œå¦åˆ™æ¸¸æˆä¼šå¡ä½ï¼
                    setTimeout(finishTurn, 1000); 
                } else {
                    // ç†è®ºä¸Šä¸ä¼šè¿›è¿™é‡Œï¼Œä½†ä¸ºäº†ä¿é™©
                    this.showBottomDialog(actor.name, "ç‰©å“ä¸è¶³ï¼");
                    setTimeout(finishTurn, 1000);
                }
            }
            
            
        };




        // --- 3. å°è£…ç»“æŸé€»è¾‘ ---
        const finishTurn = () => {
            // ã€ä¿®æ­£ã€‘æ— è®ºæ˜¯ enemy è¿˜æ˜¯ bossï¼Œæ­»åŽéƒ½ä»Žæˆ˜æ–—åˆ—è¡¨ä¸­ç§»é™¤ï¼Œä»¥è§¦å‘èƒœåˆ©åˆ¤æ–­
            if (target.hp <= 0 && (target.type === 'enemy' || target.type === 'boss')) {
                this.battleEnemies = this.battleEnemies.filter(e => e !== target);
            }
            this.nextTurn(); 
        };

        // --- 4. æ‰§è¡Œæµç¨‹ (ä¿æŒä¸å˜) ---
        if (bark && timing === 'before') {
            this.showBottomDialog(this.p2.name, bark);
            setTimeout(() => {
                performAction();
                setTimeout(finishTurn, 1000);
            }, 1200); 
        } else if (bark && timing === 'after') {
            performAction();
            setTimeout(() => {
                this.showBottomDialog(this.p2.name, bark);
                setTimeout(finishTurn, 1200); 
            }, 1000);
        } else {
            performAction();
            setTimeout(finishTurn, 1000);
        }
    }







// --- è¾…åŠ©å·¥å…·ï¼šä»Žæ•°ç»„ä¸­éšæœºå–ä¸€ä¸ª (é˜²æ­¢æŠ¥é”™å¡æ­») ---
    getRandomLine(arr) {
        if (!arr || !Array.isArray(arr) || arr.length === 0) return null;
        return arr[Math.floor(Math.random() * arr.length)];
    }




    nextTurn() {
        // 1. æ£€æŸ¥èƒœè´Ÿ
        if (this.battleEnemies.length === 0) { this.battleWin(); return; }
        if (this.p1.hp <= 0 && this.p2.hp <= 0) { this.gameOver(); return; }

        // 2. æµç¨‹æµè½¬é€»è¾‘
        if (this.activeUnit === this.p1) {
            // --- P1 å›žåˆç»“æŸï¼Œè½®åˆ° P2 ---
            
            // ... inside nextTurn ...
            if (this.p2.hp > 0) {
                this.activeUnit = this.p2; 
                
                // 1. æ£€æŸ¥çŠ¶æ€
                const statusReport = this.checkStatusEffect(this.p2);
                
                // 2. æ’­æ”¾æ¶ˆæ¯è¾…åŠ©å‡½æ•° (åŒä¸Š)
                const playMsgs = (msgs, cb) => {
                    if (msgs.length === 0) { cb(); return; }
                    this.showBottomDialog("", msgs.shift());
                    setTimeout(() => playMsgs(msgs, cb), 1000);
                };
                
                // 3. æ‰§è¡Œæµç¨‹
                playMsgs(statusReport.msgs, () => {
                    if (statusReport.isDead || statusReport.skip) {
                        this.activeUnit = null; 
                        setTimeout(() => {
                            
                            this.enemyTurn(0);
                        }, 500);
                        return;
                    }
                    
                    // æ­£å¸¸è¡ŒåŠ¨
                    
                    let target = this.battleEnemies[0];
                    let lowHpAlly = this.battleTeam.find(a => a.hp > 0 && a.hp < a.maxHp * 0.4);
                    let action = (lowHpAlly && this.p2.mp >= 5) ? 'heal' : 'attack';
                    if (action === 'heal') target = lowHpAlly;
                    else target = this.battleEnemies[Math.floor(Math.random() * this.battleEnemies.length)];
                    
                    this.executeAction(this.p2, target, action);
                });

            } else {
                // P2 æ­»äº†
                this.activeUnit = null;
                this.enemyTurn(0);
            }

        } else if (this.activeUnit === this.p2) {
            // --- P2 å›žåˆç»“æŸï¼Œè½®åˆ°æ•Œäºº ---
            this.activeUnit = null; 
            this.enemyTurn(0);
        } 
        // æ³¨æ„ï¼šæ•Œäººå›žåˆç»“æŸåˆ‡å›ž P1 çš„é€»è¾‘é€šå¸¸åœ¨ enemyTurn çš„æœ«å°¾è°ƒç”¨ playerTurn()ï¼Œä¸åœ¨è¿™é‡Œå†™
    }

    enemyTurn(idx) {
        // æ‰€æœ‰æ•Œäººè¡ŒåŠ¨å®Œæ¯•ï¼Œåˆ‡å›žçŽ©å®¶å›žåˆ
        if (idx >= this.battleEnemies.length) { 
            if (this.p1.hp > 0) this.playerTurn();
            else if (this.p2.hp > 0) { this.activeUnit = this.p1; this.nextTurn(); }
            return; 
        }
        
        let enemy = this.battleEnemies[idx];
        let aliveTeam = this.battleTeam.filter(t => t.hp > 0);
        if (aliveTeam.length === 0) { this.gameOver(); return; }

        let target = aliveTeam[Math.floor(Math.random() * aliveTeam.length)];
        
        // --- 1. å…ˆæ˜¾ç¤ºæ”»å‡»å‰æ‘‡ (å–Šè¯) ---
        this.showTopDialog(enemy.name, "æ”»å‡»ï¼");
        
        setTimeout(() => {
            // --- 2. è®¡ç®—ä¼¤å®³å¹¶æ‰§è¡ŒæŠ–åŠ¨ (å…ˆå—ä¼¤) ---
            let dmg = Math.floor(enemy.atk * (0.8 + Math.random()*0.4));
            target.hp -= dmg; 
            target.shake = 20; // <--- è§’è‰²åœ¨è¿™é‡ŒæŠ–åŠ¨

            // --- 3. æ–½åŠ å¼‚å¸¸çŠ¶æ€ (ç§»åˆ°äº†è¿™é‡Œï¼Œå—ä¼¤åŽæ‰åˆ¤æ–­) ---
            let statusMsg = ""; // ç”¨æ¥æ”¶é›†è§¦å‘äº†ä»€ä¹ˆçŠ¶æ€
            Object.keys(RPG_STATUS_CONFIG).forEach(statusId => {
                const config = RPG_STATUS_CONFIG[statusId];
                if (config.apply) {
                    // æ¦‚çŽ‡åˆ¤å®š
                    if (Math.random() < config.apply.rate) {
                        // æ–½åŠ çŠ¶æ€ (å¦‚æžœå·²æœ‰è¯¥çŠ¶æ€ï¼Œåˆ™åˆ·æ–°æŒç»­æ—¶é—´)
                        if (!target.status) target.status = {}; // é˜²æ­¢ undefined
                        target.status[statusId] = config.apply.duration;
                        
                        // è®°å½•çŠ¶æ€æç¤ºè¯­ (å¦‚æžœæœ‰çš„è¯)
                        if (config.apply.msg) statusMsg += " " + config.apply.msg;
                    }
                }
            });

            // 4. æ˜¾ç¤ºä¼¤å®³æ•°å­— (åŠ ä¸ŠçŠ¶æ€æç¤º)
            let displayMsg = "å—åˆ° " + dmg + " ä¼¤å®³ã€‚";
            if (statusMsg) displayMsg += statusMsg; // ä¾‹å¦‚ï¼šå—åˆ° 10 ä¼¤å®³ã€‚ ä¸­æ¯’äº†ï¼

            this.showBottomDialog(target.name, displayMsg);
            
            // 5. æ£€æŸ¥æ˜¯å¦è§¦å‘ P2 å—å‡»å°è¯
            let hurtBark = null;
            if (target === this.p2 && target.hp > 0) { // æ²¡æ­»æ‰è¯´è¯
                if (this.p2.customData && this.p2.customData.dialogues) {
                    hurtBark = this.getRandomLine(this.p2.customData.dialogues.hurt);
                }
            }

            // 6. æµç¨‹æŽ§åˆ¶ï¼šä¸‹ä¸€ä¸ªæ•Œäºº
            const proceed = () => {
                if (this.p1.hp <= 0 && this.p2.hp <= 0) { 
                    setTimeout(()=>this.gameOver(), 1000); 
                } else {
                    setTimeout(() => this.enemyTurn(idx+1), 1000);
                }
            };

            if (hurtBark) {
                // å¦‚æžœæœ‰æƒ¨å«ï¼Œå»¶è¿Ÿæ˜¾ç¤º
                setTimeout(() => {
                    this.showBottomDialog(this.p2.name, hurtBark);
                    setTimeout(proceed, 1200); // è¯»å®Œæƒ¨å«å†ç»§ç»­
                }, 1000); // è¯»å®Œä¼¤å®³æ•°å­—
            } else {
                proceed();
            }

        }, 1000); // æ”»å‡»å‰æ‘‡ç»“æŸ
    }

    gameOver() {
        this.state = this.STATE.GAME_OVER;
        
        // --- æ–°å¢žï¼šæ­»äº¡å°è¯ ---
        const deadLines = this.p2.customData?.dialogues?.dead || [];
        if (deadLines.length > 0) {
            this.showBottomDialog(this.p2.name, this.getRandomLine(deadLines));
        } else {
            this.showBottomDialog("", "å…¨å†›è¦†æ²¡...");
        }

        // å»¶è¿Ÿæ˜¾ç¤ºé»‘å±ï¼Œè®©çŽ©å®¶çœ‹åˆ°é—è¨€
        setTimeout(() => {
            document.getElementById('rpg-game-over-screen').style.display = 'flex';
            this.closeDialogs(); // å…³æŽ‰å¯¹è¯æ¡†
        }, 2000);
    }

// ã€æ–°å¢žã€‘æ–°æ‰‹æ•™ç¨‹ç»“å±€ï¼ˆæ‰“å®Œé­”çŽ‹åŽï¼‰
triggerTutorialEnding() {
    this.state = this.STATE.STORY;
    this.storyQueue = [];

    // ç³»ç»Ÿæ—ç™½
    this.storyQueue.push({name: "", text: "éšç€ä¸€å£°å·¨å“ï¼Œé­”çŽ‹å€’ä¸‹äº†ã€‚"});
    this.storyQueue.push({name: "", text: "ç¬¼ç½©åœ¨ä¸–ç•Œçš„é˜´äº‘ç»ˆäºŽæ¶ˆæ•£ã€‚"});

    // ä¼™ä¼´å°è¯
    const aiEnding = this.p2.customData?.dialogues?.ending || [];
    const fallbackEnding = [
        "å‘¼... ç»ˆäºŽç»“æŸäº†ã€‚",
        "æˆ‘ä»¬åšåˆ°äº†ï¼Œæ­æ¡£ï¼",
        "è¿™çœŸæ˜¯ä¸€åœºä¼Ÿå¤§çš„å†’é™©ã€‚",
        "ä¸è¿‡ï¼Œå†’é™©æ‰åˆšåˆšå¼€å§‹å‘¢ã€‚",
        "æˆ‘ä»¬å›žå®¶å§ï¼"
    ];

    const linesToUse = aiEnding.length >= 5 ? aiEnding : fallbackEnding;

    linesToUse.forEach(text => {
        this.storyQueue.push({name: this.p2.name, text: text});
    });

    // æœ€ç»ˆæç¤º
    this.storyQueue.push({name: "", text: "æ–°æ‰‹æ•™ç¨‹å®Œæˆï¼"});
    this.storyQueue.push({name: "", text: "çŽ°åœ¨å¯ä»¥æŽ¢ç´¢æ›´å¤šä¸–ç•Œäº†..."});

    // éšè—æˆ˜æ–—UI
    
    document.getElementById('rpg-battle-menu').style.display = 'none';
    document.getElementById('rpg-battle-target-panel').style.display = 'none';
    
    const titleEl = document.getElementById('rpg-header-title');
    if (titleEl) {
        titleEl.innerText = this.curLv.name;
        
    }
    
    // æ ‡è®°è¿›å…¥å®¶å›­
    this.isGoingHome = true;
    
    this.nextStory();
}


// --- æ–°å¢žï¼šè§¦å‘é€šå…³ç»“å±€ ---
    triggerEnding() {
        this.state = this.STATE.STORY;
        this.isGameClear = true; // æ ‡è®°å½“å‰ä¸ºé€šå…³çŠ¶æ€
        this.storyQueue = [];

        // 1. ç³»ç»Ÿæ—ç™½
        this.storyQueue.push({name: "", text: "éšç€ä¸€å£°å·¨å“ï¼Œé­”çŽ‹å€’ä¸‹äº†ã€‚"});
        this.storyQueue.push({name: "", text: "ç¬¼ç½©åœ¨ä¸–ç•Œçš„é˜´äº‘ç»ˆäºŽæ¶ˆæ•£ã€‚"});

        // 2. ä¼™ä¼´å°è¯ (ä¼˜å…ˆç”¨AIç”Ÿæˆçš„ï¼Œå¦‚æžœæ²¡æœ‰åˆ™ç”¨é»˜è®¤çš„)
        const aiEnding = this.p2.customData?.dialogues?.ending || [];
        
        // é»˜è®¤å…œåº•å°è¯ (5å¥)
        const fallbackEnding = [
            "å‘¼... ç»ˆäºŽç»“æŸäº†ã€‚",
            "æˆ‘ä»¬åšåˆ°äº†ï¼Œæ­æ¡£ï¼",
            "è¿™å°±åŽ»æŠŠè¿™ä¸ªå¥½æ¶ˆæ¯å‘Šè¯‰å¤§å®¶ã€‚",
            "è°¢è°¢ä½ ä¸€ç›´ä¿æŠ¤æˆ‘ã€‚",
            "è¿™çœŸæ˜¯ä¸€åœºä¼Ÿå¤§çš„å†’é™©ï¼Œæˆ‘æ°¸è¿œä¸ä¼šå¿˜è®°ã€‚",
            "é‚£ä¹ˆ... æˆ‘ä»¬å›žå®¶å§ï¼Ÿ"
        ];

        // å¦‚æžœAIç”Ÿæˆçš„å°‘äºŽ5å¥ï¼Œå°±ç”¨é»˜è®¤çš„ï¼Œä¿è¯é•¿åº¦
        const linesToUse = aiEnding.length >= 5 ? aiEnding : fallbackEnding;

        linesToUse.forEach(text => {
            this.storyQueue.push({name: this.p2.name, text: text});
        });

        // 3. æœ€ç»ˆç³»ç»Ÿæ„Ÿè°¢
        this.storyQueue.push({name: "", text: "ã€THE ENDã€‘"});
        this.storyQueue.push({name: "", text: "æ„Ÿè°¢æ¸¸çŽ© Eternal Legendï¼"});

        // éšè—æˆ˜æ–—UIï¼Œå¼€å§‹æ’­æ”¾å‰§æƒ…
        document.getElementById('rpg-battle-info').style.display = 'none';
        document.getElementById('rpg-battle-menu').style.display = 'none';
        document.getElementById('rpg-battle-target-panel').style.display = 'none';
        
        this.nextStory();
    }



battleWin() {
    // 1. å¼ºåˆ¶å…³é—­è‡ªåŠ¨æˆ˜æ–—
    this.isAutoBattle = false;
    document.getElementById('rpg-auto-battle-btn').style.display = 'none';
    
    if (this.battleMapEntity) {
        this.battleMapEntity.isDefeated = true;
    }
        
    const entityToRemove = this.battleMapEntity;    
    let totalXp = 0;
    
    if (this.battleMapEntity) {
        totalXp = this.battleMapEntity.xp || 30;
    }

    // ç»“ç®—ç»éªŒ
    if (this.p1.hp > 0) this.p1.xp += totalXp; 
    if (this.p2.hp > 0) this.p2.xp += totalXp;
    
    let msg = `èŽ·å¾— ${totalXp} ç»éªŒã€‚`;
    let leveledUp = false;

    if(this.p1.hp > 0 && this.p1.xp >= this.p1.nextXp) { 
        this.p1.levelUp(); 
        msg += " å‹‡è€…å‡çº§ï¼"; 
        leveledUp = true; 
    }
    if(this.p2.hp > 0 && this.p2.xp >= this.p2.nextXp) { 
        this.p2.levelUp(); 
        msg += " ä¼™ä¼´å‡çº§ï¼"; 
        leveledUp = true; 
    }
    
    // ã€æ­¥éª¤ 1ã€‘ç«‹å³æ˜¾ç¤ºç»éªŒå€¼/å‡çº§ä¿¡æ¯
    this.showBottomDialog("", msg);
    
    // --- å®šä¹‰ä¸€ä¸ªæ—¶é—´ç´¯åŠ å™¨ï¼Œç”¨äºŽæŽ§åˆ¶åŽç»­æ¶ˆæ¯çš„æ’­æ”¾é¡ºåº ---
    let stepDelay = 0; 

    // æŽ‰è½å¤„ç†
    let lootMsgItems = []; 
    let totalCoins = 0;    
    const enemiesToLoot = this.allBattleEnemiesCache || [];

    enemiesToLoot.forEach(e => {
        const dropList = (e.type === 'boss') ? RPG_DROP_CONFIG.boss : RPG_DROP_CONFIG.normal;
        dropList.forEach(itemConfig => {
            if (Math.random() < itemConfig.rate) {
                const qty = Math.floor(Math.random() * (itemConfig.max - itemConfig.min + 1)) + itemConfig.min;
                if (qty > 0) {
                    if (itemConfig.id === 'currency' || itemConfig.id === 'points') { 
                            this.currency += qty;
                            totalCoins += qty;
                        } else {
                            this.gainItem(itemConfig.id, qty);
                            lootMsgItems.push(itemConfig.name);
                    }
                }
            }
        });
    });
    
    // ç”Ÿæˆæœ€ç»ˆæŽ‰è½æ–‡æœ¬
    let finalMsg = "";
    if (lootMsgItems.length > 0) finalMsg += "èŽ·å¾—: " + lootMsgItems.join("ï¼");
    if (totalCoins > 0) {
            // ã€ä¿®æ”¹ã€‘ä¸éœ€è¦åˆ¤æ–­BOSSäº†ï¼Œç»Ÿç§°ä¸ºé‡‘å¸
            finalMsg += ` èŽ·å¾— ${totalCoins} é‡‘å¸ï¼`;
    }
    
    // ã€æ­¥éª¤ 2ã€‘å¦‚æžœæœ‰æŽ‰è½ï¼Œå»¶è¿Ÿ 1.5ç§’ åŽæ˜¾ç¤º
    if (finalMsg) {
        stepDelay += 1500; // å¢žåŠ å»¶è¿Ÿ
        setTimeout(() => {
            this.showBottomDialog("", finalMsg);
        }, stepDelay);
    }

    // ç§»é™¤åœ°å›¾ä¸Šçš„æ•Œäººå®žä½“
    this.mapEnemies = this.mapEnemies.filter(e => e !== this.battleMapEntity);

    // ã€æ­¥éª¤ 3ã€‘å¦‚æžœæœ‰å‡çº§å°è¯ï¼Œåœ¨æŽ‰è½æ˜¾ç¤ºå®Œ 1.5ç§’ åŽæ˜¾ç¤º
    if (leveledUp) {
        const lvLines = this.p2.customData?.dialogues?.lvup || [];
        if (lvLines.length > 0) {
            stepDelay += 1500; // å†å¢žåŠ å»¶è¿Ÿ
            setTimeout(() => {
                this.showBottomDialog(this.p2.name, this.getRandomLine(lvLines));
            }, stepDelay);
        }
    }
    
    // ã€æ­¥éª¤ 4ã€‘æ‰€æœ‰æ¶ˆæ¯æ’­æ”¾å®Œæ¯•åŽï¼Œå†è¿‡ 2ç§’ ç»“æŸæˆ˜æ–—
    // æ³¨æ„ï¼šè¿™é‡Œçš„åŸºç¡€æ—¶é—´æ˜¯ stepDelayï¼Œä¿è¯å‰é¢çš„æ¶ˆæ¯éƒ½æ’­å®Œäº†
    setTimeout(() => {
        this.closeDialogs();
        
        // æ£€æŸ¥ BOSS æˆ˜ç»“å±€
        const isTutorialBoss = (this.curLv.type === 'tutorial' && this.curLv.id === 'lv3' && this.battleMapEntity?.type === 'boss');
        const isRandomBoss = (this.curLv.type === 'random' && this.randomMapData.currentMapIndex === 4 && this.battleMapEntity?.type === 'boss');

        if (isTutorialBoss) {
            this.triggerTutorialEnding();
        } else if (isRandomBoss) {
            this.triggerRandomEnding();
        } else {
            if (entityToRemove) {
                this.mapEnemies = this.mapEnemies.filter(e => e !== entityToRemove);
            }
            // æ¢å¤åœ°å›¾çŠ¶æ€
            this.state = this.STATE.MAP;
            
            // æ¢å¤å¤´éƒ¨æ ‡é¢˜
            const titleEl = document.getElementById('rpg-header-title');
            if (titleEl && this.curLv) {
                titleEl.innerText = this.curLv.name;
                titleEl.style.color = 'var(--text-color)';
            }
            // æ¢å¤ UI
            document.getElementById('rpg-controls').style.display = 'block';
            document.getElementById('rpg-battle-menu').style.display = 'none';
            document.getElementById('rpg-battle-target-panel').style.display = 'none';
            
            const menuBtn = document.getElementById('rpg-menu-toggle-btn');
            if(menuBtn) menuBtn.style.display = 'flex';
        }
    }, stepDelay + 2000); // è¿™é‡Œçš„å»¶è¿Ÿæ˜¯ ç´¯ç§¯æ—¶é—´ + 2ç§’é˜…è¯»æ—¶é—´
}




gainItem(id, count) {
        if (!this.inventory[id]) this.inventory[id] = 0;
        this.inventory[id] += count;
    }


   // === æ‰“å¼€èƒŒåŒ… (ä¿®å¤ç‰ˆï¼šå¸¦Tabè¿‡æ»¤) ===
    // åœ¨ RpgGame ç±»ä¸­æ‰¾åˆ° openInventory æ–¹æ³•å¹¶æ›¿æ¢
    openInventory(context = 'map') {

        
        // 2. è®¾ç½®æš‚åœçŠ¶æ€
        this.isPaused = true;
        this.stop(); // å½»åº•åœæ­¢å¾ªçŽ¯ï¼Œé˜²æ­¢åŽå°è·‘åŠ¨

        // 3. èŽ·å–å¹¶å‡†å¤‡ DOM
        const modal = document.getElementById('rpg-common-modal');
        const list = document.getElementById('rpg-modal-body');
        const tabsContainer = document.getElementById('rpg-modal-tabs');

        document.getElementById('rpg-modal-title').innerText = context === 'battle' ? 'æˆ˜æ–—èƒŒåŒ…' : 'è¡Œå›Š';

        // æ¸²æŸ“ Tab
        if (context === 'battle') {
            tabsContainer.style.display = 'none';
            this.renderInventoryList(list, 'battle', 'battle'); 
        } else {
            tabsContainer.style.display = 'flex';
            this.renderInventoryList(list, 'all', 'map'); 
            
            const tabs = tabsContainer.querySelectorAll('.rpg-tab-btn');
            tabs.forEach(tab => {
                tab.onclick = (e) => {
                    tabs.forEach(t => t.classList.remove('active'));
                    e.target.classList.add('active');
                    this.renderInventoryList(list, e.target.dataset.type, 'map');
                };
            });
            tabs.forEach(t => t.classList.remove('active'));
            if(tabs[0]) tabs[0].classList.add('active');
        }

        // 4. æ˜¾ç¤ºæ¨¡æ€æ¡†
        modal.classList.add('visible');

           // 5. ã€å…³é”®ä¿®å¤ã€‘å®šä¹‰å…³é—­é€»è¾‘
        const handleClose = () => {
            modal.classList.remove('visible');
            
            // ã€ä¿®æ­£ã€‘æ— è®ºåœ¨åœ°å›¾è¿˜æ˜¯æˆ˜æ–—ï¼Œå…³é—­èƒŒåŒ…åŽéƒ½å¿…é¡»æ¢å¤æ¸¸æˆè¿è¡Œ
            // å¦åˆ™æˆ˜æ–—ç”»é¢ä¼šé™æ­¢ï¼Œç‚¹å‡»æŒ‰é’®æ— ååº”
            this.isPaused = false;
            this.resume(); // æ¢å¤æ¸¸æˆå¾ªçŽ¯ (requestAnimationFrame)
        };

        // ç»‘å®šå…³é—­äº‹ä»¶ (å…ˆè§£ç»‘æ—§çš„ï¼Œé˜²æ­¢å¤šæ¬¡ç»‘å®š)
        const closeBtn = document.getElementById('rpg-modal-close-btn');
        const newCloseBtn = closeBtn.cloneNode(true);
        closeBtn.parentNode.replaceChild(newCloseBtn, closeBtn);
        newCloseBtn.onclick = handleClose;

        // ç‚¹å‡»é®ç½©å±‚å…³é—­ (åŒæ ·é‡æ–°ç»‘å®š)
        modal.onclick = (e) => {
            if (e.target === modal) handleClose();
        };
    }
    
// === è¾…åŠ©ï¼šæ¸²æŸ“åˆ—è¡¨ (ä¿®å¤ç‰ˆ) ===
    renderInventoryList(container, filterCategory, usageContext) {
        container.innerHTML = '';
        
        // æ˜¾ç¤ºé‡‘å¸
        const currencyDiv = document.createElement('div');
        currencyDiv.style.cssText = "padding:10px; font-weight:bold; color:#e67e22; background:#fff8e1; border-radius:8px; margin-bottom:10px; text-align:right;";
        currencyDiv.innerText = `æŒæœ‰é‡‘å¸: ${this.currency || 0}`;
        container.appendChild(currencyDiv);

        let hasItem = false;

        for (let [id, count] of Object.entries(this.inventory)) {
            if (count <= 0) continue;
            
            const itemDef = RPG_ITEMS[id];
            if (!itemDef) continue;

            // ã€ä¿®å¤ç‚¹1ã€‘å±žæ€§åä¿®æ­£ï¼šä½¿ç”¨ itemDef.use è€Œä¸æ˜¯ category
            // å¦‚æžœé“å…·æ²¡æœ‰ use å±žæ€§ï¼ˆå¦‚é‡‘å¸ï¼‰ï¼Œä¸”è¿‡æ»¤æ¡ä»¶ä¸æ˜¯ allï¼Œåˆ™è·³è¿‡
            if (filterCategory !== 'all' && itemDef.use !== filterCategory) continue;

            // åˆ¤æ–­â€œä½¿ç”¨â€æŒ‰é’®æ˜¯å¦å¯ç”¨
            let canUse = false;
            let btnText = "ä½¿ç”¨";

            // ã€ä¿®å¤ç‚¹2ã€‘å±žæ€§åä¿®æ­£ï¼šä½¿ç”¨ itemDef.use åˆ¤æ–­ç±»åž‹
            if (usageContext === 'battle') {
                // æˆ˜æ–—çŠ¶æ€ä¸‹ï¼šåªæœ‰ use='battle' çš„é“å…·å¯ç”¨
                if (itemDef.use === 'battle') canUse = true;
                else btnText = "ä¸å¯ç”¨";
            } else {
                // åœ°å›¾çŠ¶æ€ä¸‹ï¼š
                if (itemDef.use === 'map') {
                    canUse = true; // åœ°å›¾é“å…·ï¼ˆå›žåŸŽã€å¸ç¯·ï¼‰å¯ç”¨
                } else if (itemDef.use === 'home') {
                    btnText = "å®¶å›­å¯ç”¨"; // ææ–™ç±»
                } else if (itemDef.use === 'battle') {
                    btnText = "æˆ˜æ–—å¯ç”¨"; // æˆ˜æ–—è¯æ°´åœ¨å¹³æ—¶ä¸èƒ½å–ï¼ˆæˆ–è€…ä½ å¯ä»¥æ”¹ä¸ºèƒ½å–ï¼Œçœ‹éœ€æ±‚ï¼‰
                }
            }

            const row = document.createElement('div');
            row.className = 'rpg-item-row';
            row.innerHTML = `
                <div class="rpg-item-icon">${itemDef.icon}</div>
                <div class="rpg-item-info">
                    <div class="rpg-item-name">${itemDef.name} <span style="color:var(--primary-color)">x${count}</span></div>
                    <div class="rpg-item-desc">${itemDef.desc}</div>
                </div>
            `;

            const btn = document.createElement('button');
            btn.className = 'rpg-use-btn';
            btn.innerText = btnText;
            btn.disabled = !canUse;
            
            btn.onclick = () => {
                if (usageContext === 'battle') {
                    this.useItemInBattle(id);
                    // æˆ˜æ–—ä¸­ä½¿ç”¨åŽé€šå¸¸ç›´æŽ¥å…³é—­èƒŒåŒ…åŽ»é€‰äºº
                    // (å·²ç»åœ¨ useItemInBattle é‡Œå¤„ç†äº†å…³é—­é€»è¾‘)
                } else {
                    this.useItemInMap(id);
                    // åœ°å›¾ä¸­ä½¿ç”¨åŽåˆ·æ–°åˆ—è¡¨ï¼ˆä¾‹å¦‚æ•°é‡å‡å°‘ï¼‰
                    this.renderInventoryList(container, filterCategory, usageContext);
                }
            };

            row.appendChild(btn);
            container.appendChild(row);
            hasItem = true;
        }

        if (!hasItem) {
            let catName = filterCategory === 'all' ? '' : 
                          (filterCategory === 'battle' ? 'æˆ˜æ–—' : 
                          (filterCategory === 'map' ? 'åœ°å›¾' : 'å®¶å›­'));
            
            container.innerHTML += `<div style="text-align:center; color:#999; margin-top:20px;">æ²¡æœ‰${catName}é“å…·</div>`;
        }
    }

    // åœ°å›¾ä½¿ç”¨ç‰©å“
    useItemInMap(id) {
        const item = RPG_ITEMS[id];
        if (this.inventory[id] > 0) {
            this.inventory[id]--;
            
            if (id === 'return_scroll') {
                this.isGoingHome = true;
                this.showTeleportScreen("æ­£åœ¨ä¼ é€å›žå®¶...", 'light');
                setTimeout(() => {
                    document.getElementById('rpg-common-modal').classList.remove('visible');
                    this.hideTeleportScreen();
                    this.resume();
                    // è§¦å‘å›žå®¶é€»è¾‘
                    const homeIdx = this.LEVELS.findIndex(lv => lv.type === 'home');
                    this.loadLevel(homeIdx, 'start');
                }, 1000);
            } else if (id === 'tent') {
                this.showTeleportScreen("æ­£åœ¨ç”Ÿç«ä¼‘æ¯...", 'dark');
                this.p1.hp = this.p1.maxHp; this.p1.mp = this.p1.maxMp;
                this.p2.hp = this.p2.maxHp; this.p2.mp = this.p2.maxMp;
                
                setTimeout(() => {
                    this.hideTeleportScreen();
                    showToast("ä½“åŠ›å®Œå…¨æ¢å¤ï¼");
                }, 2000);
            }
        }
    }

    // æˆ˜æ–—ä½¿ç”¨ç‰©å“
useItemInBattle(id) {
        if (this.inventory[id] <= 0) return;

        // 1. è®°å½•å½“å‰å¾…ä½¿ç”¨çš„ç‰©å“
        this.pendingItemId = id;
        this.currentAction = 'item'; 

        // 2. å…³é—­èƒŒåŒ…æ¨¡æ€æ¡†
        document.getElementById('rpg-common-modal').classList.remove('visible');
        
        // ã€å…³é”®ä¿®å¤ã€‘å¿…é¡»åœ¨è¿™é‡Œæ¢å¤æ¸¸æˆå¾ªçŽ¯ï¼
        // ä¹‹å‰æ‰“å¼€èƒŒåŒ…æ—¶æ¸¸æˆè¢« stop() äº†ï¼Œå¦‚æžœä¸ resume()ï¼Œ
        // å³ä½¿çŠ¶æ€åˆ‡åˆ°äº† BATTLE_TARGETï¼Œç”»é¢ä¹Ÿä¸ä¼šåˆ·æ–°ï¼Œå¯¼è‡´çœ‹ä¸è§HPå˜åŒ–ï¼Œä¹Ÿçœ‹ä¸è§ç®­å¤´ã€‚
        this.isPaused = false;
        this.resume(); 
        
        // 3. è¿›å…¥ç›®æ ‡é€‰æ‹©çŠ¶æ€
        this.state = this.STATE.BATTLE_TARGET;
        document.getElementById('rpg-battle-menu').style.display = 'none';
        document.getElementById('rpg-battle-target-panel').style.display = 'flex';

        // 4. è®¾ç½®å¯é€‰ç›®æ ‡
        const itemDef = RPG_ITEMS[id];
        
        if (itemDef.effect && itemDef.effect.type === 'flee') {
            this.executeAction(this.p1, this.p1, 'item');
        } else {
            this.targets = this.battleTeam;
            this.targetIndex = 0; 
            this.showBottomDialog(this.p1.name, `å¯¹è°ä½¿ç”¨ ${itemDef.name}ï¼Ÿ`);
        }
    }





// ã€æ–°å¢žã€‘éšæœºåœ°å›¾ç»“å±€ï¼ˆæ‰“å®Œéšæœºä¸–ç•ŒBOSSåŽï¼‰
// ã€é‡æž„ç‰ˆã€‘è§¦å‘éšæœºåœ°å›¾ç»“å±€ (ä¼˜å…ˆè¯»å–AIç”Ÿæˆçš„æˆ˜åŽå‰§æƒ…)
triggerRandomEnding() {
    this.state = this.STATE.STORY;
    this.storyQueue = [];

    // 1. å°è¯•èŽ·å– AI ç”Ÿæˆçš„ç¬¬5å…³â€œæˆ˜åŽç»“å±€â€ (idx=4)
    const finalMapStory = this.randomMapData.mapStories[4];
    let endingLines = [];

    if (finalMapStory && finalMapStory.ending && finalMapStory.ending.length > 0) {
        // å¦‚æžœæœ‰ AI ç”Ÿæˆçš„ä¸“å±žç»“å±€ï¼Œç›´æŽ¥ä½¿ç”¨
        endingLines = finalMapStory.ending;
    } else {
        // å…œåº•æ–¹æ¡ˆï¼šå¦‚æžœæ²¡æœ‰ç”Ÿæˆç»“å±€ï¼Œä½¿ç”¨å¤§çº²æ‘˜è¦æˆ–é»˜è®¤æ–‡æœ¬
        const grandPlot = this.randomMapData.grandPlot || [];
        const finalSummary = grandPlot[4] || "å†’é™©ç»“æŸï¼Œè‹±é›„å‡¯æ—‹ã€‚";
        
        endingLines.push("éšç€ä¸€å£°å·¨å“ï¼Œå¼ºæ•Œå€’ä¸‹äº†ã€‚");
        endingLines.push("ã€ç»“å±€ç¯‡ã€‘");
        endingLines.push(finalSummary);
        endingLines.push(`${this.p2.name}ï¼šä¸€åˆ‡éƒ½ç»“æŸäº†...`);
        endingLines.push(`${this.p2.name}ï¼šè°¢è°¢ä½ ï¼Œæœ€å¥½çš„æ­æ¡£ã€‚`);
    }

    // 2. å°†å†…å®¹åŠ å…¥æ’­æ”¾é˜Ÿåˆ—
    endingLines.forEach(text => {
        // ç®€å•åˆ¤æ–­æ˜¯å¦åŒ…å«å†’å·æ¥åŒºåˆ†åå­—
        let name = "";
        let content = text;
        
        if (text.includes("ï¼š") || text.includes(":")) {
            const parts = text.split(/[ï¼š:]/);
            if (parts.length >= 2) {
                name = parts[0].trim();
                content = parts.slice(1).join("ï¼š").trim();
            }
        }
        
        this.storyQueue.push({ name: name, text: content });
    });

    // 3. æ·»åŠ ç³»ç»Ÿæç¤º
    this.storyQueue.push({ name: "", text: "ï¼ˆå†’é™©å·²å®Œæˆï¼Œå³å°†è¿”å›žå®¶å›­ï¼‰" });

    // 4. éšè—æˆ˜æ–—UI
    document.getElementById('rpg-battle-menu').style.display = 'none';
    document.getElementById('rpg-battle-target-panel').style.display = 'none';
    
    // æ¢å¤æ ‡é¢˜
    const titleEl = document.getElementById('rpg-header-title');
    if (titleEl) titleEl.innerText = this.curLv.name; 
    
    // æ ‡è®°å›žåŸŽ
    this.isGoingHome = true;
    this.nextStory();
}


// ã€æ–°å¢žæ–¹æ³•ã€‘è§¦å‘å•å¥å¯¹è¯ï¼ˆç”¨äºŽå®¶å…·äº¤äº’ã€ç®€å•æç¤ºï¼‰
    triggerSimpleDialog(name, text) {
        // 1. åˆ‡æ¢åˆ°å‰§æƒ…çŠ¶æ€ï¼Œæš‚åœåœ°å›¾æ“ä½œ
        this.state = this.STATE.STORY;
        
        // 2. æž„é€ åªæœ‰ä¸€å¥è¯çš„å‰§æƒ…é˜Ÿåˆ—
        this.storyQueue = [{ name: name, text: text }];
        
        // 3. å¯åŠ¨å‰§æƒ…ï¼ˆæ˜¾ç¤ºå¯¹è¯æ¡†ï¼Œéšè—æ–¹å‘é”®ï¼‰
        this.nextStory();
    }



    // åœ¨ RpgGame ç±»ä¸­æ›¿æ¢è¿™ä¸¤ä¸ªæ–¹æ³•

    // ã€ä¿®æ”¹ç‰ˆã€‘æ˜¾ç¤ºåº•éƒ¨å¯¹è¯æ¡† (æ”¯æŒéšè—æ—ç™½åå­—æ¡†)
showBottomDialog(name, text) {
    const dialogBox = document.getElementById('rpg-bottom-dialog');
    const nameBox = document.getElementById('rpg-dialog-name');
    const textBox = document.getElementById('rpg-dialog-text');
    
    dialogBox.style.display = 'flex';
    
    // éšè—é¡¶éƒ¨å¯¹è¯æ¡†ï¼ˆé˜²æ­¢å†²çªï¼‰
    document.getElementById('rpg-top-dialog').style.display = 'none';

    // é€»è¾‘ï¼šå¦‚æžœåå­—ä¸ºç©ºï¼Œæˆ–è€…åå­—æ˜¯"æ—ç™½"ï¼Œåˆ™éšè—åå­—æ¡†
    if (!name || name.trim() === "" || name === "æ—ç™½") {
        nameBox.style.display = 'none'; // å½»åº•éšè—åå­—æ¡†
        nameBox.innerText = "";
        
        // å¯é€‰ï¼šå¦‚æžœæ˜¯æ—ç™½ï¼Œå¯ä»¥å°†æ–‡æœ¬è®¾ä¸ºå±…ä¸­æˆ–æ–œä½“ï¼Œå¢žåŠ åŒºåˆ†åº¦
        // textBox.style.fontStyle = 'italic'; 
    } else {
        nameBox.style.display = 'block'; // æ˜¾ç¤ºåå­—æ¡†
        nameBox.innerText = name;
        // textBox.style.fontStyle = 'normal';
    }

    textBox.innerText = text;
    
    // å¯¹è¯æ—¶éšè—æ–¹å‘é”®å’Œäº¤äº’æŒ‰é’®
    const controls = document.getElementById('rpg-controls');
    if (controls) controls.style.display = 'none';
    
    const interactBtn = document.getElementById('rpg-interact-btn');
    if (interactBtn) interactBtn.style.display = 'none';
}

showTopDialog(name, text) {
        let box = document.getElementById('rpg-top-dialog');
        box.style.display = 'block'; box.innerText = `${name}: ${text}`;
    }



    closeDialogs() {
        document.getElementById('rpg-bottom-dialog').style.display = 'none';
        document.getElementById('rpg-top-dialog').style.display = 'none';
        
        // ã€æ–°å¢žã€‘å¯¹è¯ç»“æŸï¼Œå¦‚æžœæ˜¯åœ¨åœ°å›¾æ¨¡å¼ï¼Œæ¢å¤æ–¹å‘é”®
        if (this.state === this.STATE.MAP) {
            const controls = document.getElementById('rpg-controls');
            if (controls) controls.style.display = 'block';
            
            // æ¢å¤äº¤äº’æŒ‰é’®ï¼ˆå¦‚æžœæœ‰å¾…äº¤äº’å¯¹è±¡ï¼‰
            if (this.pendingInteraction) {
                 const interactBtn = document.getElementById('rpg-interact-btn');
                 if (interactBtn) interactBtn.style.display = 'flex';
            }
        }
    }

    draw() {
        this.ctx.fillStyle = "#111";
        this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
        if (this.curLv && this.curLv.type === 'prologue') {
        return; 
    }
        // åªæœ‰åœ¨ random0 ä¸” æ˜¯å¼€åœºå‰§æƒ…æ—¶ï¼Œæ‰éšè—åœ°å›¾
        if (this.curLv && this.curLv.id === 'random0' && this.isOpeningStory) {
            return;
        }
        if (this.state === this.STATE.MAP || this.state === this.STATE.STORY) this.drawMapMode();
        else if (this.state >= this.STATE.BATTLE_CMD && this.state !== this.STATE.GAME_OVER) this.drawBattleMode();
    }

    // --- è¾…åŠ©ï¼šç»˜åˆ¶å¸¦å™ªç‚¹çš„æ–¹å— (æ¨¡æ‹Ÿæè´¨) ---
    // --- ä¿®å¤ç‰ˆï¼šåŸºäºŽåœ°å›¾åæ ‡çš„ç¡®å®šæ€§çº¹ç† ---
    // ctx: ç”»å¸ƒ
    // dx, dy: å±å¹•ä¸Šçš„ç»˜åˆ¶åæ ‡ (ç”¨äºŽç”»å›¾)
    // mapX, mapY: åœ°å›¾ç½‘æ ¼åæ ‡ (ç”¨äºŽç”Ÿæˆå›ºå®šçš„éšæœºæ•°)
    // size: æ ¼å­å¤§å°
    // type: 'floor' æˆ– 'wall'
    drawTexturedTile(ctx, dx, dy, mapX, mapY, size, type, baseColor) {
        // 1. ç»˜åˆ¶åº•è‰²
        ctx.fillStyle = baseColor;
        ctx.fillRect(dx, dy, size, size);

        // 2. ä¼ªéšæœºæ•°ç”Ÿæˆå™¨ (æ ¸å¿ƒä¿®å¤ï¼šåªè¦ mapX å’Œ mapY ä¸å˜ï¼Œç®—å‡ºæ¥çš„ rand æ°¸è¿œä¸å˜)
        // è¿™æ˜¯ä¸€ä¸ªç®€å•çš„å“ˆå¸Œç®—æ³•ï¼Œé¿å…ä½¿ç”¨ Math.random()
        const pseudoRandom = (x, y) => {
            let n = x * 331 + y * 433; // ä»»æ„è´¨æ•°
            n = (n << 13) ^ n;
            return (n * (n * n * 15731 + 789221) + 1376312589) & 0x7fffffff;
        };
        
        const randVal = pseudoRandom(mapX, mapY);
        const variant = randVal % 10; // ç”Ÿæˆ 0-9 çš„å˜ç§ç¼–å·

        // 3. æ ¹æ®å˜ç§ç»˜åˆ¶è£…é¥° (é™ä½Žå¯†åº¦ï¼Œåªæœ‰ç‰¹å®šç¼–å·æ‰ç”»ä¸œè¥¿ï¼Œå°±ä¸ä¼šèŠ±äº†)
        
        if (type === 'floor') {
            // --- åœ°æ¿/è‰åœ°æ¨¡å¼ ---
            // åªæœ‰ 30% çš„æ ¼å­æœ‰è£…é¥°ï¼Œå‰©ä¸‹ 70% æ˜¯å¹²å‡€çš„åº•è‰²
            if (variant === 0 || variant === 1) { 
                // å˜ç§A: ç”»ä¸¤æ ¹å°è‰ (æ·±è‰²ä¸€ç‚¹ç‚¹)
                ctx.fillStyle = "rgba(0, 0, 0, 0.1)"; 
                ctx.fillRect(dx + size * 0.3, dy + size * 0.4, 2, 4);
                ctx.fillRect(dx + size * 0.4, dy + size * 0.3, 2, 5);
            } else if (variant === 2) {
                // å˜ç§B: ç”»ä¸€ä¸ªå°çŸ³å­/äº®æ–‘ (äº®è‰²)
                ctx.fillStyle = "rgba(255, 255, 255, 0.15)";
                ctx.fillRect(dx + size * 0.7, dy + size * 0.7, 4, 4);
            }
            // variant 3-9 ä»€ä¹ˆéƒ½ä¸ç”»ï¼Œä¿æŒå¹²å‡€
        } 
        else if (type === 'wall') {
            // --- å¢™å£æ¨¡å¼ ---
            // å¢™å£åŠ ä¸€ç‚¹ç –ç¼çº¹ç†
            ctx.fillStyle = "rgba(0, 0, 0, 0.15)"; // é˜´å½±è‰²
            
            if (variant < 3) {
                // æ ·å¼1ï¼šæ¨ªå‘ç –ç¼
                ctx.fillRect(dx, dy + size * 0.5, size, 2);
                ctx.fillRect(dx + size * 0.5, dy + size * 0.5, 2, size * 0.5);
            } else if (variant < 6) {
                // æ ·å¼2ï¼šè£‚çº¹
                ctx.fillRect(dx + size * 0.2, dy + size * 0.2, 2, 6);
                ctx.fillRect(dx + size * 0.2, dy + size * 0.4, 6, 2);
            }
            
            // ç»Ÿä¸€åŠ ä¸€ä¸ªé¡¶éƒ¨é«˜å…‰ï¼Œå¢žåŠ ç«‹ä½“æ„Ÿ
            ctx.fillStyle = "rgba(255, 255, 255, 0.1)";
            ctx.fillRect(dx, dy, size, 2);
        }
    }

drawMapMode() {
    // 1. è®¡ç®—å¯è§†åŒºåŸŸ
    let startCol = Math.floor(this.cam.x / RPG_CONFIG.TILE);
    let endCol = startCol + Math.ceil(this.canvas.width / RPG_CONFIG.TILE) + 1;
    let startRow = Math.floor(this.cam.y / RPG_CONFIG.TILE);
    let endRow = startRow + Math.ceil(this.canvas.height / RPG_CONFIG.TILE) + 1;

    // å®‰å…¨èŽ·å–å·²è§¦å‘ç‚¹é›†åˆ (é˜²æ­¢æŠ¥é”™)
    const triggeredSet = (this.randomMapData && this.randomMapData.triggeredPoints instanceof Set) 
        ? this.randomMapData.triggeredPoints 
        : new Set();


// ç»Ÿè®¡è§£é”è¿›åº¦ (ç”¨äºŽå‡ºå£åˆ¤æ–­)
let unlockedPoints = 0;
if (this.curLv.type === 'random') {
    const mapId = this.curLv.id;
    const mapState = this.randomMapData?.mapStates?.[mapId]; // ã€ä¿®å¤ã€‘æ·»åŠ å¯é€‰é“¾
    
    if (mapState) {
        unlockedPoints = mapState.triggered.size;
    }
}
const isExitOpen = (this.curLv.type !== 'random' || this.curLv.id === 'random0' || unlockedPoints >= 3);
// ã€ä¿®å¤ã€‘æ•™ç¨‹åœ°å›¾é»˜è®¤å¼€å¯å‡ºå£

    // ===============================================
    // ç¬¬ä¸€å±‚å¾ªçŽ¯ï¼šç»˜åˆ¶ åœ°å½¢ã€è£…é¥°ã€ç‰¹æ•ˆ
    // ===============================================
    for(let y=startRow; y<=endRow; y++) {
        for(let x=startCol; x<=endCol; x++) {
            if(y>=0 && y<this.h && x>=0 && x<this.w) {
                let dx = Math.floor(x * RPG_CONFIG.TILE - this.cam.x);
                let dy = Math.floor(y * RPG_CONFIG.TILE - this.cam.y);
                let tileSize = RPG_CONFIG.TILE;
                let tile = this.mapData[y][x];

                // ã€æ­¥éª¤1ã€‘å…ˆç”»åœ°æ¿ (æ‰“åº•)
                this.drawTexturedTile(this.ctx, dx, dy, x, y, tileSize, 'floor', this.curLv.colors.floor);

                // ã€æ­¥éª¤2ã€‘ç”»å¢™å£
                if(tile === '#') {
                    this.drawTexturedTile(this.ctx, dx, dy, x, y, tileSize, 'wall', this.curLv.colors.wall);
                    // å¢™å£é˜´å½±
                    this.ctx.fillStyle = "rgba(0,0,0,0.3)";
                    this.ctx.fillRect(dx, dy + tileSize - 8, tileSize, 8);
                }

if (tile === 'T') {
    let isTriggered = false;
    
    // ã€ä¿®å¤ã€‘åªæœ‰éšæœºåœ°å›¾æ‰æ£€æŸ¥è§¦å‘çŠ¶æ€
    if (this.curLv.type === 'random') {
        const mapId = this.curLv.id;
        const mapState = this.randomMapData?.mapStates?.[mapId]; // æ·»åŠ å¯é€‰é“¾
        
        if (mapState) {
            const pointKey = `${x},${y}`;
            isTriggered = mapState.triggered.has(pointKey);
        }
    } else {
        // æ•™ç¨‹åœ°å›¾çš„ T ç‚¹ï¼ˆå¦‚æžœæœ‰ï¼‰é»˜è®¤ä¸æ˜¾ç¤ºï¼Œæˆ–è€…ä½ å¯ä»¥æ”¹ä¸º true è®©å®ƒæ˜¾ç¤º
        isTriggered = true; // ä¸æ˜¾ç¤ºå‰§æƒ…ç‚¹å›¾æ ‡
    }
    
    if (!isTriggered) {
        // â˜… æœªè§¦å‘ï¼šç»˜åˆ¶å‘å…‰ç‰¹æ•ˆ â˜…
        this.ctx.save();
        
        const alpha = 0.6 + Math.sin(Date.now() / 200) * 0.4;
        this.ctx.shadowBlur = 20;
        this.ctx.shadowColor = "#f1c40f"; 
        
        this.ctx.fillStyle = `rgba(241, 196, 15, ${alpha})`;
        this.ctx.beginPath();
        this.ctx.arc(dx + tileSize/2, dy + tileSize/2, 12, 0, Math.PI*2);
        this.ctx.fill();
        
        this.ctx.shadowBlur = 0;
        this.ctx.fillStyle = "#fff";
        this.ctx.font = "bold 20px Arial";
        this.ctx.textAlign = "center";
        this.ctx.textBaseline = "middle";
        this.ctx.fillText("?", dx + tileSize/2, dy + tileSize/2 + 1);
        
        this.ctx.restore();
    } 
}

                // ã€æ­¥éª¤4ã€‘ç”»å‡ºå£ E / å…¥å£ P
                if(tile === 'P') {
                    this.drawExitOrEntry(dx, dy, tileSize, "#fff", true);
                }
                
                if(tile === 'E') {
                    if (this.curLv.type !== 'random' || isExitOpen) {
                        // å·²è§£é”
                        this.drawExitOrEntry(dx, dy, tileSize, "#fff", true);
                    } else {
                        // æœªè§£é”ï¼šç”»çº¢è‰²å°å°
                        this.ctx.save();
                        this.ctx.fillStyle = "rgba(231, 76, 60, 0.6)"; 
                        this.ctx.beginPath();
                        this.ctx.arc(dx + tileSize/2, dy + tileSize/2, 14, 0, Math.PI*2);
                        this.ctx.fill();
                        
                        this.ctx.fillStyle = "#fff";
                        this.ctx.font = "16px Arial";
                        this.ctx.textAlign = "center";
                        this.ctx.textBaseline = "middle";
                        this.ctx.fillText("ðŸ”’", dx + tileSize/2, dy + tileSize/2);
                        this.ctx.restore();
                    }
                }

                // ã€æ­¥éª¤5ã€‘ç”»ç‰¹æ®Šç‰¹æ•ˆ (å®¶å›­ä¼ é€é—¨)
                if (this.curLv.type === 'home' && this.gatePos && x === this.gatePos.x && y === this.gatePos.y) {
                    this.drawMagicGate(dx, dy, tileSize);
                }
            }
        }
    }

    // ===============================================
    // ç¬¬äºŒå±‚å¾ªçŽ¯ï¼šç»˜åˆ¶ å®žä½“ä¸Žå®¶å…· (é®æŒ¡å…³ç³»)
    // ===============================================
    
    // 1. åº•å±‚å®¶å…· (åœ°æ¯¯)
    this.drawFurniture('bottom');
    if (this.curLv.id === 'home') this.drawHomeBuildings();

    // 2. å®žä½“ (æŒ‰Yè½´æŽ’åºï¼Œå®žçŽ°é®æŒ¡)
    const entities = [...this.mapEnemies, this.p2, this.p1].sort((a,b) => a.y - b.y);
    entities.forEach(e => this.drawEntityOnMap(e));

    // 3. é¡¶å±‚å®¶å…· (æ¡Œå­)
    this.drawFurniture('top');
    if (this.curLv.id === 'home') this.drawHomeRoof();
}

// è¾…åŠ©æ–¹æ³•ï¼šç»˜åˆ¶å‡ºå…¥å£åœˆåœˆ
drawExitOrEntry(dx, dy, size, color, glow) {
    this.ctx.save();
    this.ctx.fillStyle = color; 
    if (glow) {
        this.ctx.globalAlpha = 0.3 + Math.sin(Date.now()/200)*0.1;
    }
    this.ctx.beginPath(); 
    this.ctx.arc(dx+size/2, dy+size/2, 12, 0, 6.28); 
    this.ctx.fill();
    this.ctx.restore();
}

// ã€æ–°å¢žè¾…åŠ©ã€‘ç»˜åˆ¶æ—¶ç©ºä¹‹é—¨ç‰¹æ•ˆ
drawMagicGate(dx, dy, tileSize) {
    this.ctx.save();
    const time = Date.now() / 1000;
    const pulse = 0.5 + Math.sin(time * 2) * 0.3;
    const gradient = this.ctx.createRadialGradient(
        dx + tileSize/2, dy + tileSize/2, 0,
        dx + tileSize/2, dy + tileSize/2, tileSize/2 * pulse
    );
    gradient.addColorStop(0, 'rgba(138, 43, 226, 0.8)');
    gradient.addColorStop(0.5, 'rgba(75, 0, 130, 0.5)');
    gradient.addColorStop(1, 'rgba(138, 43, 226, 0)');
    this.ctx.fillStyle = gradient;
    this.ctx.fillRect(dx, dy, tileSize, tileSize);
    this.ctx.fillStyle = '#fff';
    this.ctx.globalAlpha = 0.8 + Math.sin(time * 3) * 0.2;
    this.ctx.font = 'bold 32px Arial';
    this.ctx.textAlign = 'center';
    this.ctx.textBaseline = 'middle';
    this.ctx.fillText('âœ¦', dx + tileSize/2, dy + tileSize/2);
    this.ctx.restore();
}

// ã€æ–°å¢žè¾…åŠ©ã€‘ç»˜åˆ¶å®¶å›­å»ºç­‘ç»“æž„
drawHomeBuildings() {
    // æˆ¿å­ä¸»ä½“
    this.ctx.fillStyle = "#ecf0f1";
    this.ctx.fillRect((13 * 64) - this.cam.x, (3 * 64) - this.cam.y, 5*64, 4*64);
    // é»‘é—¨
    this.ctx.fillStyle = "#2c3e50";
    this.ctx.fillRect((15 * 64) - this.cam.x, (5 * 64) - this.cam.y + 10, 64, 54);
    // å‘Šç¤ºç‰Œ (å•†åº—)
    let signX = (10 * 64) - this.cam.x + 20;
    let signY = (6 * 64) - this.cam.y + 10;
    this.ctx.fillStyle = "#e67e22";
    this.ctx.fillRect(signX, signY, 24, 40);
    this.ctx.fillStyle = "#fff";
    this.ctx.font = "10px Arial";
    this.ctx.fillText("SHOP", signX - 2, signY + 20);
}

// ã€æ–°å¢žè¾…åŠ©ã€‘ç»˜åˆ¶å±‹é¡¶
drawHomeRoof() {
    const pY = this.p1.y;
    // å¦‚æžœçŽ©å®¶åœ¨æˆ¿å­Yåæ ‡èŒƒå›´å†…(3-5)ï¼ŒåŠé€æ˜Ž
    if (pY <= 5 && pY >= 3 && this.p1.x >= 13 && this.p1.x <= 17) {
        this.ctx.globalAlpha = 0.4;
    } else {
        this.ctx.globalAlpha = 1.0;
    }
    this.ctx.fillStyle = "#c0392b";
    // ç®€åŒ–å±‹é¡¶ï¼šè¦†ç›–åœ¨å¢™ä½“ä¸ŠåŠéƒ¨åˆ†
    this.ctx.fillRect((12.5 * 64) - this.cam.x, (2 * 64) - this.cam.y, 6*64, 2*64);
    this.ctx.globalAlpha = 1.0;
}

   // ç»˜åˆ¶å®¶å…· Helper
    drawFurniture(layer) {
        // èŽ·å–å½“å‰åœ°å›¾çš„æ‰€æœ‰å·²è´­å®¶å…· + é»˜è®¤å®¶å…·
        const myItems = this.homeState.furniture;
        
        // åˆå¹¶é»˜è®¤å®¶å…· (è¡£æŸœç­‰)
        const defaults = [
            { id: 'wardrobe', x: 1, y: 1, map: 'indoor', icon: 'ðŸšª', color: '#8e44ad', name: 'è¡£æŸœ' },
            { id: 'log', x: 4, y: 2, map: 'indoor', icon: 'ðŸ“–', color: '#f39c12', name: 'å†’é™©æ‰‹è´¦' }
        ];
        
        const all = [...defaults];
        myItems.forEach(id => {
            if (RPG_FURNITURE[id]) all.push(RPG_FURNITURE[id]);
        });
        
        all.forEach(f => {
            if (f.map !== this.curLv.id) return; // ä¸åœ¨å½“å‰åœ°å›¾
            
            let dx = f.x * 64 - this.cam.x;
            let dy = f.y * 64 - this.cam.y;
            
            // ç®€å•çš„å±‚çº§åŒºåˆ†ï¼ˆæš‚ä¸å¤æ‚åŒ–ï¼‰
            if (layer === 'bottom') {
                 this.ctx.fillStyle = f.color || '#999';
                 this.ctx.fillRect(dx+10, dy+10, 44, 44);
                 this.ctx.fillStyle = "#fff";
                 this.ctx.font = "24px Arial";
                 this.ctx.fillText(f.icon, dx+20, dy+40);
            }
        });
    }

getFurnitureAt(x, y) {
        // é€»è¾‘åŒ drawFurnitureï¼ŒæŸ¥æ‰¾åæ ‡åŒ¹é…
         const defaults = [
            { id: 'wardrobe', x: 1, y: 1, map: 'indoor', type: 'wardrobe' },
            { id: 'log', x: 4, y: 2, map: 'indoor', type: 'log' }
        ];
        const myItems = this.homeState.furniture.map(id => RPG_FURNITURE[id]);
        const all = [...defaults, ...myItems];
        return all.find(f => f.map === this.curLv.id && f.x === x && f.y === y);
    }
    

    interactWithFurniture(f) {
        if (f.type === 'wardrobe') {
            // è¡£æŸœé€»è¾‘
            if (this.inventory['dye'] > 0) {
                 // confirm æ˜¯æµè§ˆå™¨åŽŸç”Ÿå¼¹çª—ï¼Œä¸å—æ¸¸æˆçŠ¶æ€å½±å“ï¼Œè¿™é‡Œä¿æŒåŽŸæ ·å³å¯
                 // æˆ–è€…ä¹Ÿå¯ä»¥æ”¹æˆæ¸¸æˆå†…çš„å¯¹è¯é€»è¾‘ï¼Œä¸ºäº†ç®€å•å…ˆä¿ç•™ confirm
                 if(confirm("æ¶ˆè€—1ä¸ªæŸ“æ–™éšæœºæ”¹å˜ä¸Šè¡£é¢œè‰²ï¼Ÿ")) {
                     this.inventory['dye']--;
                     this.p1.bodyColor = '#' + Math.floor(Math.random()*16777215).toString(16);
                     this.p1.styleData.top = this.p1.bodyColor; 
                     this.p1.sprite = generateCharaSprite(this.p1.styleData);
                     
                     // æˆåŠŸåŽçš„æç¤ºä¹Ÿæ”¹ä¸ºç‚¹å‡»å…³é—­
                     this.triggerSimpleDialog("", "è¡£æœç„•ç„¶ä¸€æ–°ï¼(é¢œè‰²å·²æ”¹å˜)");
                 }
            } else {
                // ã€ä¿®å¤ã€‘æ”¹ä¸ºè§¦å‘å•å¥å‰§æƒ…
                this.triggerSimpleDialog("", "è¡£æŸœé‡Œåªæœ‰æ—§è¡£æœ... (éœ€è¦'ç¥žå¥‡æŸ“æ–™'æ‰èƒ½æŸ“è‰²)");
            }
        } else if (f.id === 'bed') {
            // åºŠé€»è¾‘
            this.p1.hp = this.p1.maxHp; this.p1.mp = this.p1.maxMp;
            this.p2.hp = this.p2.maxHp; this.p2.mp = this.p2.maxMp;
            
            
            // ã€ä¿®å¤ã€‘æ”¹ä¸ºè§¦å‘å•å¥å‰§æƒ…
            this.triggerSimpleDialog("", "å¥½èˆ’æœçš„åºŠ... Zzz (å…¨å‘˜HP/MPå·²æ¢å¤)");
            
        } else if (f.id === 'log') {
            // å†’é™©æ—¥å¿—é€»è¾‘
            const visitedCount = this.visitedLevels.size;
            const text = `å†’é™©æ—¥å¿—ï¼š\næˆ‘ä»¬å·²ç»æŽ¢ç´¢äº† ${visitedCount} ä¸ªåŒºåŸŸã€‚\nå½“å‰æŒæœ‰é‡‘å¸ï¼š${this.currency}`;
            this.triggerSimpleDialog("", text);
            
        } else {
            // é€šç”¨å®¶å…·æè¿°
            // ã€ä¿®å¤ã€‘æ”¹ä¸ºè§¦å‘å•å¥å‰§æƒ…
            this.triggerSimpleDialog("", `è¿™æ˜¯ ${f.name}ã€‚`);
        }
    }
    
    // å•†åº—ç³»ç»Ÿ
        // === æ‰“å¼€å•†åº— (ä¿®å¤ç‰ˆ) ===
    // === æ‰“å¼€å•†åº— (é€»è¾‘ä¿®å¤ç‰ˆ) ===
    openShop() {
        // 1. è®¾ç½®æš‚åœ
        this.toggleMenu(false); // ç¡®ä¿æš‚åœèœå•å…³é—­
        this.isPaused = true;
        this.stop(); // åœæ­¢å¾ªçŽ¯
        
        const modal = document.getElementById('rpg-common-modal');
        const list = document.getElementById('rpg-modal-body');
        const tabs = document.getElementById('rpg-modal-tabs');
        
        if (!modal) return;

        document.getElementById('rpg-modal-title').innerText = 'å®¶å…·å•†åº—';
        if(tabs) tabs.style.display = 'none'; // å•†åº—ä¸éœ€è¦åˆ†ç±»Tab
        
        list.innerHTML = '';
        
        // ä½™é¢æ˜¾ç¤º
        const currencyDiv = document.createElement('div');
        currencyDiv.style.cssText = "padding:10px; font-weight:bold; color:#e67e22; background:#fff8e1; border-radius:8px; margin-bottom:10px; text-align:right;";
        currencyDiv.innerText = `æŒæœ‰é‡‘å¸: ${this.currency}`;
        list.appendChild(currencyDiv);

        // å¡«å……åˆ—è¡¨
        Object.entries(RPG_FURNITURE).forEach(([id, item]) => {
            const isBought = this.homeState.furniture.includes(id);
            
            const row = document.createElement('div');
            row.className = 'rpg-item-row';
            row.innerHTML = `
                <div class="rpg-item-icon">${item.icon}</div>
                <div class="rpg-item-info">
                    <div class="rpg-item-name">${item.name}</div>
                    <div class="rpg-item-desc" style="color:#e67e22; font-weight:bold;">${item.cost} é‡‘å¸ | ${item.map === 'indoor' ? 'å®¤å†…' : 'å®¤å¤–'}</div>
                </div>
            `;
            
            const btn = document.createElement('button');
            btn.className = 'rpg-use-btn';
            btn.innerText = isBought ? 'å·²è´­ä¹°' : 'è´­ä¹°';
            btn.disabled = isBought || this.currency < item.cost;
            if (isBought) btn.style.background = '#ccc';
            
            btn.onclick = () => {
                if (this.currency >= item.cost && !isBought) {
                    this.currency -= item.cost;
                    this.homeState.furniture.push(id);
                    // è´­ä¹°æˆåŠŸæç¤º
                    this.triggerSimpleDialog("", `èŠ±è´¹ ${item.cost} é‡‘å¸è´­ä¹°äº† ${item.name}ï¼`);
                    this.openShop(); // åˆ·æ–°ç•Œé¢
                }
            };
            
            row.appendChild(btn);
            list.appendChild(row);
        });
        
        modal.classList.add('visible');
        
        // ã€å…³é”®ä¿®å¤ã€‘å®šä¹‰æ¢å¤æ¸¸æˆçš„å…³é—­é€»è¾‘
        const handleClose = () => {
            modal.classList.remove('visible');
            this.isPaused = false; // å¿…é¡»é‡ç½®
            this.resume();         // å¿…é¡»æ¢å¤
        };
        
        // ç»‘å®šå…³é—­äº‹ä»¶
        const closeBtn = document.getElementById('rpg-modal-close-btn');
        // å…‹éš†èŠ‚ç‚¹ä»¥ç§»é™¤æ—§ç›‘å¬å™¨
        const newCloseBtn = closeBtn.cloneNode(true);
        closeBtn.parentNode.replaceChild(newCloseBtn, closeBtn);
        newCloseBtn.onclick = handleClose;

        modal.onclick = (e) => {
             if (e.target === modal) handleClose();
        };
    }

openStatus() {
        // ç®€å•å®žçŽ°ï¼šå¼¹ä¸ªæç¤ºæˆ–è€…æ˜¾ç¤ºç®€å•é¢æ¿
        const stats = `
        å‹‡è€… LV.${this.p1.lv}  HP:${this.p1.hp}/${this.p1.maxHp}  ATK:${this.p1.atk}
        ä¼™ä¼´ LV.${this.p2.lv}  HP:${this.p2.hp}/${this.p2.maxHp}  ATK:${this.p2.atk}
        ç»éªŒå€¼: ${this.p1.xp}/${this.p1.nextXp}
        `;
        alert(stats); // æš‚æ—¶ç”¨ alertï¼Œæˆ–è€…ä½ å¯ä»¥å¤ç”¨ modal æ˜¾ç¤º
    }

drawEntityOnMap(e) {
    let rawDx = e.x * RPG_CONFIG.TILE - this.cam.x;
    let rawDy = e.y * RPG_CONFIG.TILE - this.cam.y;
    
    let dx = Math.floor(rawDx);
    let dy = Math.floor(rawDy);
    
    if (e.sprite) {
        // ã€æ–°å¢žã€‘ç¡®ä¿æŠ—é”¯é½¿å…³é—­
        this.ctx.imageSmoothingEnabled = false;
        
        const spriteSize = 64; 
        const sx = e.step * spriteSize;
        const sy = (e.direction || 0) * spriteSize;
        const drawSize = RPG_CONFIG.TILE; 
        const destY = Math.floor(dy - 16); 

        if (e.type === 'enemy' || e.type === 'boss') {
            const bounce = Math.floor(Math.sin(Date.now() / 200) * 3);
            this.ctx.drawImage(e.sprite, sx, sy, spriteSize, spriteSize, dx, dy + bounce, drawSize, drawSize);
            
            this.ctx.fillStyle = "#fff"; 
            this.ctx.font = "bold 20px Arial";
            this.ctx.fillText("!", dx + drawSize/2 - 4, dy);
        } else {
            this.ctx.drawImage(
                e.sprite, 
                sx, sy, spriteSize, spriteSize,
                dx, destY, drawSize, drawSize
            );
        }
    } else {
        let size = RPG_CONFIG.TILE;
        let bodySize = size * 0.8;
        this.ctx.fillStyle = e.bodyColor;
        this.ctx.fillRect(dx + (size-bodySize)/2, dy + size - bodySize, bodySize, bodySize);
    }
}

// ã€ä¼˜åŒ–ç‰ˆã€‘ç»˜åˆ¶æˆ˜æ–—å•ä½ï¼šä½¿ç”¨ source-atop å®žçŽ°å®Œç¾Žè´´åˆçš„æŸ“è‰²
    drawBattleUnit(e, x, y) {
        let drawX = Math.floor(x);
        
        // çŠ¶æ€æŠ–åŠ¨æ•ˆæžœ
        if(e.shake > 0) { 
            drawX += Math.floor((Math.random()-0.5)*10);
            e.shake--; 
        }
        
        let size = 64; 
        let isDead = e.hp <= 0;

        if (e.sprite) {
            this.ctx.save();
            this.ctx.imageSmoothingEnabled = false;

            // æ­»äº¡ç°é˜¶æ•ˆæžœ
            if (isDead) {
                this.ctx.globalAlpha = 0.5;
                this.ctx.filter = 'grayscale(100%)';
            }

            // === 1. æ¸…ç©ºå¹¶å‡†å¤‡ç¼“å†²åŒº ===
            this.bufferCtx.clearRect(0, 0, 64, 64);
            
            // === 2. å°†è§’è‰²ç»˜åˆ¶åˆ°ç¼“å†²åŒº ===
            if (e.type === 'player' || e.type === 'partner') {
                const spriteSize = 64;
                const dir = 2; // æˆ˜æ–—æ—¶æœå‘
                // ç»˜åˆ¶åˆ°ç¼“å†²åŒºçš„ (0,0)
                this.bufferCtx.drawImage(e.sprite, 0, dir * spriteSize, spriteSize, spriteSize, 0, 0, 64, 64);
            } else {
                const monsterSize = 48;
                // æ€ªç‰©è¾ƒå°ï¼Œç»˜åˆ¶åˆ°ç¼“å†²åŒºä¸­å¿ƒ (8,8) ä½ç½®ï¼Œä½¿å…¶å±…ä¸­
                this.bufferCtx.drawImage(e.sprite, 0, 0, 48, 48, 8, 8, 48, 48);
            }

            // === 3. åº”ç”¨çŠ¶æ€é¢œè‰²é®ç½© (å…³é”®æ­¥éª¤) ===
            if (!isDead && e.status) {
                // åˆ‡æ¢æ··åˆæ¨¡å¼ï¼šåŽç»­ç»˜åˆ¶çš„å†…å®¹åªä¼šå‡ºçŽ°åœ¨å·²æœ‰åƒç´ çš„åŒºåŸŸ
                this.bufferCtx.globalCompositeOperation = 'source-atop';
                
                Object.keys(e.status).forEach(statusId => {
                    const config = RPG_STATUS_CONFIG[statusId];
                    if (config && config.overlay) {
                        this.bufferCtx.fillStyle = config.overlay;
                        // å¡«æ»¡æ•´ä¸ªç¼“å†²åŒºï¼Œä½†å› ä¸º source-atopï¼Œåªä¼šæŸ“åˆ°äººç‰©èº«ä¸Š
                        this.bufferCtx.fillRect(0, 0, 64, 64);
                    }
                });
                
                // æ¢å¤é»˜è®¤æ··åˆæ¨¡å¼ï¼Œä»¥å…å½±å“ä¸‹ä¸€æ¬¡ç»˜åˆ¶
                this.bufferCtx.globalCompositeOperation = 'source-over';
            }

            // === 4. å°†å¤„ç†å¥½çš„ç¼“å†²åŒºç»˜åˆ¶åˆ°ä¸»å±å¹• ===
            this.ctx.drawImage(this.bufferCanvas, drawX, y, size, size);

            this.ctx.restore();
        } else {
            // å…œåº•ï¼šå¦‚æžœæ²¡æœ‰ sprite å›¾ç‰‡ï¼Œç”»æ–¹å—
            this.ctx.fillStyle = isDead ? "#555" : (e.bodyColor || "#888");
            this.ctx.fillRect(drawX, y, size, size);
        }

        // ç»˜åˆ¶è¡€æ¡ (ä¿æŒä¸å˜)
        const hasMp = (e.type !== 'enemy' && e.type !== 'boss');
        const barHeight = 6;
        const gap = 4;
        let mpY = y - 10 - barHeight;
        let hpY = hasMp ? (mpY - gap - barHeight) : (y - 10 - barHeight);

        this.drawBarWithNum(drawX, hpY, size, e.hp, e.maxHp, isDead ? "#555" : "#e74c3c");
        if (hasMp) {
            this.drawBarWithNum(drawX, mpY, size, e.mp, e.maxMp, isDead ? "#555" : "#3498db");
        }

        // ç»˜åˆ¶å¤´é¡¶çŠ¶æ€å›¾æ ‡
        if (!isDead && e.status) {
            let iconOffsetX = 0;
            const iconY = hpY - 15; 

            Object.keys(e.status).forEach(statusId => {
                const config = RPG_STATUS_CONFIG[statusId];
                if (config && config.icon) {
                    this.ctx.font = "16px Arial";
                    this.ctx.textAlign = "center";
                    this.ctx.fillStyle = "#fff"; // ç¡®ä¿æ–‡å­—ç™½è‰²
                    // åŠ ä¸Šé»‘è‰²æè¾¹ï¼Œé˜²æ­¢åœ¨æµ…è‰²èƒŒæ™¯çœ‹ä¸æ¸…
                    this.ctx.strokeStyle = "rgba(0,0,0,0.5)";
                    this.ctx.lineWidth = 2;
                    this.ctx.strokeText(config.icon, drawX + size/2 + iconOffsetX, iconY);
                    this.ctx.fillText(config.icon, drawX + size/2 + iconOffsetX, iconY);
                    
                    iconOffsetX += 20; 
                }
            });
        }
    }


    drawBarWithNum(x, y, w, val, max, color) {
        let h = 8;
        this.ctx.fillStyle = "#444"; this.ctx.fillRect(x, y, w, h);
        this.ctx.fillStyle = color; this.ctx.fillRect(x, y, w * (Math.max(0,val)/max), h);
        this.ctx.fillStyle = "#fff"; this.ctx.font = "10px Arial"; this.ctx.fillText(`${Math.max(0,val)}`, x + w + 5, y + 8);
    }

    drawMarker(x, y) {
        this.ctx.fillStyle = "#f1c40f"; this.ctx.beginPath();
        let bounce = Math.sin(Date.now()/100) * 5;
        this.ctx.moveTo(x - 10, y + bounce); this.ctx.lineTo(x + 10, y + bounce); this.ctx.lineTo(x, y + 10 + bounce); this.ctx.fill();
    }
}

// ã€å…¨å±€å‡½æ•°ã€‘æ¸¸æˆåˆå§‹åŒ–ä¸Žäº‹ä»¶ç»‘å®š
// è¯·ç¡®ä¿æ­¤å‡½æ•°åœ¨ RpgGame ç±»çš„é—­åˆå¤§æ‹¬å· } ä¹‹åŽï¼
function setupRpgGame() {
    console.log("æ­£åœ¨åˆå§‹åŒ– RPG æŒ‰é’®äº‹ä»¶..."); // æŽ§åˆ¶å°çœ‹åˆ°è¿™å°±è¯´æ˜Ž JS æ²¡å´©

    if(!window.rpgGameInstance) {
        window.rpgGameInstance = new RpgGame();
    }
    
    // ================= 1. æ ‡é¢˜ç”»é¢æŒ‰é’® =================
    const newGameBtn = document.getElementById('rpg-new-game-btn');
    if (newGameBtn) newGameBtn.onclick = () => {
        switchScreen('rpg-create-screen');
        // éšè—ä¸éœ€è¦çš„UI
        const partnerCard = document.getElementById('rpg-partner-card');
        if (partnerCard) partnerCard.style.display = 'none';
        
        const aiInitBtn = document.getElementById('rpg-ai-init-btn');
        if (aiInitBtn) aiInitBtn.style.display = 'none';
        
        // ç¦ç”¨å¼€å§‹æŒ‰é’®
        const startBtn = document.getElementById('rpg-start-adventure-btn');
        if (startBtn) {
            startBtn.disabled = true;
            startBtn.innerText = "è¯·å…ˆé€‰æ‹©å†’é™©ä¼™ä¼´";
        }
        
        // è§¦å‘ä¸€æ¬¡P1é¢œè‰²é¢„è§ˆ (æ¨¡æ‹Ÿ input äº‹ä»¶)
        const hairInput = document.getElementById('p1-color-hair');
        if(hairInput) hairInput.dispatchEvent(new Event('input'));
        
        selectedPartnerCharId = null;
    };
    
    const loadGameBtn = document.getElementById('rpg-load-game-btn');
    if (loadGameBtn) loadGameBtn.onclick = () => {
        switchScreen('rpg-profile-screen');
        renderProfileList();
    };

    const exitGameBtn = document.getElementById('rpg-exit-game-btn');
    if (exitGameBtn) exitGameBtn.onclick = () => switchScreen('home-screen');

    // ================= 2. æ¡£æ¡ˆä¸Žå­˜æ¡£/è¯»æ¡£é¡µæŒ‰é’® =================
    const profileBackBtn = document.getElementById('rpg-profile-back-btn');
    if (profileBackBtn) profileBackBtn.onclick = () => switchScreen('rpg-title-screen');

    // ã€ä¿®æ­£ã€‘å­˜æ¡£/è¯»æ¡£é¡µçš„è¿”å›žæŒ‰é’®
    const loadBackBtn = document.getElementById('rpg-save-back-btn');
    if (loadBackBtn) loadBackBtn.onclick = (e) => {
        e.preventDefault();
        rpgHandleSaveBack(); // è°ƒç”¨æ™ºèƒ½è¿”å›žå‡½æ•°
    };

    // ================= 3. è§’è‰²åˆ›å»ºé¡µæŒ‰é’® =================
    const startAdvBtn = document.getElementById('rpg-start-adventure-btn');
    if (startAdvBtn) startAdvBtn.onclick = () => rpgStartNewGame();
    
    // åˆå§‹åŒ–è§’è‰²åˆ›å»ºé¡µçš„é€»è¾‘ (é¢œè‰²é€‰æ‹©å™¨ç­‰)
    if (typeof setupRpgCreateScreenLogic === 'function') setupRpgCreateScreenLogic();

    // ================= 4. æ¸¸æˆå†… HUD æŒ‰é’® =================
    const backToTitleBtn = document.getElementById('rpg-back-to-title-btn');
    if (backToTitleBtn) backToTitleBtn.onclick = () => rpgBackToTitle();
    
    const menuToggleBtn = document.getElementById('rpg-menu-toggle-btn');
    if (menuToggleBtn) menuToggleBtn.onclick = (e) => {
        e.stopPropagation();
        if (window.rpgGameInstance) window.rpgGameInstance.toggleMenu(true);
    };

    // ================= 5. æš‚åœé¡µé¢æŒ‰é’® (æ–°ç‰ˆ) =================
    const pauseBackBtn = document.getElementById('rpg-pause-back-btn');
    if (pauseBackBtn) pauseBackBtn.onclick = () => {
        if (window.rpgGameInstance) window.rpgGameInstance.toggleMenu(false);
    };

    const menuStatusBtn = document.getElementById('rpg-menu-status-btn');
    if (menuStatusBtn) menuStatusBtn.onclick = () => {
        if (window.rpgGameInstance) window.rpgGameInstance.openStatus();
    };

    const menuBagBtn = document.getElementById('rpg-menu-bag-btn');
    if (menuBagBtn) menuBagBtn.onclick = () => {
        if (window.rpgGameInstance) window.rpgGameInstance.openInventory('map');
    };

    const menuSaveBtn = document.getElementById('rpg-menu-save-btn');
    if (menuSaveBtn) menuSaveBtn.onclick = () => {
        rpgSaveContext = 'pause_save';
        rpgShowSaveScreen();
    };

    const menuLoadBtn = document.getElementById('rpg-menu-load-btn');
    if (menuLoadBtn) menuLoadBtn.onclick = () => {
        rpgSaveContext = 'pause_load';
        rpgShowLoadScreen();
    };

    const menuQuitBtn = document.getElementById('rpg-menu-quit-btn');
    if (menuQuitBtn) menuQuitBtn.onclick = () => {
        if(confirm("ç¡®å®šè¦æ”¾å¼ƒå½“å‰è¿›åº¦è¿”å›žæ ‡é¢˜å—ï¼Ÿ")) {
            switchScreen('rpg-title-screen');
        }
    };

    // ================= 6. æˆ˜æ–—ç›¸å…³æŒ‰é’® =================
    document.querySelectorAll('.rpg-battle-btn').forEach(btn => {
        btn.onclick = (e) => {
            const action = e.target.dataset.action;
            if (window.rpgGameInstance && action) {
                window.rpgGameInstance.inputBattleCommand(action);
            }
        };
    });

    const battleBagBtn = document.getElementById('rpg-battle-bag-btn');
    if (battleBagBtn) battleBagBtn.onclick = (e) => {
        e.stopPropagation();
        if (window.rpgGameInstance) window.rpgGameInstance.openInventory('battle');
    };

    const stopAutoBtn = document.getElementById('rpg-auto-battle-btn');
    if (stopAutoBtn) stopAutoBtn.onclick = (e) => {
        e.preventDefault(); e.stopPropagation();
        if (window.rpgGameInstance) window.rpgGameInstance.toggleAutoBattle(false);
    };

    const startAutoBtn = document.getElementById('rpg-start-auto-btn');
    if (startAutoBtn) startAutoBtn.onclick = (e) => {
        e.preventDefault(); e.stopPropagation();
        if (window.rpgGameInstance) window.rpgGameInstance.toggleAutoBattle(true);
    };
    
    // ================= 7. äº¤äº’ä¸ŽæŽ§åˆ¶æŒ‰é’® =================
    const interactBtn = document.getElementById('rpg-interact-btn');
    if (interactBtn) interactBtn.onclick = (e) => {
        e.preventDefault(); e.stopPropagation();
        if (window.rpgGameInstance) window.rpgGameInstance.triggerInteraction();
    };

    // ç»‘å®šå¯¹è¯æ¡†ç‚¹å‡» (æŽ¨è¿›å‰§æƒ…)
    const dialogBox = document.getElementById('rpg-bottom-dialog');
    if (dialogBox) dialogBox.onclick = () => {
        if (window.rpgGameInstance) window.rpgGameInstance.nextStory();
    };
    
    // ç»‘å®šæ–¹å‘é”®ä¸Žç¡®è®¤é”®
    document.querySelectorAll('.rpg-ctrl-btn').forEach(btn => {
        btn.onclick = (e) => {
            if (!window.rpgGameInstance) return;
            const key = e.target.dataset.key;
            if (key === 'left') window.rpgGameInstance.moveTargetCursor(-1);
            else if (key === 'right') window.rpgGameInstance.moveTargetCursor(1);
            else if (key === 'confirm') window.rpgGameInstance.confirmTarget();
            else if (key === 'cancel') window.rpgGameInstance.cancelTarget();
        };
    });

    // ================= 8. é¡µé¢å¯è§æ€§ç›‘å¬ (è‡ªåŠ¨æš‚åœ) =================
    const gameScreen = document.getElementById('rpg-game-screen');
    if (gameScreen) {
        // å…ˆæ–­å¼€æ—§çš„ observer (å¦‚æžœæœ‰) é˜²æ­¢é‡å¤ç›‘å¬ï¼Œè¿™é‡Œç®€å•é‡æ–°åˆ›å»º
        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                if (mutation.target.id === 'rpg-game-screen') {
                    // å¦‚æžœæ¸¸æˆå±å¹•ä¸å†åŒ…å« active ç±»ï¼ˆå³è¢«éšè—äº†ï¼‰
                    if (!mutation.target.classList.contains('active')) {
                        if (window.rpgGameInstance) window.rpgGameInstance.stop();
                    }
                }
            });
        });
        observer.observe(gameScreen, { attributes: true, attributeFilter: ['class'] });
    }
}