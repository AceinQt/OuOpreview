<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>OuO</title>
    <meta name="theme-color" content="#FFFFFF" />
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="apple-touch-icon" href="./icon/icon_cat.png">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
    <script src="https://unpkg.com/dompurify@2.3.8/dist/purify.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="css/main.css">


</head>

<body>
<!-- === 启动页 (Splash Screen) === -->
<div id="app-splash-screen">
    <div class="splash-content">
        <!-- 这里可以换成你的 LOGO 图片，或者简单的文字 -->
        <div class="splash-logo"></div> 
        <div class="splash-spinner"></div>
    </div>
</div>

<!-- === phone-screen开始 === -->
    <div class="phone-screen">
    
<!-- === 主页 (home-screen) === -->
<div id="home-screen" class="screen active">
    <div class="home-screen-swiper">
        <div class="home-screen-page">
            <div class="home-widget-container">
                <!-- 中央圆圈 (头像/图片) -->
                <div class="central-circle" id="home-central-circle"></div>
                
                <!-- 时间与日期 -->
                <div class="widget-time" id="time-display"></div>
                <div class="widget-date" id="date-display"></div>
                
                <!-- 个性签名 -->
                <div contenteditable="true" class="widget-signature" id="widget-signature" placeholder="编辑个性签名..."></div>
                
                <!-- 电池小组件 (SVG 图标直接写在这里) -->
                <div class="widget-battery">
                    <svg width="32" height="23" viewBox="0 0 24 12" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M1 2.5C1 1.94772 1.44772 1.5 2 1.5H20C20.5523 1.5 21 1.94772 21 2.5V9.5C21 10.0523 20.5523 10.5 20 10.5H2C1.44772 10.5 1 10.0523 1 9.5V2.5Z" stroke="currentColor" stroke-opacity="1" stroke-width="1"/>
                        <path d="M22.5 4V8" stroke="currentColor" stroke-opacity="1" stroke-width="1.5" stroke-linecap="round"/>
                        <rect id="battery-fill-rect" x="2" y="2.5" width="18" height="7" rx="0.5" fill="currentColor" fill-opacity="1"/>
                    </svg>
                    <span id="battery-level">--%</span>
                </div>
            </div>

            <div class="app-grid">
                <!-- INS 风格小组件 -->
                <div class="app-grid-widget-container">
                   <div class="app-grid-widget">
                        <div class="ins-widget">
                            <div class="ins-widget-row user">
                                <img src="" alt="Avatar" class="ins-widget-avatar" id="ins-widget-avatar-1">
                                <div class="ins-widget-bubble" id="ins-widget-bubble-1" contenteditable="true"></div>
                            </div>
                            <div class="ins-widget-divider"><span>୨୧</span></div>
                            <div class="ins-widget-row character">
                                <div class="ins-widget-bubble" id="ins-widget-bubble-2" contenteditable="true"></div>
                                <img src="" alt="Avatar" class="ins-widget-avatar" id="ins-widget-avatar-2">
                            </div>
                        </div>
                   </div>
                </div>

                <!-- === APP 图标区域 === -->
                <!-- 每个图标都有一个唯一的 id，方便 JS 更新 -->
                
                <!-- 聊天 -->
                <a href="#" class="app-icon" data-target="chat-list-screen" id="app-icon-chat-list-screen">
                    <div class="icon-container"></div> <!-- JS会把图片/SVG塞进这里 -->
                    <span class="app-name">聊天</span>
                </a>

                <!-- 番茄钟 -->
                <a href="#" class="app-icon" data-target="pomodoro-screen" id="app-icon-pomodoro-screen">
                    <div class="icon-container"></div>
                    <span class="app-name">番茄钟</span>
                </a>

                <!-- 喵坛 (论坛) -->
                <a href="#" class="app-icon" data-target="forum-screen" id="app-icon-forum-screen">
                    <div class="icon-container"></div>
                    <span class="app-name">喵坛</span>
                </a>                         

                <!-- 传说之旅 (RPG) -->
                <a href="#" class="app-icon" data-target="rpg-title-screen" id="app-icon-rpg-title-screen">
                    <div class="icon-container"></div>
                    <span class="app-name">传说之旅</span>
                </a>                         
            </div>
        </div>
        <!-- 如果你需要第二页，可以在这里加 -->
        <div class="app-grid"></div>
    </div>

    <!-- 底部 Dock 栏 -->
    <div class="dock">
        <a href="#" class="app-icon" data-target="settings-screen" id="app-icon-settings-screen">
            <div class="icon-container"></div>
        </a>
        <a href="#" class="app-icon" data-target="world-book-screen" id="app-icon-world-book-screen">
            <div class="icon-container"></div>
        </a>
    </div>
</div>
<!-- === 结束：主页 === -->

    <!-- 聊天列表 -->
        <div id="chat-list-screen" class="screen">
    <header class="app-header">
        <button class="back-btn" data-target="home-screen">‹</button>
        <div class="title-container">
            <h1 class="title" id="chat-list-title">聊天</h1>
        </div>
        <div class="action-btn-group">
            <button class="action-btn" id="create-group-btn" title="群聊">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
            </button>
            <button class="action-btn" id="import-character-card-btn" title="导入">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
            </button>
            <input type="file" id="character-card-input" accept="image/png,application/json" style="display: none;">
            <button class="action-btn" id="chat-list-add-btn">+</button>
        </div>
    </header>    
    <!-- 内容区域 -->
    <main class="content">
        <!-- Tab 1: 消息列表 -->
        <div id="tab-view-messages" class="tab-content-view active">
            <ul class="list-container" id="chat-list-container"></ul>
            <div class="placeholder-text" id="no-chats-placeholder" style="display: none;">
                <p>还没有聊天对象哦~</p>
                <p>点击右上角的“+”创建一个吧！</p>
            </div>
        </div>
        <!-- Tab 2: 我 (用户档案管理) -->
        <div id="tab-view-me" class="tab-content-view" style="display:none;">
            <div id="my-personas-list"></div>
        </div>
    </main>
    <!-- 底部 Tab 切换 (新样式 + SVG) -->
    <nav class="bottom-nav-tabs">
        <div class="nav-tab-item active" data-tab="messages">
            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M8 12H8.009M11.991 12H12M15.991 12H16"  stroke-linecap="round" stroke-linejoin="round"/>
<path d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 13.5997 2.37562 15.1116 3.04346 16.4525C3.22094 16.8088 3.28001 17.2161 3.17712 17.6006L2.58151 19.8267C2.32295 20.793 3.20701 21.677 4.17335 21.4185L6.39939 20.8229C6.78393 20.72 7.19121 20.7791 7.54753 20.9565C8.88837 21.6244 10.4003 22 12 22Z"/>
</svg>
            <span>消息</span>
        </div>
        <div class="nav-tab-item" data-tab="me">
            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M12 12C14.7614 12 17 9.76142 17 7C17 4.23858 14.7614 2 12 2C9.23858 2 7 4.23858 7 7C7 9.76142 9.23858 12 12 12Z" stroke-linecap="round" stroke-linejoin="round"/>
<path d="M20.5899 22C20.5899 18.13 16.7399 15 11.9999 15C7.25991 15 3.40991 18.13 3.40991 22" stroke-linecap="round" stroke-linejoin="round"/>
</svg>
            <span>我</span>
        </div>
    </nav>
</div>


    <!-- 聊天室页面 -->
        <div id="chat-room-screen" class="screen">
            <header class="app-header" id="chat-room-header-default">
                <button class="back-btn" data-target="chat-list-screen">‹</button>
                <div class="title-container">
                    <h1 class="title" id="chat-room-title">...</h1>
                    <div class="subtitle" id="chat-room-subtitle">
                        <div class="online-indicator"></div>
                        <span id="chat-room-status-text">在线</span>
                    </div>
                </div>
                <div class="action-btn-group">
                    <button class="action-btn" id="peek-btn">
                        <svg viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                            <path transform="scale(1.4) translate(0.5 0.5)"
                                d="M3.654 1.328a.678.678 0 0 0-1.015-.063L1.605 2.3c-.483.484-.661 1.169-.45 1.77a17.568 17.568 0 0 0 4.168 6.608 17.569 17.569 0 0 0 6.608 4.168c.601.211 1.286.033 1.77-.45l1.034-1.034a.678.678 0 0 0-.063-1.015l-2.307-1.794a.678.678 0 0 0-.58-.122l-2.19.547a1.745 1.745 0 0 1-1.657-.459L5.482 8.062a1.745 1.745 0 0 1-.46-1.657l.548-2.19a.678.678 0 0 0-.122-.58L3.654 1.328zM1.83 1.83l.002-.001-.002.001z"
                                fill="none" stroke="currentColor" stroke-width="1.3" stroke-linecap="round"
                                stroke-linejoin="round" />
                        </svg>
                    </button>
                    <button class="action-btn" id="chat-settings-btn"><svg viewBox="0 0 24 24" fill="currentColor">
                            <rect x="3" y="5" width="18" height="1.5" rx="0.75" />
                            <rect x="3" y="11" width="18" height="1.5" rx="0.75" />
                            <rect x="3" y="17" width="18" height="1.5" rx="0.75" />
                        </svg></button>
                </div>
            </header>
            <header class="app-header" id="chat-room-header-select" style="display: none;">
                <button class="action-btn" id="cancel-multi-select-btn">取消</button>
                <div class="title-container">
                    <h1 class="title" id="multi-select-title">选择消息</h1>
                </div>
                <div class="placeholder"></div>
            </header>
            <main class="content">
                <div class="message-area" id="message-area"></div>
                <div class="typing-indicator" id="typing-indicator"></div>
            </main>
            <div class="chat-input-wrapper">

                <div id="reply-preview-bar">
                    <div class="reply-preview-content">
                        <span class="reply-preview-name"></span>
                        <p class="reply-preview-text"></p>
                    </div>
                    <button id="cancel-reply-btn">×</button>
                </div>
                <div class="message-input-area" id="message-input-default">
                    <input type="text" id="message-input" placeholder="输入消息...">
                    <button id="send-message-btn" class="icon-btn send-btn">发送</button>
                    <button id="get-reply-btn" class="icon-btn">
                        <svg viewBox="0 0 24 24">
                            <path
                                d="M12,2A10,10 0 1,0 22,12A10,10 0 0,0 12,2M12,20A8,8 0 1,1 20,12A8,8 0 0,1 12,20M16.24,7.76C15.07,6.58 13.53,6 12,6V12L7.76,16.24C10.1,18.58 13.9,18.58 16.24,16.24C18.58,13.9 18.58,10.1 16.24,7.76Z" />
                        </svg>
                    </button>
                </div>
                <div id="sticker-bar">
                    <button class="sticker-bar-btn" id="regenerate-btn" title="重回">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path
                                d="M17.65,6.35C16.2,4.9,14.21,4,12,4A8,8,0,0,0,4,12A8,8,0,0,0,12,20C15.73,20,18.84,17.45,19.73,14H17.65C16.83,16.33,14.61,18,12,18A6,6,0,0,1,6,12A6,6,0,0,1,12,6C13.66,6,15.14,6.69,16.22,7.78L13,11H20V4L17.65,6.35Z" />
                        </svg>
                    </button>
                    <button class="sticker-bar-btn" id="voice-message-btn">
                        <svg viewBox="0 0 24 24">
                            <path
                                d="M12 14c1.66 0 2.99-1.34 2.99-3L15 5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.3-3c0 3-2.54 5.1-5.3 5.1S6.7 14 6.7 11H5c0 3.41 2.72 6.23 6 6.72V21h2v-3.28c3.28-.48 6-3.3 6-6.72h-1.7z" />
                        </svg>
                    </button>
                    <button class="sticker-bar-btn" id="image-recognition-btn">
                        <svg viewBox="0 0 24 24">
                            <!-- 外框 -->
                            <path
                                d="M20,4H4C2.9,4,2,4.9,2,6v12c0,1.1,0.9,2,2,2h16c1.1,0,2-0.9,2-2V6C22,4.9,21.1,4,20,4z M20,18H4v-4.57l5.36-4.91l4.06,3.72l3.43-3.09L20,12.27V18z" />
                        </svg>
                    </button>

                    <button class="sticker-bar-btn" id="photo-video-btn">
                        <svg viewBox="0 0 24 24">
                            <path
                                d="M4,4H7L9,2H15L17,4H20A2,2 0 0,1 22,6V18A2,2 0 0,1 20,20H4A2,2 0 0,1 2,18V6A2,2 0 0,1 4,4M12,7A5,5 0 0,0 7,12A5,5 0 0,0 12,17A5,5 0 0,0 17,12A5,5 0 0,0 12,7M12,9A3,3 0 0,1 15,12A3,3 0 0,1 12,15A3,3 0 0,1 9,12A3,3 0 0,1 12,9Z" />
                        </svg>
                    </button>
                    <button class="sticker-bar-btn" id="wallet-btn">
                        <svg viewBox="0 0 24 24"><path d="M20,4H4C2.9,4,2,4.9,2,6v12c0,1.1,0.9,2,2,2h16c1.1,0,2-0.9,2-2V6C22,4.9,21.1,4,20,4z M20,8l-8,5L4,8V6l8,5l8-5V8z" /></svg>
                    </button>
                    <button class="sticker-bar-btn" id="sticker-toggle-btn">
                        <svg viewBox="0 0 24 24"><path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm3.5-9c.83 0 1.5-.67 1.5-1.5S16.33 8 15.5 8 14 8.67 14 9.5s.67 1.5 1.5 1.5zm-7 0c.83 0 1.5-.67 1.5-1.5S9.33 8 8.5 8 7 8.67 7 9.5 7.67 11 8.5 11zm3.5 6.5c2.33 0 4.31-1.46 5.11-3.5H6.89c.8 2.04 2.78 3.5 5.11 3.5z" /></svg>
                    </button>

                    <button class="sticker-bar-btn" id="placeholder-plus-btn">
                        <svg viewBox="0 0 24 24">
                            <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z" />
                        </svg>
                    </button>
                </div>

            </div>

            <div id="multi-select-bar"><span id="select-count">已选择 0 项</span>
                <button class="btn btn-danger" id="delete-selected-btn">删除已选
                </button>
            </div>
<!-- 表情包主面板 -->
            <div id="sticker-modal">
                <div class="header">
                    <span style="font-weight: bold; color: var(--primary-color);">我的表情</span>
                    <div class="btn-group">
                        <button class="btn btn-primary" id="link-sticker-btn" style="display: none;">关联表情</button>
                        <button class="btn btn-primary" id="manage-stickers-btn">管理</button>
                        <button class="btn btn-primary" id="batch-add-sticker-btn">批量导入</button>
                        <button class="btn btn-primary" id="add-new-sticker-btn">添加</button>
                    </div>
                </div>
                
                <!-- 表情网格区 -->
                <div class="sticker-grid" id="sticker-grid-container"></div>
                <div id="sticker-manage-bar">
                    <div class="placeholder"></div>
                    <button class="btn btn-danger" id="delete-selected-stickers-btn">删除已选(0)</button>
                </div>
                <!-- 新增：底部分类栏 -->
                <div id="sticker-category-bar"></div>               
            </div>
            <!-- NEW: Chat Expansion Panel -->
            <div id="chat-expansion-panel">
                <div class="sticker-grid" id="chat-expansion-grid">
                    <!-- Items will be populated by JS -->
                </div>
            </div>
        </div>

<!-- === 搜索结果页面 === -->
<div id="search-results-screen" class="screen">
    <header class="app-header">
        <button class="back-btn" id="exit-search-results-btn">‹</button>
        <div class="title-container">
            <h1 class="title">搜索结果</h1>
        </div>
        <div class="placeholder"></div>
    </header>
    <main class="content" id="search-scroll-container"> <!-- 给容器加个ID便于监听滚动 -->
        <div id="search-results-list" class="list-container">
            <!-- 结果项通过 JS 插入 -->
        </div>
        
        <!-- 新增：加载状态/空状态提示 -->
        <div id="search-status-bar" style="text-align: center; padding: 20px; color: #999; font-size: 13px;">
            <span id="search-loading" style="display: none;">正在加载更多...</span>
            <span id="search-no-more" style="display: none;">没有更多结果了</span>
            <span id="search-empty" style="display: none;">未找到匹配的消息</span>
        </div>
    </main>
</div>



        <!-- 世界书页面 -->
        <div id="world-book-screen" class="screen">
            <header class="app-header">
                <button class="back-btn" data-target="home-screen">‹</button>
                <div class="title-container">
                    <h1 class="title">世界书</h1>
                </div>
                <div class="action-btn-group">
                    <button class="action-btn" id="add-world-book-btn">+</button>
                    <button class="action-btn" id="cancel-wb-multi-select-btn"
                        style="display: none; font-size: 16px;">取消</button>
                </div>
            </header>
            <main class="content">
                <ul class="list-container" id="world-book-list-container"></ul>
                <div class="placeholder-text" id="no-world-books-placeholder" style="display: none;">
                    <p>你的世界一片混沌...</p>
                    <p>点击右上角的“+”创造第一个设定吧！</p>
                </div>
            </main>
            <div id="world-book-multi-select-bar" style="display: none;">
                <span id="world-book-select-count">已选择 0 项</span>
                <button class="btn btn-danger" id="delete-selected-world-books-btn"
                    style="width: auto; padding: 8px 16px;">删除已选</button>
            </div>
        </div>
        <div id="edit-world-book-screen" class="screen">
            <header class="app-header">
                <button class="back-btn" data-target="world-book-screen">‹</button>
                <div class="title-container">
                    <h1 class="title" id="edit-world-book-title">创建/编辑条目</h1>
                </div>
                <div class="placeholder"></div>
            </header>
            <main class="content">
                <form id="edit-world-book-form">
                    <input type="hidden" id="world-book-id">
                    <div class="form-group">
                        <label for="world-book-name">条目名称</label>
                        <input type="text" id="world-book-name" placeholder="例如：世界观背景、魔法体系" required>
                    </div>
                    <div class="form-group">
                        <label for="world-book-category">条目分类</label>
                        <input type="text" id="world-book-category" placeholder="例如：人物、地点、组织（可选）">
                    </div>
                    <div class="form-group">
                        <label for="world-book-content">条目内容</label>
                        <textarea id="world-book-content" rows="8" placeholder="详细描述此项设定..." required></textarea>
                    </div>
                    <div class="form-group">
                        <label>注入位置</label>
                        <div class="form-group radio-group">
                            <label><input type="radio" name="world-book-position" value="before" checked> 前</label>
                            <label><input type="radio" name="world-book-position" value="after"> 后</label>
                            <label><input type="radio" name="world-book-position" value="writing"> 写作</label>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">保存条目</button>
                </form>
            </main>
        </div>
        
        <!-- 设置页面 -->
<div id="settings-screen" class="screen">
    <header class="app-header">
        <button class="back-btn" data-target="home-screen">‹</button>
        <div class="title-container">
            <h1 class="title">设&nbsp;&nbsp;置</h1>
        </div>
        <div class="placeholder"></div>
    </header>
    <main class="content">        
        <!-- 第一组：系统 (API, 存储, 教程) -->
        <div class="settings-group-title">系统</div>
        <div class="settings-card">
            <!-- API 设置 -->
            <div class="settings-item" data-target="api-settings-screen">
                <div class="setting-icon-box">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-cloud"><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"></path></svg>
                </div>
                <div class="item-details">
                    <span class="item-name">API 设置</span>
                </div>
                <svg class="chevron-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#ccc" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>
            </div>
            <!-- 存储与备份 -->
            <div class="settings-item" data-target="storage-analysis-screen">
                <div class="setting-icon-box">
                    <svg class="storage-icon-alt" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M11 13 L11 4 A9 9 0 1 0 20 13 Z"></path>
                        <path d="M13 11 L13 2 A9 9 0 0 1 22 11 Z"></path>
                    </svg>
                </div>
                <div class="item-details">
                    <span class="item-name">存储备份</span>
                </div>
                <svg class="chevron-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#ccc" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>
            </div>
            <!-- 教程与更新 -->
            <div class="settings-item" data-target="tutorial-screen">
                <div class="setting-icon-box">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-book-open"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path></svg>
                </div>
                <div class="item-details">
                    <span class="item-name">教程与更新</span>
                </div>
                <svg class="chevron-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#ccc" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>
            </div>
        </div>

        <!-- 第二组：外观 (壁纸, 字体, 自定义, 主题) -->
        <div class="settings-group-title">外观</div>
        <div class="settings-card">
        <!-- 顶部安全区避让 (Toggle) -->
            <div class="settings-item toggle-setting" style="cursor: default;">
                <div class="setting-icon-box">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="feather"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="3" y1="9" x2="21" y2="9"></line></svg>
                </div>
                <div class="item-details">
                    <span class="item-name">顶部避让</span>
                </div>
                <div style="display: flex; align-items: center;">
                    <label class="switch">
                        <input type="checkbox" id="safe-area-top-toggle">
                        <span class="slider round"></span>
                    </label>
                </div>
            </div>

            <!-- 底部安全区避让 (Toggle) -->
            <div class="settings-item toggle-setting" style="cursor: default;">
                <div class="setting-icon-box">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="feather"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="3" y1="15" x2="21" y2="15"></line></svg>
                </div>
                <div class="item-details">
                    <span class="item-name">底部避让</span>
                </div>
                <div style="display: flex; align-items: center;">
                    <label class="switch">
                        <input type="checkbox" id="safe-area-bottom-toggle">
                        <span class="slider round"></span>
                    </label>
                </div>
            </div>
            <!-- 更换壁纸 -->
            <div class="settings-item" data-target="wallpaper-screen">
                <div class="setting-icon-box">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-image"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>
                </div>
                <div class="item-details">
                    <span class="item-name">更换壁纸</span>
                </div>
                <svg class="chevron-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#ccc" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>
            </div>
            <!-- 字体设置 -->
            <div class="settings-item" data-target="font-settings-screen">
                <div class="setting-icon-box">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-type"><polyline points="4 7 4 4 20 4 20 7"></polyline><line x1="9" y1="20" x2="15" y2="20"></line><line x1="12" y1="4" x2="12" y2="20"></line></svg>
                </div>
                <div class="item-details">
                    <span class="item-name">字体设置</span>
                </div>
                <svg class="chevron-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#ccc" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>
            </div>
            <!-- 主屏幕自定义 -->
            <div class="settings-item" data-target="customize-screen">
                <div class="setting-icon-box">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-grid"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>
                </div>
                <div class="item-details">
                    <span class="item-name">主屏幕自定义</span>
                </div>
                <svg class="chevron-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#ccc" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>
            </div>
            <!-- 主题颜色 (Toggle) -->
            <div class="settings-item toggle-setting" style="cursor: default;">
                <div class="setting-icon-box">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-lightbulb"><path d="M15 14c.2-1 .7-1.7 1.5-2.5 1-.9 1.5-2.2 1.5-3.5A6 6 0 0 0 6 8c0 1 .2 2.2 1.5 3.5.7.7 1.3 1.5 1.5 2.5"></path><path d="M9 18h6"></path><path d="M10 22h4"></path></svg>
                </div>
                <div class="item-details">
                    <span class="item-name">主屏幕黑白模式</span>
                </div>
                <!-- Toggle 开关区域 -->
                <div style="display: flex; align-items: center; margin-right:5px;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#ccc" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-moon"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
                    <label class="switch">
                        <input type="checkbox" id="dark-mode-toggle">
                        <span class="slider round"></span>
                    </label>
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#ccc" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-sun"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
                </div>
            </div>
        </div>
    </main>
</div>


<!-- api设置页面 -->
        <div id="api-settings-screen" class="screen">
    <header class="app-header">
        <button class="back-btn" data-target="settings-screen">‹</button>
        <div class="title-container"><h1 class="title">API 设置</h1></div>
        <div class="placeholder"></div>
    </header>
    <main class="content">
        <form id="api-form">
            <div class="form-group">
                <label for="api-provider">API 服务商</label>
                <select id="api-provider" name="provider">
                    <option value="newapi">NewAPI (自定义)</option>
                    <option value="deepseek">DeepSeek</option>
                    <option value="claude">Claude</option>
                    <option value="gemini">Gemini</option>
                </select>
            </div>
            <div class="form-group">
                <label for="api-url">API 地址（后缀不用添加/v1）</label>
                <input type="url" id="api-url" name="url" placeholder="选择服务商可自动填写" required>
            </div>
            <div class="form-group">
                <label for="api-key">密钥 (Key)</label>
                <input type="password" id="api-key" name="key" placeholder="请输入你的API密钥" required>
            </div>
            <button type="button" class="btn btn-secondary" id="fetch-models-btn">
                <span class="btn-text">点击拉取模型</span>
                <div class="spinner"></div>
            </button>
            <div class="form-group">
                <label for="api-model">选择模型</label>
                <select id="api-model" name="model" required>
                    <option value="">请先拉取模型列表</option>
                </select>
            </div>
            <div class="form-group-select">
                <label for="time-perception-switch">时间感知加强</label>
                <input type="checkbox" id="time-perception-switch">
            </div>
            <div class="form-group-select">
                <label for="stream-switch">流式输出</label>
                <input type="checkbox" id="stream-switch">
            </div>
        </form>
     <div class="form-group">
        <label>API 预设</label>
        <div class="api-presets-embedded" id="api-presets-control">
             <div class="api-presets-content">
                <select id="api-preset-select">
                  <option value="">— 选择 API 预设 —</option>
                </select>
                <button id="api-apply-preset" class="btn btn-primary">应 用</button>
             </div>
             <div class="api-presets-content">
               <button id="api-save-preset" class="btn btn-secondary">另存为</button>
               <button id="api-manage-presets" class="btn btn-secondary">管理</button> 
               <button id="api-import-presets" class="btn btn-secondary">导入</button>
               <button id="api-export-presets" class="btn btn-secondary">导出</button>
             </div>
          </div>
        </div>
<button type="submit" form="api-form" class="btn btn-primary" id="save-btn">
    <span class="btn-text">保 存</span>
    <div class="spinner"></div>
</button>
    </main>
</div>

<!-- 存储分析页面 -->
<div id="storage-analysis-screen" class="screen">
    <header class="app-header">
        <button class="back-btn" data-target="settings-screen">‹</button>
        <div class="title-container">
            <h1 class="title">存储备份</h1>
        </div>
        <div class="placeholder"></div>
    </header>
    <main class="content">
        <!-- Card 1: 概览与全量备份 -->
        <div class="storage-card overview-card">
            <!-- 左侧：饼图 -->
            <div id="storage-chart-container"></div>
            <!-- 右侧：信息与操作 -->
            <div class="overview-info">
                <div class="total-size-container">
                    <span class="total-size-label">总占用空间</span>
                    <h2 id="storage-total-size">Calculating...</h2>
                </div>
                <div class="backup-actions">
                    <button id="btn-backup-full" class="btn btn-primary btn-block">导出全部数据</button>
                    <label for="import-data-input" class="btn btn-neutral btn-block">导入备份文件</label>
                    <input type="file" id="import-data-input" accept=".ee,.json,application/octet-stream" hidden>
                </div>
            </div>
        </div>
        <!-- Card 2: 详细数据与单项导出 -->
        <div class="storage-card">
            <div id="storage-details-list">
                <!-- 列表项将由 JS 生成 -->
            </div>
        </div>
<!-- Card 3: GitHub 云端备份 (已修改) -->
        <div class="storage-card cloud-card" id="github-card">
            <div class="cloud-left">
                <div class="cloud-icon-bg" id="github-status-icon">
                    <svg viewBox="0 0 16 16"><path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"></path></svg>
                </div>
                <div>
                    <div class="cloud-title">云端同步</div>
                    <div class="cloud-desc" id="github-status-text">点击配置连接</div>
                    <div class="cloud-meta" id="github-last-sync">从未备份</div>
                </div>
            </div>
            <div class="cloud-actions">
                <!-- 未配置时显示配置按钮，配置后显示同步按钮 -->
                <button id="btn-gh-upload" class="btn-export-sm" style="display:none;">上传</button>
                <button id="btn-gh-download" class="btn-export-sm" style="display:none;">下载</button>
                <button id="btn-gh-config" class="btn-export-sm">配置</button>               
            </div>
        </div>
</main>
        </div>

<!-- 壁纸设置页面 -->
        <div id="wallpaper-screen" class="screen">
    <header class="app-header">
        <button class="back-btn" data-target="settings-screen">‹</button>
        <div class="title-container"><h1 class="title">更换壁纸</h1></div>
        <div class="placeholder"></div>
    </header>
    <main class="content">
        <div class="wallpaper-preview" id="wallpaper-preview"><span>当前壁纸预览</span></div>
        <input type="file" id="wallpaper-upload" accept="image/*" style="display: none;">
        <label for="wallpaper-upload" class="btn btn-primary">从相册选择新壁纸</label>
        <hr>
        <div class="form-group">
            <label for="home-status-bar-color">首页顶部状态栏颜色</label>
            <div class="status-bar-color">
                <!-- 颜色选择器 -->
                <div class="status-bar-color-picker">
                    <input type="color" id="home-status-bar-color-picker" title="点击选择颜色">
                </div>
                <!-- 文本输入框 -->
                <input type="text" id="home-status-bar-color-input" placeholder="#FFFFFF">
            </div>
        </div>
    </main>
    </div>
    
    <!-- 字体设置页面 -->
        <div id="font-settings-screen" class="screen">
        <header class="app-header">
        <button class="back-btn" data-target="settings-screen">‹</button>
        <div class="title-container">
        <h1 class="title">字体设置</h1></div>
        <div class="placeholder"></div>
        </header>
        <main class="content">
        <form id="font-settings-form">
        <div class="form-group">
        <label for="font-url">字体链接 (ttf, woff, woff2)</label>
        <input type="url" id="font-url" placeholder="https://.../font.ttf" required>
        </div>
        <p style="font-size:12px; color:#888; text-align:center;">示例: https://cdn.jsdelivr.net/npm/@fontsource/zcool-kuaile/files/zcool-kuaile-chinese-simplified-400-normal.woff2</p>
        <button type="submit" class="btn btn-primary">应用字体</button>
        <button type="button" class="btn btn-neutral" id="restore-default-font-btn" style="margin-top: 15px;">恢复默认字体</button>
        </form>
        </main>
        </div>
        
<!-- 全局设置页面 -->        
        <div id="customize-screen" class="screen">
        <header class="app-header">
        <button class="back-btn" data-target="settings-screen">‹</button>
        <div class="title-container">
        <h1 class="title">主屏幕自定义</h1>
        </div>
        <div class="placeholder"></div>
        </header>
        <main class="content">
        <form id="customize-form"></form></main></div>
        
<!-- 教程页面 -->        
<div id="tutorial-screen" class="screen">
    <header class="app-header">
        <button class="back-btn" data-target="settings-screen">‹</button>
        <div class="title-container">
            <h1 class="title">教程与更新</h1>
        </div>
        <div class="placeholder"></div>
    </header>
    <main class="content" id="tutorial-content-area"></main>
</div>
        
        
        <div id="toast-notification" class="toast">
            <img class="toast-avatar" src="" alt="avatar">
            <div class="toast-content">
                <div class="toast-name"></div>
                <div class="toast-message"></div>
            </div>
        </div>
        <input type="file" id="image-upload-input" accept="image/*" style="display:none;">

        <!-- Private Chat Settings -->
        <div id="chat-settings-sidebar" class="settings-sidebar">
            <div class="header">聊天设置</div>
            <div class="content">
                <form id="chat-settings-form">
                    <div class="avatar-setting"><img src="" alt="角色头像" id="setting-char-avatar-preview"
                            class="avatar-preview"><input type="file" id="setting-char-avatar-upload" accept="image/*"
                            style="display:none;"><label for="setting-char-avatar-upload" class="btn btn-primary"
                            style="flex-grow:1;">更换角色头像</label></div>
                    <!-- 替换开始：将原来的备注单行改为 姓名+备注 并排 -->
                    <div class="form-group" style="display: flex; gap: 10px;">
                        <div style="flex: 1;">
                            <label for="setting-char-real-name">角色姓名</label>
                            <input type="text" id="setting-char-real-name" placeholder="设定中的名字">
                        </div>
                        <div style="flex: 1;">
                            <label for="setting-char-remark">角色昵称</label>
                            <input type="text" id="setting-char-remark" placeholder="列表显示名">
                        </div>
                    </div>
                    <!-- 替换结束 -->
                    <div class="form-group"><label for="setting-char-persona">角色人设</label><textarea
                            id="setting-char-persona" placeholder="详细描述角色的性格、背景、说话风格等。"></textarea></div>
<!-- 新的侧边栏结构：我的信息 (只读 + 绑定) -->
<!-- 我的信息部分修改后的结构 -->
<hr class="divider">
    <div class="avatar-setting">
        <img src="" alt="我的头像" id="setting-my-avatar-preview" class="avatar-preview">
        <input type="hidden" id="setting-my-avatar-src">
        <button type="button" class="btn btn-primary" id="bind-user-persona-btn">更换我的身份</button>
        </div>
        <div class="form-group" style="display: flex; gap: 10px;">
        <div style="flex-grow: 1;">

                    <label for="setting-my-realname-display">我的姓名</label>
                    <span id="setting-my-realname-display" class="sidebar-info-value">未设置</span>
                    <input type="hidden" id="setting-my-name">
                </div>
                 <div style="flex-grow: 1;">
                    <label for="setting-my-nickname-display">我的昵称</label>
                    <span id="setting-my-nickname-display" class="sidebar-info-value">未设置</span>
                    <input type="hidden" id="setting-my-nickname">
                </div>
            </div>
            

    <div class="form-group">
        <label for="setting-my-persona">我的人设</label>
        <textarea id="setting-my-persona" class="readonly-field" placeholder="绑定身份后自动填充" readonly></textarea>
    </div>


 
<hr class="divider">
                    <div class="form-group">
                        <button type="button" class="btn btn-secondary" id="link-world-book-btn">关联世界书</button>
                    </div>
                    <div class="form-group"
                        style="display: flex; justify-content: space-between; align-items: center; padding: 10px; border: 1px solid #DAF0FC; border-radius: 10px; background-color: #F5FBFF;">
                        <label for="setting-bilingual-mode"
                            style="margin-bottom: 0; color: var(--secondary-color); font-weight: 600;">双语聊天模式</label>
                        <input type="checkbox" id="setting-bilingual-mode"
                            style="width: auto; height: 20px; width: 20px;">
                    </div>
                    <div class="form-group"><label for="setting-theme-color">主题颜色 (对方/我方)</label><select
                            id="setting-theme-color"></select></div>

<hr class="divider">
                    <div class="form-group">
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <label for="setting-use-custom-css" style="margin-bottom:0;">自定义气泡样式</label>
                            <input type="checkbox" id="setting-use-custom-css" style="width: auto;">
                        </div>
                        <div id="private-bubble-css-preview" class="bubble-css-preview"
                            style="background: #fff; border: 1px solid #eee; border-radius: 10px; padding: 15px; margin-bottom: 10px; display: flex; flex-direction: column; gap: 10px;">
                        </div>
                        <textarea id="setting-custom-bubble-css" rows="6"
                            placeholder="在此输入CSS代码...&#10;例如：&#10;.message-bubble.sent { background-color: #A5D6A7; }&#10;.message-bubble.received { background-color: #E1E1E1; }"
                            disabled></textarea>
                        <button type="button" class="btn btn-neutral" id="reset-custom-bubble-css-btn"
                            style="margin-top: 10px; width: auto; padding: 5px 15px; font-size: 14px;">恢复默认
                        </button>
                    </div>
                    <div class="panel panel-sm"
                        style="padding:12px;border-radius:10px;border:1px solid var(--border-color,#e8e8ef);background:var(--panel-bg,#fff);box-shadow:var(--panel-shadow,0 4px 12px rgba(20,20,30,0.04));margin:10px 0;">
                        <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;"><label
                                for="bubble-preset-select"
                                style="width:88px;color:var(--muted,#667);font-size:13px;">气泡</label><select
                                id="bubble-preset-select"
                                style="flex:1;padding:8px 10px;border-radius:8px;border:1px solid var(--input-border,#e6e6ea);background:var(--input-bg,#fff);font-size:14px;">
                                <option value="">— 选择预设 —</option>
                            </select><button type="button" id="apply-preset-btn" class="btn btn-primary"
                                style="margin-left:8px;padding:7px 10px;border-radius:8px;">应用</button></div>
                        <div style="display:flex;gap:8px;align-items:center;margin-bottom:10px;"><label
                                style="width:88px;color:var(--muted,#667);font-size:13px;">外观操作</label><button
                                type="button" id="save-preset-btn" class="btn"
                                style="padding:7px 10px;border-radius:8px;">另存为</button><button type="button"
                                id="manage-presets-btn" class="btn"
                                style="padding:7px 10px;border-radius:8px;">管理</button></div>
                    </div>
                    <div class="form-group"><label for="setting-max-memory">最大记忆轮数</label><input type="number"
                            id="setting-max-memory" value="10" min="1">
                    </div>
                    <div class="form-group"><label for="setting-chat-bg-upload"
                            class="btn btn-primary">更换聊天背景</label><input type="file" id="setting-chat-bg-upload"
                            accept="image/*" style="display:none;"></div>
                    <button type="submit" class="btn btn-primary">保存设置</button>
                </form>
<hr class="divider">
                <button type="button" class="btn btn-danger" id="clear-chat-history-btn">清空聊天记录</button>

            </div>
        </div>


        <!-- Group Chat Settings -->
        <div id="group-settings-sidebar" class="settings-sidebar">
            <div class="header">群聊设置</div>
            <div class="content">
                <form id="group-settings-form">
                    <div class="group-avatar-setting">
                        <img src="" alt="群头像" id="setting-group-avatar-preview" class="group-avatar-preview">
                        <input type="file" id="setting-group-avatar-upload" accept="image/*" style="display:none;">
                        <label for="setting-group-avatar-upload" class="btn btn-primary"
                            style="flex-grow:1;">更换群头像</label>
                    </div>
                    <div class="form-group">
                        <label for="setting-group-name">群名 (AI也可见)</label>
                        <input type="text" id="setting-group-name">
                    </div>
                    <hr style="border:none; border-top:1px solid #eee; margin: 20px 0;">
                    <!-- 在 群聊.txt 中找到 id="group-settings-form"，找到“我的头像”那部分，替换为以下代码 -->

<!-- === 修改开始：我的信息 (与私聊保持一致) === -->
<div class="avatar-setting">
    <img src="" alt="我的头像" id="setting-group-my-avatar-preview" class="avatar-preview">
    <!-- 隐藏 input，主要靠绑定，但也保留手动上传功能 -->
    <input type="file" id="setting-group-my-avatar-upload" accept="image/*" style="display:none;">
    <!-- 绑定按钮 -->
    <button type="button" class="btn btn-primary" id="bind-group-user-persona-btn">更换群主身份</button>
</div>

<!-- 并排显示 真名 和 昵称 -->
<div class="form-group" style="display: flex; gap: 10px;">
    <div style="flex: 1;">
        <label for="setting-group-my-realname">群主(我)</label>
        <input type="text" id="setting-group-my-realname" placeholder="真名" readonly>
    </div>
    <div style="flex: 1;">
        <label for="setting-group-my-nickname">群昵称</label>
        <input type="text" id="setting-group-my-nickname" placeholder="昵称">
    </div>
</div>

<div class="form-group" style="display: none;">
    <label for="setting-group-my-persona">我的人设</label>
    <textarea id="setting-group-my-persona" placeholder="绑定身份后自动填充" readonly></textarea>
</div>
<!-- === 修改结束 === -->
                    <hr style="border:none; border-top:1px solid #eee; margin: 20px 0;">
                    <div class="form-group">
                        <label>群成员</label>
                        <div class="group-members-list" id="group-members-list-container"></div>
                    </div>
                    <hr style="border:none; border-top:1px solid #eee; margin: 20px 0;">
                    <div class="form-group">
                        <button type="button" class="btn btn-secondary" id="link-group-world-book-btn">关联世界书</button>
                    </div>
                    <div class="form-group"><label for="setting-group-theme-color">主题颜色 (对方/我方)</label><select
                            id="setting-group-theme-color"></select></div>

                    <hr style="border:none; border-top:1px solid #eee; margin: 20px 0;">
                    <div class="form-group">
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <label for="setting-group-use-custom-css" style="margin-bottom:0;">自定义气泡样式</label>
                            <input type="checkbox" id="setting-group-use-custom-css" style="width: auto;">
                        </div>
                        <div id="group-bubble-css-preview" class="bubble-css-preview"
                            style="background: #fff; border: 1px solid #eee; border-radius: 10px; padding: 15px; margin-bottom: 10px; display: flex; flex-direction: column; gap: 10px;">
                        </div>
                        <textarea id="setting-group-custom-bubble-css" rows="6"
                            placeholder="在此输入CSS代码...&#10;例如：&#10;.message-bubble.sent { background-color: #A5D6A7; }&#10;.message-bubble.received { background-color: #E1E1E1; }"
                            disabled></textarea>
                        <button type="button" class="btn btn-neutral" id="reset-group-custom-bubble-css-btn"
                            style="margin-top: 10px; width: auto; padding: 5px 15px; font-size: 14px;">恢复默认
                        </button>
                    </div>
                    <div class="panel panel-sm"
                        style="padding:12px;border-radius:10px;border:1px solid var(--border-color,#e8e8ef);background:var(--panel-bg,#fff);box-shadow:var(--panel-shadow,0 4px 12px rgba(20,20,30,0.04));margin:10px 0;">
                        <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;"><label
                                for="group-bubble-preset-select"
                                style="width:88px;color:var(--muted,#667);font-size:13px;">气泡预设</label><select
                                id="group-bubble-preset-select"
                                style="flex:1;padding:8px 10px;border-radius:8px;border:1px solid var(--input-border,#e6e6ea);background:var(--input-bg,#fff);font-size:14px;">
                                <option value="">— 选择预设 —</option>
                            </select><button type="button" id="group-apply-preset-btn" class="btn btn-primary"
                                style="margin-left:8px;padding:7px 10px;border-radius:8px;">应用</button></div>
                        <div style="display:flex;gap:8px;align-items:center;margin-bottom:10px;"><label
                                style="width:88px;color:var(--muted,#667);font-size:13px;">外观操作</label><button
                                type="button" id="group-save-preset-btn" class="btn"
                                style="padding:7px 10px;border-radius:8px;">另存为</button><button type="button"
                                id="group-manage-presets-btn" class="btn"
                                style="padding:7px 10px;border-radius:8px;">管理</button></div>
                    </div>
                    <div class="form-group"><label for="setting-group-max-memory">最大记忆轮数</label><input type="number"
                            id="setting-group-max-memory" value="10" min="1"></div>
                    <div class="form-group"><label for="setting-group-chat-bg-upload"
                            class="btn btn-primary">更换聊天背景</label><input type="file" id="setting-group-chat-bg-upload"
                            accept="image/*" style="display:none;">
                    </div>
                    <button type="submit" class="btn btn-primary">保存设置</button>
                </form>
                <hr style="border:none; border-top:1px solid #eee; margin: 20px 0;">
                <button type="button" class="btn btn-danger" id="clear-group-chat-history-btn">清空聊天记录</button>
            </div>
        </div>

<!-- 总结页面 -->
<div id="memory-journal-screen" class="screen">
    <!-- Header 和 Tab 保持不变 -->
    <header class="app-header">
        <button class="back-btn" data-target="chat-room-screen">‹</button>
        <div class="title-container">
            <h1 class="title">记忆档案</h1>
        </div>
        <div class="action-btn-group">
            <button class="action-btn" id="bind-journal-worldbook-btn" title="绑定世界书">
                <svg viewBox="0 0 24 24" fill="currentColor" width="24" height="24">
                    <path d="M17 7h-4v2h4c1.65 0 3 1.35 3 3s-1.35 3-3 3h-4v2h4c2.76 0 5-2.24 5-5s-2.24-5-5-5zm-6 8H7c-1.65 0-3-1.35-3-3s1.35-3 3-3h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-2zm-3-4h8v2H8v-2z"></path>
                </svg>
            </button>
            <button class="action-btn" id="generate-new-journal-btn" title="生成">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="24" height="24">
                    <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"></path>
                </svg>
            </button>
        </div>
    </header>
    
    <div class="mem-tab-header">
        <button class="mem-tab-btn active" data-tab="summary">对话总结</button>
        <button class="mem-tab-btn" data-tab="journal">角色日记</button>
    </div>

    <!-- 新增：分栏布局容器 -->
    <div class="memory-layout-container">
        <!-- 侧边栏 (仅在总结Tab显示) -->
        <aside id="summary-sidebar" class="summary-sidebar">
            <div class="summary-sidebar-item active" data-sub="short">短期</div>
            <div class="summary-sidebar-item" data-sub="long">长期</div>
        </aside>

        <!-- 列表内容区 -->
        <main class="content">
            <ul class="list-container" id="journal-list-container">
                <!-- 列表内容 -->
            </ul>
            <div class="placeholder-text" id="no-journals-placeholder" style="display: none;">
                <p id="placeholder-text-content">还没有记录哦~</p>
            </div>
        </main>
    </div>
</div>



<!-- ================= 1. 总结详情页 (Summary Detail) ================= -->
<div id="summary-detail-screen" class="screen">
    <header class="app-header">
        <button class="back-btn" data-target="memory-journal-screen">‹</button>
        <div class="title-container">
            <h1 class="title">总结详情</h1>
        </div>
        <button class="action-btn" id="edit-summary-btn">
            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M20.71,7.04C21.1,6.65 21.1,6 20.71,5.63L18.37,3.29C18,2.9 17.35,2.9 16.96,3.29L15.13,5.12L18.88,8.87M3,17.25V21H6.75L17.81,9.94L14.06,6.19L3,17.25Z" /></svg>
        </button>
    </header>
    <main class="content" style="padding: 20px; font-family: 'Georgia', 'Times New Roman', serif;">
        <h2 id="summary-detail-title" style="margin-top: 0; font-size: 22px;"></h2>
        
        <div class="date-edit-container">
            <span>发生时间:</span>
            <input type="text" id="summary-occurred-at" class="date-edit-input" placeholder="YYYY-MM-DD" readonly>
            <span id="summary-range-display" style="margin-left: auto;"></span>
        </div>

        <div id="summary-detail-content" style="padding: 5px; line-height: 1.7; white-space: pre-wrap; font-size: 17px;"></div>
    </main>
</div>

<!-- ================= 2. 日记详情页 (Journal Detail) ================= -->
<div id="journal-detail-screen" class="screen">
    <header class="app-header">
        <button class="back-btn" data-target="memory-journal-screen">‹</button>
        <!-- 标题移除，空着或者放个装饰 -->
        <div class="title-container"></div> 
        <div class="action-btn-group">
            <button class="action-btn" id="journal-settings-btn" title="设置">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
            </button>
            <button class="action-btn" id="edit-journal-btn" title="编辑">
                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M20.71,7.04C21.1,6.65 21.1,6 20.71,5.63L18.37,3.29C18,2.9 17.35,2.9 16.96,3.29L15.13,5.12L18.88,8.87M3,17.25V21H6.75L17.81,9.94L14.06,6.19L3,17.25Z" /></svg>
            </button>
        </div>
    </header>
    
    <style id="dynamic-journal-style"></style>

    <main class="content">
        <!-- 拟物化布局：日期在右上角 -->
                <!-- 标题居中 -->
        <h2 id="journal-detail-title"></h2>
        <div class="journal-meta-container">
            <!-- 年 -->
            <input type="text" id="journal-date-year" class="date-value-handwriting" style="width: 50px;" readonly>
            <span class="date-label-print">年</span>
            <!-- 月 -->
            <input type="text" id="journal-date-month" class="date-value-handwriting" style="width: 30px;" readonly>
            <span class="date-label-print">月</span>
            <!-- 日 -->
            <input type="text" id="journal-date-day" class="date-value-handwriting" style="width: 30px;" readonly>
            <span class="date-label-print">日</span>
        </div>


        
        <!-- 正文 -->
        <div id="journal-detail-content" class="journal-paper-content"></div>
    </main>
</div>


<!-- 偷看手机页面 -->
        <div id="peek-screen" class="screen">
            <header class="app-header">
                <button class="back-btn" data-target="chat-room-screen">‹</button>
                <div class="title-container">
                    <h1 class="title">Ta的手机</h1>
                </div>
                <button class="action-btn" id="peek-settings-btn"><svg viewBox="0 0 24 24" fill="currentColor">
                        <rect x="3" y="5" width="18" height="1.5" rx="0.75" />
                        <rect x="3" y="11" width="18" height="1.5" rx="0.75" />
                        <rect x="3" y="17" width="18" height="1.5" rx="0.75" />
                    </svg></button>
            </header>
            <main class="content" style="padding: 50px 0; justify-content: flex-start; align-items: center;">
                <!-- Content rendered by renderPeekScreen() -->
            </main>
        </div>
                <div id="peek-messages-screen" class="screen">

            <header class="app-header">
                <button class="back-btn" data-target="peek-screen">‹</button>
                <div class="title-container">
                    <h1 class="title">Ta的消息</h1>
                </div>
                <button class="action-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="22"
                        height="22">
                        <path
                            d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z">
                        </path>
                    </svg>
                </button>
            </header>
            <main class="content">
                <ul class="list-container" id="peek-chat-list-container">
                    <!-- Simulated chat list will be rendered here -->
                </ul>
            </main>
        </div>

        <!-- Peek Conversation Screen -->
        <div id="peek-conversation-screen" class="screen">
            <header class="app-header">
                <button class="back-btn" data-target="peek-messages-screen">‹</button>
                <div class="title-container">
                    <h1 class="title" id="peek-conversation-title">...</h1>
                </div>
                <button class="action-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="22"
                        height="22">
                        <path
                            d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z">
                        </path>
                    </svg>
                </button>
            </header>
            <main class="content">
                <div class="message-area" id="peek-message-area">
                    <!-- Simulated messages will be rendered here -->
                </div>
            </main>
        </div>

        <!-- Peek Memos Screen -->
        <div id="peek-memos-screen" class="screen"></div>

        <!-- Peek Memo Detail Screen -->
        <div id="peek-memo-detail-screen" class="screen"></div>

        <!-- Peek Cart Screen -->
        <div id="peek-cart-screen" class="screen"></div>

        <!-- Peek Transfer Station Screen -->
        <div id="peek-transfer-station-screen" class="screen"></div>

        <!-- Peek Browser Screen -->
        <div id="peek-browser-screen" class="screen"></div>

        <!-- Peek Drafts Screen -->
        <div id="peek-drafts-screen" class="screen"></div>

        <div id="peek-album-screen" class="screen">
            <header class="app-header">
                <button class="back-btn" data-target="peek-screen">‹</button>
                <div class="title-container">
                    <h1 class="title">相册</h1>
                </div>
                <button class="action-btn" id="refresh-album-btn"><svg xmlns="http://www.w3.org/2000/svg"
                        viewBox="0 0 24 24" fill="currentColor" width="22" height="22">
                        <path
                            d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z">
                        </path>
                    </svg></button>
            </header>
            <main class="content">
                <div class="album-grid">
                    <p class="placeholder-text">正在生成相册内容...</p>
                </div>
            </main>
        </div>

        <!-- Peek Unlock Screen (Social Media) -->
        <div id="peek-unlock-screen" class="screen">
            <!-- Content will be dynamically rendered by renderPeekUnlock() -->
        </div>
        
        <!-- Peek Steps App Screen -->
        <div id="peek-steps-screen" class="screen">
            <header class="app-header">
                <button class="back-btn" data-target="peek-screen">‹</button>
                <div class="title-container">
                    <h1 class="title">步数</h1>
                </div>
                <button class="action-btn" id="refresh-steps-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="22"
                        height="22">
                        <path
                            d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z">
                        </path>
                    </svg>
                </button>
            </header>
            <main class="content">
                <div class="steps-header">
                    <img src="https://i.postimg.cc/Y96LPskq/o-o-2.jpg" alt="Char Avatar" class="steps-header-avatar"
                        id="steps-char-avatar">
                    <span class="steps-header-name" id="steps-char-name">Char</span>
                </div>

                <div class="steps-progress-container">
                    <div class="steps-progress-circle" id="steps-progress-ring"></div>
                    <div class="steps-progress-inner">
                        <div class="steps-count" id="steps-current-count">4321</div>
                        <div class="steps-label">/ 6000 步</div>
                    </div>
                </div>

                <div class="steps-module">
                    <h3 class="steps-module-title">最近活动轨迹</h3>
                    <ul class="activity-track-list" id="activity-track-list">
                        <li class="activity-track-item">10:00 AM - 咖啡馆</li>
                        <li class="activity-track-item">01:30 PM - 市中心图书馆</li>
                        <li class="activity-track-item">06:00 PM - 河边公园</li>
                        <li class="activity-track-item">07:00 PM - 健身房</li>
                        <li class="activity-track-item">08:30 PM - 超市</li>
                        <li class="activity-track-item">09:00 PM - 回家</li>
                    </ul>
                </div>
                <div class="steps-annotation" id="steps-annotation-content">
                    “今天走了不少路，但感觉很充实。特别是下午在图书馆找到的那本书，感觉能看很久。”
                </div>
            </main>
        </div>


       <!-- 论坛页面 -->
        <!-- 1. 发现页 (Forum Home) -->
        <div id="forum-screen" class="screen has-bottom-nav">
            <!-- Header: 只有返回和标题 -->
            <header class="app-header">
                <button class="back-btn" data-target="home-screen">‹</button>
                <div class="title-container">
                    <h1 class="title">喵 坛</h1>
                </div>
                <!-- 右侧留空，保持标题居中 -->
                <div style="width: 40px;"></div>
            </header>

            <!-- 顶部搜索栏 (包含发帖按钮) -->
            <div class="forum-top-search-bar">
                <input type="text" id="forum-search-input" placeholder="搜索关键词...">
                <button class="action-btn" id="forum-refresh-btn" title="搜索/刷新">
                    <svg viewBox="0 0 24 24" fill="none" width="22" height="22" xmlns="http://www.w3.org/2000/svg">
                        <path
                            d="M15.7955 15.8111L21 21M18 10.5C18 14.6421 14.6421 18 10.5 18C6.35786 18 3 14.6421 3 10.5C3 6.35786 6.35786 3 10.5 3C14.6421 3 18 6.35786 18 10.5Z"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                    </svg>
                </button>
                <button class="action-btn" id="forum-create-btn" title="发布新帖">
                    <svg viewBox="0 0 24 24" fill="currentColor" width="22" height="22">
                        <path
                            d="M20.71,7.04C21.1,6.65 21.1,6 20.71,5.63L18.37,3.29C18,2.9 17.35,2.9 16.96,3.29L15.12,5.12L18.87,8.87M3,17.25V21H6.75L17.81,9.93L14.06,6.18L3,17.25Z" />
                    </svg>
                </button>
            </div>

            <!-- Main 内容区域 -->
            <main class="content forum-content-area">
                <!-- 新增：热帖模块 -->
                <div id="hot-posts-section" class="hot-posts-section" style="display:none;">
                    <!-- 修改：header 增加 inner-wrapper 用于控制下划线长度 -->
                    <div class="hot-posts-header">
                        <span class="header-content-wrapper">
                            <svg viewBox="0 0 24 24" fill="currentColor" width="20" height="20"
                                xmlns="http://www.w3.org/2000/svg">
                                <path
                                    d="M12.8324 21.8013C15.9583 21.1747 20 18.926 20 13.1112C20 7.8196 16.1267 4.29593 13.3415 2.67685C12.7235 2.31757 12 2.79006 12 3.50492V5.3334C12 6.77526 11.3938 9.40711 9.70932 10.5018C8.84932 11.0607 7.92052 10.2242 7.816 9.20388L7.73017 8.36604C7.6304 7.39203 6.63841 6.80075 5.85996 7.3946C4.46147 8.46144 3 10.3296 3 13.1112C3 20.2223 8.28889 22.0001 10.9333 22.0001C11.0871 22.0001 11.2488 21.9955 11.4171 21.9858C10.1113 21.8742 8 21.064 8 18.4442C8 16.3949 9.49507 15.0085 10.631 14.3346C10.9365 14.1533 11.2941 14.3887 11.2941 14.7439V15.3331C11.2941 15.784 11.4685 16.4889 11.8836 16.9714C12.3534 17.5174 13.0429 16.9454 13.0985 16.2273C13.1161 16.0008 13.3439 15.8564 13.5401 15.9711C14.1814 16.3459 15 17.1465 15 18.4442C15 20.4922 13.871 21.4343 12.8324 21.8013Z"
                                    fill="currentColor" />
                            </svg>
                            <span>Hot！</span>
                        </span>
                    </div>
                    <div id="hot-posts-list" class="hot-posts-list">
                        <!-- JS 生成热帖 -->
                    </div>
                </div>

                <div id="forum-posts-container">
                    <!-- 普通帖子列表 -->
                </div>
            </main>
        </div>


        <!-- 2. 世界页 (World Settings) -->
        <div id="world-screen" class="screen has-bottom-nav">
            <header class="app-header">
                <!-- 新增：返回按钮，指向 forum-screen -->
                <button class="back-btn" data-target="forum-screen">‹</button>

                <div class="title-container">
                    <h1 class="title">世 界</h1>
                </div>

                <!-- 右侧保存按钮保持不变 -->
                <button class="action-btn" id="world-save-btn" title="保存设置">
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path fill-rule="evenodd" clip-rule="evenodd"
                            d="M12 22C7.28595 22 4.92893 22 3.46447 20.5355C2 19.0711 2 16.714 2 12C2 7.28595 2 4.92893 3.46447 3.46447C4.92893 2 7.28595 2 12 2C12.3415 2 12.5122 2 12.6858 2.01515C13.4951 2.08581 14.2874 2.414 14.9097 2.93631C15.0431 3.04834 15.1668 3.17204 15.4142 3.41938L20.5806 8.58578C20.828 8.83317 20.9516 8.95687 21.0637 9.09034C21.586 9.71257 21.9142 10.5049 21.9848 11.3142C22 11.4878 22 11.6585 22 12C22 16.714 22 19.0711 20.5355 20.5355C19.0711 22 16.714 22 12 22ZM8.60982 13.0384C8.80302 13 9.03535 13 9.5 13H14.5C14.9647 13 15.197 13 15.3902 13.0384C16.1836 13.1962 16.8038 13.8164 16.9616 14.6098C17 14.803 17 15.0353 17 15.5C17 15.9647 17 16.197 16.9616 16.3902C16.8038 17.1836 16.1836 17.8038 15.3902 17.9616C15.197 18 14.9647 18 14.5 18H9.5C9.03535 18 8.80302 18 8.60982 17.9616C7.81644 17.8038 7.19624 17.1836 7.03843 16.3902C7 16.197 7 15.9647 7 15.5C7 15.0353 7 14.803 7.03843 14.6098C7.19624 13.8164 7.81644 13.1962 8.60982 13.0384Z"
                            fill="currentColor" />
                    </svg>
                </button>
            </header>

            <!-- 2. 新布局：侧边栏 + 内容区 -->
            <main class="content tab-content-area">
                <!-- 侧边栏：角色在上，世界书在下 -->
                <div class="world-sidebar">
                    <!-- 1. 角色按钮 (默认激活 active) -->
                    <button class="world-sidebar-btn active" data-tab="char">
                        <svg viewBox="0 0 24 24">
                            <path
                                d="M12,5.5A3.5,3.5 0 0,1 15.5,9A3.5,3.5 0 0,1 12,12.5A3.5,3.5 0 0,1 8.5,9A3.5,3.5 0 0,1 12,5.5M5,8C5.56,8 6.08,8.15 6.53,8.42C6.38,9.85 6.8,11.27 7.66,12.38C7.16,13.34 6.16,14 5,14A3,3 0 0,1 2,11A3,3 0 0,1 5,8M19,8A3,3 0 0,1 22,11A3,3 0 0,1 19,14C17.84,14 16.84,13.34 16.34,12.38C17.2,11.27 17.62,9.85 17.47,8.42C17.92,8.15 18.44,8 19,8M5.5,18.25C5.5,16.18 8.41,14.5 12,14.5C15.59,14.5 18.5,16.18 18.5,18.25V20H5.5V18.25M0,20V18.5C0,17.11 1.89,15.94 4.45,15.6C3.86,16.28 3.5,17.22 3.5,18.25V20H0M24,20H20.5V18.25C20.5,17.22 20.14,16.28 19.55,15.6C22.11,15.94 24,17.11 24,18.5V20Z" />
                        </svg>
                        <span>角色</span>
                    </button>

                    <!-- 2. 世界书按钮 -->
                    <button class="world-sidebar-btn" data-tab="wb">
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path fill-rule="evenodd" clip-rule="evenodd"
                                d="M4 5V19C4 20.6569 5.34315 22 7 22H17C18.6569 22 20 20.6569 20 19V9C20 7.34315 18.6569 6 17 6H5C4.44772 6 4 5.55228 4 5ZM7.25 12C7.25 11.5858 7.58579 11.25 8 11.25H16C16.4142 11.25 16.75 11.5858 16.75 12C16.75 12.4142 16.4142 12.75 16 12.75H8C7.58579 12.75 7.25 12.4142 7.25 12ZM7.25 15.5C7.25 15.0858 7.58579 14.75 8 14.75H13.5C13.9142 14.75 14.25 15.0858 14.25 15.5C14.25 15.9142 13.9142 16.25 13.5 16.25H8C7.58579 16.25 7.25 15.9142 7.25 15.5Z"
                                fill="currentColor" />
                            <path
                                d="M4.40879 4.0871C4.75727 4.24338 5 4.59334 5 5H17C17.3453 5 17.6804 5.04375 18 5.12602V4.30604C18 3.08894 16.922 2.15402 15.7172 2.32614L4.91959 3.86865C4.72712 3.89615 4.55271 3.97374 4.40879 4.0871Z"
                                fill="currentColor" />
                        </svg>
                        <span>世界书</span>
                    </button>
                </div>

                <div class="world-content-wrapper">
                    <p id="world-content-tips">
                        <span style="color:var(--primary-color)">提示：</span>勾选后请点击右上角保存。
                    </p>

                    <!-- Tab 1: 角色 (默认显示 active) -->
                    <!-- Tab 1: 角色 -->
                    <div id="world-tab-char" class="world-tab-pane active">
                        <div class="setting-row">
                            <div style="display:flex; flex-direction:column;">
                                <span style="font-size:14px; font-weight:600; color:#333;">关联聊天记忆</span>
                                <span style="font-size:11px; color:#999;">开启后 AI 将读取选中角色的聊天记录</span>
                            </div>
                            <div style="display: flex; align-items: center;">
                                <!-- 修改：开关在前，输入框在后 -->
                                <label class="switch" style="margin-right: -5px;">
                                    <input type="checkbox" id="world-use-history-toggle">
                                    <span class="slider round"></span>
                                </label>
                                <!-- 修改：去掉了 display:none，增加了 transition 和默认占位样式 -->
                                <input type="number" id="world-history-limit" class="history-limit-input" value="50"
                                    min="1" max="500" placeholder="条数"
                                    style="opacity: 0; pointer-events: none; transition: opacity 0.2s; width: 45px;">
                            </div>
                        </div>
                        <div class="world-section-title">活跃的角色 (Char)</div>
                        <!-- 列表容器将由 JS 填充 -->
                        <div class="world-list-container">
                            <ul id="forum-char-list" class="binding-list"></ul>
                        </div>
                    </div>

                    <!-- Tab 2: 世界书 (默认隐藏) -->
                    <div id="world-tab-wb" class="world-tab-pane">
                        <!-- 新增：跳转按钮 -->
                        <div id="jump-to-wb-edit-btn" class="world-book-shortcut-btn">
                            + 去管理/添加世界书
                        </div>
                        <div class="world-section-title">生效的世界书</div>

                        <div class="world-list-container">
                            <ul id="forum-worldbook-list" class="binding-list">
                                <!-- JS 填充 -->
                            </ul>
                        </div>
                    </div>
                </div>
            </main> 
        </div>


        <!-- 新增：收藏页 -->
        <!-- 找到这一行 -->
        <div id="favorites-screen" class="screen has-bottom-nav">
            <header class="app-header">
                <!-- ... header 内容保持不变 ... -->
                <button class="back-btn" data-target="forum-screen">‹</button>
                <div class="title-container">
                    <h1 class="title">收 藏</h1>
                </div>
                <button class="action-btn" id="fav-manage-btn" title="管理">
                    <!-- ... svg ... -->
                    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path
                            d="M19 7L18.1327 19.1425C18.0579 20.1891 17.187 21 16.1378 21H7.86224C6.81296 21 5.94208 20.1891 5.86732 19.1425L5 7M10 11V17M14 11V17M15 7V4C15 3.44772 14.5523 3 14 3H10C9.44772 3 9 3.44772 9 4V7M4 7H20"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                    </svg>
                </button>
            </header>

            <!-- 【新增】Tab 切换栏 -->
            <div class="fav-tab-header">
                <button class="fav-tab-btn active" data-tab="my-fav">我的收藏</button>
                <button class="fav-tab-btn" data-tab="watching">角色在看</button>
            </div>

            <!-- 主内容区，注意增加了 padding-top: 0，因为 tab 占据了空间，
         实际上列表需要减去 header(60) + tab(44) + bottom(60) 的高度 -->
            <main class="content" style="padding:0; position: relative; height: calc(100% - 60px - 44px);">
                <!-- 列表容器 -->
                <div id="favorites-list-container" style="overflow-y: auto; height: 100%;">
                    <!-- 收藏列表 JS 填充 -->
                    <p class="placeholder-text" style="margin-top:50px;">暂无收藏内容</p>
                </div>

                <!-- 管理操作栏 (保持不变) -->
                <div id="fav-manage-actions" class="favorites-manage-bar">
                    <button id="fav-delete-confirm-btn" class="btn btn-danger">删除选中</button>
                </div>
            </main>
        </div>

<!-- 3. 我 (User Settings) - Tab分栏版 -->
<div id="me-screen" class="screen has-bottom-nav">
    
    <!-- 顶部导航 (透明) -->
    <header class="app-header">
        <button class="back-btn" data-target="forum-screen">‹</button>
        <div style="width: 40px;"></div>
    </header>

    <main class="content me-content-area">
        
 

        <!-- 头部信息区域 (无背景，直接叠在banner下沿) -->
        <div class="me-profile-header">
            <!-- 悬浮头像 -->
            <div class="me-avatar-wrapper-left">
                <div class="me-avatar-container" id="me-avatar-trigger">
                    <div class="me-avatar-preview">
                        <img id="me-avatar-img" src="https://i.postimg.cc/Y96LPskq/o-o-2.jpg">
                    </div>
                    <div class="me-avatar-overlay">
                        <svg viewBox="0 0 24 24"><path fill="#fff" d="M4,4H7L9,2H15L17,4H20A2,2 0 0,1 22,6V18A2,2 0 0,1 20,20H4A2,2 0 0,1 2,18V6A2,2 0 0,1 4,4M12,7A5,5 0 0,0 7,12A5,5 0 0,0 12,17A5,5 0 0,0 17,12A5,5 0 0,0 12,7M12,9A3,3 0 0,1 15,12A3,3 0 0,1 12,15A3,3 0 0,1 9,12A3,3 0 0,1 12,9Z" /></svg>
                    </div>
                </div>
                <!-- 隐藏的文件输入框 -->
                <input type="hidden" id="me-avatar-input">
            </div>

            <!-- 右侧信息 (左对齐) -->
            <div class="me-info-right-aligned">
    <input type="text" id="me-nickname-input" class="me-nickname-text" placeholder="昵称">
    <div class="me-code-badge">
        <span>@喵叽</span>
        <input 
            type="text" 
            inputmode="numeric"
            id="me-anon-code-input" 
            placeholder="0311" 
            maxlength="4" 
            oninput="this.value = this.value.replace(/\D/g, '')"
            onblur="if(this.value) this.value = this.value.padStart(4, '0')"
        >
    </div>
</div>
        </div>
       
        <!-- 数据统计悬浮块 (独立圆角卡片) -->
        <div class="me-stats-floating-card">
            <div class="stat-item">
                <span class="stat-num" id="stat-post-count">0</span>
                <span class="stat-label">发帖</span>
            </div>
            <div class="stat-item">
                <span class="stat-num" id="stat-fav-count">0</span>
                <span class="stat-label">收藏</span>
            </div>
            <div class="stat-item">
                <span class="stat-num" id="stat-watch-count">0</span>
                <span class="stat-label">在看</span>
            </div>
        </div>

        <!-- Tab 切换导航 -->
 <div class="me-detail-card">
        <div class="me-tab-nav">
            <div class="me-tab-item active" data-tab="persona">
                我的档案
                <div class="active-bar"></div>
            </div>
            <div class="me-tab-item" data-tab="css">
                正文样式
                <div class="active-bar"></div>
            </div>
        </div>

        <!-- Tab 内容区域 (无卡片背景，直接衔接) -->
        <div class="me-tab-content-container">
            
            <!-- Tab 1: 档案内容 -->
            <div class="me-tab-pane active" id="tab-persona">
                <div class="field-group">
                    <label>姓名</label>
                    <input type="text" id="me-realname-input" readonly placeholder="未设置" class="field-input">
                    <div class="me-load-btn">
                    <button id="me-load-persona-btn" class="btn btn-secondary">读取预设</button></div>
                </div>
                
                <div class="field-group">
                    <label>设定</label>
                    <textarea id="me-persona-input" readonly class="field-textarea" placeholder="暂无设定信息"></textarea>
                </div>
            </div>

            <!-- Tab 2: CSS 内容 -->
            <div class="me-tab-pane" id="tab-css">
                <div class="field-group">
                    <textarea id="me-custom-css-input" class="field-textarea css-editor" placeholder=".post-detail-content-body{正文}
.inline-quote{引用}"></textarea>
                </div>
            </div>
</div>
        </div>

        <!-- 保存按钮 (悬浮底部或者放在最下) -->
        <div class="save-btn-container">
            <button id="me-save-btn" type="submit" class="btn btn-secondary">保存设置</button>
        </div>

    </main>


        </div>


            <!-- 底部导航栏保持不变 -->

            <nav class="bottom-tab-bar">
                <div class="tab-item" data-target="forum-screen">
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <!-- 添加了一个分组 <g>，并应用了缩放和平移 -->
                        <!-- scale(0.8) 表示缩小到80% -->
                        <!-- translate(2.4, 2.4) 是为了让缩放后的图标重新居中 ((24 - 24*0.8)/2 = 2.4) -->
                        <g transform="translate(1.2, 1.2) scale(0.9)">
                            <path fill-rule="evenodd" clip-rule="evenodd"
                                d="M13.9931 3.43368C12.8564 2.42331 11.1436 2.42331 10.0069 3.43368L2.33565 10.2526C1.92286 10.6195 1.88568 11.2516 2.2526 11.6644C2.61952 12.0771 3.25159 12.1143 3.66437 11.7474L4.00001 11.4491L4.00001 17.0658C3.99996 17.9523 3.99992 18.7161 4.08215 19.3278C4.17028 19.9833 4.36903 20.6117 4.87869 21.1213C5.38835 21.631 6.0167 21.8297 6.67222 21.9179C7.28388 22.0001 8.04769 22 8.93418 22H15.0658C15.9523 22 16.7161 22.0001 17.3278 21.9179C17.9833 21.8297 18.6117 21.631 19.1213 21.1213C19.631 20.6117 19.8297 19.9833 19.9179 19.3278C20.0001 18.7161 20.0001 17.9523 20 17.0659L20 11.4491L20.3356 11.7474C20.7484 12.1143 21.3805 12.0771 21.7474 11.6644C22.1143 11.2516 22.0772 10.6195 21.6644 10.2526L13.9931 3.43368ZM12 16C11.4477 16 11 16.4477 11 17V19C11 19.5523 10.5523 20 10 20C9.44772 20 9 19.5523 9 19V17C9 15.3431 10.3431 14 12 14C13.6569 14 15 15.3431 15 17V19C15 19.5523 14.5523 20 14 20C13.4477 20 13 19.5523 13 19V17C13 16.4477 12.5523 16 12 16Z"
                                fill="currentColor" />
                        </g>
                    </svg>
                    <span>主页</span>
                </div>
                <div class="tab-item" data-target="world-screen">
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path fill-rule="evenodd" clip-rule="evenodd"
                            d="M12 20C16.4183 20 20 16.4183 20 12C20 11.8805 19.9974 11.7615 19.9922 11.6433C20.2479 11.4141 20.4882 11.1864 20.7118 10.9611C21.0037 10.6672 21.002 10.1923 20.708 9.90049C20.4336 9.628 20.0014 9.61143 19.7077 9.84972C19.4023 8.75248 18.8688 7.75024 18.1616 6.89725C18.4607 6.84611 18.7436 6.8084 19.0087 6.784C19.4212 6.74604 19.7247 6.38089 19.6868 5.96842C19.6488 5.55595 19.2837 5.25235 18.8712 5.29032C18.4474 5.32932 17.9972 5.39638 17.5262 5.48921C17.3267 5.52851 17.1614 5.64353 17.0543 5.79852C15.6765 4.67424 13.917 4 12 4C7.58172 4 4 7.58172 4 12C4 12.2776 4.01414 12.552 4.04175 12.8223C3.78987 12.7532 3.50899 12.8177 3.31137 13.0159C2.97651 13.3517 2.67596 13.6846 2.415 14.0113C2.15647 14.3349 2.20924 14.8069 2.53287 15.0654C2.8565 15.3239 3.32843 15.2711 3.58696 14.9475C3.78866 14.695 4.02466 14.4302 4.2938 14.1557C4.60754 15.2796 5.16056 16.3037 5.8945 17.1697C5.66824 17.3368 5.54578 17.6248 5.60398 17.919C5.68437 18.3253 6.07894 18.5896 6.48528 18.5092C6.7024 18.4662 6.92455 18.4177 7.15125 18.3637C8.49656 19.3903 10.1771 20 12 20ZM7.15125 18.3637C6.69042 18.012 6.26891 17.6114 5.8945 17.1697C5.98073 17.106 6.08204 17.0599 6.19417 17.0377C7.19089 16.8405 8.33112 16.5084 9.55581 16.0486C9.94359 15.903 10.376 16.0994 10.5216 16.4872C10.6671 16.8749 10.4708 17.3073 10.083 17.4529C9.05325 17.8395 8.0653 18.1459 7.15125 18.3637ZM19.7077 9.84972C19.6869 9.86663 19.6667 9.88483 19.6474 9.90431C18.9609 10.5957 18.0797 11.3337 17.0388 12.0753C16.7014 12.3157 16.6228 12.784 16.8631 13.1213C17.1035 13.4587 17.5718 13.5373 17.9091 13.297C18.6809 12.7471 19.3806 12.1912 19.9922 11.6433C19.965 11.0246 19.8676 10.4241 19.7077 9.84972ZM20.9366 5.37924C20.5336 5.28378 20.1294 5.53313 20.034 5.93619C19.9385 6.33925 20.1879 6.74339 20.5909 6.83886C20.985 6.93219 21.1368 7.07125 21.1932 7.16142C21.2565 7.26269 21.3262 7.52732 21.0363 8.10938C20.8516 8.48014 21.0025 8.93042 21.3732 9.1151C21.744 9.29979 22.1943 9.14894 22.379 8.77818C22.7566 8.02003 22.9422 7.12886 22.4648 6.36582C22.1206 5.81574 21.5416 5.52252 20.9366 5.37924ZM2.81481 16.2501C2.94057 15.8555 2.72259 15.4336 2.32793 15.3078C1.93327 15.1821 1.51138 15.4 1.38562 15.7947C1.19392 16.3963 1.17354 17.0573 1.53488 17.6349C1.98775 18.3587 2.84153 18.6413 3.68907 18.7224C4.1014 18.7619 4.46765 18.4596 4.50712 18.0473C4.54658 17.635 4.24432 17.2687 3.83199 17.2293C3.13763 17.1628 2.88355 16.9624 2.80651 16.8393C2.75679 16.7598 2.70479 16.5954 2.81481 16.2501ZM15.7504 14.704C16.106 14.4915 16.2218 14.0309 16.0093 13.6754C15.7967 13.3199 15.3362 13.204 14.9807 13.4166C14.4991 13.7045 13.9974 13.9881 13.4781 14.2648C12.9445 14.5491 12.4132 14.8149 11.8883 15.0615C11.5134 15.2376 11.3522 15.6843 11.5283 16.0592C11.7044 16.4341 12.1511 16.5953 12.526 16.4192C13.0739 16.1618 13.6277 15.8847 14.1834 15.5887C14.7242 15.3005 15.2474 15.0048 15.7504 14.704Z"
                            fill="currentColor" />
                    </svg>
                    <span>世界</span>
                </div>
                <!-- 新增：收藏 Tab -->
                <div class="tab-item" data-target="favorites-screen">
                    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path fill-rule="evenodd" clip-rule="evenodd"
                            d="M10.5766 8.70419C11.2099 7.56806 11.5266 7 12 7C12.4734 7 12.7901 7.56806 13.4234 8.70419L13.5873 8.99812C13.7672 9.32097 13.8572 9.48239 13.9975 9.5889C14.1378 9.69541 14.3126 9.73495 14.6621 9.81402L14.9802 9.88601C16.2101 10.1643 16.825 10.3034 16.9713 10.7739C17.1176 11.2443 16.6984 11.7345 15.86 12.715L15.643 12.9686C15.4048 13.2472 15.2857 13.3865 15.2321 13.5589C15.1785 13.7312 15.1965 13.9171 15.2325 14.2888L15.2653 14.6272C15.3921 15.9353 15.4554 16.5894 15.0724 16.8801C14.6894 17.1709 14.1137 16.9058 12.9622 16.3756L12.6643 16.2384C12.337 16.0878 12.1734 16.0124 12 16.0124C11.8266 16.0124 11.663 16.0878 11.3357 16.2384L11.0378 16.3756C9.88634 16.9058 9.31059 17.1709 8.92757 16.8801C8.54456 16.5894 8.60794 15.9353 8.7347 14.6272L8.76749 14.2888C8.80351 13.9171 8.82152 13.7312 8.76793 13.5589C8.71434 13.3865 8.59521 13.2472 8.35696 12.9686L8.14005 12.715C7.30162 11.7345 6.88241 11.2443 7.02871 10.7739C7.17501 10.3034 7.78993 10.1643 9.01977 9.88601L9.33794 9.81402C9.68743 9.73495 9.86217 9.69541 10.0025 9.5889C10.1428 9.48239 10.2328 9.32097 10.4127 8.99812L10.5766 8.70419ZM12 1.25C12.4142 1.25 12.75 1.58579 12.75 2V4C12.75 4.41421 12.4142 4.75 12 4.75C11.5858 4.75 11.25 4.41421 11.25 4V2C11.25 1.58579 11.5858 1.25 12 1.25ZM18.5304 5.46955C18.8233 5.76245 18.8233 6.23732 18.5304 6.53021L18.1872 6.87348C17.8943 7.16637 17.4194 7.16637 17.1265 6.87348C16.8336 6.58058 16.8336 6.10571 17.1265 5.81282L17.4698 5.46955C17.7627 5.17666 18.2376 5.17666 18.5304 5.46955ZM5.46967 5.46967C5.76256 5.17678 6.23744 5.17678 6.53033 5.46967L6.87359 5.81293C7.16648 6.10582 7.16648 6.5807 6.87359 6.87359C6.5807 7.16648 6.10582 7.16648 5.81293 6.87359L5.46967 6.53033C5.17678 6.23744 5.17678 5.76256 5.46967 5.46967ZM1.25 12C1.25 11.5858 1.58579 11.25 2 11.25H4C4.41421 11.25 4.75 11.5858 4.75 12C4.75 12.4142 4.41421 12.75 4 12.75H2C1.58579 12.75 1.25 12.4142 1.25 12ZM19.25 12C19.25 11.5858 19.5858 11.25 20 11.25H22C22.4142 11.25 22.75 11.5858 22.75 12C22.75 12.4142 22.4142 12.75 22 12.75H20C19.5858 12.75 19.25 12.4142 19.25 12ZM6.87348 17.1265C7.16637 17.4194 7.16637 17.8943 6.87348 18.1872L6.53043 18.5302C6.23754 18.8231 5.76266 18.8231 5.46977 18.5302C5.17688 18.2373 5.17688 17.7625 5.46977 17.4696L5.81282 17.1265C6.10571 16.8336 6.58058 16.8336 6.87348 17.1265ZM17.1265 17.1267C17.4194 16.8339 17.8943 16.8339 18.1872 17.1267L18.5302 17.4698C18.8231 17.7627 18.8231 18.2376 18.5302 18.5305C18.2373 18.8233 17.7624 18.8233 17.4695 18.5305L17.1265 18.1874C16.8336 17.8945 16.8336 17.4196 17.1265 17.1267ZM12 19.25C12.4142 19.25 12.75 19.5858 12.75 20V22C12.75 22.4142 12.4142 22.75 12 22.75C11.5858 22.75 11.25 22.4142 11.25 22V20C11.25 19.5858 11.5858 19.25 12 19.25Z"
                            fill="currentColor" />
                    </svg>
                    <span>收藏</span>
                </div>
                <div class="tab-item" data-target="me-screen">
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path fill-rule="evenodd" clip-rule="evenodd"
                            d="M11.7501 6.40636C10.2698 6.40636 10.1222 6.5625 9.3561 6.5625C8.71769 6.5625 6.80245 5 5.84485 5C4.88724 5 3.77004 5.5625 3.77004 7.1875V9.0625C3.77197 9.55469 3.95081 11.0634 4.65075 10.6602C3.82323 11.6382 3.73963 12.7786 3.751 13.8826C3.52812 13.947 3.30072 14.0196 3.08003 14.095C2.39614 14.3289 1.67085 14.6271 1.3432 14.8387C0.995241 15.0634 0.895339 15.5277 1.12006 15.8756C1.34478 16.2236 1.80903 16.3235 2.15698 16.0988C2.3132 15.9979 2.87823 15.7493 3.56532 15.5144C3.64124 15.4884 3.71731 15.4631 3.79298 15.4386C3.83925 15.8724 3.95408 16.2684 4.12478 16.6292L4.1012 16.6416C3.69148 16.8581 3.3113 17.1067 3.06889 17.2652C3.02694 17.2926 2.98912 17.3173 2.95599 17.3387C2.60803 17.5634 2.50813 18.0277 2.73285 18.3756C2.95757 18.7236 3.42182 18.8235 3.76978 18.5988C3.8109 18.5722 3.85472 18.5436 3.90097 18.5134C4.1463 18.3533 4.45999 18.1485 4.80199 17.9678C4.88218 17.9254 4.95935 17.887 5.03317 17.8524C6.76347 19.4748 9.86991 20 11.7501 20C13.6302 20 16.7367 19.4748 18.467 17.8524C18.5408 17.887 18.6179 17.9254 18.6981 17.9678C19.0401 18.1485 19.3538 18.3533 19.5991 18.5134C19.6454 18.5436 19.6892 18.5722 19.7303 18.5988C20.0783 18.8235 20.5425 18.7236 20.7673 18.3756C20.992 18.0277 20.8921 17.5634 20.5441 17.3387C20.511 17.3173 20.4732 17.2926 20.4312 17.2652C20.1888 17.1067 19.8086 16.8581 19.3989 16.6416L19.3754 16.6292C19.5461 16.2683 19.6609 15.8724 19.7072 15.4385C19.783 15.463 19.8592 15.4883 19.9352 15.5144C20.6223 15.7493 21.1874 15.9979 21.3436 16.0988C21.6915 16.3235 22.1558 16.2236 22.3805 15.8756C22.6052 15.5277 22.5053 15.0634 22.1574 14.8387C21.8297 14.6271 21.1044 14.3289 20.4205 14.095C20.1997 14.0195 19.9722 13.947 19.7492 13.8825C19.7605 12.7785 19.6769 11.6382 18.8494 10.6602C19.5494 11.0634 19.7282 9.55469 19.7302 9.0625V7.18761C19.7302 5.56261 18.6129 5.00011 17.6553 5.00011C16.6977 5.00011 14.7825 6.5625 14.1441 6.5625C13.378 6.5625 13.2305 6.40636 11.7501 6.40636ZM13.9201 12.5005C14.0566 12.2721 14.326 12 14.7301 12C15.1342 12 15.4036 12.2721 15.54 12.5005C15.6823 12.7387 15.7501 13.0274 15.7501 13.3125C15.7501 13.5976 15.6823 13.8863 15.54 14.1245C15.4036 14.3529 15.1342 14.625 14.7301 14.625C14.326 14.625 14.0566 14.3529 13.9201 14.1245C13.7778 13.8863 13.7101 13.5976 13.7101 13.3125C13.7101 13.0274 13.7778 12.7387 13.9201 12.5005ZM7.96016 12.5005C8.09658 12.2721 8.36599 12 8.7701 12C9.17421 12 9.44362 12.2721 9.58004 12.5005C9.72234 12.7387 9.79011 13.0274 9.79011 13.3125C9.79011 13.5976 9.72234 13.8863 9.58004 14.1245C9.44362 14.3529 9.17421 14.625 8.7701 14.625C8.36599 14.625 8.09658 14.3529 7.96016 14.1245C7.81786 13.8863 7.75009 13.5976 7.75009 13.3125C7.75009 13.0274 7.81786 12.7387 7.96016 12.5005Z"
                            fill="currentColor" />
                    </svg>
                    <span>我</span>
                </div>
            </nav>


        <div id="forum-post-detail-screen" class="screen">
            <!-- 1. 静态 Header -->
            <header class="app-header">
                <button class="back-btn" data-target="forum-screen">‹</button>
                <div class="title-container">
                    <h1 class="title">详 情</h1>
                </div>
                <div class="action-btn-group">
                    <!-- 新增：收藏星标 -->
                    <button class="action-btn" id="d-delete-btn" style="cursor: pointer;">
                        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path
                                d="M19 7L18.1327 19.1425C18.0579 20.1891 17.187 21 16.1378 21H7.86224C6.81296 21 5.94208 20.1891 5.86732 19.1425L5 7M10 11V17M14 11V17M15 7V4C15 3.44772 14.5523 3 14 3H10C9.44772 3 9 3.44772 9 4V7M4 7H20"
                                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                        </svg>
                    </button>
                    <!-- 原有的分享按钮 -->
                    <!-- 原有的 AI 按钮 -->
                    <button class="action-btn" id="detail-ai-btn" title="AI生成评论">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                            <path
                                d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z">
                            </path>
                        </svg>
                    </button>
                </div>
            </header>

            <!-- 2. 静态 Main (内容滚动区) -->
            <main class="content" id="detail-content-area">
                <!-- 帖子主体容器 -->
                <div class="post-detail-container">
                    <div class="post-detail-main">
                        <!-- 新增：复制按钮 -->
                        <button class="post-copy-btn" id="d-copy-btn" title="复制标题和正文">
                            <svg viewBox="0 0 24 24">
                                <path
                                    d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z" />
                            </svg>
                        </button>
                        <div class="post-author-info">
                            <div id="d-author-avatar" class="author-avatar">?</div>
                            <div class="author-details">
                                <span id="d-author-name" class="author-name">加载中...</span>
                                <span id="d-post-time" class="post-meta-data">...</span>
                            </div>
                        </div>
                        <h2 id="d-post-title" class="post-detail-title">...</h2>
                        <div id="d-post-content" class="post-detail-content-body">...</div>

                        <!-- 操作栏：赞和删除 -->
                        <!-- 操作栏：删除、阅读、评论 -->
                        <!-- 找到 post-detail-actions 区域 -->
                        <div class="post-detail-actions">
                            <!-- 【修改】阅读/在看 按钮 -->
                            <!-- 给外层 div 加 id="detail-watching-btn" -->
                            <div class="action-item" id="detail-watching-btn" style="cursor: pointer;">
                                <!-- Eye Icon -->
                                <svg viewBox="0 0 24 24">
                                    <path
                                        d="M12,9A3,3 0 0,0 9,12A3,3 0 0,0 12,15A3,3 0 0,0 15,12A3,3 0 0,0 12,9M12,17A5,5 0 0,1 7,12A5,5 0 0,1 12,7A5,5 0 0,1 17,12A5,5 0 0,1 12,17M12,4.5C7,4.5 2.73,7.61 1,12C2.73,16.39 7,19.5 12,19.5C17,19.5 21.27,16.39 23,12C21.27,7.61 17,4.5 12,4.5Z" />
                                </svg>
                                <!-- span ID 保持不变，JS 会修改内容 -->
                                <span id="d-like-count">0</span>
                            </div>

                            <!-- ... 其他按钮保持不变 ... -->

                            <div class="action-item" id="detail-star-btn" title="收藏" style="cursor: pointer;">
                                <svg viewBox="0 0 24 24">
                                    <path
                                        d="M12,17.27L18.18,21L16.54,13.97L22,9.24L14.81,8.62L12,2L9.19,8.62L2,9.24L7.45,13.97L5.82,21L12,17.27Z" />
                                </svg>
                                <span>收藏</span>
                            </div>

                            <div class="action-item" id="detail-share-btn" title="分享" style="cursor: pointer;">
                                <svg viewBox="0 0 24 24" fill="currentColor">
                                    <path
                                        d="M18,16.08C17.24,16.08 16.56,16.38 16.04,16.85L8.91,12.7C8.96,12.47 9,12.24 9,12C9,11.76 8.96,11.53 8.91,11.3L16.04,7.15C16.56,7.62 17.24,7.92 18,7.92C19.66,7.92 21,6.58 21,5C21,3.42 19.66,2 18,2C16.34,2 15,3.42 15,5C15,5.24 15.04,5.47 15.09,5.7L7.96,9.85C7.44,9.38 6.76,9.08 6,9.08C4.34,9.08 3,10.42 3,12C3,13.58 4.34,14.92 6,14.92C6.76,14.92 7.44,14.62 7.96,14.15L15.09,18.3C15.04,18.53 15,18.76 15,19C15,20.58 16.34,22 18,22C19.66,22 21,20.58 21,19C21,17.42 19.66,16.08 18,16.08Z">
                                    </path>
                                </svg>
                                <span>分享</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 评论列表容器 -->
                <div class="comments-section">
                    <div class="comments-header">全部评论</div>
                    <ul class="comment-list" id="detail-comment-list">
                        <!-- JS 将在这里插入 li -->
                    </ul>
                </div>
            </main>


            <!-- 3. 静态 Footer (固定回复栏) -->
            <div class="detail-reply-bar">
                <!-- 替换为复选框容器 -->
                <!-- 在 .detail-reply-bar 内部 -->
                <div id="reply-anon-trigger" class="reply-anon-wrapper custom-check-item">
                    <!-- 真实的 checkbox 隐藏 -->
                    <input type="checkbox" id="reply-is-anon" class="hidden-checkbox">
                    <label style="font-size: 14px; color: #666; cursor: pointer; pointer-events: none;">匿名</label>
                </div>

                <input type="text" id="reply-content-input" class="reply-bar-input" placeholder="输入评论...">
                <button id="submit-reply-btn" class="reply-bar-btn">
                    <svg viewBox="0 0 24 24">
                        <path d="M2,21L23,12L2,3V10L17,12L2,14V21Z" />
                    </svg>
                </button>
            </div>
        </div>

       
    <!-- RPG游戏页面 -->
<!-- ================= RPG 模块开始 ================= -->

<!-- 1. 标题封面页 -->
<div id="rpg-title-screen" class="screen rpg-centered-col">
    <!-- 复用 App Header，绝对定位透明背景 -->
    <header class="app-header rpg-header-absolute">
        <button class="back-btn" data-target="home-screen">‹</button>
    </header>

    <h1 class="rpg-main-title">永恒传说</h1>
    <div class="rpg-sub-title">Eternal Legend</div>

    <div class="rpg-menu-container">
        <button class="btn btn-primary" id="rpg-new-game-btn">新游戏</button>
        <button class="btn btn-primary" id="rpg-load-game-btn">读取存档</button>
        <button class="btn btn-danger" id="rpg-exit-game-btn">退出游戏</button>
    </div>
    <p class="rpg-version-text">Ver.半成品</p>
</div>

<!-- 【✪开始】HTML: 角色创建页 (3x3布局 + 2:1分割) -->
<div id="rpg-create-screen" class="screen">
    <header class="app-header">
        <button class="back-btn" data-target="rpg-title-screen">‹</button>
        <div class="title-container">
            <h1 class="title">创建角色</h1>
        </div>
        <div class="placeholder"></div>
    </header>

    <div class="rpg-scroll-col">
        
        <!-- ================= P1: 勇者 ================= -->
        <div class="rpg-char-card">
            <div class="rpg-char-card-header" >
                <h3>勇者 (你)</h3>
            </div>
            <input type="hidden" id="p1-persona-hidden" value="">
            
            <!-- 名称行 -->
            <div class="name-row">
                <div class="form-group">
                    <label>角色名称</label>
                    <input type="text" id="p1-name-input" value="勇者">
                </div>
                <button class="btn btn-neutral" id="rpg-load-user-btn">读取我的人设</button>
            </div>

            <!-- 下方分栏 2:1 -->
            <div class="split-layout">
                <!-- 左侧：3x3 网格 -->
                <div class="split-left char-custom-grid">
                    <!-- 第一行：颜色1 -->
                    <div class="form-group"><label>头发</label><input type="color" id="p1-color-hair" value="#917C66" class="preview-trigger-p1 input-color-preview"></div>
                    <div class="form-group"><label>眼睛</label><input type="color" id="p1-color-eye" value="#D7CAFF" class="preview-trigger-p1 input-color-preview"></div>
                    <div class="form-group"><label>皮肤</label><input type="color" id="p1-color-skin" value="#FFE4CF" class="preview-trigger-p1 input-color-preview"></div>
                    
                    <!-- 第二行：颜色2 -->
                    <div class="form-group"><label>上衣</label><input type="color" id="p1-color-top" value="#3498db" class="preview-trigger-p1 input-color-preview"></div>
                    <div class="form-group"><label>下装</label><input type="color" id="p1-color-bottom" value="#2c3e50" class="preview-trigger-p1 input-color-preview"></div>
                    <div class="form-group"><label>鞋子</label><input type="color" id="p1-color-shoe" value="#101018" class="preview-trigger-p1 input-color-preview"></div>

                    <!-- 第三行：样式 -->
                    <div class="form-group"><label>刘海</label><select id="p1-style-bangs" class="preview-trigger-p1"><option value="0">分</option><option value="1" selected>碎</option><option value="2">齐</option></select></div>
                    <div class="form-group"><label>后发</label><select id="p1-style-back" class="preview-trigger-p1"><option value="0">短</option><option value="1">中</option><option value="2">长</option></select></div>
                    <div class="form-group"><label>下装型</label><select id="p1-style-bottom" class="preview-trigger-p1"><option value="0">裤</option><option value="1">裙</option></select></div>
                </div>

                <!-- 右侧：预览 (48px宽) -->
                <div class="split-right">
                    <canvas id="p1-preview-canvas" class="pixel-preview-canvas preview-canvas-large"></canvas>
                    <div style="font-size:12px; color:#aaa; margin-top:5px;">预览</div>
                </div>
            </div>
        </div>

        <!-- 按钮区 -->
                <!-- 新增：世界书绑定区域 -->

    <button class="btn btn-secondary" id="rpg-select-wb-btn">绑定世界书 (可选)
    </button>

       
            <button class="btn btn-secondary" id="rpg-choose-partner-btn">+ 选择共同冒险伙伴</button>
            
       

        <!-- ================= P2: 伙伴 (初始隐藏) ================= -->
        <div class="rpg-char-card" id="rpg-partner-card" style="display: none; ">
            <div class="rpg-char-card-header">
                <h3>伙伴</h3>
            </div>
            <input type="hidden" id="p2-persona-hidden" value="">

            <div class="name-row">
                <div class="form-group">
                    <label>角色名称</label>
                    <input type="text" id="p2-name-input" value="伙伴">
                </div>
                <button class="btn btn-neutral" id="rpg-ai-init-btn">✨ 冒险初始化</button>
            </div>

            <!-- 伙伴设置内容容器 (初始化前隐藏) -->
            <div id="rpg-partner-settings-container" style="display:none;">
                <div class="split-layout">
                    <div class="split-left char-custom-grid">
                        <!-- P2 第一行 -->
                        <div class="form-group"><label>头发</label><input type="color" id="p2-color-hair" value="#917C66" class="preview-trigger-p2 input-color-preview"></div>
                        <div class="form-group"><label>眼睛</label><input type="color" id="p2-color-eye" value="#ADADAD" class="preview-trigger-p2 input-color-preview"></div>
                        <div class="form-group"><label>皮肤</label><input type="color" id="p2-color-skin" value="#FFE4CF" class="preview-trigger-p2 input-color-preview"></div>
                        
                        <!-- P2 第二行 -->
                        <div class="form-group"><label>上衣</label><input type="color" id="p2-color-top" value="#2ecc71" class="preview-trigger-p2 input-color-preview"></div>
                        <div class="form-group"><label>下装</label><input type="color" id="p2-color-bottom" value="#2c3e50" class="preview-trigger-p2 input-color-preview"></div>
                        <div class="form-group"><label>鞋子</label><input type="color" id="p2-color-shoe" value="#101018" class="preview-trigger-p2 input-color-preview"></div>

                        <!-- P2 第三行 -->
                        <div class="form-group"><label>刘海</label><select id="p2-style-bangs" class="preview-trigger-p2"><option value="0">分</option><option value="1">M</option><option value="2" selected>齐</option></select></div>
                        <div class="form-group"><label>后发</label><select id="p2-style-back" class="preview-trigger-p2"><option value="0">短</option><option value="1">中</option><option value="2" selected>长</option></select></div>
                        <div class="form-group"><label>下装型</label><select id="p2-style-bottom" class="preview-trigger-p2"><option value="0">裤</option><option value="1">裙</option></select></div>
                    </div>

                    <div class="split-right">
                        <canvas id="p2-preview-canvas" width="64" height="64" class="pixel-preview-canvas preview-canvas-large"></canvas>
                        <div style="font-size:12px; color:#aaa; margin-top:5px;">预览</div>
                    </div>
                </div>
            </div>
            <!-- 初始化提示 -->
            <div id="rpg-partner-wait-msg" class="text-center" style="padding: 20px; color:#aaa; font-size:13px; border:1px dashed #ddd; border-radius:8px; margin-top:10px;">
                请点击上方“✨ 冒险初始化”以生成伙伴形象
            </div>
        </div>

        <div id="fill-rate-val" class="text-center" style="font-size:12px; color:#aaa; margin-bottom:5px;"></div>
        <button class="btn btn-primary" id="rpg-start-adventure-btn">开始冒险</button>
    </div>
</div>

<!-- 【新增】档案选择/管理页 -->
<div id="rpg-profile-screen" class="screen">
    <header class="app-header">
        <button class="back-btn" id="rpg-profile-back-btn">‹</button>
        <div class="title-container">
            <h1 class="title">冒险档案</h1>
        </div>
        <div class="placeholder"></div>
    </header>
    <div class="rpg-scroll-col" id="rpg-profile-list-container" style="padding-top: 10px;">
        <!-- JS 动态生成档案列表 -->
    </div>
</div>
<!-- 3. 存档读取页 -->
<div id="rpg-load-screen" class="screen" >
    <header class="app-header">
        <button class="back-btn" id="rpg-save-back-btn">‹</button>
        <div class="title-container">
            <h1 class="title">读取存档</h1>
        </div>
        <div class="placeholder"></div>
    </header>
    <div class="rpg-scroll-col" id="rpg-save-list-container" style="padding-top: 0;">
        <!-- 存档插槽将由 JS 动态生成 -->
        <div class="rpg-save-slot empty">没有存档</div>
    </div>
</div>


<!-- 4. 游戏主界面 (修复结构版) -->
<div id="rpg-game-screen" class="screen rpg-screen-base">
    <div class="app-header">
        <button class="back-btn" id="rpg-back-to-title-btn">‹</button>
        <div class="title-container">
            <h1 class="title" id="rpg-header-title">加载中...</h1>
        </div>
        <button class="action-btn" id="rpg-menu-toggle-btn">
            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"></path></svg>
        </button>
    </div>

    <div class="rpg-canvas-container">
        <canvas id="rpgGameCanvas" width="320" height="320"></canvas>
        
        <!-- UI 覆盖层 -->
        <div id="rpg-ui-layer">
            <!-- 顶部提示 -->
            <div id="rpg-top-dialog">获得 10 金币!</div>
            
            <!-- 底部对话框 -->
            <div id="rpg-bottom-dialog">
                <div id="rpg-dialog-name">勇者</div>
                <div id="rpg-dialog-text">这里看起来很危险...</div>
                <div id="rpg-dialog-next">▼</div>
            </div>

            <!-- 战斗操作面板 (右侧) -->
            <div id="rpg-battle-menu">
                <button class="rpg-battle-btn" data-action="attack">攻击</button>
                <button class="rpg-battle-btn" data-action="heal">治疗</button>
                <button class="rpg-battle-btn" id="rpg-battle-bag-btn">背包</button>
                <button class="rpg-auto-btn" id="rpg-start-auto-btn">自动</button>
                
            </div>
<button class="rpg-auto-btn" id="rpg-auto-battle-btn" style="display:none;">停止自动</button>
            <!-- 战斗目标/确认面板 (底部右侧) -->
            <div id="rpg-battle-target-panel">
                <div class="rpg-battle-row">
                    <div class="rpg-ctrl-btn rpg-btn-confirm" data-key="confirm">确定</div>
                </div>
                <div class="rpg-battle-row">
                    <div class="rpg-ctrl-btn rpg-btn-cancel" data-key="cancel">取消</div>
                </div>
                <div class="rpg-battle-row">
                    <div class="rpg-ctrl-btn rpg-btn-arrow" data-key="left">◀</div>
                    <div class="rpg-ctrl-btn rpg-btn-arrow" data-key="right">▶</div>
                </div>
            </div>
            
            <!-- 移动控制 (左下角) - 建议放在 UI 层内以便统一管理层级，或保持在 Canvas 容器内 -->
            <div id="rpg-controls">
                <div class="rpg-d-pad">
                    <div class="rpg-d-key rpg-up" data-key="ArrowUp">▲</div>
                    <div class="rpg-d-key rpg-left" data-key="ArrowLeft">◀</div>
                    <div class="rpg-d-key rpg-right" data-key="ArrowRight">▶</div>
                    <div class="rpg-d-key rpg-down" data-key="ArrowDown">▼</div>
                </div>
            </div>

    
        </div> <!-- 结束 rpg-ui-layer -->


         <button id="rpg-interact-btn">🖐️</button>

        <!-- Game Over 遮罩 -->
        <div id="rpg-game-over-screen">
            <h1>胜败乃兵家常事</h1>
            <button class="btn btn-primary" id="rpg-respawn-btn" style="width: 200px;">读档重来</button>
            <button class="btn btn-neutral" id="rpg-give-up-btn" style="width: 200px; margin-top: 15px;">放弃治疗</button>
        </div>
    </div> <!-- 结束 rpg-canvas-container -->
</div> <!-- 结束 rpg-game-screen -->

<!-- 【新增】状态详情/修改页 (优化布局版) -->
<div id="rpg-status-screen" class="screen">
    <header class="app-header">
        <button class="back-btn" id="rpg-status-back-btn">‹</button>
        <div class="title-container">
            <h1 class="title">队伍状态</h1>
        </div>
        <div class="placeholder"></div>
    </header>

    <div class="rpg-scroll-col">
        <!-- P1 状态卡片 -->
        <div class="rpg-char-card">
            <div class="rpg-char-card-header">
                <!-- 标题现在包含等级 -->
                <h3>勇者（ <span class="lv-badge">LV.<span id="status-p1-lv">1</span></span> ）</h3>
            </div>
            <div class="split-layout">
                <div class="split-left">
                    <div class="form-group">
                        <label>冒险名</label>
                        <input type="text" id="status-p1-name" class="rpg-input-compact">
                    </div>
                    <!-- 属性列表：垂直排列 -->
                    <div class="rpg-stats-list">
                        <div class="stat-row">
                            <span class="stat-label">HP</span>
                            <span class="stat-val hp-text" id="status-p1-hp">100/100</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">MP</span>
                            <span class="stat-val mp-text" id="status-p1-mp">50/50</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">攻击力</span>
                            <span class="stat-val" id="status-p1-atk">20</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">经验值</span>
                            <span class="stat-val xp-text" id="status-p1-xp">0/100</span>
                        </div>
                    </div>
                </div>
                <div class="split-right">
                    <canvas id="status-p1-canvas" class="pixel-preview-canvas preview-canvas-large"></canvas>
                </div>
            </div>
        </div>

        <!-- P2 状态卡片 -->
        <div class="rpg-char-card">
            <div class="rpg-char-card-header">
                <h3>伙伴（ <span class="lv-badge">LV.<span id="status-p2-lv">1</span></span> ）</h3>
                <div class="char-reinit"><button class="btn btn-secondary" id="rpg-char-reinit-btn">更新战斗台词</button></div>
            </div>
            <div class="split-layout">
                <div class="split-left">
                    <div class="form-group">
                        <label>冒险名</label>
                        <input type="text" id="status-p2-name" class="rpg-input-compact">
                    </div>
                    <!-- 属性列表：垂直排列 -->
                    <div class="rpg-stats-list">
                        <div class="stat-row">
                            <span class="stat-label">HP</span>
                            <span class="stat-val hp-text" id="status-p2-hp">100/100</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">MP</span>
                            <span class="stat-val mp-text" id="status-p2-mp">50/50</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">攻击力</span>
                            <span class="stat-val" id="status-p2-atk">20</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">经验值</span>
                            <span class="stat-val xp-text" id="status-p2-xp">0/100</span>
                        </div>
                    </div>
                </div>
                <div class="split-right">
                    <canvas id="status-p2-canvas" class="pixel-preview-canvas preview-canvas-large"></canvas>
                </div>
            </div>
        </div>

        <!-- 底部按钮区 -->
        <div class="rpg-status-actions">
            <button class="btn btn-secondary" id="rpg-status-wb-btn">修改世界书绑定</button>
            <button class="btn btn-primary" id="rpg-status-save-btn">保存修改（建议保存后存档）</button>
        </div>
        <div style="height: 40px;"></div> <!-- 底部留白 -->
    </div>
</div>

<!-- 【新增】暂停页面 (标准 Screen 结构) -->
<div id="rpg-pause-screen" class="screen">
    <header class="app-header">
        <!-- 这里的返回键充当“继续游戏”的功能 -->
        <button class="back-btn" id="rpg-pause-back-btn">‹</button>
        <div class="title-container">
            <h1 class="title">暂停</h1>
        </div>
        <div class="placeholder"></div> <!-- 占位符，保持标题居中 -->
    </header>

    <main class="content">
        
        
        <button class="btn btn-primary" id="rpg-menu-save-btn">保存进度</button>
        <button class="btn btn-primary" id="rpg-menu-load-btn">读取进度</button>
        <button class="btn btn-primary" id="rpg-menu-bag-btn">查看背包</button>
        <button class="btn btn-primary" id="rpg-menu-status-btn">角色状态</button>
        <button class="btn btn-danger" id="rpg-menu-quit-btn">返回标题</button>
    </main>
</div>




<!-- 【新增HTML】在 </body> 前添加传送黑屏 -->
<div id="rpg-teleport-screen" class="rpg-teleport-screen">
    <div class="rpg-teleport-particles" id="rpg-teleport-particles"></div>
    <div class="rpg-teleport-text">
        正在传送进入新世界<span class="rpg-teleport-dots" id="rpg-teleport-dots">...</span>
    </div>
</div>


 <!-- 番茄钟页面 -->           
        <div id="pomodoro-screen" class="screen">
            <header class="app-header">
                <button class="back-btn" data-target="home-screen">‹</button>
                <div class="title-container">
                    <h1 class="title">专注任务</h1>
                </div>
                <div class="action-btn-group">
                    <button class="action-btn" id="pomodoro-settings-btn" title="设置">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="22"
                            height="22">
                            <path
                                d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.44,0.17-0.48,0.41L9.2,5.77C8.61,6.01,8.08,6.33,7.58,6.71L5.19,5.75C4.97,5.68,4.72,5.75,4.6,5.97L2.68,9.29 c-0.11,0.2-0.06,0.47,0.12,0.61l2.03,1.58C4.78,11.66,4.76,11.97,4.76,12.3c0,0.32,0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.04,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.48-0.41l0.36-2.54c0.59-0.24,1.12-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0.01,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z" />
                        </svg>
                    </button>
                    <button class="action-btn" id="pomodoro-create-task-btn" title="创建任务">+</button>
                </div>
            </header>
            <main class="content">
                <div class="task-list-container" id="pomodoro-task-list">
                    <!-- Task cards will be rendered here by JS -->
                </div>
                <p class="placeholder-text" id="pomodoro-no-tasks-placeholder">还没有专注任务，点击右上角“+”创建一个吧。</p>
            </main>
        </div>
        <!-- Pomodoro Focus Screen -->
        <div id="pomodoro-focus-screen" class="screen">
            <header class="app-header">
                <button class="back-btn" data-target="pomodoro-screen">‹</button>
                <div class="title-container">
                    <h1 class="title">专注中</h1>
                </div>
                <div class="action-btn-group">
                    <button class="action-btn" id="pomodoro-focus-settings-btn" title="设置">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="22"
                            height="22">
                            <path
                                d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.44,0.17-0.48,0.41L9.2,5.77C8.61,6.01,8.08,6.33,7.58,6.71L5.19,5.75C4.97,5.68,4.72,5.75,4.6,5.97L2.68,9.29 c-0.11,0.2-0.06,0.47,0.12,0.61l2.03,1.58C4.78,11.66,4.76,11.97,4.76,12.3c0,0.32,0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.04,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.48-0.41l0.36-2.54c0.59-0.24,1.12-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0.01,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z" />
                        </svg>
                    </button>
                </div>
            </header>
            <main class="content">
                <div class="focus-timer-container">
                    <h2 class="focus-task-title">阅读一章《JavaScript高级程序设计》</h2>
                    <div class="focus-timer-display">24:32</div>
                    <div class="focus-timer-mode">倒计时</div>
                    <div class="focus-total-time" id="pomodoro-total-focused-time">已专注 0 分钟</div>
                </div>

                <div class="focus-footer">
                    <div class="focus-message-bubble">
                        <p>保持专注，你做得很好！</p>
                    </div>
                    <div class="focus-bottom-controls">
                        <div class="focus-controls-group">
                            <button class="control-btn" id="pomodoro-start-btn" title="开始">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"
                                    stroke="currentColor" stroke-width="0">
                                    <polygon points="5 3 19 12 5 21 5 3"></polygon>
                                </svg>
                            </button>
                            <button class="control-btn" id="pomodoro-pause-btn" title="暂停" style="display: none;">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"
                                    stroke="currentColor" stroke-width="1">
                                    <rect x="6" y="4" width="4" height="16"></rect>
                                    <rect x="14" y="4" width="4" height="16"></rect>
                                </svg>
                            </button>
                        </div>
                        <img src="https://i.postimg.cc/Y96LPskq/o-o-2.jpg" class="focus-avatar" alt="avatar">
                        <button class="control-btn" id="pomodoro-giveup-btn" title="放弃">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <line x1="18" y1="6" x2="6" y2="18"></line>
                                <line x1="6" y1="6" x2="18" y2="18"></line>
                            </svg>
                        </button>
                    </div>
                </div>
            </main>
        </div>

        <!-- Pomodoro Settings Sidebar -->
        <div id="pomodoro-settings-sidebar" class="settings-sidebar">
            <div class="header">专注设置</div>
            <div class="content">
                <form id="pomodoro-settings-form">
                    <div class="form-group">
                        <label for="pomodoro-char-select">绑定陪伴角色</label>
                        <select id="pomodoro-char-select" class="form-group"></select>
                    </div>
                    <div class="form-group">
                        <label for="pomodoro-user-persona-select">选择你的设定</label>
                        <select id="pomodoro-user-persona-select" class="form-group"></select>
                    </div>
                    <hr>
                    <div class="form-group">
                        <label for="pomodoro-encouragement-minutes">鼓励机制 (分钟)</label>
                        <input type="number" id="pomodoro-encouragement-minutes" class="form-group"
                            placeholder="专注多少分钟后收到鼓励" min="1">
                    </div>
                    <div class="form-group">
                        <label for="pomodoro-poke-limit">“戳一戳”次数上限</label>
                        <input type="number" id="pomodoro-poke-limit" class="form-group" placeholder="每次专注允许戳几次"
                            min="0">
                    </div>
                    <hr>
                    <div class="form-group">
                        <label for="pomodoro-focus-bg-url">专注界面背景 URL</label>
                        <input type="url" id="pomodoro-focus-bg-url" class="form-group" placeholder="粘贴图片URL">
                    </div>
                    <div class="form-group">
                        <label for="pomodoro-focus-bg-upload" class="btn btn-secondary">或从本地上传</label>
                        <input type="file" id="pomodoro-focus-bg-upload" accept="image/*" style="display:none;">
                    </div>
                    <hr>
                    <div class="form-group">
                        <label for="pomodoro-task-card-bg-url">任务卡片背景 URL</label>
                        <input type="url" id="pomodoro-task-card-bg-url" class="form-group" placeholder="粘贴图片URL">
                    </div>
                    <div class="form-group">
                        <label for="pomodoro-task-card-bg-upload" class="btn btn-secondary">或从本地上传</label>
                        <input type="file" id="pomodoro-task-card-bg-upload" accept="image/*" style="display:none;">
                    </div>
                    <button type="submit" class="btn btn-primary" style="margin-top: 20px;">保存设置</button>
                </form>
            </div>
        </div>

        <!-- Pomodoro Global Settings Sidebar -->
        <div id="pomodoro-global-settings-sidebar" class="settings-sidebar">
            <div class="header">全局专注设置</div>
            <div class="content">
                <form id="pomodoro-global-settings-form">
                    <div class="form-group">
                        <button type="button" class="btn btn-secondary"
                            id="link-global-pomodoro-world-book-btn">关联世界书</button>
                    </div>
                    <p style="font-size: 12px; color: #888; margin-top: 15px;">
                        这里关联的世界书将作为全局上下文，作用于所有番茄钟任务的AI互动。
                    </p>
                </form>
            </div>
        </div>


<!-- === 全局通用系统弹窗 (复用现有组件样式) === -->
<div id="app-global-dialog" class="modal-overlay">
    <div class="modal-window">
        <!-- 标题复用 h3 -->
        <h3 id="global-dialog-title">提示</h3>
        
        <!-- 内容区域 -->
        <div class="dialog-content" id="global-dialog-content"></div>
        
        <!-- 输入框容器 (复用 form-group) -->
        <div id="global-dialog-input-container" class="form-group">
            <input type="text" id="global-dialog-input" autocomplete="off">
        </div>
        
        <!-- 按钮区域 (Flex布局让按钮并排) -->
        <div class="btn-group" id="global-dialog-actions">
            <!-- 按钮由 JS 动态生成，会应用 .btn 类 -->
        </div>
    </div>
</div>

    <!-- 聊天弹窗 -->
<!-- 修改后的编辑弹窗 HTML -->
<div id="message-edit-modal" class="modal-overlay">
    <div class="modal-window">
        <h3>编辑消息</h3>
        <form id="message-edit-form">
            <!-- 新增：类型选择下拉框 -->
            <div id="message-edit-select" class="form-group">
                <label for="message-edit-type">消息类型</label>
                <select id="message-edit-type" class="form-control">
                    <option value="text">普通对话</option>
                    <option value="display">用户剧情旁白</option>
                    <option value="narration">线下模式旁白</option>
                </select>
            </div>

            <div class="form-group">
                <textarea id="message-edit-textarea" rows="4" required></textarea>
            </div>
            <div class="btn-group">
                <button type="submit" class="btn btn-primary">保存</button>
                <button type="button" id="cancel-edit-modal-btn" class="btn btn-neutral">取消</button>
            </div>
        </form>
    </div>
</div>

<!-- START OF FILE 聊天界面3.txt (局部更新) -->

<!-- 新建角色弹窗 -->
<div id="add-char-modal" class="modal-overlay">
    <div class="modal-window">
        <h3>创建新角色</h3>
        <form id="add-char-form">
            <!-- 角色信息 (保持不变) -->

                <div class="form-group">
                    <label for="char-real-name">角色姓名</label>
                    <input type="text" id="char-real-name" placeholder="真实姓名" required>
                </div>
                <div class="form-group">
                    <label for="char-remark-name">角色昵称</label>
                    <input type="text" id="char-remark-name" placeholder="聊天顶部显示的名称" required>
                </div>

            

            
            <!-- 我的信息 (修改部分) -->
            <input type="hidden" id="selected-persona-id" value="">
            
            <div class="form-group" >
                <!-- 修改：使用 form-header-row 将 Label 和 按钮 并排 -->
                                <div class="form-header-row">
                    <label for="my-name-for-char";">我的姓名</label>
                    
      <button type="button" class="btn btn-primary" id="add-chat-select-persona-btn">选择人设</button>
                     </div>         
                <!-- 输入框单独一行，恢复全宽 -->
                <input type="text" id="my-name-for-char" placeholder="你在设定中的姓名" required>
            </div>
            
            <div class="form-group">

                <label for="my-nickname-for-char">我的昵称</label>
                
                <input type="text" id="my-nickname-for-char" placeholder="你在聊天中的昵称" required>
            </div>
            
            <!-- 隐藏的人设区域 -->
            <div class="form-group" style="display:none;">
                <label for="my-persona-for-char">我的人设</label>
                <textarea id="my-persona-for-char" rows="2"></textarea>
            </div>

            <button type="submit" class="btn btn-primary" style="margin-top:15px;">创建开始</button>
        </form>
    </div>
</div>

<!-- 编辑/新建 用户档案弹窗 (修改结构) -->
<div id="user-persona-modal" class="modal-overlay">
    <div class="modal-window">
        <h3 id="user-persona-modal-title">编辑我的档案</h3>
        <form id="user-persona-form">
            <!-- 头像行 -->
            <div class="avatar-setting sidebar-avatar-container">
                <img src="" id="user-persona-avatar-preview" class="avatar-preview" style="width:60px;height:60px;border-radius:50%;">
                <input type="file" id="user-persona-avatar-upload" accept="image/*" style="display:none;">
                <label for="user-persona-avatar-upload" class="btn btn-primary" style="flex:1;">
                    上传新头像
                </label>
            </div>

            <!-- 并排输入 -->
            <div class="modal-row-inputs">
                <div class="form-group">
                    <label>姓名 (设定用)</label>
                    <input type="text" id="user-persona-realname" required>
                </div>
                <div class="form-group">
                    <label>昵称 (显示用)</label>
                    <input type="text" id="user-persona-nickname" required>
                </div>
            </div>

            <div class="form-group">
                <label>人设描述</label>
                <textarea id="user-persona-desc" rows="5" placeholder="详细描述身份背景..."></textarea>
            </div>

            <!-- 按钮组 -->
            <div class="modal-footer-actions">
                <button type="submit" class="btn btn-primary">保存</button>
                <button type="button" class="btn btn-secondary" id="user-persona-cancel-btn">取消</button>
            </div>
        </form>
    </div>
</div>

<!-- 选择用户档案弹窗 (用于绑定) -->
<div id="select-persona-modal" class="modal-overlay">
    <div class="modal-window">
        <h3>选择身份</h3>
        <ul id="select-persona-list" class="list-container" style="max-height: 300px; overflow-y: auto;">
            <!-- 动态生成 -->
        </ul>
        <button class="btn btn-secondary" id="close-select-persona-btn" style="margin-top:15px; width:100%">取消</button>
    </div>
</div>


        <div id="world-book-selection-modal" class="modal-overlay">
            <div class="modal-window">
                <h3>选择要关联的世界书</h3>
                <ul id="world-book-selection-list"></ul>
                <button class="btn btn-primary" id="save-world-book-selection-btn" style="margin-top: 20px;">确认</button>
            </div>
        </div>
 
            <!-- 关联表情包选择弹窗 -->
            <div id="link-sticker-modal" class="modal-overlay">
                <div class="modal-window">
                    <h3>从库中勾选要关联的表情</h3>
                    <div id="link-sticker-bar">
                    <button type="button" class="btn btn-secondary" id="link-sticker-select-all-btn">全选</button>
                    <div id="link-sticker-category-bar"></div>
                    </div>
                    <div class="sticker-grid" id="link-sticker-grid"></div>
                    <div class="btn-group">
                        <button type="button" class="btn btn-primary" id="confirm-link-sticker-btn">确认关联</button>         
                        <button type="button" class="btn btn-neutral" id="cancel-link-sticker-btn">取消</button>
                    </div>
                </div>
            </div>

            <!-- 新增：分类长按管理菜单 -->
            <div id="category-actionsheet" class="action-sheet-overlay">
                <div class="action-sheet">
                    <button class="action-sheet-button" id="rename-category-btn">重命名分类</button>
                    <button class="action-sheet-button" id="link-category-btn">一键关联到本角色</button>
                    <button class="action-sheet-button danger" id="delete-category-btn">删除整个分类及内容</button>
                </div>
            </div>
            
            <!-- 添加单张表情 -->
            <div id="add-sticker-modal" class="modal-overlay">
                <div class="modal-window">
                    <h3 id="add-sticker-modal-title">添加新表情</h3>
                    <form id="add-sticker-form">
                        <div class="sticker-detail">
                        <input type="hidden" id="sticker-edit-id">
                        <div id="sticker-preview"><span>预览</span></div>
  
                        <div class="form-group">
                        <!-- 新增分类输入框，附带 datalist 用于下拉提示 -->
                        
                            <label for="sticker-category-input">所属分类</label>
                            <input type="text" id="sticker-category-input" placeholder="留空则为'默认'" list="category-datalist">
                            <datalist id="category-datalist"></datalist>
                        </div>
                        </div>
                        <div class="form-group">
                            <label for="sticker-name">表情名称</label>
                            <input type="text" id="sticker-name" placeholder="如：开心" required>
                        </div>

  
                        <div class="form-group">
                            <label for="sticker-url-input">表情URL</label>
                            <input type="url" id="sticker-url-input" placeholder="粘贴图片URL">
                        </div>
                        <p style="text-align:center; color:#888; margin: -5px 0 10px;">或</p>
                        <input type="file" id="sticker-file-upload" accept="image/*" style="display:none;">
                        <label for="sticker-file-upload" class="btn btn-secondary" style="width:100%; margin-bottom: 20px;">从本地上传</label>
                        <button type="submit" class="btn btn-primary">保存</button>
                    </form>
                </div>
            </div>

            <div id="sticker-actionsheet" class="action-sheet-overlay">
                <div class="action-sheet">
                    <button class="action-sheet-button" id="edit-sticker-btn">编辑</button>
                    <button class="action-sheet-button danger" id="delete-sticker-btn">彻底删除</button>
                </div>
            </div>

            <!-- 批量导入表情 -->
            <div id="batch-add-sticker-modal" class="modal-overlay">
                <div class="modal-window">
                    <h3>批量导入表情</h3>
                    <form id="batch-add-sticker-form">
                        <!-- 新增批量导入时的分类选择 -->
                        <div class="form-group">
                            <label for="batch-category-input">导入到分类</label>
                            <input type="text" id="batch-category-input" placeholder="留空则为'默认'" list="category-datalist">
                        </div>
                        <div class="form-group">
                            <label for="sticker-urls-textarea">数据格式：名称:URL (英文冒号，每行一个)</label>
                            <textarea id="sticker-urls-textarea" rows="8" placeholder="例如：&#10;开心:https://example.com/happy.gif&#10;哭泣:https://example.com/cry.png"></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary">开始导入</button>
                    </form>
                </div>
            </div>
            
        <div id="send-voice-modal" class="modal-overlay">
            <div class="modal-window">
                <h3>发送语音消息</h3>
                <form id="send-voice-form">
                    <div class="form-group">
                        <label for="voice-text-input">输入语音文字</label>
                        <textarea id="voice-text-input" placeholder="在这里输入你想说的话..." required rows="4"></textarea>
                    </div>
                    <div class="form-group" style="text-align:center; color:#888; font-size: 14px;">
                        预计时长: <span id="voice-duration-preview">0"</span>
                    </div>
                    <button type="submit" class="btn btn-primary">发送</button>
                </form>
            </div>
        </div>
        <div id="send-pv-modal" class="modal-overlay">
            <div class="modal-window">
                <h3>分享照片/视频</h3>
                <form id="send-pv-form">
                    <div class="form-group">
                        <label for="pv-text-input">输入描述</label>
                        <textarea id="pv-text-input" placeholder="在这里描述你的照片或视频内容..." required rows="4"></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">发送</button>
                </form>
            </div>
        </div>
        <div id="send-transfer-modal" class="modal-overlay">
            <div class="modal-window">
                <h3>转账</h3>
                <form id="send-transfer-form">
                    <div class="form-group">
                        <label for="transfer-amount-input">金额 (元)</label>
                        <input type="number" id="transfer-amount-input" placeholder="0.00" required step="0.01"
                            min="0.01">
                    </div>
                    <div class="form-group">
                        <label for="transfer-remark-input">备注</label>
                        <input type="text" id="transfer-remark-input" placeholder="（选填）">
                    </div>
                    <button type="submit" class="btn btn-primary">发送</button>
                </form>
            </div>
        </div>
        <div id="send-gift-modal" class="modal-overlay">
            <div class="modal-window">
                <h3>送出礼物</h3>
                <form id="send-gift-form">
                    <div class="form-group">
                        <label for="gift-description-input">礼物描述</label>
                        <textarea id="gift-description-input" placeholder="告诉Ta你送了什么特别的东西..." required
                            rows="4"></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">发送</button>
                </form>
            </div>
        </div>
        <!-- NEW: Time Skip Modal -->
        <div id="time-skip-modal" class="modal-overlay">
            <div class="modal-window">
                <h3>剧情旁白</h3>
                <form id="time-skip-form">
                    <div class="form-group">
                        <label for="time-skip-input">事件描述（该消息AI可见，会作为上下文）</label>
                        <textarea id="time-skip-input" placeholder="例如：我们一起去山顶看了日落，然后吃了烧烤。" required
                            rows="4"></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">发送</button>
                </form>
            </div>
        </div>
        <!-- 线下模式设置弹窗 -->
        <div id="offline-mode-modal" class="modal-overlay">
            <div class="modal-window">
                <h3>线下模式设置</h3>
                <form id="offline-mode-form">
                    <div class="form-group"
                        style="display: flex; justify-content: space-between; align-items: center;margin-bottom: 5px;">
                        <label for="offline-mode-toggle" style="margin-bottom: 10px;">线下模式是否开启</label>
                        <label class="switch">
                            <input type="checkbox" id="offline-mode-toggle">
                            <span class="slider round"></span>
                        </label>
                    </div>
                    <div class="form-group">
                        <label for="offline-narration-css">行动气泡自定义CSS</label>
                        <textarea id="offline-narration-css"
                            placeholder=".narration-bubble { background: #f0f0f0; ... }"
                            style="height: 120px; font-family: monospace; font-size: 12px;"></textarea>
                        <p style="font-size: 12px; color: #888; margin-top: 5px;">针对 .narration-bubble 类进行样式修改。</p>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button type="button" class="btn btn-neutral" id="cancel-offline-mode-btn">取消</button>
                        <button type="submit" class="btn btn-primary">保存</button>
                    </div>
                </form>
            </div>
        </div>
        
 <!-- === 新增：搜索设置弹窗 === -->
<div id="search-config-modal" class="modal-overlay">
    <div class="modal-window">
        <h3>查找聊天记录</h3>
        <form id="search-config-form">
            <div class="form-group">
                <label>关键词</label>
                <input type="text" id="search-keyword-input" class="form-control" placeholder="输入对话内容...">
            </div>
            <div class="form-group">
                <label>日期筛选</label>
                <input type="date" id="search-date-input" class="form-control">
            </div>
            <p class="input-hint">* 日期和关键词至少填写一项</p>
            <div class="btn-group">
                <button type="submit" class="btn btn-primary">开始搜索</button>
                <button type="button" id="cancel-search-btn" class="btn btn-neutral">取消</button>
            </div>
        </form>
    </div>
</div>       
        <!-- NEW: Group Recipient Selection Modal -->
        <div id="group-recipient-selection-modal" class="modal-overlay">
            <div class="modal-window">
                <h3 id="group-recipient-selection-title">选择收件人</h3>
                <ul id="group-recipient-selection-list"></ul>
                <button class="btn btn-primary" id="confirm-group-recipient-btn" style="margin-top: 20px;">确认</button>
            </div>
        </div>
        <div id="receive-transfer-actionsheet" class="action-sheet-overlay">
            <div class="action-sheet">
                <button class="action-sheet-button" id="accept-transfer-btn">接收</button>
                <button class="action-sheet-button danger" id="return-transfer-btn">退回</button>
            </div>
        </div>

        <!-- 群聊弹窗 -->
        <!-- Group Chat Creation Modal -->
        <div id="create-group-modal" class="modal-overlay">
            <div class="modal-window">
                <h3>创建群聊</h3>
                <!-- 在 群聊.txt 中找到 id="create-group-modal" 的 div，替换整个 form 内容 -->
<form id="create-group-form">
    <div class="form-group">
        <label for="group-name-input">群聊名称</label>
        <input type="text" id="group-name-input" placeholder="给你的群聊起个名字吧" required>
    </div>
        <!-- 3. 我的信息 (新增部分，模仿私聊) -->
    <input type="hidden" id="group-selected-persona-id" value="">
    
    <div class="form-group">
        <div class="form-header-row">
            <button type="button" class="btn btn-primary" id="create-group-select-persona-btn">选择群主</button>
        </div>
    </div>

    <!-- 并排显示 真名 和 昵称 -->
    <div class="form-group" style="display:none;">
        <div style="flex: 1;">
            <label for="group-my-name">我的姓名</label>
            <input type="text" id="group-my-name" placeholder="真名" readonly>
        </div>
        <div style="flex: 1;">
            <label for="group-my-nickname">我的昵称</label>
            <input type="text" id="group-my-nickname" placeholder="群内显示名" required readonly>
        </div>
    </div>
    
    <!-- 隐藏的人设区域 (只读) -->
    <div class="form-group" style="display:none;">
        <label>我的人设 (绑定后自动填充)</label>
        <textarea id="group-my-persona" rows="2" readonly placeholder="请通过上方“绑定人设”按钮导入"></textarea>
    </div>
    <!-- 1. 选择群成员 -->
    <div class="form-group">
        <label>选择群成员</label>
        <ul id="member-selection-list" class="list-container"></ul>
    </div>
    <button type="submit" class="btn btn-primary" style="margin-top: 15px;">创建群聊</button>
</form>
            </div>
        </div>

        <!-- Group Member Edit Modal -->
        <div id="edit-group-member-modal" class="modal-overlay">
            <div class="modal-window">
                <h3 id="edit-group-member-title">修改群昵称</h3>
                <form id="edit-group-member-form">
                    <input type="hidden" id="editing-member-id">
                    <div class="avatar-setting">
                        <img src="" alt="成员头像" id="edit-member-avatar-preview" class="avatar-preview"
                            style="cursor: pointer;">
                        <input type="file" id="edit-member-avatar-upload" accept="image/*" style="display:none;">
                    </div>
                    <div class="form-group">
                        <label for="edit-member-group-nickname"></label>
                        <input type="text" id="edit-member-group-nickname" required>
                    </div>
                    <div class="form-group" style="display:none;">
                        <label for="edit-member-real-name">姓名</label>
                        <input type="text" id="edit-member-real-name" required>
                    </div>
                    <div class="form-group" style="display:none;">
                        <label for="edit-member-persona">人设</label>
                        <textarea id="edit-member-persona" placeholder="详细描述角色的性格、背景等。"></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">保存</button>
                </form>
            </div>
        </div>
        <!-- Add Member to Group Action Sheet -->
        <div id="add-member-actionsheet" class="action-sheet-overlay">
            <div class="action-sheet">
                <button class="action-sheet-button" id="invite-existing-member-btn">邀请现有角色</button>
                <button class="action-sheet-button" id="create-new-member-btn">创建新角色入群</button>
            </div>
        </div>
        <!-- Invite Existing Member Modal -->
        <div id="invite-member-modal" class="modal-overlay">
            <div class="modal-window">
                <h3>邀请成员加入群聊</h3>
                <ul id="invite-member-selection-list"></ul>
                <button class="btn btn-primary" id="confirm-invite-btn" style="margin-top: 20px;">确认邀请</button>
            </div>
        </div>
        <!-- Create New Member for Group Modal -->
        <div id="create-member-for-group-modal" class="modal-overlay">
            <div class="modal-window">
                <h3>创建新角色并加入群聊</h3>
                <form id="create-member-for-group-form">
                    <div class="avatar-setting" style="justify-content: center;">
                        <img src="https://i.postimg.cc/Y96LPskq/o-o-2.jpg" alt="新成员头像"
                            id="create-group-member-avatar-preview" class="avatar-preview" style="cursor: pointer;">
                        <input type="file" id="create-group-member-avatar-upload" accept="image/*"
                            style="display:none;">
                    </div>
                    <div class="form-group">
                        <label for="create-group-member-nickname">群昵称</label>
                        <input type="text" id="create-group-member-nickname" required>
                    </div>
                    <div class="form-group">
                        <label for="create-group-member-realname">姓名</label>
                        <input type="text" id="create-group-member-realname" required>
                    </div>
                    <div class="form-group">
                        <label for="create-group-member-persona">人设</label>
                        <textarea id="create-group-member-persona" placeholder="详细描述角色的性格、背景等。"></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">创建并加入</button>
                </form>
            </div>
        </div>



   <!-- 批量删除消息弹窗 --> 
    <div id="delete-chunk-modal" class="modal-overlay">
        <div class="modal-window">
            <h3>删除指定范围记录</h3>
            <form id="delete-chunk-form">
                <div id="delete-chunk-range-info"
                    style="font-size: 12px; color: #888; text-align: center; margin-bottom: 15px;"></div>
                <div class="form-group">
                    <label for="delete-range-start">起始消息 (序号)</label>
                    <input type="number" id="delete-range-start" placeholder="例如：1" required>
                </div>
                <div class="form-group">
                    <label for="delete-range-end">结束消息 (序号)</label>
                    <input type="number" id="delete-range-end" placeholder="例如：100" required>
                </div>
                <button type="submit" class="btn btn-primary">下一步</button>
            </form>
        </div>
    </div>

    <div id="delete-chunk-confirm-modal" class="modal-overlay">
        <div class="modal-window">
            <h3>确认删除</h3>
            <p>将永久删除以下范围的消息，此操作不可撤销！</p>
            <div id="delete-chunk-preview"
                style="max-height: 200px; overflow-y: auto; background: #f5f5f5; border-radius: 8px; padding: 10px; margin: 15px 0; font-size: 12px; line-height: 1.5;">
                <!-- Preview will be inserted here -->
            </div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button id="confirm-delete-chunk-btn" class="btn btn-danger" style="flex: 1;">永久删除</button>
                <button id="cancel-delete-chunk-btn" class="btn btn-neutral" style="flex: 1;">取消</button>
            </div>
        </div>
    </div>

    <!-- 预设气泡弹窗 -->
    <div id="bubble-presets-modal" class="modal-overlay">
        <div class="modal-window">
            <h3>管理气泡预设</h3>
            <div class="list-container" id="bubble-presets-list"></div>
            <button type="button" id="close-presets-modal" class="btn btn-primary">关闭</button>
        </div>
    </div>


    <!-- 偷看手机弹窗 -->
        <div id="peek-confirm-modal" class="modal-overlay">
            <div class="modal-window">
                <h3>要偷看ta的手机吗？</h3>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button id="peek-confirm-yes" class="btn btn-primary" style="flex: 1;">是</button>
                    <button id="peek-confirm-no" class="btn btn-neutral" style="flex: 1;">否</button>
                </div>
            </div>
        </div>
        <!-- New Peek Wallpaper Modal -->
        <div id="peek-wallpaper-modal" class="modal-overlay">
            <div class="modal-window" style="max-height: 80vh; overflow-y: auto;">
                <h3>“偷看”页面自定义</h3>
                <div class="collapsible-section open">
    <div class="collapsible-header">
        <h4>关联聊天记录</h4>
        <span class="collapsible-arrow">▼</span>
    </div>
    <div class="collapsible-content">
        <div class="form-group" style="margin-bottom: 0;">
            <label for="peek-context-limit">关联聊天记录条数 (1-500)</label>
            <input type="number" id="peek-context-limit" class="form-group" style="margin-bottom: 0;"
                   min="1" max="500" step="1" placeholder="默认: 50">
        </div>
    </div>
</div>
                <div class="collapsible-section">
                    <div class="collapsible-header">
                        <h4>页面壁纸</h4>
                        <span class="collapsible-arrow">▼</span>
                    </div>
                    <div class="collapsible-content">
                        <form id="peek-wallpaper-form">
                            <div class="form-group">
                                <label for="peek-wallpaper-url-input">壁纸URL</label>
                                <input type="url" id="peek-wallpaper-url-input" class="form-group" style="margin-bottom: 0;"
                                    placeholder="粘贴图片URL">
                            </div>
                            <p style="text-align:center; color:#888; margin: -10px 0 15px;">或</p>
                            <input type="file" id="peek-wallpaper-upload" accept="image/*" style="display: none;">
                            <label for="peek-wallpaper-upload" class="btn btn-secondary" style="margin-bottom: 0;">从本地上传</label>
                        </form>
                    </div>
                </div>
                <div class="collapsible-section">
                    <div class="collapsible-header">
                        <h4>应用图标</h4>
                        <span class="collapsible-arrow">▼</span>
                    </div>
                    <div class="collapsible-content" id="peek-app-icons-settings">
                        <!-- App icon settings will be rendered here by JS -->
                    </div>
                </div>
                <div class="collapsible-section">
                    <div class="collapsible-header">
                        <h4>微博(Unlock)小号</h4>
                        <span class="collapsible-arrow">▼</span>
                    </div>
                    <div class="collapsible-content">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="peek-unlock-avatar-url">头像URL</label>
                            <input type="url" id="peek-unlock-avatar-url" class="form-group" style="margin-bottom: 0;" placeholder="粘贴图片URL">
                        </div>
                    </div>
                </div>
                <button id="save-peek-settings-btn" class="btn btn-primary" style="margin-top: 20px;">保存所有更改</button>
            </div>
        </div>

        <div id="peek-photo-modal" class="modal-overlay">
            <div class="modal-window">
                <div id="peek-photo-image-container">
                    <span class="placeholder-icon">🖼️</span>
                </div>
                <div id="peek-photo-description"></div>
            </div>
        </div>

    <!-- 总结弹窗 -->
    <!-- Journal World Book Selection Modal -->
    <div id="journal-worldbook-selection-modal" class="modal-overlay">
        <div class="modal-window">
            <h3>为日记绑定世界书</h3>
            <ul id="journal-worldbook-selection-list" class="list-container"
                style="max-height: 40vh; overflow-y: auto; padding: 0; margin: 15px 0;">
                <!-- World book items will be rendered here -->
            </ul>
            <button class="btn btn-primary" id="save-journal-worldbook-selection-btn"
                style="margin-top: 20px;">确认</button>
        </div>
    </div>

<!-- 日记设置模态框 (HTML修改版) -->
<div id="journal-css-modal" class="modal-overlay">
    <div class="modal-window">
        <h3>日记设置</h3>
        <form id="journal-css-form">
            <!-- 新增：字体选择 -->
            <div class="form-group">
                <label for="journal-font-select">日记字体</label>
                <select id="journal-font-select" class="form-control" style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #ddd;">
                    <!-- 选项将通过 JS 动态生成 -->
                </select>
            </div>

            <!-- 原有的 CSS 输入框 -->
            <div class="form-group">
                <label for="journal-css-input">自定义 CSS (可选)</label>
                <textarea id="journal-css-input" rows="6" placeholder=".journal-custom-scope { background: #fff; } ..."></textarea>
            </div>
            
            <div class="form-actions">
                <button type="submit" class="btn btn-primary" style="width: 100%;">保存设置</button>
            </div>
        </form>
    </div>
</div>

<!-- Generate Journal Modal (增加开关) -->
<div id="generate-journal-modal" class="modal-overlay">
    <div class="modal-window">
        <h3>生成内容</h3>
        <form id="generate-journal-form">
            <div id="journal-range-info" style="font-size: 12px; color: #888; text-align: center; margin-bottom: 15px;"></div>
            
            <div class="form-group">
                <label for="journal-range-start">起始消息 (序号)</label>
                <input type="number" id="journal-range-start" placeholder="例如：1" required>
            </div>
            <div class="form-group">
                <label for="journal-range-end">结束消息 (序号)</label>
                <input type="number" id="journal-range-end" placeholder="例如：100" required>
            </div>

            <!-- 新增：同时生成日记开关 -->
            <div class="form-group" id="generate-both-toggle-container" style="display: flex; align-items: center; justify-content: space-between; margin-top: 15px;">
                <label for="generate-both-switch" style="margin-bottom: 0;">同时生成角色日记</label>
                <label class="switch">
                    <input type="checkbox" id="generate-both-switch">
                    <span class="slider round"></span>
                </label>
            </div>

            <button type="submit" class="btn btn-primary">生成</button>
        </form>
    </div>
</div>

<!-- 新增：长期总结生成模态框 -->
<div id="generate-long-term-modal" class="modal-overlay">
    <div class="modal-window">
        <h3>生成长期总结</h3>
        <p style="font-size:12px; color:#666; margin-bottom:15px;">将选定日期范围内的所有“短期总结”再次精炼，提取关键事件。</p>
        
        <form id="generate-long-term-form">
            <div class="date-range-inputs">
                <!-- 开始日期 -->
                <div style="font-weight: bold; font-size: 13px;">起始日期：</div>
                <div class="date-input-group">
                    <input type="number" id="long-start-year" class="date-input-field" placeholder="YYYY" required>
                    <span class="date-label">年</span>
                    <input type="number" id="long-start-month" class="date-input-field" placeholder="MM" min="1" max="12" required>
                    <span class="date-label">月</span>
                    <input type="number" id="long-start-day" class="date-input-field" placeholder="DD" min="1" max="31" required>
                    <span class="date-label">日</span>
                </div>

                <div class="date-separator">至</div>

                <!-- 结束日期 -->
                <div style="font-weight: bold; font-size: 13px;">结束日期：</div>
                <div class="date-input-group">
                    <input type="number" id="long-end-year" class="date-input-field" placeholder="YYYY" required>
                    <span class="date-label">年</span>
                    <input type="number" id="long-end-month" class="date-input-field" placeholder="MM" min="1" max="12" required>
                    <span class="date-label">月</span>
                    <input type="number" id="long-end-day" class="date-input-field" placeholder="DD" min="1" max="31" required>
                    <span class="date-label">日</span>
                </div>
            </div>
            
            <button type="submit" class="btn btn-primary">开始精炼</button>
        </form>
    </div>
</div>

    <!-- 论坛弹窗 -->
    <!-- 手动发帖弹窗 -->
    <div id="forum-create-post-modal" class="modal-overlay">
        <div class="modal-window">
            <h3>发布新帖</h3>

            <div class="form-group" style="display: flex; align-items: center; gap: 8px; margin-bottom: 15px;">
                <input type="checkbox" id="create-post-is-anon" style="width: auto;">
                <label for="create-post-is-anon" style="margin: 0; user-select: none;">使用匿名发布 (隐藏身份)</label>
            </div>

            <div class="form-group">
                <input type="text" id="create-post-title" placeholder="帖子标题" maxlength="30">
            </div>
            <div class="form-group">
                <textarea id="create-post-content" placeholder="分享你的想法..." rows="5"></textarea>
            </div>

            <button class="btn btn-primary" id="confirm-create-post-btn"
                style="width: 100%; margin-top: 10px;">发布</button>
        </div>
    </div>

            <!-- 分享弹窗 -->
    <div id="share-post-modal" class="modal-overlay">
        <div class="modal-window">
            <h3>分享帖子给角色</h3>
            <!-- 新增：评论数量设置 -->
            <div class="form-group" style="margin-bottom: 10px;">
                <label style="font-size:13px; color:#666;">包含最新评论条数</label>
                <input type="number" id="share-comment-count-input" value="30" min="0" max="100"
                    style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 8px;">
            </div>

            <div style="max-height: 250px; overflow-y: auto; border: 1px solid #eee; border-radius: 8px; padding: 5px; margin-bottom: 15px;">
                <ul id="share-char-list" class="binding-list">
                    <!-- JS 填充 -->
                </ul>
            </div>
            <button id="confirm-share-btn" class="btn btn-primary" style="width:100%">发送</button>
        </div>
    </div>

        <!-- 新增：头像更换弹窗 (复用并修改自提供的示例) -->
        <div id="me-avatar-modal" class="modal-overlay">
            <div class="modal-window">
                <h3>更换论坛头像</h3>
                <form id="me-avatar-form">
                    <div id="me-avatar-preview-modal"
                        style="width: 100px; height: 100px; border: 2px dashed #ddd; border-radius: 50%; margin: 0 auto 15px; display: flex; align-items: center; justify-content: center; color: #aaa; background-color: #f9f9f9; background-size: cover; background-position: center;">
                        <span></span>
                    </div>
                    <div class="form-group">
                        <label for="me-avatar-url-input-modal">头像URL</label>
                        <input type="url" id="me-avatar-url-input-modal" placeholder="粘贴图片URL">
                    </div>
                    <p style="text-align:center; color:#888; margin: -10px 0 15px;">或</p>
                    <input type="file" id="me-avatar-file-upload-modal" accept="image/*" style="display:none;">
                    <label for="me-avatar-file-upload-modal" class="btn btn-secondary"
                        style="width:100%; margin-bottom: 20px;">从本地上传</label>

                    <!-- 修改：去掉了取消按钮，只保留确认按钮 -->
                    <button type="submit" class="btn btn-primary" style="width:100%; margin-top:0;">确认</button>
                </form>
            </div>
        </div>


<!-- 模态框：读取人设列表 (放在 body 结束前) -->
<div id="forum-load-persona-modal" class="modal-overlay">
    <div class="modal-window">
        <h3>选择预设身份</h3>
        <ul id="forum-persona-list" class="list-container" style="max-height: 40vh; overflow-y: auto; padding: 0; margin: 15px 0; ">
            <!-- JS 填充 -->
        </ul>
        <button class="btn btn-primary" id="forum-confirm-persona-load" style="margin-top: 10px;">确认读取</button>
    </div>
</div>


       <!-- 番茄钟弹窗 -->
       <!-- Global Pomodoro World Book Selection Modal -->
        <div id="global-pomodoro-world-book-selection-modal" class="modal-overlay">
            <div class="modal-window">
                <h3>为全局专注设置关联世界书</h3>
                <ul id="global-pomodoro-world-book-selection-list" class="list-container"
                    style="max-height: 40vh; overflow-y: auto; padding: 0; margin: 15px 0;">
                    <!-- World book items will be rendered here -->
                </ul>
                <button class="btn btn-primary" id="save-global-pomodoro-world-book-selection-btn"
                    style="margin-top: 20px;">确认</button>
            </div>
        </div>

        <!-- Pomodoro Certificate Modal -->
        <div id="pomodoro-certificate-modal" class="modal-overlay">
            <div class="modal-window" style="text-align: center;">
                <h3>专注完成！</h3>
                <div id="pomodoro-certificate-content"
                    style="border: 2px dashed var(--primary-color); padding: 20px; margin: 15px 0; border-radius: 10px; background: #F5FBFF;">
                    <p><strong>任务名称:</strong> <span id="cert-task-name"></span></p>
                    <p><strong>专注时长:</strong> <span id="cert-duration"></span></p>
                    <p><strong>“戳一戳”次数:</strong> <span id="cert-poke-count"></span></p>
                </div>
                <p>做的很棒！要不要把这次的专注成果分享一下？</p>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button id="forward-certificate-btn" class="btn btn-primary" style="flex: 1;">转发到聊天框</button>
                    <button id="close-certificate-btn" class="btn btn-neutral" style="flex: 1;">关闭</button>
                </div>
            </div>
        </div>

        <!-- Pomodoro Record Detail Modal -->

        <!-- Pomodoro Create Task Modal -->
        <div id="pomodoro-create-modal" class="modal-overlay">
            <div class="modal-window">
                <h3>创建专注任务</h3>
                <form id="pomodoro-create-form">
                    <div class="form-group">
                        <label for="pomodoro-task-name">任务名称</label>
                        <input type="text" id="pomodoro-task-name" class="form-group"
                            placeholder="例如：阅读一章《JavaScript高级程序设计》" required>
                    </div>
                    <div class="form-group">
                        <label>计时模式</label>
                        <div class="radio-group-pills">
                            <input type="radio" id="mode-countdown" name="pomodoro-mode" value="countdown" checked>
                            <label for="mode-countdown">倒计时</label>
                            <input type="radio" id="mode-stopwatch" name="pomodoro-mode" value="stopwatch">
                            <label for="mode-stopwatch">正计时</label>
                        </div>
                    </div>
                    <div id="pomodoro-duration-options" class="visible">
                        <button type="button" class="duration-pill active" data-duration="30">30分钟</button>
                        <button type="button" class="duration-pill" data-duration="45">45分钟</button>
                        <button type="button" class="duration-pill" data-duration="60">60分钟</button>
                        <button type="button" class="duration-pill" data-duration="custom">自定义</button>
                        <input type="number" id="pomodoro-custom-duration-input" class="form-group" placeholder="输入分钟数">
                    </div>
                    <button type="submit" class="btn btn-primary" style="margin-top: 20px;">创建任务</button>
                </form>
            </div>
        </div>


       <!-- 设置页面弹窗 -->
<!-- api预设弹窗 -->
             <div id="api-presets-modal" class="modal-overlay">
             <div class="modal-window">
             <h3>API 预设管理</h3>
             <div class="list-container" id="api-presets-list" ></div>
             <button id="api-close-modal" class="btn btn-primary">关闭</button>
             </div>
             </div>
       
       
       <!-- 全局css弹窗 -->
    <div id="global-css-presets-modal" class="modal-overlay">
        <div class="modal-window">
            <h3>管理全局CSS预设</h3>
            <div class="list-container" id="global-css-presets-list"></div>
            <button type="button" id="global-css-close-modal" class="btn btn-primary">关闭</button>
        </div>
    </div>
    
    <!-- GitHub 配置弹窗 -->
<div id="github-settings-modal" class="modal-overlay">
    <div class="modal-content" style="padding: 20px; width: 85%; max-width: 320px;">
        <h3 style="margin-top:0; margin-bottom:15px;">GitHub 连接配置</h3>
        
        <div class="input-group" style="margin-bottom: 10px;">
            <label style="display:block; font-size:12px; color:#666; margin-bottom:4px;">Token (以 ghp_ 开头)</label>
            <input type="password" id="gh-token-input" class="modal-input" placeholder="ghp_xxxx..." style="width:100%; padding:8px; border:1px solid #ddd; border-radius:6px;">
        </div>

        <div class="input-group" style="margin-bottom: 10px;">
            <label style="display:block; font-size:12px; color:#666; margin-bottom:4px;">用户名 (GitHub Username)</label>
            <input type="text" id="gh-username-input" class="modal-input" placeholder="例如: yourname" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:6px;">
        </div>

        <div class="input-group" style="margin-bottom: 15px;">
            <label style="display:block; font-size:12px; color:#666; margin-bottom:4px;">仓库名 (Repository)</label>
            <input type="text" id="gh-repo-input" class="modal-input" placeholder="例如: my-backup" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:6px;">
            <div style="font-size:10px; color:#999; margin-top:4px;">* 建议使用私有仓库 (Private)</div>
        </div>

        <div style="margin-bottom: 15px; display:flex; align-items:center; gap:8px;">
             <input type="checkbox" id="gh-auto-backup-switch">
             <label for="gh-auto-backup-switch" style="font-size:13px;">开启自动备份（每日打开时备份）</label>
        </div>

        <div class="modal-actions" style="display:flex; justify-content: flex-end; gap: 10px;">
            <button id="btn-gh-save"  class="btn btn-primary">保存并连接</button>
            <button id="btn-gh-cancel" class="btn btn-neutral">取消</button>            
        </div>
    </div>
</div>

       <!-- 主页弹窗 -->
    <!-- INS Widget Avatar Modal -->
    <div id="ins-widget-avatar-modal" class="modal-overlay">
        <div class="modal-window">
            <h3>更换头像</h3>
            <form id="ins-widget-avatar-form">
                <input type="hidden" id="ins-widget-avatar-target">
                <div id="ins-widget-avatar-preview"
                    style="width: 100px; height: 100px; border: 2px dashed #ddd; border-radius: 50%; margin: 0 auto 15px; display: flex; align-items: center; justify-content: center; color: #aaa; background-color: #f9f9f9; background-size: cover; background-position: center;">
                    <span>预览</span>
                </div>
                <div class="form-group">
                    <label for="ins-widget-avatar-url-input">头像URL</label>
                    <input type="url" id="ins-widget-avatar-url-input" class="form-group" placeholder="粘贴图片URL">
                </div>
                <p style="text-align:center; color:#888; margin: -10px 0 15px;">或</p>
                <input type="file" id="ins-widget-avatar-file-upload" accept="image/*" style="display:none;">
                <label for="ins-widget-avatar-file-upload" class="btn btn-secondary"
                    style="width:100%; margin-bottom: 20px;">从本地上传</label>
                <button type="submit" class="btn btn-primary">保存</button>
            </form>
        </div>
    </div>



<!-- Rpg游戏弹窗 -->
<!-- 角色选择模态框 (原有的) -->
<div id="rpg-chat-char-select-modal" class="modal-overlay">
    <div class="modal-window">
        <h3>选择伙伴</h3>
        <ul id="rpg-chat-char-list" class="list-container" style="max-height: 40vh; overflow-y: auto;">
            <!-- JS 填充 -->
        </ul>
        <button class="btn btn-neutral" id="rpg-cancel-char-select-btn" style="margin-top: 15px;">取消</button>
    </div>
</div>

<!-- 1. 读取人设模态框 (样式统一) -->
<div id="rpg-user-persona-modal" class="modal-overlay">
    <div class="modal-window">
        <h3>我的预设人设</h3>
        <ul id="rpg-user-persona-list" class="list-container" style="max-height: 40vh; overflow-y: auto; padding: 0; margin: 15px 0;">
            <!-- JS 填充 -->
        </ul>
        <button class="btn btn-primary" id="rpg-confirm-user-persona" style="margin-top: 10px;">确认读取</button>
    </div>
</div>

<!-- 2. 选择伙伴模态框 (样式统一) -->
<div id="rpg-partner-select-modal" class="modal-overlay">
    <div class="modal-window">
        <h3>选择冒险伙伴</h3>
        <ul id="rpg-partner-list" class="list-container" style="max-height: 40vh; overflow-y: auto; padding: 0; margin: 15px 0;">
             <!-- JS 填充 -->
        </ul>
        <button class="btn btn-primary" id="rpg-confirm-partner-select" style="margin-top: 10px;">确认选择</button>
    </div>
</div>

<!-- 3. 世界书选择模态框 (照搬 Journal 样式) -->
<div id="rpg-wb-select-modal" class="modal-overlay">
    <div class="modal-window">
        <h3>绑定冒险世界书</h3>
        <ul id="rpg-wb-list" class="list-container" style="max-height: 40vh; overflow-y: auto; padding: 0; margin: 15px 0;">
            <!-- RenderCategorizedWorldBookList 将填充这里 -->
        </ul>
        <button class="btn btn-primary" id="rpg-wb-confirm-btn" style="margin-top: 20px;">确认绑定</button>
    </div>
</div>


        <!-- 通用模态框 (用于背包和商店) -->
       <div id="rpg-common-modal" class="modal-overlay" style="z-index: 200;">
            <div class="rpg-modal-content">
                <button class="rpg-close-btn" id="rpg-modal-close-btn">×</button>
                <div id="rpg-modal-title" class="rpg-modal-header">标题</div>
                <div id="rpg-modal-tabs" class="rpg-modal-tabs" style="display:none;">
                    <button class="rpg-tab-btn active" data-type="all">全部</button>
                    <button class="rpg-tab-btn" data-type="battle">战斗</button>
                    <button class="rpg-tab-btn" data-type="map">地图</button>
                    <button class="rpg-tab-btn" data-type="home">家园</button>
                </div>
                <div id="rpg-modal-body" class="rpg-inventory-list"></div>
            </div>
        </div>

    <!-- Update Log Modal -->
    <div id="update-log-modal" class="modal-overlay">
        <div class="modal-window">
            <h3>发现新版本！</h3>
            <div id="update-log-modal-content">
                <!-- Update content will be injected here -->
            </div>
            <button id="close-update-log-modal" class="btn btn-primary" style="margin-top: 15px;">我知道了</button>
        </div>
    </div>
    
      <!-- phone-screen的结尾 -->
</div>   

<!-- js文件引入开始 -->
<script src="js/core/globals.js"></script>
<script src="js/core/database.js"></script>
<script src="js/core/utils.js"></script>

<!-- 设置页面 -->
    <script src="js/settings/api.js"></script>
    <script src="js/settings/wallpaper.js"></script>    
    <script src="js/settings/update_log.js"></script>
    <script src="js/settings/tutorial.js"></script>
    <script src="js/settings/font_settings.js"></script>
    <script src="js/settings/customize.js"></script>
    <script src="js/settings/safe_toggle.js"></script>


<!-- 世界书 -->    
    <script src="js/world_book.js"></script>
    
<!-- 聊天室 -->            
    <script src="js/chat/chat_room.js"></script>
    <script src="js/chat/group.js"></script>
    <script src="js/chat/private_prompt.js"></script>
    <script src="js/chat/group_prompt.js"></script>
    <script src="js/chat/char_import.js"></script>
    <script src="js/chat/bubble_css_preset.js"></script>
    <script src="js/chat/chat_list.js"></script>
    <script src="js/chat/chat_settings.js"></script>
    <script src="js/chat/chat_search.js"></script>

    <script src="js/chat/summary.js"></script>
    <script src="js/peek.js"></script>
    
<!-- 番茄钟 -->
    <script src="js/pomodoro.js"></script>
<!-- 论坛 -->
    <script src="js/forum.js"></script>
<!-- rpg -->    
    <script src="js/rpg_game.js"></script>

    <script src="js/settings/backup_data.js"></script>
    <script src="js/settings/data_storage.js"></script>

    <script src="js/home.js"></script>
    <script src="js/main.js"></script>

</body>
</html>